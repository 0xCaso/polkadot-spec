<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.18">
<meta name="description" content="The Official Polkadot and Kusama Protocol Specification">
<meta name="keywords" content="babe, blockchain, consensus, finality, grandpa, kusama, parachain, polkadot, relay-chain, runtime, spec, web3, w3f">
<meta name="author" content="Web 3.0 Technologies Foundation">
<link rel="icon" type="image/png" href="./favicon.png">
<title>Polkadot Protocol Specification</title>
<style>
/* Fetch Unbounded - Normal - Regular */
@import url('https://fonts.googleapis.com/css2?family=Unbounded:wght@400&display=swap');
/* Fetch Work Sans - Normal + Italic - Regular + Bold */
@import url('https://fonts.googleapis.com/css2?family=Work+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap');
/* Fetch Asciidoctor Default Style Sheet */
@import url('https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css');

/* Base constants of theme */
:root {
	--font-header: 'Unbounded', cursive;
	--font-text: 'Work Sans', sans-serif;

	--black: #1E1E1E;
	--white: #FFFFFF;

	--dark-blue: #172026;
	--grey: #efefef;

	--pink: #E6007A;
	--purple: #670d35;
}


/* Apply some layout corrections */
html {
	height: 100%;
}

body {
	min-height: 100%;
  	display: flex;
  	flex-direction: column;
}

.partintro {
	margin-bottom: 1.25rem;
}

/* Render part intros just like other text */
.partintro div.content {
	line-height: 1.6;
	font-size: 1.0625rem;
	letter-spacing: -.01em;
	text-rendering: optimizeLegibility;
}

/* Set our custom font */
body {
	font-family: var(--font-text);
}

h1, h2, h3, h4, h5, h6,
#toctitle,
#toc ul.sectlevel0 > li > a,
.sidebarblock > .content > .title {
	font-family: var(--font-header);
	font-weight: 400;
}

#toc ul{
	font-family: var(--font-text);
}

/* Set base colors */
body {
	color: var(--black);
	background-color: var(--white);
}

/* Style all titles */
h1, h2, h3, h4, h5, h6,
#toctitle,
.subheader,
.title {
	color: var(--pink);
}

/* - could be replaced by !important in previous block */
.sidebarblock > .content > .title,
.admonitionblock td.content > .title,
.audioblock > .title,
.exampleblock > .title,
.imageblock > .title,
.listingblock > .title,
.literalblock > .title,
.stemblock > .title,
.openblock > .title,
.paragraph > .title,
.quoteblock > .title,
table.tableblock > .title,
.verseblock > .title,
.videoblock > .title,
.dlist > .title,
.olist > .title,
.ulist > .title,
.qlist > .title,
.hdlist > .title {
	color: inherit;
}

h1 code,
h2 code,
h3 code,
h4 code,
h5 code,
h6 code {
    color: inherit;
}

/* Style all links */
a {
	color: var(--pink);
}

a:hover {
	color: var(--purple);
}

/* - same here, next two blocks or important above */
#content h1 > a.link,
h2 > a.link,
h3 > a.link, #toctitle > a.link,
h4 > a.link,
h5 > a.link,
h6 > a.link,
.sidebarblock > .content > .title > a.link {
	color: inherit;
}

#content h1 > a.link:hover,
h2 > a.link:hover,
h3 > a.link:hover,
h4 > a.link:hover,
h5 > a.link:hover,
h6 > a.link:hover,
#toctitle > a.link:hover,
.sidebarblock > .content > .title > a.link:hover {
	color: var(--purple);
}

/* Style header like toc on small screens */
@media screen and (max-width:768px) {
	#header {
		background-color: var(--dark-blue);
		max-width: none;
	}

	#header > h1:first-child {
  		color: var(--pink);
	}

	#header .details {
  		color: var(--white);
		border: none;
	}
}

/* Style table of content */
#toc.toc2 {
	background-color: var(--dark-blue);
	border: none;
}

#toc ul.sectlevel0 > li > a {
  font-weight: bold;
  font-style: normal;
  text-decoration: underline;
}

#toc a {
	color: var(--white);
}

#toc a code {
	color: inherit;
	background-color: inherit;
}

#toc a .toc-current,
#toc .tocify-focus a {
	color: var(--pink);
}

/* Tame SVG images */
.imageblock .content svg {
  max-width: 100%;
}

/* Style boxes */
.exampleblock > .content, 
.sidebarblock {
	background: var(--grey);
}

/* Style footer */
#footer {
	color: var(--white);
	background-color: var(--dark-blue);
}

/* CSS Ribbon */
.ribbon {
  position: absolute;
  width: 200px;
  height: 200px;
  overflow: hidden;
  z-index: 99999;
  top: 0px;
  right: 0px;
}

.ribbon a {
  display: inline-block;
  position: inherit;
  transform: rotate(45deg);
  width: 200px;
  top: 45px; 
  right: -40px;
  padding: 6px 0px;
  overflow: hidden;

  text-align: center;
  font-size: 12px;
  font-weight: bold;
  text-decoration: none;

  color: var(--white);
  background-color: var(--pink);
  background-image: linear-gradient(rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));
  border: 2px dotted var(--white);
  box-shadow: rgba(0, 0, 0, 0.5) 0px 2px 3px 0px;
}

/* MathJax v3 */
.stemblock mjx-container {
  text-align: center;
  display: block;
  width: 100%;
  margin: 1em 0em;
}

/* Pseudocode.js */
.ps-root {
  font-size: 1.2em !important;
}

/* Fix inline svg with fixed width or height. */
.imageblock .content svg {
  widht: auto;
  height: auto;
}

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>.toc-current{font-weight: bold;} .toc-root{font-family: "Open Sans","DejaVu Sans",sans-serif;
                       font-size: 0.9em;} #content{display: flex; flex-direction: column; flex: 1 1 auto;}
             .nav-footer{text-align: center; margin-top: auto;}
             .nav-footer > p > a {white-space: nowrap;}</style>
</head>
<body id="chap-sync" class="book toc2 toc-left">
<!-- Contribution Ribbon -->
<div class="ribbon"><a target="_blank" href="https://github.com/w3f/polkadot-spec">Contributions welcome!</a></div>
<div id="header">
<h1>Polkadot Protocol Specification</h1>
<div class="details">
<span id="author" class="author">Web 3.0 Technologies Foundation</span><br>
<span id="revnumber">version 0.2.1</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<p><span class="toc-root"><a href="polkadot-spec.html">Polkadot Protocol Specification</a></span></p><ul class="sectlevel1">
<li><a href="id-polkadot-protocol.html">Polkadot Protocol</a>
</li>
<li><a href="part-polkadot-host.html">Polkadot Host</a>
<ul class="sectlevel1">
<li><a href="chap-overview.html">1. Overview</a>
</li>
<li><a href="chap-state.html">2. States and Transitions</a>
</li>
<li><a href="chap-sync.html"><span class="toc-current">3. Synchronization</span></a>
<ul class="sectlevel2">
<li><a href="chap-sync.html#sect-sync-warp">3.1. Warp Sync</a>
</li>
<li><a href="chap-sync.html#sect-sync-fast">3.2. Fast Sync</a>
</li>
<li><a href="chap-sync.html#id-full-sync">3.3. Full Sync</a>
</li>
<li><a href="chap-sync.html#sect-block-validation">3.4. Importing and Validating Block</a>
</li>
</ul>
</li>
<li><a href="chap-networking.html">4. Networking</a>
</li>
<li><a href="sect-block-production.html">5. Block Production</a>
</li>
<li><a href="sect-finality.html">6. Finality</a>
</li>
<li><a href="sect-lightclient.html">7. Light Clients</a>
</li>
<li><a href="chapter-anv.html">8. Availability &amp; Validity</a>
</li>
</ul>
</li>
<li><a href="part-polkadot-runtime.html">Polkadot Runtime</a>
</li>
<li><a href="id-cryptography-encoding.html">Appendix D: Cryptography &amp; Encoding</a>
</li>
<li><a href="chap-host-api.html">Appendix E: Host API</a>
</li>
<li><a href="chap-runtime-api.html">Appendix F: Runtime API</a>
</li>
<li><a href="id-bibliography.html">Bibliography</a>
</li>
<li><a href="id-glossary.html">Glossary</a>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="chap-sync"><a class="anchor" href="#chap-sync"></a><a class="link" href="#chap-sync">3. Synchronization</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Many applications that interact with the Polkadot network to some extent must be
able to retrieve certain information about the network. Depending on the
utility, this includes validators that interact with Polkadot&#8217;s consensus and
need access to the full state, either from the past or just the most up-to-date
state, or light clients that are only interest in the minimum information
required in order to verify some claims about the state of the network, such as
the balance of a specific account. To allow implemenations to quickly retrieve
the required information, different types of synchronization protocols are
available, respectivel Full, Fast and Warp sync suited for different needs.</p>
</div>
<div class="paragraph">
<p>The associated network messages are specified in <a href="chap-networking.html#sect-network-messages">Section 4.8</a>.</p>
</div>
<div class="sect2">
<h3 id="sect-sync-warp"><a class="anchor" href="#sect-sync-warp"></a><a class="link" href="#sect-sync-warp">3.1. Warp Sync</a></h3>
<div class="paragraph">
<p>Warp sync (<a href="chap-networking.html#sect-msg-warp-sync">Section 4.8.4</a>) only downloads the block headers where authority set changes occurred, so called fragments (<a href="chap-networking.html#defn-warp-sync-proof">Definition 41</a>), and by verifying the GRANDPA justifications (<a href="chap-networking.html#defn-grandpa-justifications-compact">Definition 45</a>). This protocols allows nodes to arrive at the desired state much faster than fast sync.</p>
</div>
</div>
<div class="sect2">
<h3 id="sect-sync-fast"><a class="anchor" href="#sect-sync-fast"></a><a class="link" href="#sect-sync-fast">3.2. Fast Sync</a></h3>
<div class="paragraph">
<p>Fast sync works by downloading the block header history and validating the
auhtority set changes (<a href="chap-sync.html#sect-authority-set">Section 3.3.1</a>) in order to arrive at a specific
(usually the most recent) header. After the desired header has been reached and
verified, the state can be downloaded and imported (<a href="chap-networking.html#sect-msg-state-request">Section 4.8.3</a>).
Once this process has been completed, the node can proceed with a full sync.</p>
</div>
</div>
<div class="sect2">
<h3 id="id-full-sync"><a class="anchor" href="#id-full-sync"></a><a class="link" href="#id-full-sync">3.3. Full Sync</a></h3>
<div class="paragraph">
<p>The full sync protocols is the "default" protocol that&#8217;s suited for many types
of implementations, such as archive nodes (nodes that store everything),
validators that participate in Polkadots consensus and light clients that only
verify claims about the state of the network. Full sync works by listening to
announced blocks (<a href="chap-networking.html#sect-msg-block-announce">Section 4.8.1</a>) and requesting the blocks from
the announcing peers, or just the block headers in case of light clients.</p>
</div>
<div class="paragraph">
<p>The full sync protocol usually downloads the entire chain, but no such
requirements must be met. If an implemenation only wants the latest, finalized
state, it can combine it with protocols such as fast sync (<a href="chap-sync.html#sect-sync-fast">Section 3.2</a>)
and/or warp sync (<a href="chap-sync.html#sect-sync-warp">Section 3.1</a>) to make synchronization as fast as
possible.</p>
</div>
<div class="sect3">
<h4 id="sect-authority-set"><a class="anchor" href="#sect-authority-set"></a><a class="link" href="#sect-authority-set">3.3.1. Consensus Authority Set</a></h4>
<div class="paragraph">
<p>Because Polkadot is a proof-of-stake protocol, each of its consensus engines has
its own set of nodes represented by known public keys, which have the authority
to influence the protocol in pre-defined ways explained in this Section. To
verify the validity of each block, the Polkadot node must track the current list
of authorities (<a href="chap-sync.html#defn-authority-list">Definition 33</a>) for that block.</p>
</div>
<div id="defn-authority-list" class="exampleblock">
<div class="title">Definition 33. <a href="chap-sync.html#defn-authority-list">Authority List</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>authority list</strong> of block \$B\$ for consensus engine \$C\$ noted as
\$"Auth"_C(B)\$ is an array that contains the following pair of types for
each of its authorities \$A in "Auth"_C(B)\$:</p>
</div>
<div class="stemblock">
<div class="content">
\$(pk_A,w_A)\$
</div>
</div>
<div class="paragraph">
<p>\$pk_A\$ is the session public key (<a href="id-cryptography-encoding.html#defn-session-key">Definition 180</a>) of authority
\$A\$. And \$w_A\$ is an unsigned 64-bit integer indicating the authority
weight. The value of \$"Auth"_C(B)\$ is part of the Polkadot state. The value
for \$"Auth"_C(B_0)\$ is set in the genesis state (<a href="id-cryptography-encoding.html#chapter-genesis">Section A.3</a>) and
can be retrieved using a runtime entrypoint corresponding to consensus engine
\$C\$.</p>
</div>
<div class="paragraph">
<p>The authorities and their corresponding weights can be retrieved from the
Runtime (<a href="chap-runtime-api.html#sect-rte-grandpa-auth">Section C.10.1</a>).</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-consensus-message-digest"><a class="anchor" href="#sect-consensus-message-digest"></a><a class="link" href="#sect-consensus-message-digest">3.3.2. Runtime-to-Consensus Engine Message</a></h4>
<div class="paragraph">
<p>The authority list (<a href="chap-sync.html#defn-authority-list">Definition 33</a>) is part of the Polkadot state and
the Runtime has the authority to update this list in the course of any state
transitions. The Runtime informs the corresponding consensus engine about the
changes in the authority set by adding the appropriate consensus message in the
form of a digest item (<a href="chap-state.html#defn-digest">Definition 11</a>) to the block header of block \$B\$
which caused the transition in the authority set.</p>
</div>
<div class="paragraph">
<p>The Polkadot Host must inspect the digest header of each block and delegate
consensus messages to their consensus engines. The BABE and GRANDPA consensus
engine must react based on the type of consensus messages it receives. The
active GRANDPA authorities can only vote for blocks that occurred after the
finalized block in which they were selected. Any votes for blocks before the
came into effect would get rejected.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-block-validation"><a class="anchor" href="#sect-block-validation"></a><a class="link" href="#sect-block-validation">3.4. Importing and Validating Block</a></h3>
<div class="paragraph">
<p>Block validation is the process by which a node asserts that a block is fit to
be added to the blockchain. This means that the block is consistent with the
current state of the system and transitions to a new valid state.</p>
</div>
<div class="paragraph">
<p>New blocks can be received by the Polkadot Host via other peers
(<a href="chap-networking.html#sect-msg-block-request">Section 4.8.2</a>) or from the Host’s own consensus engine
(<a href="sect-block-production.html">Chapter 5</a>). Both the Runtime and the Polkadot Host then need to
work together to assure block validity. A block is deemed valid if the block
author had authorship rights for the slot in which the block was produce as well
as if the transactions in the block constitute a valid transition of states. The
former criterion is validated by the Polkadot Host according to the block
production consensus protocol. The latter can be verified by the Polkadot Host
invoking entry into the Runtime as (<a href="chap-runtime-api.html#sect-rte-core-execute-block">Section C.4.2</a>) as a part
of the validation process. Any state changes created by this function on
successful execution are persisted.</p>
</div>
<div class="paragraph">
<p>The Polkadot Host implements <a href="chap-sync.html#algo-import-and-validate-block">Import-and-Validate-Block</a> to assure the
validity of the block.</p>
</div>
<div class="sidebarblock">
<div class="content">
\require $B, \text{Just}(B)$

\state \call{Set-Storage-State-At}{$P(B)$}

\if{$\text{Just}(B) \neq \emptyset$}

    \state \call{Verify-Block-Justification}{$B, \text{Just}(B)$}

    \if{$B~\textbf{is}~\text{Finalized}~\textbf{and}~P(B)~\textbf{is not}~\text{Finalized}$}

        \state \call{Mark-as-Final}{$P(B)$}

     \endif

\endif

\if{$H_p(B) \notin PBT$}

    \return

\endif

\state \call{Verify-Authorship-Right}{$\text{Head}(B)$}

\state $B \leftarrow$ \call{Remove-Seal}{$B$}

\state $R \leftarrow$ \call{Call-Runtime-Entry}{$\texttt{Core\_execute\_block}, B$}

\state $B \leftarrow$ \call{Add-Seal}{$B$}

\if{$R =$ \textsc{True}}

    \state \call{Persist-State}{}

\endif
<div class="dlist">
<dl>
<dt class="hdlist1">where</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>\$"Remove-Seal"\$ removes the Seal digest from the block (<a href="chap-state.html#defn-digest">Definition 11</a>)
before submitting it to the Runtime.</p>
</li>
<li>
<p>\$"Add-Seal"\$ adds the Seal digest back to the block (<a href="chap-state.html#defn-digest">Definition 11</a>) for
later propagation.</p>
</li>
<li>
<p>\$"Persist-State"\$ implies the persistence of any state changes created by
\$tt "Core_execute_block"\$ (<a href="chap-runtime-api.html#sect-rte-core-execute-block">Section C.4.2</a>) on successful
execution.</p>
</li>
<li>
<p>\$"PBT"\$ is the pruned block tree (<a href="chap-state.html#defn-block-tree">Definition 4</a>).</p>
</li>
<li>
<p>\$"Verify-Authorship-Right"\$ is part of the block production consensus
protocol and is described in <a href="sect-block-production.html#algo-verify-authorship-right">Verify-Authorship-Right</a>.</p>
</li>
<li>
<p><em>Finalized block</em> and <em>finality</em> are defined in <a href="sect-finality.html">Chapter 6</a>.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph nav-footer">
<p>← Previous: <a href="chap-state.html">States and Transitions</a> | ↑ Up: <a href="part-polkadot-host.html">Polkadot Host</a> | ⌂ Home: <a href="polkadot-spec.html">Polkadot Protocol Specification</a> | Next: <a href="chap-networking.html">Networking</a> →</p>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 0.2.1<br>
Last updated 2023-03-09 11:37:31 +0100
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>