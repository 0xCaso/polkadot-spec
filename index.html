<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<meta name="description" content="The Official Polkadot and Kusama Protocol Specification">
<meta name="keywords" content="babe, blockchain, consensus, finality, grandpa, kusama, parachain, polkadot, relay-chain, runtime, spec, web3, w3f">
<meta name="author" content="Web 3.0 Technologies Foundation, Fabio Lama, Florian Franzen, Syed Hosseini">
<link rel="icon" type="image/png" href="./favicon.png">
<title>Polkadot Protocol Specification</title>
<style>
/* Fetch Work Sans - Normal + Italic - Regular + Bold */
@import url('https://fonts.googleapis.com/css2?family=Work+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap');
/* Fetch Asciidoctor Default Style Sheet */
@import url('https://cdn.jsdelivr.net/gh/asciidoctor/asciidoctor@2.0/data/stylesheets/asciidoctor-default.css');

/* Base constants of theme */
:root {
	--font-family: 'Work Sans', sans-serif;

	--black: #1E1E1E;
	--white: #FFFFFF;

	--dark-blue: #172026;
	--grey: #efefef;

	--pink: #E6007A;
	--purple: #670d35;
}


/* Apply some layout corrections */
html {
	height: 100%;
}

body {
	min-height: 100%;
  	display: flex;
  	flex-direction: column;
}

.partintro {
	margin-bottom: 1.25rem;
}

/* Set our custom font */
body {
	font-family: var(--font-family);
}

h1, h2, h3, h4, h5, h6,
#toctitle,
.sidebarblock > .content > .title {
	font-family: var(--font-family);
}

#toc ul{
	font-family: var(--font-family);
}

/* Set base colors */
body {
	color: var(--black);
	background-color: var(--white);
}

/* Style all titles */
h1, h2, h3, h4, h5, h6,
#toctitle,
.subheader,
.title {
	color: var(--pink);
}

/* - could be replaced by !important in previous block */
.sidebarblock > .content > .title,
.admonitionblock td.content > .title,
.audioblock > .title,
.exampleblock > .title,
.imageblock > .title,
.listingblock > .title,
.literalblock > .title,
.stemblock > .title,
.openblock > .title,
.paragraph > .title,
.quoteblock > .title,
table.tableblock > .title,
.verseblock > .title,
.videoblock > .title,
.dlist > .title,
.olist > .title,
.ulist > .title,
.qlist > .title,
.hdlist > .title {
	color: inherit;
}

h1 code,
h2 code,
h3 code,
h4 code,
h5 code,
h6 code {
    color: inherit;
}

/* Style all links */
a {
	color: var(--pink);
}

a:hover {
	color: var(--purple);
}

/* - same here, next two blocks or important above */
#content h1 > a.link,
h2 > a.link,
h3 > a.link, #toctitle > a.link,
h4 > a.link,
h5 > a.link,
h6 > a.link,
.sidebarblock > .content > .title > a.link {
	color: inherit;
}

#content h1 > a.link:hover,
h2 > a.link:hover,
h3 > a.link:hover,
h4 > a.link:hover,
h5 > a.link:hover,
h6 > a.link:hover,
#toctitle > a.link:hover,
.sidebarblock > .content > .title > a.link:hover {
	color: var(--purple);
}

/* Style header like toc on small screens */
@media screen and (max-width:768px) {
	#header {
		background-color: var(--dark-blue);
		max-width: none;
	}

	#header > h1:first-child {
  		color: var(--pink);
	}

	#header .details {
  		color: var(--white);
		border: none;
	}
}

/* Style table of content */
#toc.toc2 {
	background-color: var(--dark-blue);
	border: none;
}

#toc ul.sectlevel0 > li > a {
  font-weight: bold;
  font-style: normal;
  text-decoration: underline;
}

#toc a {
	color: var(--white);
}

#toc a code {
	color: inherit;
	background-color: inherit;
}

#toc a .toc-current,
#toc .tocify-focus a {
	color: var(--pink);
}

/* Style boxes */
.exampleblock > .content, 
.sidebarblock {
	background: var(--grey);
}

/* Style footer */
#footer {
	color: var(--white);
	background-color: var(--dark-blue);
}

/* CSS Ribbon */
.ribbon {
  position: absolute;
  width: 200px;
  height: 200px;
  overflow: hidden;
  z-index: 99999;
  top: 0px;
  right: 0px;
}

.ribbon a {
  display: inline-block;
  position: inherit;
  transform: rotate(45deg);
  width: 200px;
  top: 45px; 
  right: -40px;
  padding: 6px 0px;
  overflow: hidden;

  text-align: center;
  font-size: 12px;
  font-weight: bold;
  text-decoration: none;

  color: var(--white);
  background-color: var(--pink);
  background-image: linear-gradient(rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));
  border: 2px dotted var(--white);
  box-shadow: rgba(0, 0, 0, 0.5) 0px 2px 3px 0px;
}

/* MathJax v3 */
.stemblock mjx-container {
  text-align: center;
  display: block;
  width: 100%;
  margin: 1em 0em;
}

/* Pseudocode.js */
.ps-root {
  font-size: 1.2em !important;
}

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sa {
  color: #000000;
  font-weight: bold;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
<style type="text/css">@import url(https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css);.ps-root{font-family:KaTeX_Main,'Times New Roman',Times,serif;font-size:1em;font-weight:100;-webkit-font-smoothing:antialiased!important}.ps-root .ps-algorithm{margin:.8em 0;border-top:3px solid #000;border-bottom:2px solid #000}.ps-root .ps-algorithm.with-caption>.ps-line:first-child{border-bottom:2px solid #000}.ps-root .katex{text-indent:0;font-size:1em}.ps-root .MathJax,.ps-root .MathJax_CHTML{text-indent:0;font-size:1em!important}.ps-root .ps-line{margin:0;padding:0;line-height:1.2}.ps-root .ps-funcname{font-family:KaTeX_Main,'Times New Roman',Times,serif;font-weight:400;font-variant:small-caps;font-style:normal;text-transform:none}.ps-root .ps-keyword{font-family:KaTeX_Main,'Times New Roman',Times,serif;font-weight:700;font-variant:normal;font-style:normal;text-transform:none}.ps-root .ps-comment{font-family:KaTeX_Main,'Times New Roman',Times,serif;font-weight:400;font-variant:normal;font-style:normal;text-transform:none}.ps-root .ps-linenum{font-size:.8em;line-height:1em;width:1.6em;text-align:right;display:inline-block;position:relative;padding-right:.3em}.ps-root .ps-algorithmic.with-linenum .ps-line.ps-code{text-indent:-1.6em}.ps-root .ps-algorithmic.with-linenum .ps-line.ps-code>span{text-indent:0}</style>
</head>
<body class="book toc2 toc-left">
<!-- Contribution Ribbon -->
<div class="ribbon"><a target="_blank" href="https://github.com/w3f/polkadot-spec">Contributions welcome!</a></div>
<div id="header">
<h1>Polkadot Protocol Specification</h1>
<div class="details">
<span id="author" class="author">Web 3.0 Technologies Foundation</span><br>
<span id="author2" class="author">Fabio Lama</span><br>
<span id="author3" class="author">Florian Franzen</span><br>
<span id="author4" class="author">Syed Hosseini</span><br>
<span id="revnumber">version 0.2.0</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#_host_specification">Host Specification</a>
<ul class="sectlevel1">
<li><a href="#_preliminaries">1. Preliminaries</a>
<ul class="sectlevel2">
<li><a href="#_bootstrapping">1.1. Bootstrapping</a></li>
<li><a href="#sect-defn-conv">1.2. Definitions</a></li>
</ul>
</li>
<li><a href="#chap-state-spec">2. State Specification</a>
<ul class="sectlevel2">
<li><a href="#sect-state-storage">2.1. State Storage and Storage Trie</a></li>
<li><a href="#sect-child-storages">2.2. Child Storage</a></li>
</ul>
</li>
<li><a href="#chap-state-transit">3. State Transition</a>
<ul class="sectlevel2">
<li><a href="#sect-entries-into-runtime">3.1. Interacting with the Runtime</a></li>
<li><a href="#sect-extrinsics">3.2. Extrinsics</a></li>
<li><a href="#sect-state-replication">3.3. State Replication</a></li>
</ul>
</li>
<li><a href="#chap-networking">4. Networking</a>
<ul class="sectlevel2">
<li><a href="#_introduction">4.1. Introduction</a></li>
<li><a href="#sect-networking-external-docs">4.2. External Documentation</a></li>
<li><a href="#_node_identities">4.3. Node Identities</a></li>
<li><a href="#sect-discovery-mechanism">4.4. Discovery mechanism</a></li>
<li><a href="#sect-connection-establishment">4.5. Connection establishment</a></li>
<li><a href="#sect-encryption-layer">4.6. Encryption Layer</a></li>
<li><a href="#sect-protocols-substreams">4.7. Protocols and Substreams</a></li>
<li><a href="#sect-network-messages">4.8. Network Messages</a></li>
<li><a href="#sect-network-sync">4.9. Synchronization</a></li>
</ul>
</li>
<li><a href="#chap-consensus">5. Consensus</a>
<ul class="sectlevel2">
<li><a href="#_common_consensus_structures">5.1. Common Consensus Structures</a></li>
<li><a href="#sect-block-production">5.2. Block Production</a></li>
<li><a href="#sect-finality">5.3. Finality</a></li>
<li><a href="#sect-block-finalization">5.4. Block Finalization</a></li>
<li><a href="#sect-grandpa-beefy">5.5. Bridge design (BEEFY)</a></li>
</ul>
</li>
<li><a href="#chapter-anv">6. Availability &amp; Validity</a>
<ul class="sectlevel2">
<li><a href="#sect-collations">6.1. Collations</a></li>
<li><a href="#sect-candidate-backing">6.2. Candidate Backing</a></li>
<li><a href="#sect-candidate-validation">6.3. Candidate Validation</a></li>
<li><a href="#sect-availability">6.4. Availability</a></li>
<li><a href="#sect-approval-voting">6.5. Approval Voting</a></li>
<li><a href="#sect-disputes">6.6. Disputes</a></li>
<li><a href="#sect-anv-network-messages">6.7. Network Messages</a></li>
<li><a href="#sect-anv-definitions">6.8. Definitions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_runtime_specification">Runtime Specification</a>
<ul class="sectlevel1">
<li><a href="#_extrinsics">7. Extrinsics</a>
<ul class="sectlevel2">
<li><a href="#_introduction_2">7.1. Introduction</a></li>
<li><a href="#_preliminaries_6">7.2. Preliminaries</a></li>
<li><a href="#_extrinsics_body">7.3. Extrinsics Body</a></li>
</ul>
</li>
<li><a href="#_weights">8. Weights</a>
<ul class="sectlevel2">
<li><a href="#_motivation">8.1. Motivation</a></li>
<li><a href="#sect-assumptions">8.2. Assumptions</a></li>
<li><a href="#sect-runtime-primitives">8.3. Calculation of the weight function</a></li>
<li><a href="#sect-benchmarking">8.4. Benchmarking</a></li>
<li><a href="#sect-practical-examples">8.5. Practical examples</a></li>
<li><a href="#_fees">8.6. Fees</a></li>
</ul>
</li>
<li><a href="#_consensus">9. Consensus</a>
<ul class="sectlevel2">
<li><a href="#_babe_digest_messages">9.1. BABE digest messages</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_additional_information">Additional information</a>
<ul class="sectlevel1">
<li><a href="#chapter-crypto-algos">10. Cryptographic Algorithms</a>
<ul class="sectlevel2">
<li><a href="#sect-hash-functions">10.1. Hash Functions</a></li>
<li><a href="#sect-blake2">10.2. BLAKE2</a></li>
<li><a href="#sect-randomness">10.3. Randomness</a></li>
<li><a href="#sect-vrf">10.4. VRF</a></li>
<li><a href="#sect-cryptographic-keys">10.5. Cryptographic Keys</a></li>
</ul>
</li>
<li><a href="#chapter-encoding">11. Auxiliary Encodings</a>
<ul class="sectlevel2">
<li><a href="#sect-scale-codec">11.1. SCALE Codec</a></li>
<li><a href="#_hex_encoding">11.2. Hex Encoding</a></li>
</ul>
</li>
<li><a href="#chapter-genesis">12. Genesis State</a></li>
<li><a href="#chapter-erasure-encoding">13. Erasure Encoding</a>
<ul class="sectlevel2">
<li><a href="#sect-erasure-encoding">13.1. Erasure Encoding</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#chap-host-api">Host API</a>
<ul class="sectlevel1">
<li><a href="#_preliminaries_7">14. Preliminaries</a></li>
<li><a href="#sect-storage-api">15. Storage</a>
<ul class="sectlevel2">
<li><a href="#_functions">15.1. Functions</a></li>
</ul>
</li>
<li><a href="#sect-child-storage-api">16. Child Storage</a>
<ul class="sectlevel2">
<li><a href="#_functions_2">16.1. Functions</a></li>
</ul>
</li>
<li><a href="#sect-crypto-api">17. Crypto</a>
<ul class="sectlevel2">
<li><a href="#_functions_3">17.1. Functions</a></li>
</ul>
</li>
<li><a href="#sect-hashing-api">18. Hashing</a>
<ul class="sectlevel2">
<li><a href="#_functions_4">18.1. Functions</a></li>
</ul>
</li>
<li><a href="#sect-offchain-api">19. Offchain</a>
<ul class="sectlevel2">
<li><a href="#_functions_5">19.1. Functions</a></li>
</ul>
</li>
<li><a href="#sect-trie-api">20. Trie</a>
<ul class="sectlevel2">
<li><a href="#_functions_6">20.1. Functions</a></li>
</ul>
</li>
<li><a href="#sect-misc-api">21. Miscellaneous</a>
<ul class="sectlevel2">
<li><a href="#_functions_7">21.1. Functions</a></li>
</ul>
</li>
<li><a href="#sect-allocator-api">22. Allocator</a>
<ul class="sectlevel2">
<li><a href="#_functions_8">22.1. Functions</a></li>
</ul>
</li>
<li><a href="#sect-logging-api">23. Logging</a>
<ul class="sectlevel2">
<li><a href="#_functions_9">23.1. Functions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#chap-runtime-api">Runtime API</a>
<ul class="sectlevel1">
<li><a href="#_general_information">24. General Information</a>
<ul class="sectlevel2">
<li><a href="#sect-json-rpc-api">24.1. JSON-RPC API for external services</a></li>
</ul>
</li>
<li><a href="#_runtime_constants">25. Runtime Constants</a>
<ul class="sectlevel2">
<li><a href="#_heap_base">25.1. <code>__heap_base</code></a></li>
</ul>
</li>
<li><a href="#_runtime_functions">26. Runtime Functions</a>
<ul class="sectlevel2">
<li><a href="#sect-runtime-core-module">26.1. Core Module (Version 3)</a></li>
<li><a href="#sect-runtime-metadata-module">26.2. Metadata Module (Version 1)</a></li>
<li><a href="#sect-runtime-blockbuilder-module">26.3. BlockBuilder Module (Version 4)</a></li>
<li><a href="#sect-runtime-txqueue-module">26.4. TaggedTransactionQueue (Version 2)</a></li>
<li><a href="#sect-runtime-offchainapi-module">26.5. OffchainWorkerApi Module (Version 2)</a></li>
<li><a href="#sect-anv-runtime-api">26.6. ParachainHost Module (Version 1)</a></li>
<li><a href="#_grandpaapi_module_version_2">26.7. GrandpaApi Module (Version 2)</a></li>
<li><a href="#_babeapi_module_version_2">26.8. BabeApi Module (Version 2)</a></li>
<li><a href="#_accountnonceapi_module_version_1">26.9. AccountNonceApi Module (Version 1)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_bibliography">Appendix A: Bibliography</a></li>
<li><a href="#_glossary">Glossary</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This specification is <strong>Work-In-Progress</strong> and any content, structure,
design and/or hyper/anchor-link <strong>is subject to change</strong>.
</td>
</tr>
</table>
</div>
</div>
</div>
<h1 id="_host_specification" class="sect0"><a class="link" href="#_host_specification">Host Specification</a></h1>
<div class="openblock partintro">
<div class="content">
Description of the Host-side of the Polkadot Protocol
</div>
</div>
<div class="sect1">
<h2 id="_preliminaries"><a class="link" href="#_preliminaries">1. Preliminaries</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Formally, Polkadot is a replicated sharded state machine designed to
resolve the scalability and interoperability among blockchains. In
Polkadot vocabulary, shards are called <em>parachains</em> and Polkadot <em>relay
chain</em> is part of the protocol ensuring global consensus among all the
parachains. The Polkadot relay chain protocol, henceforward called
<em>Polkadot protocol</em>, can itself be considered as a replicated state
machine on its own. As such, the protocol can be specified by
identifying the state machine and the replication strategy.</p>
</div>
<div class="paragraph">
<p>From a more technical point of view, the Polkadot protocol has been
divided into two parts, the <em>Runtime</em> and the <em>Host</em>. The Runtime
comprises the state transition logic for the Polkadot protocol and is
designed and be upgradable via the consensus engine without requiring
hard forks of the blockchain. The Polkadot Host provides the
functionality for the Runtime to execute its state transition logic,
such as an execution environment, I/O and consensus, shared mostly among
peer-to-peer decentralized cryptographically-secured transaction
systems, i.e. blockchains whose consensus system is based on the
proof-of-stake. The Polkadot Host is planned to be stable and static for
the lifetime duration of the Polkadot protocol.</p>
</div>
<div class="paragraph">
<p>With the current document, we aim to specify the Polkadot Host part of the
Polkadot protocol as a replicated state machine. After defining the basic terms
in Chapter 1, we proceed to specify the representation of a valid state of the
Protocol in <a href="#chap-state-spec">Chapter 2</a>. In <a href="#chap-state-transit">Chapter 3</a>, we identify the
protocol states, by explaining the Polkadot state transition and discussing the
detail based on which the Polkadot Host interacts with the state transition
function, i.e. Runtime. Following, we specify the input messages triggering the
state transition and the system behaviour. In <a href="#chap-networking">Chapter 4</a>, we specify
the communication protocols and network messages required for the Polkadot Host
to communicate with other nodes in the network, such as exchanging blocks and
consensus messages. In <a href="#chap-consensus">Chapter 5</a>, we specify the consensus protocol,
which is responsible for keeping all the replica in the same state. Finally, the
initial state of the machine is identified and discussed in <a href="#chapter-genesis">Chapter 12</a>.
A Polkadot Host implementation which conforms with this part of the
specification should successfully be able to sync its states with the Polkadot
network.</p>
</div>
<div class="sect2">
<h3 id="_bootstrapping"><a class="link" href="#_bootstrapping">1.1. Bootstrapping</a></h3>
<div class="paragraph">
<p>This section provides an overview over the tasks a Polkadot Host needs to
performs in order to join and participate in the Polkadot network. While this
chapter does not go into any new specifications of the protocol, it has been
included to provide implementors with a pointer to what these steps are and
where they are defined. In short, the following steps should be taken by all
bootstrapping nodes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The node needs to populate the state storage with the official genesis state,
clarifier further in <a href="#chapter-genesis">Chapter 12</a>.</p>
</li>
<li>
<p>The node should maintains a set of around 50 active peers at any time. New
peers can be found using the discovery protocols (<a href="#sect-discovery-mechanism">Section 4.4</a>)</p>
</li>
<li>
<p>The node should open and maintain the various required streams
(<a href="#sect-protocols-substreams">Section 4.7</a>) with each of its active peers.</p>
</li>
<li>
<p>Furthermore, the node should send block requests (<a href="#sect-msg-block-request">Section 4.8.2</a>)
to these peers to receive all blocks in the chain and execute each of them.</p>
</li>
<li>
<p>Exchange neighbor packets (<a href="#sect-grandpa-neighbor-msg">Section 4.8.6.1</a>).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Validator nodes should take the following, additional steps.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Verify that the Host’s session key is included in the current Epoch’s
authority set (<a href="#sect-authority-set">Section 5.1.1</a>).</p>
</li>
<li>
<p>Run the BABE lottery (<a href="#sect-block-production">Section 5.2</a>) and wait for the next
assigned slot in order to produce a block.</p>
</li>
<li>
<p>Gossip any produced blocks to all connected peers
(<a href="#sect-msg-block-announce">Section 4.8.1</a>).</p>
</li>
<li>
<p>Run the catch-up protocol (<a href="#sect-grandpa-catchup">Section 5.4.1</a>) to make sure that the
node is participating in the current round and not a past round.</p>
</li>
<li>
<p>Run the GRANDPA rounds protocol (<a href="#sect-finality">Section 5.3</a>).</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="sect-defn-conv"><a class="link" href="#sect-defn-conv">1.2. Definitions</a></h3>
<div id="defn-state-machine" class="exampleblock">
<div class="title">Definition 1. <a href="#defn-state-machine">Discrete State Machine (DSM)</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>Discrete State Machine(DSM)</strong> is a state transition system whose set of states
and set of transitions are countable and admits a starting state. Formally, it
is a tuple of</p>
</div>
<div class="stemblock">
<div class="content">
\$(\Sigma, S, s_0, \delta)\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$\Sigma\$ is the countable set of all possible transitions.</p>
</li>
<li>
<p>\$S\$ is a countable set of all possible states.</p>
</li>
<li>
<p>\$s_0 in S\$ is the initial state.</p>
</li>
<li>
<p>\$\delta\$ is the state-transition function, known as <strong>Runtime</strong> in the
Polkadot vocabulary, such that</p>
</li>
</ul>
</div>
<div class="stemblock">
<div class="content">
\$\delta : S \times \Sigma \rightarrow S\$
</div>
</div>
</div>
</div>
<div id="defn-path-graph" class="exampleblock">
<div class="title">Definition 2. <a href="#defn-path-graph">Path Graph</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>path graph</strong> or a <strong>path</strong> of \$n\$ nodes formally referred to as <strong>\$P_n\$</strong>,
is a tree with two nodes of vertex degree 1 and the other n-2 nodes of vertex
degree 2. Therefore, \$P_n\$ can be represented by sequences of \$(v_1,
\ldots, v_n)\$ where \$e_i = (v_i, v_{i + 1})\$ for \$1 &lt;= i &lt;= n - 1\$ is
the edge which connect \$v_i\$ and \$v_{i + 1}\$.</p>
</div>
</div>
</div>
<div id="defn-radix-tree" class="exampleblock">
<div class="title">Definition 3. <a href="#defn-radix-tree">Radix-r Tree</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>Radix-r tree</strong> is a variant of  a trie in which:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Every node has at most \$r\$ children where \$r = 2^x\$ for some
\$x\$;</p>
</li>
<li>
<p>Each node that is the only child of a parent, which does not
represent a valid key is merged with its parent.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As a result, in a radix tree, any path whose interior vertices all have only one
child and does not represent a valid key in the data set, is compressed into a
single edge. This improves space efficiency when the key space is sparse.</p>
</div>
</div>
</div>
<div id="defn-byte-sequence" class="exampleblock">
<div class="title">Definition 4. <a href="#defn-byte-sequence">Sequence of Bytes</a></div>
<div class="content">
<div class="paragraph">
<p>By a <strong>sequences of bytes</strong> or a <strong>byte array</strong>, \$b\$, of length
\$n\$, we refer to</p>
</div>
<div class="stemblock">
<div class="content">
\$b := (b_0, b_1, ..., b_{n - 1}) " such that " 0 &lt;= b_i &lt;= 255\$
</div>
</div>
<div class="paragraph">
<p>We define \$bbb B_n\$ to be the
<strong>set of all byte arrays of length \$n\$</strong>. Furthermore, we
define:</p>
</div>
<div class="stemblock">
<div class="content">
\$bbb B := uuu_(i=0)^infty bbb B_i\$
</div>
</div>
<div class="paragraph">
<p>We represent the concatenation of byte arrays
\$a :=(a_0, ..., a_n)\$ and
\$b :=(b_0, ..., b_m)\$ by:</p>
</div>
<div class="stemblock">
<div class="content">
\$a |\| b :=(a_0, ..., a_n, b_0, ..., b_m)\$
</div>
</div>
</div>
</div>
<div id="defn-bit-rep" class="exampleblock">
<div class="title">Definition 5. <a href="#defn-bit-rep">Bitwise Representation</a></div>
<div class="content">
<div class="paragraph">
<p>For a given byte \$b\$ the <strong>bitwise representation</strong> of \$b\$ is defined as</p>
</div>
<div class="stemblock">
<div class="content">
\$b :=b_7 ... b_0\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="stemblock">
<div class="content">
\$b = 2_0 b_0 + 2_1 b_1 + ... + 2_7 b_7\$
</div>
</div>
</div>
</div>
<div id="defn-little-endian" class="exampleblock">
<div class="title">Definition 6. <a href="#defn-little-endian">Little Endian</a></div>
<div class="content">
<div class="paragraph">
<p>By the <strong>little-endian</strong> representation of a non-negative integer, \$I\$,
represented as</p>
</div>
<div class="stemblock">
<div class="content">
\$I = (B_n ... B_0)_256\$
</div>
</div>
<div class="paragraph">
<p>in base 256, we refer to a byte array
\$B = (b_0, b_1, ..., b_n)\$ such that</p>
</div>
<div class="stemblock">
<div class="content">
\$b_i :=B_i\$
</div>
</div>
<div class="paragraph">
<p>Accordingly, we define the function \$sf "Enc"_(sf "LE")\$:</p>
</div>
<div class="stemblock">
<div class="content">
\$sf "Enc"_(sf "LE"):{(bbb Z^+ -&gt; bbb B),((B_n ... B_0)_256 -&gt; (B_{0,} B_1, ... , B_n)):}\$
</div>
</div>
</div>
</div>
<div id="defn-uint32" class="exampleblock">
<div class="title">Definition 7. <a href="#defn-uint32">UINT32</a></div>
<div class="content">
<div class="paragraph">
<p>By <strong>UINT32</strong> we refer to a non-negative integer stored in a byte array of
length \$4\$ using little-endian encoding format.</p>
</div>
</div>
</div>
<div id="defn-blockchain" class="exampleblock">
<div class="title">Definition 8. <a href="#defn-blockchain">Blockchain</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>blockchain</strong> \$C\$ is a directed path graph. Each node of the graph is
called <strong>Block</strong> and indicated by <strong>\$B\$</strong>. The unique sink of \$C\$ is
called <strong>Genesis Block</strong>, and the source is called the \$sf "Head"\$ of \$C\$. For any
vertex \$(B_1, B_2)\$ where \$B_1 -&gt; B_2\$ we say \$B_2\$ is the
<strong>parent</strong> of \$B_1\$ and we indicate it by</p>
</div>
<div class="stemblock">
<div class="content">
\$B_2 := P(B_1)\$
</div>
</div>
</div>
</div>
<div id="defn-unix-time" class="exampleblock">
<div class="title">Definition 9. <a href="#defn-unix-time">Unix Time</a></div>
<div class="content">
<div class="paragraph">
<p>By <strong>Unix time</strong>, we refer to the unsigned, little-endian encoded 64-bit integer
which stores the number of <strong>milliseconds</strong> that have elapsed since the Unix
epoch, that is the time 00:00:00 UTC on 1 January 1970, minus leap seconds. Leap
seconds are ignored, and every day is treated as if it contained exactly 86’400
seconds.</p>
</div>
</div>
</div>
<div id="defn-block-tree" class="exampleblock">
<div class="title">Definition 10. <a href="#defn-block-tree">Block </a></div>
<div class="content">
<div class="paragraph">
<p>In the course of formation of a (distributed) blockchain, it is possible
that the chain forks into multiple subchains in various block positions.
We refer to this structure as a <em>block tree</em>.</p>
</div>
<div class="paragraph">
<p>The <strong>block tree</strong> of a blockchain, denoted by \$BT\$ is the union of all
different versions of the blockchain observed by the Polkadot Host such that
every block is a node in the graph and \$B_1\$ is connected to \$B_2\$ if
\$B_1\$ is a parent of \$B_2\$.</p>
</div>
<div class="paragraph">
<p>When a block in the block tree gets finalized, there is an opportunity to prune
the block tree to free up resources into branches of blocks that do not contain
all of the finalized blocks or those that can never be finalized in the
blockchain (<a href="#sect-finality">Section 5.3</a>).</p>
</div>
</div>
</div>
<div id="defn-pruned-tree" class="exampleblock">
<div class="title">Definition 11. <a href="#defn-pruned-tree">Pruned Block Tree</a></div>
<div class="content">
<div class="paragraph">
<p>By <strong>Pruned Block Tree</strong>, denoted by \$"PBT"\$, we refer to a subtree of the block
tree obtained by eliminating all branches which do not contain the most recent
finalized blocks (<a href="#defn-finalized-block">Definition 88</a>). By <strong>pruning</strong>, we refer to the
procedure of \$BT larr "PBT"\$. When there is no risk of ambiguity and is safe
to prune BT, we use \$"BT"\$ to refer to \$"PBT"\$.</p>
</div>
<div class="paragraph">
<p><a href="#defn-chain-subchain">Definition 12</a> gives the means to highlight various branches of the
block tree.</p>
</div>
</div>
</div>
<div id="defn-chain-subchain" class="exampleblock">
<div class="title">Definition 12. <a href="#defn-chain-subchain">Subchain</a></div>
<div class="content">
<div class="paragraph">
<p>Let \$G\$ be the root of the block tree and \$B\$ be one of its nodes. By
\$"Chain"(B)\$, we refer to the path graph from \$G\$ to \$B\$ in
\$"BT"\$ or \$"PBT"\$. Conversely, for a chain \$C = sf "Chain"(b)\$,
we define <strong>the head of \$C\$</strong> to be \$B\$, formally noted as \$B :=
bar C\$. We define \$|C|\$, the length of \$C\$ as a path graph. If
\$B'\$ is another node on \$sf "Chain"(B)\$, then by \$sf
"SubChain"(B', B)\$ we refer to the subgraph of \$sf "Chain"(B)\$ path graph
which contains both \$B\$ and \$B'\$ and by \$sf "SubChain"(B', B)\$ we
refer to its length. Accordingly, \$bbb C_(B')((P)BT)\$ is the set of all
subchains of \$(P)BT\$ rooted at \$B'\$. The set of all chains of
\$(P)BT\$, \$bbb C_G((P)BT})\$ is denoted by \$bbb C((P)BT)\$ or simply
\$bbb C\$, for the sake of brevity.</p>
</div>
</div>
</div>
<div id="defn-longest-chain" class="exampleblock">
<div class="title">Definition 13. <a href="#defn-longest-chain">Longest Chain</a></div>
<div class="content">
<div class="paragraph">
<p>We define the following complete order over \$bbb C\$ such that for
\$C_1, C_2 in bbb C\$ if \$|C_1| != |C_2|\$ we say \$C_1 &gt; C_2\$ if
and only if \$|C_1| &gt; |C_2|\$.</p>
</div>
<div class="paragraph">
<p>If \$|C_1| =| C_2|\$ we say \$C_1 &gt; C_2\$ if and only if the block arrival
time of \$bar C_1\$ is less than the block arrival time of \$bar C_2\$
(<a href="#defn-block-time">Section 5.2.3.3</a>). We define the \$sf "Longest-Chain"(BT)\$ too be the
maximum chain given by this order.</p>
</div>
</div>
</div>
<div id="defn-longest-path" class="exampleblock">
<div class="title">Definition 14. <a href="#defn-longest-path">Longest Path</a></div>
<div class="content">
<div class="paragraph">
<p>\$sf "Longest-Path"(BT)\$ returns the path graph of \$(P)BT\$ which is the
longest among all paths in \$(P)BT\$ and has the earliest block arrival time
(<a href="#defn-block-time">Section 5.2.3.3</a>). \$sf "Deepest-Leaf"(BT)\$ returns the head of \$sf
"Longest-Path"(BT)\$ chain.</p>
</div>
<div class="paragraph">
<p>Because every block in the blockchain contains a reference to its parent, it is
easy to see that the block tree is de facto a tree. A block tree naturally
imposes partial order relationships on the blocks as follows:</p>
</div>
</div>
</div>
<div id="defn-descendant" class="exampleblock">
<div class="title">Definition 15. <a href="#defn-descendant">Descendant</a></div>
<div class="content">
<div class="paragraph">
<p>We say <strong>B is descendant of \$B'\$</strong>, formally noted as \$B &gt; B'\$ if
\$B\$ is a descendant of \$B'\$ in the block tree.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chap-state-spec"><a class="link" href="#chap-state-spec">2. State Specification</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="sect-state-storage"><a class="link" href="#sect-state-storage">2.1. State Storage and Storage Trie</a></h3>
<div class="paragraph">
<p>For storing the state of the system, Polkadot Host implements a hash
table storage where the keys are used to access each data entry. There
is no assumption either on the size of the key nor on the size of the
data stored under them, besides the fact that they are byte arrays with
specific upper limits on their length. The limit is imposed by the
encoding algorithms to store the key and the value in the storage trie.</p>
</div>
<div class="sect3">
<h4 id="_accessing_system_storage"><a class="link" href="#_accessing_system_storage">2.1.1. Accessing System Storage</a></h4>
<div class="paragraph">
<p>The Polkadot Host implements various functions to facilitate access to the
system storage for the Runtime (<a href="#sect-entries-into-runtime">Section 3.1</a>). Here we
formalize the access to the storage when it is being directly accessed by the
Polkadot Host (in contrast to Polkadot runtime).</p>
</div>
<div id="defn-stored-value" class="exampleblock">
<div class="title">Definition 16. <a href="#defn-stored-value">Stored Value</a></div>
<div class="content">
<div class="paragraph">
<p>The \$sf "StoredValue"\$ function retrieves the value stored under a specific
key in the state storage and is formally defined as:</p>
</div>
<div class="stemblock">
<div class="content">
\$sf "StoredValue" ": " cc K -&gt; cc V\$
\$k -&gt; {(v,"if " (k,v), "exists in state storage"),(phi,,"otherwise"):}\$
</div>
</div>
<div class="paragraph">
<p>where \$cc K sub bbb B\$ and \$cc V sub bbb B\$ are respectively
the set of all keys and values stored in the state storage.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_general_tree_structure"><a class="link" href="#_the_general_tree_structure">2.1.2. The General Tree Structure</a></h4>
<div class="paragraph">
<p>In order to ensure the integrity of the state of the system, the stored data
needs to be re-arranged and hashed in a <em>modified Merkle Patricia Tree</em>, which
hereafter we refer to as the <em>*Trie*</em>. This rearrangment is necessary to be able
to compute the Merkle hash of the whole or part of the state storage,
consistently and efficiently at any given time.</p>
</div>
<div class="paragraph">
<p>The Trie is used to compute the <em>state root</em>, \$H_r\$,
(<a href="#defn-block-header">Definition 32</a>), whose purpose is to authenticate the validity of the
state database. Thus, the Polkadot Host follows a rigorous encoding algorithm to
compute the values stored in the trie nodes to ensure that the computed Merkle
hash, \$H_r\$, matches across the Polkadot Host implementations.</p>
</div>
<div class="paragraph">
<p>The Trie is a <em>radix-16</em> tree (<a href="#defn-radix-tree">Definition 3</a>). Each key value identifies a
unique node in the tree. However, a node in a tree might or might not be
associated with a key in the storage.</p>
</div>
<div class="paragraph">
<p>When traversing the Trie to a specific node, its key can be reconstructed by
concatenating the subsequences of the key which are stored either explicitly in
the nodes on the path or implicitly in their position as a child of their
parent.</p>
</div>
<div class="paragraph">
<p>To identify the node corresponding to a key value, \$k\$, first we need to
encode \$k\$ to be consistent with the Trie structure way. Because each node
in the trie has at most 16 children, we represent the key as a sequence of 4-bit
nibbles:</p>
</div>
<div id="defn-trie-key-encode" class="exampleblock">
<div class="title">Definition 17. <a href="#defn-trie-key-encode">Key Encode</a></div>
<div class="content">
<div class="paragraph">
<p>For the purpose of labeling the branches of the Trie, the key \$k\$ is
encoded to \$k_("enc")\$ using \$sf "KeyEncode"\$ functions:</p>
</div>
<div class="stemblock">
<div class="content">
\$k_("enc") := (k_("enc"_1), ..., k_("enc"_(2n))) := sf "KeyEncode"(k)\$
</div>
</div>
<div class="paragraph">
<p>such that:</p>
</div>
<div class="stemblock">
<div class="content">
\$sf "KeyEncode"(k): {(bbb B,-&gt;,"Nibbles"^4),(k:=(b_1,...,b_n),-&gt;,(b_1^(1),b_1^2,b_2^1,b_2^2,...,b_n^1,b_n^2)),(,,:=(k_("enc"_1),...,k_("enc"_(2n)))):}\$
</div>
</div>
<div class="paragraph">
<p>where \$"Nibble"^4\$ is the set of all nibbles of 4-bit arrays and
\$b_i^1\$ and \$b_i^2\$ are 4-bit nibbles, which are the big endian
representations of \$b_i\$:</p>
</div>
<div class="stemblock">
<div class="content">
\$(b_i^1,b_i^2) := (b_i -: 16,b_i mod 16)\$
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>By looking at \$k_("enc")\$ as a sequence of nibbles, one can walk the radix
tree to reach the node identifying the storage value of \$k\$.</p>
</div>
</div>
<div class="sect3">
<h4 id="sect-state-storage-trie-structure"><a class="link" href="#sect-state-storage-trie-structure">2.1.3. Trie Structure</a></h4>
<div class="paragraph">
<p>In this subsection, we specify the structure of the nodes in the Trie as
well as the Trie structure:</p>
</div>
<div id="defn-trie-nodeset" class="exampleblock">
<div class="title">Definition 18. <a href="#defn-trie-nodeset">Set of Nodes</a></div>
<div class="content">
<div class="paragraph">
<p>We refer to the <strong>set of the nodes of Polkadot state trie</strong> by \$cc N\$. By
\$N in cc N\$ to refer to an individual node in the trie.</p>
</div>
</div>
</div>
<div id="defn-nodetype" class="exampleblock">
<div class="title">Definition 19. <a href="#defn-nodetype">State Trie</a></div>
<div class="content">
<div class="paragraph">
<p>The State Trie is a radix-16 tree. Each Node in the Trie is identified with a
unique key \(k_N\) such that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$k_N\$ is the shared prefix of the key of all the
descendants of \$N\$ in the Trie.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>and, at least one of the following statements holds:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$(k_N, v)\$ corresponds to an existing entry in the State Storage.</p>
</li>
<li>
<p>\$N\$ has more than one child.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Conversely, if \$(k, v)\$ is an entry in the State Trie then there is a node
\$N in cc N\$ such that \$k_N = k\$.</p>
</div>
</div>
</div>
<div id="defn-trie-branch" class="exampleblock">
<div class="title">Definition 20. <a href="#defn-trie-branch">Branch</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>branch</strong> node is a node which has one child or more. A branch node can have at
most 16 children. A <strong>leaf</strong> node is a childless node. Accordingly:</p>
</div>
<div class="stemblock">
<div class="content">
\$cc N_b := {N in cc N | N " is a branch node"}\$
\$cc N_i := {N in cc N | N " is a leaf node"}\$
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>For each node, part of \$k_N\$ is built while the trie is traversed from root
to \$N\$ part of \$k_N\$ is stored in \$N\$ (<a href="#defn-node-key">Definition 21</a>).</p>
</div>
<div id="defn-node-key" class="exampleblock">
<div class="title">Definition 21. <a href="#defn-node-key">Aggregated Prefix Key</a></div>
<div class="content">
<div class="paragraph">
<p>For any \$N in cc N\$, its key \$k_N\$ is divided into an <strong>aggregated
prefix key, \$"pk"_N^("Agr")\$</strong>, aggregated by the algorithm as defined in
<a href="#algo-aggregate-key">Section 2.1.3.1</a> and a <strong>partial key</strong>, <strong>\$"pk"_N\$</strong> of length
\$0 &lt;= l_("pk"_N) &lt;= 65535\$ in nibbles such that:</p>
</div>
<div class="stemblock">
<div class="content">
\$"pk"_N := (k_("enc"_i),...,k_("enc"_(i+l_("pk"_N))))\$
</div>
</div>
<div class="paragraph">
<p>where \$"pk"_N^("Agr")\$ is a suffix subsequence of \$k_N\$; \$i\$ is the length
of \$"pk"_N^("Agr")\$ in nibbles and so we have:</p>
</div>
<div class="stemblock">
<div class="content">
\$sf "KeyEncode"(k_N) = "pk"_N^("Agr") || "pk"_N = (k_("enc"_1), ..., k_("enc"_(i-1)),k_("enc"_i),k_("enc"_(i+l_("pk"_N))))\$
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Part of \$"pk"_N^("Agr")\$ is explicitly stored in \$N\$’s ancestors.
Additionally, for each ancestor, a single nibble is implicitly derived while
traversing from the ancestor to its child included in the traversal path using
the \$"Index"_N\$ function (<a href="#defn-index-function">Definition 22</a>).</p>
</div>
<div id="defn-index-function" class="exampleblock">
<div class="title">Definition 22. <a href="#defn-index-function">Index</a></div>
<div class="content">
<div class="paragraph">
<p>For \$N in cc N_b\$ and \$N_c\$ child of \$N\$, we define
\$sf "Index"_N\$ function as:</p>
</div>
<div class="stemblock">
<div class="content">
\$sf "Index"_N: {N_C in cc N | N_c " is a child of " N} -&gt; "Nibbles"_1^4\$
\$N_c -&gt; i\$
</div>
</div>
<div class="paragraph">
<p>such that</p>
</div>
<div class="stemblock">
<div class="content">
\$k_(N_c) = k_N || i || "pk"_(N_c)\$
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Assuming that \$P_N\$ is the path (<a href="#defn-path-graph">Definition 2</a>) from the Trie root to
node \$N\$, the algorithm defined in <a href="#algo-aggregate-key">Section 2.1.3.1</a> rigorously
demonstrates how to build \$"pk"_N^("Agr")\$ while traversing \$P_N\$.</p>
</div>
<div class="sect4">
<h5 id="algo-aggregate-key"><a class="link" href="#algo-aggregate-key">2.1.3.1. Aggregate Key</a></h5>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Algorithm: \$sf "Aggregate-Key"(P_N := ("TrieRoot" = N_1,...,N_j = N))\$</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>\$"pk"_N^("Agr") larr phi\$</p>
</li>
<li>
<p>\$i larr 1\$</p>
</li>
<li>
<p>\$"while" (N_i != N)\$</p>
</li>
<li>
<p>\$"    " pk_N^(Agr) larr pk_N^(Agr)"||"pk_(N_i)\$</p>
</li>
<li>
<p>\$"    " pk_N^(Agr) larr pk_N^(Agr)"||""Index"_(N_i)(N_(i+1))\$</p>
</li>
<li>
<p>\$"    " i larr i + 1\$</p>
</li>
<li>
<p>\$pk_N^(Agr) larr pk_N^(Agr)"||"pk_(N_i)\$</p>
</li>
<li>
<p>\$"return " pk_N^(Agr)\$</p>
</li>
</ol>
</div>
</div>
</div>
<div id="defn-node-value" class="exampleblock">
<div class="title">Definition 23. <a href="#defn-node-value">Node Value</a></div>
<div class="content">
<div class="paragraph">
<p>A node \$N in cc N\$ stores the <strong>node value</strong>, \$v_N\$, which consists of
the following concatenated data:</p>
</div>
<div class="stemblock">
<div class="content">
\$"Node Header"||"Partial Key"||"Node Subvalue"\$
</div>
</div>
<div class="paragraph">
<p>Formally noted as:</p>
</div>
<div class="stemblock">
<div class="content">
\$v_N := "Head"_N||"Enc"_("HE")(pk_N)||sv_N\$
</div>
</div>
<div class="paragraph">
<p>where \$"Head"_N\$, \$pk_N\$, \$"Enc"_("nibbles")\$ and \$sv_N\$ are
defined in <a href="#defn-node-header">Definition 24</a>, <a href="#defn-node-key">Definition 21</a>, <a href="#defn-hex-encoding">Definition 161</a> and
<a href="#defn-node-subvalue">Definition 26</a>, respectively.</p>
</div>
</div>
</div>
<div id="defn-node-header" class="exampleblock">
<div class="title">Definition 24. <a href="#defn-node-header">Node Header</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>node header</strong>, consisting of \$&gt;= 1\$ bytes, \$N_1...N_n\$, specifies
the node variant and the length of the partial key length (<a href="#defn-node-key">Definition 21</a>) in
4-bit nibbles. Both pieces of information can be represented in bits within a
single byte, \$N_1\$, where the amount of bits of the variant, \$v\$, and
the bits of the partial key length, \$p_l\$ varies.</p>
</div>
<div class="stemblock">
<div class="content">
\$v = {
    (01, "Leaf", p_l = 2^6),
    (10, "Branch Node with" k_N !in cc K, p_l = 2^6),
    (11, "Branch Node with" k_N in cc K, p_l = 2^6),
    (001, "Leaf containing hashes", p_l = 2^5),
    (0001, "Branch containing hashes", p_l = 2^4),
    (0000 0000, "Empty", p_l = 0),
    (0001 0000, "Reserved for compact encoding",)
    :}\$
</div>
</div>
<div class="paragraph">
<p>If the value of \$p_l\$ is equal to the maximum possible value the bits can
hold, such as 63 (\$2^6-1\$) in case of the \$01\$ variant, then the value
of the next 8 bits (\$N_2\$) are added the the length. This process is
repeated for every \$N_n\$ where \$N_n = 2^8-1\$. Any value smaller than
the maximum possible value of \$N_n\$ implies that the next value of
\$N_(n+1)\$ should not be added to the length.</p>
</div>
<div class="paragraph">
<p>The variant \$0001\$ can be distinguished from \$0001 0000\$ due to the
fact that the following 4 bits of the first variant never equal zero.</p>
</div>
<div class="paragraph">
<p>Formally, the lenght of the parital key, \$"pk"_N^l\$, is defined as:</p>
</div>
<div class="stemblock">
<div class="content">
\$"pk"_N^l = p_l + N_n + N_(n+x) + ... + N_(n+x+y)\$
</div>
</div>
<div class="paragraph">
<p>as long as \$p_l = m\$, \$N_(n+x) = 2^8-1\$ and
\$N_(n+x+y) &lt; 2^8-1\$, where \$m\$ is the maximum possible value
that \$p_l\$ can hold.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-merkl-proof"><a class="link" href="#sect-merkl-proof">2.1.4. Merkle Proof</a></h4>
<div class="paragraph">
<p>To prove the consistency of the state storage across the network and its
modifications both efficiently and effectively, the Trie implements a
Merkle tree structure. The hash value corresponding to each node needs
to be computed rigorously to make the inter-implementation data
integrity possible.</p>
</div>
<div class="paragraph">
<p>The Merkle value of each node should depend on the Merkle value of all its
children as well as on its corresponding data in the state storage. This
recursive dependancy is encompassed into the subvalue part of the node value
which recursively depends on the Merkle value of its children. Additionally, as
<a href="#sect-child-trie-structure">Section 2.2.1</a> clarifies, the Merkle proof of each <strong>child trie</strong>
must be updated first before the final Polkadot state root can be calculated.</p>
</div>
<div class="paragraph">
<p>We use the auxilary function introduced in <a href="#defn-children-bitmap">Definition 25</a> to encode
and decode information stored in a branch node.</p>
</div>
<div id="defn-children-bitmap" class="exampleblock">
<div class="title">Definition 25. <a href="#defn-children-bitmap">Children Bitmap</a></div>
<div class="content">
<div class="paragraph">
<p>Suppose \$N_b, N_c in cc N\$ and \$N_c\$ is a child of \$N_b\$. We
define where bit \$b_i : = 1\$ if \$N\$ has a child with partial key
\$i\$, therefore we define <strong>ChildrenBitmap</strong> functions as follows:</p>
</div>
<div class="stemblock">
<div class="content">
\$"ChildrenBitmap:"\$
\$cc N_b -&gt; bbb B_2\$
\$N -&gt; (b_(15), ...,b_8,b_7,...,b_0)_2\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="stemblock">
<div class="content">
\$b_i := {(1, EE N_c in cc N: k_(N_c) = k_(N_b)||i||pk_(N_c)),(0, "otherwise"):}\$
</div>
</div>
</div>
</div>
<div id="defn-node-subvalue" class="exampleblock">
<div class="title">Definition 26. <a href="#defn-node-subvalue">Subvalue</a></div>
<div class="content">
<div class="paragraph">
<p>For a given node \$N\$, the <strong>subvalue</strong> of \$N\$, formally referred to as
\$sv_N\$, is determined as follows:</p>
</div>
<div class="stemblock">
<div class="content">
\$sv_N := {("StoredValue"_("SC")),("Enc"_("SC")("ChildrenBitmap"(N)||"StoredValue"_("SC")||"Enc"_("SC")(H(N_(C_1))),...,"Enc"_("SC")(H(N_(C_n))))):}\$
</div>
</div>
<div class="paragraph">
<p>where the first variant is a leaf node and the second variant is a branch node.</p>
</div>
<div class="stemblock">
<div class="content">
\$"StoredValue"_("SC") := {("Enc"_("SC")("StoredValue"(k_N)),"if StoredValue"(k_N) = v),(phi,"if StoredValue"(k_N) = phi):}\$
</div>
</div>
<div class="paragraph">
<p>\$N_(C_1) ... N_(C_n)\$ with \$n &lt;= 16\$ are the children nodes of the
branch node \$N\$ and \$"Enc"_("SC")\$, \$"StoredValue"\$, \$H\$, and
\$"ChildrenBitmap"(N)\$ are defined in <a href="#sect-scale-codec">Section 11.1</a>,
<a href="#defn-stored-value">Definition 16</a>, <a href="#defn-merkle-value">Definition 28</a> and <a href="#defn-children-bitmap">Definition 25</a>
respectively.</p>
</div>
<div class="paragraph">
<p>The Trie deviates from a traditional Merkle tree where node value
(<a href="#defn-node-value">Definition 23</a>), \$v_N\$, is presented instead of its hash if it
occupies less space than its hash.</p>
</div>
</div>
</div>
<div id="defn-node-hashes" class="exampleblock">
<div class="title">Definition 27. <a href="#defn-node-hashes">Node Hashes</a></div>
<div class="content">
<div class="paragraph">
<p>To increate performance, a merkle proof can be generated by inserting the hash of
a value into the trie rather than the value itself (which can be quite
large). If merkle proof computation with node hashing is explicitly executed via
the Host API (<a href="#sect-ext-storage-root-version-2">Section 15.1.8.2</a>), then any value larger than
32 bytes is hashed, resulting in that hash being used as the subvalue
(<a href="#defn-node-subvalue">Definition 26</a>) under the corresponding key. The node header must
specify the variant \$001\$ respectively \$0001\$ (<a href="#defn-node-header">Definition 24</a>).</p>
</div>
</div>
</div>
<div id="defn-merkle-value" class="exampleblock">
<div class="title">Definition 28. <a href="#defn-merkle-value">Merkle Value</a></div>
<div class="content">
<div class="paragraph">
<p>For a given node \$N\$, the <strong>Merkle value</strong> of \$N\$, denoted by
\$H(N)\$ is defined as follows:</p>
</div>
<div class="stemblock">
<div class="content">
\$H: bbb B -&gt; U_(i -&gt; 0)^(32) bbb B_32\$
\$H(N): {(v_N,||v_N|| &lt; 32 " and " N != R),("Blake2b"(v_n),||v_N|| &gt;= 32 " or " N + R):}\$
</div>
</div>
<div class="paragraph">
<p>Where \$v_N\$ is the node value of \$N\$ (<a href="#defn-node-value">Definition 23</a>) and
\$R\$ is the root of the Trie. The <strong>Merkle hash</strong> of the Trie is defined to be
\(H(R)\).</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-child-storages"><a class="link" href="#sect-child-storages">2.2. Child Storage</a></h3>
<div class="paragraph">
<p>As clarified in <a href="#sect-state-storage">Section 2.1</a>, the Polkadot state storage implements a
hash table for inserting and reading key-value entries. The child storage works
the same way but is stored in a separate and isolated environment. Entries in
the child storage are not directly accessible via querying the main state
storage.</p>
</div>
<div class="paragraph">
<p>The Polkadot Host supports as many child storages as required by Runtime
and identifies each separate child storage by its unique identifying
key. Child storages are usually used in situations where Runtime deals
with multiple instances of a certain type of objects such as Parachains
or Smart Contracts. In such cases, the execution of the Runtime entry
might result in generating repeated keys across multiple instances of
certain objects. Even with repeated keys, all such instances of
key-value pairs must be able to be stored within the Polkadot state.</p>
</div>
<div class="paragraph">
<p>In these situations, the child storage can be used to provide the isolation
necessary to prevent any undesired interference between the state of separated
instances. The Polkadot Host makes no assumptions about how child storages are
used, but provides the functionality for it via the Host API
(<a href="#sect-child-storage-api">Chapter 16</a>).</p>
</div>
<div class="sect3">
<h4 id="sect-child-trie-structure"><a class="link" href="#sect-child-trie-structure">2.2.1. Child Tries</a></h4>
<div class="paragraph">
<p>The child trie specification is the same as the one described in
<a href="#sect-state-storage-trie-structure">Section 2.1.3</a>. Child tries have their own isolated
environment. Nonetheless, the main Polkadot state trie depends on them by
storing a node (\$K_N, V_N\$) which corresponds to an individual child trie.
Here, \$K_N\$ is the child storage key associated to the child trie, and
\$V_N\$ is the Merkle value of its corresponding child trie computed
according to the procedure described in <a href="#sect-merkl-proof">Section 2.1.4</a>.</p>
</div>
<div class="paragraph">
<p>The Polkadot Host API (<a href="#sect-child-storage-api">Chapter 16</a>) allows the Runtime to provide
the key \$K_N\$ in order to identify the child trie, followed by a second key
in order to identify the value within that child trie. Every time a child trie
is modified, the Merkle proof \$V_N\$ of the child trie stored in the
Polkadot state must be updated first. After that, the final Merkle proof of the
Polkadot state can be computed. This mechanism provides a proof of the full
Polkadot state including all its child states.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chap-state-transit"><a class="link" href="#chap-state-transit">3. State Transition</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Like any transaction-based transition system, Polkadot’s state is changed by
executing an ordered set of instructions. These instructions are known as
<em>extrinsics</em>. In Polkadot, the execution logic of the state transition function
is encapsulated in a Runtime (<a href="#defn-state-machine">Definition 1</a>). For easy upgradability
this Runtime is presented as a Wasm blob. Nonetheless, the Polkadot Host needs
to be in constant interaction with the Runtime (<a href="#sect-entries-into-runtime">Section 3.1</a>).</p>
</div>
<div class="paragraph">
<p>In <a href="#sect-extrinsics">Section 3.2</a>, we specify the procedure of the process where the
extrinsics are submitted, pre-processed and validated by Runtime and queued to
be applied to the current state.</p>
</div>
<div class="paragraph">
<p>To make state replication feasible, Polkadot journals and batches series of its
extrinsics together into a structure known as a <em>block</em>, before propagating them
to other nodes, similar to most other prominent distributed ledger systems. The
specification of the Polkadot block as well as the process of verifying its
validity are both explained in <a href="#sect-state-replication">Section 3.3</a>.</p>
</div>
<div class="sect2">
<h3 id="sect-entries-into-runtime"><a class="link" href="#sect-entries-into-runtime">3.1. Interacting with the Runtime</a></h3>
<div class="paragraph">
<p>The Runtime (<a href="#defn-state-machine">Definition 1</a>) is the code implementing the logic of the chain.
This code is decoupled from the Polkadot Host to make the the logic of the chain
easily upgradable without the need to upgrade the Polkadot Host itself. The
general procedure to interact with the Runtime is described by the algorithm as
defined in <a href="#algo-runtime-interaction">Section 3.1.1</a>.</p>
</div>
<div class="sect3">
<h4 id="algo-runtime-interaction"><a class="link" href="#algo-runtime-interaction">3.1.1. Algorithm: Interact-With-Runtime</a></h4>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Algorithm: \$"Interact-With-Runtime"(F, H_b(B),(A_1,...,A_n))\$</p>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$F\$ is the runtime entry call.</p>
</li>
<li>
<p>\$H_b(B)\$ is the block hash indicating the state at the end of \$B\$.</p>
</li>
<li>
<p>\$A_1,...,A_n\$ are arguments to be passed to the runtime entry.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>which executes the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>\$S_b larr "Set-State-At"(H_b(B))\$</p>
</li>
<li>
<p>\$A larr "Enc"_(SC)(A_1,...,A_n)\$</p>
</li>
<li>
<p>\$"Call-Runtime-Entry"(R_B,RE_B,F,A,A_(len))\$</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>In this section, we describe the details upon which the Polkadot Host is
interacting with the Runtime. In particular, \$"Set-State-At"\$ and
\$"Call-Runtime-Entry"\$ procedures called by the algorithm as defined in
<a href="#algo-runtime-interaction">Section 3.1.1</a> are explained in <a href="#defn-call-into-runtime">Definition 30</a> and
<a href="#defn-set-state-at">Definition 36</a> respectively. \$R_B\$ is the Runtime code loaded from
\$S_B\$, as described in <a href="#defn-runtime-code-at-state">Definition 29</a>, and \$RE_B\$ is
the Polkadot Host API, as described in <a href="#defn-host-api-at-state">Definition 163</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="sect-loading-runtime-code"><a class="link" href="#sect-loading-runtime-code">3.1.2. Loading the Runtime Code</a></h4>
<div class="paragraph">
<p>The Polkadot Host expects to receive the code for the Runtime of the
chain as a compiled WebAssembly (Wasm) Blob. The current runtime is
stored in the state database under the key represented as a byte array:</p>
</div>
<div class="stemblock">
<div class="content">
\$b := "3A,63,6F,64,65"\$
</div>
</div>
<div class="paragraph">
<p>which is the ASCII byte representation of the string <code>:code</code>
(<a href="#chapter-genesis">Chapter 12</a>). As a result of storing the Runtime as part of the state,
the Runtime code itself becomes state sensitive and calls to Runtime can change
the Runtime code itself. Therefore the Polkadot Host needs to always make sure
to provide the Runtime corresponding to the state in which the entry has been
called. Accordingly, we define \$R_B\$ (<a href="#defn-runtime-code-at-state">Definition 29</a>).</p>
</div>
<div class="paragraph">
<p>The initial Runtime code of the chain is provided as part of the genesis state
(<a href="#chapter-genesis">Chapter 12</a>) and subsequent calls to the Runtime have the ability to,
in turn, upgrade the Runtime by replacing this Wasm blob with the help of the
storage API (<a href="#sect-storage-api">Chapter 15</a>).</p>
</div>
<div id="defn-runtime-code-at-state" class="exampleblock">
<div class="title">Definition 29. <a href="#defn-runtime-code-at-state">Runtime Code at State</a></div>
<div class="content">
<div class="paragraph">
<p>By \$R_B\$, we refer to the Runtime code stored in the state storage at the
end of the execution of block \$B\$.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-code-executor"><a class="link" href="#sect-code-executor">3.1.3. Code Executor</a></h4>
<div class="paragraph">
<p>The Polkadot Host executes the calls of Runtime entries inside a Wasm
Virtual Machine (VM), which in turn provides the Runtime with access to
the Polkadot Host API. This part of the Polkadot Host is referred to as
the <em>Executor</em>.</p>
</div>
<div class="paragraph">
<p><a href="#defn-call-into-runtime">Definition 30</a> introduces the notation for calling the runtime entry
which is used whenever an algorithm of the Polkadot Host needs to access the
runtime.</p>
</div>
<div class="paragraph">
<p>It is acceptable behavior that the Runtime panics during execution of a
function in order to indicate an error. The Polkadot Host must be able
to catch that panic and recover from it.</p>
</div>
<div class="paragraph">
<p>In this section, we specify the general setup for an Executor that calls into
the Runtime. In <a href="#chap-runtime-api">Runtime API</a> we specify the parameters and return values
for each Runtime entry separately.</p>
</div>
<div id="defn-call-into-runtime" class="exampleblock">
<div class="title">Definition 30. <a href="#defn-call-into-runtime">Call Runtime Entry</a></div>
<div class="content">
<div class="paragraph">
<p>By</p>
</div>
<div class="stemblock">
<div class="content">
\$"Call-Runtime-Entry"(R,RE,"Runtime-Entry",A,A_len)\$
</div>
</div>
<div class="paragraph">
<p>we refer to the task using the executor to invoke the while passing an
\$A_1, ..., A_n\$ argument to it and using the encoding described in
<a href="#sect-runtime-send-args-to-runtime-enteries">Section 3.1.3.2</a>.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sect-memory-management"><a class="link" href="#sect-memory-management">3.1.3.1. Memory Management</a></h5>
<div class="paragraph">
<p>The Polkadot Host is responsible for managing the WASM heap memory starting at
the exported symbol as a part of implementing the allocator Host API
(<a href="#sect-allocator-api">Chapter 22</a>) and the same allocator should be used for any other
heap allocation to be used by the Polkadot Runtime.</p>
</div>
<div class="paragraph">
<p>The size of the provided WASM memory should be based on the value of the
storage key (an unsigned 64-bit integer), where each page has the size
of 64KB. This memory shoule be made available to the Polkadot Runtime
for import under the symbol name <code>memory</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="sect-runtime-send-args-to-runtime-enteries"><a class="link" href="#sect-runtime-send-args-to-runtime-enteries">3.1.3.2. Sending Data to a Runtime Entry</a></h5>
<div class="paragraph">
<p>In general, all data exchanged between the Polkadot Host and the Runtime is
encoded using SCALE codec described in <a href="#sect-scale-codec">Section 11.1</a>. Therefore all
runtime entries have the following identical Wasm function signatures:</p>
</div>
(func $runtime_entry (param $data i32) (param $len i32) (result i64))
<div class="paragraph">
<p>In each invocation of a Runtime entry, the argument(s) which are supposed to be
sent to the entry, need to be SCALE encoded into a byte array \$B\$
(<a href="#sect-scale-codec">Section 11.1</a>) and copied into a section of Wasm shared memory managed
by the shared allocator described in <a href="#sect-memory-management">Section 3.1.3.1</a>.</p>
</div>
<div class="paragraph">
<p>When the Wasm method , corresponding to the entry, is invoked, two
integers are passed as arguments. The first argument is set to the
memory adress of the byte array \$B\$ in Wasm memory. The
second argument sets the length of the encoded data stored in
\$B\$.</p>
</div>
</div>
<div class="sect4">
<h5 id="sect-runtime-return-value"><a class="link" href="#sect-runtime-return-value">3.1.3.3. Receiving Data from a Runtime Entry</a></h5>
<div class="paragraph">
<p>The value which is returned from the invocation is an integer,
representing two consecutive integers in which the least significant one
indicates the pointer to the offset of the result returned by the entry
encoded in SCALE codec in the memory buffer. The most significant one
provides the size of the blob.</p>
</div>
</div>
<div class="sect4">
<h5 id="sect-handling-runtime-state-update"><a class="link" href="#sect-handling-runtime-state-update">3.1.3.4. Handling Runtimes update to the State</a></h5>
<div class="paragraph">
<p>In order for the Runtime to carry on various tasks, it manipulates the current
state by means of executing calls to various Polkadot Host APIs
(<a href="#chap-host-api">Host API</a>). It is the duty of Host APIs to determine the context in
which these changes should persist. For example, if Polkdot Host needs to
validate a transaction using entry (<a href="#sect-rte-validate-transaction">Section 26.4.1</a>), it needs
to sandbox the changes to the state just for that Runtime call and prevent the
global state of the system from being influence by the call to such a Runtime
entry. This includes reverting the state of function calls which return errors
or panic.</p>
</div>
<div class="paragraph">
<p>As a rule of thumb, any state changes resulting from Runtime entries are not
persistant with the exception of state changes resulting from calling
<code>Core_execute_block</code> (<a href="#sect-rte-core-execute-block">Section 26.1.2</a>) while Polkadot Host is
importing a block (<a href="#sect-block-validation">Section 3.3.2</a>).</p>
</div>
<div class="paragraph">
<p>For more information on managing multiple variant of state see
<a href="#sect-managing-multiple-states">Section 3.3.4</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-extrinsics"><a class="link" href="#sect-extrinsics">3.2. Extrinsics</a></h3>
<div class="paragraph">
<p>The block body consists of an array of extrinsics. In a broad sense,
extrinsics are data from outside of the state which can trigger state
transitions. This section describes extrinsics and their inclusion into
blocks.</p>
</div>
<div class="sect3">
<h4 id="_preliminaries_2"><a class="link" href="#_preliminaries_2">3.2.1. Preliminaries</a></h4>
<div class="paragraph">
<p>The extrinsics are divided into two main categories defined as follows:</p>
</div>
<div class="paragraph">
<p><strong>Transaction extrinsics</strong> are extrinsics which are signed using either of the key
types (<a href="#sect-cryptographic-keys">Section 10.5</a>) and broadcasted between the nodes. <strong>Inherent
extrinsics</strong> are unsigned extrinsics which are generated by Polkadot Host and
only included in the blocks produced by the node itself. They are broadcasted as
part of the produced blocks rather than being gossiped as individual extrinsics.</p>
</div>
<div class="paragraph">
<p>The Polkadot Host does not specify or limit the internals of each extrinsics and
those are defined and dealt with by the Runtime (<a href="#defn-state-machine">Definition 1</a>). From the
Polkadot Host point of view, each extrinsics is simply a SCALE-encoded blob
(<a href="#sect-scale-codec">Section 11.1</a>).</p>
</div>
</div>
<div class="sect3">
<h4 id="_transactions"><a class="link" href="#_transactions">3.2.2. Transactions</a></h4>
<div class="paragraph">
<p>Transaction are submitted and exchanged through <em>Transactions</em> network messages
(<a href="#sect-msg-transactions">Section 4.8.5</a>). Upon receiving a Transactions message, the Polkadot
Host decodes the SCALE-encoded blob and splits it into individually
SCALE-encoded transactions.</p>
</div>
<div class="paragraph">
<p>Alternative transaction can be submitted to the host by offchain worker through
the Host API (<a href="#sect-ext-offchain-submit-transaction">Section 19.1.2</a>).</p>
</div>
<div class="paragraph">
<p>Any new transaction should be submitted to the Runtime
(<a href="#sect-rte-validate-transaction">Section 26.4.1</a>). This will allow the Polkadot Host to check
the validity of the received transaction against the current stat and if it
should be gossiped to other peers. If considers the submitted transaction as
valid, the Polkadot Host should store it for inclusion in future blocks. The
whole process of handeling new transactions is described in more detail by the
algorithm as defined in <a href="#algo-validate-transactions">Section 3.2.2.1</a>.</p>
</div>
<div class="paragraph">
<p>Additionally valid transactions that are supposed to be gossiped are
propagated to connected peers of the Polkadot Host. While doing so the
Polkadot Host should keep track of peers already aware of each
transaction. This includes peers which have already gossiped the
transaction to the node as well as those to whom the transaction has
already been sent. This behavior is mandated to avoid resending
duplicates and unnecessarily overloading the network. To that aim, the
Polkadot Host should keep a <em>transaction pool</em> and a <em>transaction queue</em>
defined as follows:</p>
</div>
<div id="defn-transaction-queue" class="exampleblock">
<div class="title">Definition 31. <a href="#defn-transaction-queue">Transaction Queue</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>Transaction Queue</strong> of a block producer node, formally referred to as
\$TQ\$ is a data structure which stores the transactions ready to be included
in a block sorted according to their priorities (<a href="#sect-msg-transactions">Section 4.8.5</a>). The
<strong>Transaction Pool</strong>, formally referred to as \$TP\$, is a hash table in which
the Polkadot Host keeps the list of all valid transactions not in the
transaction queue.</p>
</div>
<div class="paragraph">
<p>The algorithm as defined in <a href="#algo-validate-transactions">Section 3.2.2.1</a> updates the
transaction pool and the transaction queue according to the received message:</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="algo-validate-transactions"><a class="link" href="#algo-validate-transactions">3.2.2.1. Algorithm: Validate Transactions and Store</a></h5>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Algorithm: \$"Validate-Transactions-And-Store"(M_T)\$</p>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$M_T\$ is the transaction message.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>which executes the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>\$L larr "Dec"_SC(M_T)\$</p>
</li>
<li>
<p>\$"for " T " in " L " such that " E !in TQ " and " E !in TP:\$</p>
</li>
<li>
<p>\$"    " B_d larr "Head"("Longest-Chain"(BT))\$</p>
</li>
<li>
<p>\$"    " N larr H_n(B_d)\$</p>
</li>
<li>
<p>\$"    " R larr "Call-Runtime-Entry"(tt "TaggedTransactionQueue_validate_transaction", N, T)\$</p>
</li>
<li>
<p>\$"    " "if " R " indicates " E " is Valid:"\$</p>
</li>
<li>
<p>\$"    " "    " "if Requires"(R) sub uuu_(AAT in "TQ") "Provided-Tags"(T) uu uuu_(i&lt;d,AAT,T in B_i) "Provided-Tags"(T):\$</p>
</li>
<li>
<p>\$"    " "    " "    " "Insert-At"(TQ,T,"Requires"(R),"Priority"(R))\$</p>
</li>
<li>
<p>\$"    " "    " "else"\$</p>
</li>
<li>
<p>\$"    " "    " "    " "Add-To"(TP,T)\$</p>
</li>
<li>
<p>\$"    " "    " "Maintain-Transaction-Pool"\$</p>
</li>
<li>
<p>\$"    " "    " "if Should-Propagate"(R)\$</p>
</li>
<li>
<p>\$"    " "    " "    " "Propagate"(T)\$</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>in which</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$"Dec"_(SC)\$ decodes
the SCALE encoded message.</p>
</li>
<li>
<p>\$"Longest-Chain"\$ is defined in <a href="#defn-longest-chain">Definition 13</a>.</p>
</li>
<li>
<p>\$tt "TaggedTransactionQueue_validate_transaction"\$ is a Runtime entry
specified in <a href="#sect-rte-validate-transaction">Section 26.4.1</a> and \$Requires(R)\$,
\$Priority(R)\$ and \$Propagate(R)\$ refer to the corresponding fields in
the tuple returned by the entry when it deems that \$T\$ is valid.</p>
</li>
<li>
<p>\$"Provided-Tags"(T)\$ is the list of tags that transaction \$T\$
provides. The Polkadot Host needs to keep track of tags that transaction
\$T\$ provides as well as requires after validating it.</p>
</li>
<li>
<p>\$"Insert-At"(TQ,T,"Requires"(R),"Priority"(R))\$ places \$T\$
into \$TQ\$ approperietly such
that the transactions providing the tags which \$T\$ requires
or have higher priority than \$T\$ are ahead of
\$T\$.</p>
</li>
<li>
<p>\$"Maintain-Transaction-Pool"\$ is described in <a href="#algo-maintain-transaction-pool">Section 3.2.2.2</a>.</p>
</li>
<li>
<p>\$"ShouldPropagate"\$ indictes whether the transaction should be propagated
based on the <code>Propagate</code> field in the <code>ValidTransaction`</code> type as defined in
<a href="#defn-valid-transaction">Definition 186</a>, which is returned by \$tt
"TaggedTransactionQueue_validate_transaction"\$.</p>
</li>
<li>
<p>\$"Propagate"(T)\$ sends \$T\$ to all connected
peers of the Polkadot Host who are not already aware of \$T\$.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="algo-maintain-transaction-pool"><a class="link" href="#algo-maintain-transaction-pool">3.2.2.2. Algorithm: Maintain Transaction Pool</a></h5>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This has not been defined yet.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-inherents"><a class="link" href="#sect-inherents">3.2.3. Inherents</a></h4>
<div class="paragraph">
<p>Inherents are unsigned extrinsic inserted into a block by the block author and
as a result are not stored in the transaction pool or gossiped across the
network. Instead they are generated by the Polkadot Host by passing the required
inherent data, as listed in <a href="#tabl-inherent-data">Table 1</a>), to the Runtime method
\$tt "BlockBuilder_inherent_extrinsics"\$
(<a href="#defn-rt-builder-inherent-extrinsics">Section 26.3.3</a>). The then returned extrinsics should
be included in the current block as explained in <a href="#algo-build-block">Section 5.2.7.1</a>.</p>
</div>
<table id="tabl-inherent-data" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Inherent Data</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Identifier</th>
<th class="tableblock halign-left valign-top">Value Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">timstap0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unsigned 64-bit integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unix epoch time (<a href="#defn-unix-time">Definition 9</a>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uncles00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array of block headers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides a list of potential uncle block headers (<a href="#defn-block-header">Definition 32</a>) for a given block</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="defn-inherent-data"><a class="link" href="#defn-inherent-data">3.2.3.1. Definition: Inherent Data</a></h5>
<div class="paragraph">
<p><code>Inherent-Data</code> is a hashtable (<a href="#defn-scale-list">Definition 155</a>), an array of key-value
pairs consisting of the inherent 8-byte identifier and its value, representing
the totality of inherent extrinsics included in each block. The entries of this
hash table which are listed in <a href="#tabl-inherent-data">Table 1</a> are collected or generated
by the Polkadot Host and then handed to the Runtime for inclusion
(<a href="#algo-build-block">Section 5.2.7.1</a>).</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-state-replication"><a class="link" href="#sect-state-replication">3.3. State Replication</a></h3>
<div class="paragraph">
<p>Polkadot nodes replicate each other’s state by syncing the history of the
extrinsics. This, however, is only practical if a large set of transactions are
batched and synced at the time. The structure in which the transactions are
journaled and propagated is known as a block of extrinsics
(<a href="#sect-block-format">Section 3.3.1</a>). Like any other replicated state machines, state
inconsistency can occure between Polkadot replicas.
<a href="#sect-managing-multiple-states">Section 3.3.4</a> gives an overview of how a Polkadot Host
node manages multiple variants of the state.</p>
</div>
<div class="sect3">
<h4 id="sect-block-format"><a class="link" href="#sect-block-format">3.3.1. Block Format</a></h4>
<div class="paragraph">
<p>A Polkadot block consists a <em>block header</em> (<a href="#defn-block-header">Definition 32</a>) and a <em>block
body</em> (<a href="#defn-block-body">Definition 35</a>). The <em>block body</em> in turn is made up out of
<em>extrinsics</em> , which represent the generalization of the concept of
<em>transactions</em>. <em>Extrinsics</em> can contain any set of external data the underlying
chain wishes to validate and track.</p>
</div>
<div id="defn-block-header" class="exampleblock">
<div class="title">Definition 32. <a href="#defn-block-header">Block Header</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>header of block B</strong>, \$H_h(B)\$, is a 5-tuple containing the following
elements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>parent_hash:</strong> formally indicated as \$H_p\$, is the 32-byte Blake2b hash
(<a href="#sect-blake2">Section 10.2</a>) of the SCALE encoded parent block header
(<a href="#defn-block-header-hash">Definition 34</a>).</p>
</li>
<li>
<p><strong>number:</strong> formally indicated as \$H_i\$, is an integer, which represents
the index of the current block in the chain. It is equal to the number of the
ancestor blocks. The genesis state has number 0.</p>
</li>
<li>
<p><strong>state_root:</strong> formally indicated as \$H_r\$, is the root of the Merkle trie,
whose leaves implement the storage for the system.</p>
</li>
<li>
<p><strong>extrinsics_root:</strong> is the field which is reserved for the Runtime to validate
the integrity of the extrinsics composing the block body. For example, it can
hold the root hash of the Merkle trie which stores an ordered list of the
extrinsics being validated in this block. The <span class="sans-serif">extrinsics_root</span> is
set by the runtime and its value is opaque to the Polkadot Host. This element is
formally referred to as \$H_e\$.</p>
</li>
<li>
<p><strong>digest:</strong> this field is used to store any chain-specific auxiliary data, which
could help the light clients interact with the block without the need of
accessing the full storage as well as consensus-related data including the block
signature. This field is indicated as \$H_d\$ (<a href="#defn-digest">Definition 33</a>).</p>
</li>
</ul>
</div>
</div>
</div>
<div id="defn-digest" class="exampleblock">
<div class="title">Definition 33. <a href="#defn-digest">Header Digest</a></div>
<div class="content">
<div class="paragraph">
<p>The header <strong>digest</strong> of block \$B\$ formally referred to by \$H_d (B)\$ is
an array of <strong>digest items</strong> \$H_d^i\$’s, known as digest items of varying data
type (<a href="#defn-varrying-data-type">Definition 151</a>) such that:</p>
</div>
<div class="stemblock">
<div class="content">
\$H_d(B) := H_d^1, ..., H_d^n\$
</div>
</div>
<div class="paragraph">
<p>where each digest item can hold one of the following type identifiers:</p>
</div>
<div class="stemblock">
<div class="content">
\$H_d^n = {
	(0,m),
	(4,(E_("id"),"CM")),
	(5,(E_("id"),S_B)),
	(6,(E_("id"),P)),
	(8,phi)
	:}\$
</div>
</div>
<div class="paragraph">
<p>Where \$E_(id)\$ is the unique consensus engine identifier
(<a href="#defn-consensus-message-digest">Definition 59</a>) and \$bbb B\$:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Id <em>0</em>, the <strong>Non-System</strong> digest, which is opaque to the native code. \$m\$ is
an opaque byte array.</p>
</li>
<li>
<p>Id <em>4</em>, the <strong>Consensus Message</strong>, contains messages from the Runtime to the
consensus engine (<a href="#sect-consensus-message-digest">Section 5.1.2</a>).</p>
</li>
<li>
<p>Id <em>5</em>, the <strong>Seal</strong>, is the data produced by the consensus engine and proving
the authorship of the block producer. Respectively, \$S_B\$ is the signature
(<a href="#defn-block-signature">Definition 71</a>) of the block producer. In particular, the Seal digest
item must be the last item in the digest array and must be stripped off by the
Polkadot Host before the block is submitted to any Runtime function including
for validation. The Seal must be added back to the digest afterward.</p>
</li>
<li>
<p>Id <em>6</em>, the <strong>Pre-Runtime</strong> digest, contains the BABE Pre-Digest item
(<a href="#defn-babe-header">Definition 70</a>).</p>
</li>
<li>
<p>Id <em>8</em>, the <strong>Runtime Environment Updated</strong> digest, indicates that changes
regarding the Runtime code or heap pages (<a href="#sect-memory-management">Section 3.1.3.1</a>) occured.
No additional data is provided.</p>
</li>
</ul>
</div>
</div>
</div>
<div id="defn-block-header-hash" class="exampleblock">
<div class="title">Definition 34. <a href="#defn-block-header-hash">Header Hash</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>block header hash of block \$B\$</strong>, \$H_h(B)\$, is the hash of the
header of block \$B\$ encoded by simple codec:</p>
</div>
<div class="stemblock">
<div class="content">
\$H_h(B) := "Blake2b"("Enc"_(SC)("Head"(B)))\$
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sect-justified-block-header"><a class="link" href="#sect-justified-block-header">3.3.1.1. Justified Block Header</a></h5>
<div class="paragraph">
<p>The Justified Block Header is provided by the consensus engine and
presented to the Polkadot Host, for the block to be appended to the
blockchain. It contains the following parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>block_header</strong> the complete block header (<a href="#defn-block-header">Definition 32</a>) and denoted
by \$"Head"(B)\$.</p>
</li>
<li>
<p><strong>justification</strong>: as defined by the consensus specification indicated by
\$"Just"(B)\$ as defined in <a href="#defn-grandpa-justification">Definition 79</a>.</p>
</li>
<li>
<p><strong>authority Ids</strong>: This is the list of the Ids of authorities, which have voted
for the block to be stored and is formally referred to as \$A(B)\$. An
authority Id is 256-bit.</p>
</li>
</ul>
</div>
<div id="defn-block-body" class="exampleblock">
<div class="title">Definition 35. <a href="#defn-block-body">Block Body</a></div>
<div class="content">
<div class="paragraph">
<p>The block body consists of an sequence of extrinsics, each encoded as a byte
array. The content of an extrinsic is completely opaque to the Polkadot Host. As
such, from the point of the Polkadot Host, and is simply a SCALE encoded array
of byte arrays. The <strong>body of Block</strong> \$B\$ represented as \$"Body"(B)\$ is
defined to be:</p>
</div>
<div class="stemblock">
<div class="content">
\$"Body"(B) := "Enc"_(SC)(E_1,...,E_n)\$
</div>
</div>
<div class="paragraph">
<p>Where each \$E_i in bbb B\$ is a SCALE encoded extrinsic.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-block-validation"><a class="link" href="#sect-block-validation">3.3.2. Importing and Validating Block</a></h4>
<div class="paragraph">
<p>Block validation is the process by which a node asserts that a block is fit to
be added to the blockchain. This means that the block is consistent with the
current state of the system and transitions to a new valid state.</p>
</div>
<div class="paragraph">
<p>New blocks can be received by the Polkadot Host via other peers
(<a href="#sect-msg-block-request">Section 4.8.2</a>) or from the Host’s own consensus engine
(<a href="#sect-block-production">Section 5.2</a>). Both the Runtime and the Polkadot Host then need to
work together to assure block validity. A block is deemed valid if the block
author had authorship rights for the slot in which the block was produce as well
as if the transactions in the block constitute a valid transition of states. The
former criterion is validated by the Polkadot Host according to the block
production consensus protocol. The latter can be verified by the Polkadot Host
invoking entry into the Runtime as (<a href="#sect-rte-core-execute-block">Section 26.1.2</a>) as a part
of the validation process. Any state changes created by this function on
successful execution are persisted.</p>
</div>
<div class="paragraph">
<p>The Polkadot Host implements the Algorithm as defined in
<a href="#algo-import-and-validate-block">Section 3.3.3</a> to assure the validity of the block.</p>
</div>
</div>
<div class="sect3">
<h4 id="algo-import-and-validate-block"><a class="link" href="#algo-import-and-validate-block">3.3.3. Import and Validate Block</a></h4>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Algorithm: \$"Import-And-Validate-Block"(B, "Just"(B))\$</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>\$"Set-State-At"(P(B))\$</p>
</li>
<li>
<p>\$"if Just"(B) != 0\$</p>
</li>
<li>
<p>\$"    " "Verify-Block-Justification"(B, "Just"(B))\$</p>
</li>
<li>
<p>\$"    " "if " B " is Finalized and " P(B) " is not Finalized"\$</p>
</li>
<li>
<p>\$"    " "     " "Mark-As-Final"(P(B))\$</p>
</li>
<li>
<p>\$"if " H_p(B) !in "PBT"\$</p>
</li>
<li>
<p>\$"    " "return"\$</p>
</li>
<li>
<p>\$"Verify-Authorship-Right"("Head"(B))\$</p>
</li>
<li>
<p>\$B larr "Remove-Seal"(B)\$</p>
</li>
<li>
<p>\$R larr "Call-Runtime-Entry"(tt "Core_execute_block", B)\$</p>
</li>
<li>
<p>\$B larr "Add-Seal"(B)\$</p>
</li>
<li>
<p>\$"if " R = "true"\$</p>
</li>
<li>
<p>\$"    " "Persist-State"\$</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$"Remove-Seal"\$ removes the Seal digest from the block (<a href="#defn-digest">Definition 33</a>)
before submitting it to the Runtime.</p>
</li>
<li>
<p>\$"Add-Seal"\$ adds the Seal digest back to the block (<a href="#defn-digest">Definition 33</a>) for
later propagation.</p>
</li>
<li>
<p>\$"Persist-State"\$ implies the persistance of any state changes created by
\$tt "Core_execute_block"\$ (<a href="#sect-rte-core-execute-block">Section 26.1.2</a>) on successful
execution.</p>
</li>
<li>
<p>\$"PBT"\$ is the pruned block tree (<a href="#defn-block-tree">Definition 10</a>).</p>
</li>
<li>
<p>\$"Verify-Authorship-Right"\$ is part of the block production consensus
protocol and is described in <a href="#algo-verify-authorship-right">Section 5.2.6.1</a>.</p>
</li>
<li>
<p><em>Finalized block</em> and <em>finality</em> are defined in <a href="#sect-finality">Section 5.3</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-managing-multiple-states"><a class="link" href="#sect-managing-multiple-states">3.3.4. Managaing Multiple Variants of State</a></h4>
<div class="paragraph">
<p>Unless a node is committed to only update its state according to the finalized
block (<a href="#defn-finalized-block">Definition 88</a>), it is inevitable for the node to store
multiple variants of the state (one for each block). This is, for example,
necessary for nodes participating in the block production and finalization.</p>
</div>
<div class="paragraph">
<p>While the state trie structure (<a href="#sect-state-storage-trie-structure">Section 2.1.3</a>)
facilitates and optimizes storing and switching between multiple variants of the
state storage, the Polkadot Host does not specify how a node is required to
accomplish this task. Instead, the Polkadot Host is required to implement
\$"Set-State-At"\$ (<a href="#defn-set-state-at">Definition 36</a>):</p>
</div>
<div id="defn-set-state-at" class="exampleblock">
<div class="title">Definition 36. <a href="#defn-set-state-at">Set State At Block</a></div>
<div class="content">
<div class="paragraph">
<p>The function:</p>
</div>
<div class="stemblock">
<div class="content">
\$"Set-State-At"(B)\$
</div>
</div>
<div class="paragraph">
<p>in which \$B\$ is a block in the block tree (<a href="#defn-block-tree">Definition 10</a>), sets the
content of state storage equal to the resulting state of executing all
extrinsics contained in the branch of the block tree from genesis till block B
including those recorded in Block \$B\$.</p>
</div>
<div class="paragraph">
<p>For the definition of the state storage see <a href="#sect-state-storage">Section 2.1</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-changes-trie"><a class="link" href="#sect-changes-trie">3.3.5. Changes Trie</a></h4>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Changes Tries are still work-in-progress and are currently <strong>not</strong> used
in Polkadot. Additionally, the implementation of Changes Tries might change
considerably.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Polkadot focuses on light client friendliness and therefore implements
functionalities that allows identifying changes in the state of the blockchain
without the requirement to search through the entire chain. The <strong>Changes Trie</strong>
is a radix-16 tree data structure (<a href="#defn-radix-tree">Definition 3</a>) and maintained by the
Polkadot Host. It stores different types of storage changes made by each
individual block separately.</p>
</div>
<div class="paragraph">
<p>The primary method for generating the Changes Trie is provided to the Runtime
with the Host API (<a href="#sect-ext-storage-changes-root">Section 15.1.9</a>). The Runtime calls that
function shortly before finalizing the block, the Polkadot Host must then
generate the Changes Trie based on the storage changes which occured during
block production or execution. In order to provide this API function, it is
imperative that the Polkadot Host implements a mechanism to keep track of the
changes created by individual blocks, as mentioned in <a href="#sect-state-storage">Section 2.1</a> and
<a href="#sect-managing-multiple-states">Section 3.3.4</a>. The Changes Trie stores three different types
of changes.</p>
</div>
<div class="paragraph">
<p>The Changes Trie itself is not part of the block, but a separately maintained
database by the Polkadot Host. The Merkle proof of the Changes Trie must be
included in the block digest (<a href="#defn-digest">Definition 33</a>) and gets calculated as described
in <a href="#sect-merkl-proof">Section 2.1.4</a>. The root calculation only considers pairs which were
generated on the individual block and does not consider pairs which were
generated at previous blocks.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This seperately maintained database by the Polkadot Host is
intended to be used by "proof servers", where its implementation and behavior
has not been fully defined yet. This is considered future-reserved
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As clarified in the individual sections of each type, not all of those types get
generated on every block. But if conditions apply, all those different types of
pairs get inserted into the same Changes Trie, therefore only one Changes Trie
Root gets generated for each block.</p>
</div>
<div id="defn-change-trie-insert" class="exampleblock">
<div class="title">Definition 37. <a href="#defn-change-trie-insert">Inserted Key-Value Pairs</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>inserted key-value pair stored in the nodes of Changes Trie</strong> is
formally defined as:</p>
</div>
<div class="stemblock">
<div class="content">
\$(K_C, V_C)\$
</div>
</div>
<div class="paragraph">
<p>Where \$K_C\$ is a SCALE-encoded tuple:</p>
</div>
<div class="stemblock">
<div class="content">
\$"Enc"_(SC)("Type"_(V_C), H_i(B_i),K)\$
</div>
</div>
<div class="paragraph">
<p>and</p>
</div>
<div class="stemblock">
<div class="content">
\$V_C = "Enc"_(SC)(C_(value))\$
</div>
</div>
<div class="paragraph">
<p>is a SCALE encoded byte array.</p>
</div>
<div class="paragraph">
<p>Furthermore, \$K\$ represents the changed storage key, \$H_i(B_i)\$ refers
to the block number at which this key is inserted into the Changes Trie
(<a href="#defn-block-header">Definition 32</a>) and \$"Type"_(V_C)\$ is an index defining the type
\$C_(value)\$ according to:</p>
</div>
<div class="stemblock">
<div class="content">
\$C_(value) = {(1,(e_i,...,e_k)),(2,(H_i(B_k),...,H_i(B_m))),(3,H_r("Child-Changes-Trie")):}\$
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>1</em> is a list of extrinsics indices and \$e_n\$ refers to the index of the extrinsic within the block.</p>
</li>
<li>
<p><em>2</em> is a list of block numbers.</p>
</li>
<li>
<p><em>3</em> is the child changes trie.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sect-changes-trie-extrinsics-pairs"><a class="link" href="#sect-changes-trie-extrinsics-pairs">3.3.5.1. Key to extrinsics pairs</a></h5>
<div class="paragraph">
<p>This key-value pair stores changes which occurred in an individual block. Its
value is a SCALE encoded array containing the indices of the extrinsics that
caused any changes to the specified key. The key-value pair is defined as
(clarified in <a href="#sect-changes-trie">Section 3.3.5</a>):</p>
</div>
<div class="stemblock">
<div class="content">
\$(1, H_i (B_i), K) -&gt; (e_i, ..., e_k)\$
</div>
</div>
<div class="paragraph">
<p>The indices are unsigned 32-bit integers and their values are based on the order
in which each extrinsics appears in the block (indexing starts at 0). The
Polkadot Host generates those pairs for every changed key on each and every
block. Child storages have their own Changes Trie
(<a href="#sect-changes-trie-child-trie-pair">Section 3.3.5.3</a>).</p>
</div>
</div>
<div class="sect4">
<h5 id="sect-changes-trie-block-pairs"><a class="link" href="#sect-changes-trie-block-pairs">3.3.5.2. Key to block pairs</a></h5>
<div class="paragraph">
<p>This key-value pair stores changes which occurred in a certain range of blocks.
Its value is a SCALE encoded array containing block numbers in which extrinsics
caused any changes to the specified key. The key-value pair is defined as
(clarified in section <a href="#sect-changes-trie">Section 3.3.5</a>):</p>
</div>
<div class="stemblock">
<div class="content">
\$(2, H_i (B_i), K) -&gt; (H_i (B_k), ..., H_i (B_m))\$
</div>
</div>
<div class="paragraph">
<p>The block numbers are represented as unsigned 32-bit integers. There are
multiple "levels" of those pairs, and the Polkadot Host does <strong>not</strong> generate
those pairs on every block. The genesis state contains the key <code>:changes_trie</code>
where its unsigned 64-bit value is a tuple of two 32-bit integers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>interval</strong> - The interval (in blocks) at which those pairs should be created.
If this value is less or equal to 1 it means that those pairs are not created at
all.</p>
</li>
<li>
<p><strong>levels</strong> - The maximum number of "levels" in the hierarchy. If this value is
0 it means that those pairs are not created at all.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For each level from 1 to <em>levels</em>, the Polkadot Host creates those pairs on
every -nth block.</p>
</div>
<div class="paragraph">
<p>For example, let’s say <em>interval</em> is set at and is set at . This means there are
now three levels which get generated at three different occurrences:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Level 1</strong> - Those pairs are generated at every \$4^1\$-nth block, where the
pair value contains the block numbers of every block that changed the specified
storage key. This level only considers block numbers of the last four
(\$4^1\$) blocks.</p>
<div class="ulist">
<ul>
<li>
<p>Example: this level occurs at block 4, 8, 12, 16, 32, etc.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Level 2</strong> - Those pairs are generated at every \$4^2\$-nth block, where the
pair value contains the block numbers of every block that changed the specified
storage key. This level only considers block numbers of the last 16
(\$4^2\$) blocks.</p>
<div class="ulist">
<ul>
<li>
<p>Example: this level occurs at block 16, 32, 64, 128, 256, etc.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Level 3</strong> - Those pairs are generated at every \$4^3\$-nth block, where the
pair value contains the block numbers of every block that changed the specified
storage key. this level only considers block number of the last 64
(\$4^3\$) blocks.</p>
<div class="ulist">
<ul>
<li>
<p>Example: this level occurs at block 64, 128, 196, 256, 320, etc.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="sect-changes-trie-child-trie-pair"><a class="link" href="#sect-changes-trie-child-trie-pair">3.3.5.3. Key to Child Changes Trie pairs</a></h5>
<div class="paragraph">
<p>The Polkadot Host generates a separate Changes Trie for each child storage,
using the same behavior and implementation as describe in
<a href="#sect-changes-trie-extrinsics-pairs">Section 3.3.5.1</a>. Additionally, the changed child storage
key gets inserted into the primary, non-Child Changes Trie where its value is a
SCALE encoded byte array containing the Merkle root of the Child Changes Trie.
The key-value pair is defined as:</p>
</div>
<div class="stemblock">
<div class="content">
\$(3,H_i(B_i),K) -&gt; H_r("Child-Changes-Trie")\$
</div>
</div>
<div class="paragraph">
<p>The Polkadot Host creates those pairs for every changes child key for each and
every block.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chap-networking"><a class="link" href="#chap-networking">4. Networking</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter in its current form is incomplete and considered work in progress.
Authors appreciate receiving request for clarification or any reports regarding
deviation from the current Polkadot network protocol. This can be done through
filing an issue in <a href="https://github.com/w3f/polkadot-spec">Polkadot Specification
repository</a>.</p>
</div>
<div class="sect2">
<h3 id="_introduction"><a class="link" href="#_introduction">4.1. Introduction</a></h3>
<div class="paragraph">
<p>The Polkadot network is decentralized and does not rely on any central authority
or entity for achieving its fullest potential of provided functionality. The
networking protocol is based on a family of open protocols, including protocol
implemented <em>libp2p</em> e.g. the distributed Kademlia hash table which is used for
peer discovery.</p>
</div>
<div class="paragraph">
<p>This chapter walks through the behaviour of the networking implementation of the
Polkadot Host and defines the network messages. The implementation details of
the <em>libp2p</em> protocols used are specified in external sources as described in
<a href="#sect-networking-external-docs">Section 4.2</a></p>
</div>
</div>
<div class="sect2">
<h3 id="sect-networking-external-docs"><a class="link" href="#sect-networking-external-docs">4.2. External Documentation</a></h3>
<div class="paragraph">
<p>Complete specification of the Polkadot networking protocol relies on the
following external protocols:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/libp2p/specs">libp2p</a> - <em>libp2p</em> is a modular peer-to-peer
networking stack composed of many modules and different parts. includes the
multiplexing protocols and .</p>
</li>
<li>
<p><a href="https://docs.libp2p.io/concepts/addressing/">libp2p addressing</a> - The Polkadot
Host uses the <em>libp2p</em> addressing system to identify and connect to peers.</p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Kademlia">Kademlia</a> - <em>Kademlia</em> is a distributed
hash table for decentralized peer-to-peer networks. The Polkadot Host uses
Kademlia for peer discovery.</p>
</li>
<li>
<p><a href="https://noiseprotocol.org/">Noise</a> - The <em>Noise</em> protocol is a framework for
building cryptographic protocols. The Polkadot Host uses Noise to establish the
encryption layer to remote peers.</p>
</li>
<li>
<p><a href="https://docs.libp2p.io/concepts/stream-multiplexing/#mplex">mplex</a> - <em>mplex</em> is
a multiplexing protocol developed by <em>libp2p</em>. The protocol allows dividing a
connection to a peer into multiple substreams, each substream serving a specific
purpose. Generally, Polkadot Host implementers are encouraged to prioritize
implementing , since it is the de-facto standard in Polkadot.<em>mplex</em> is only
required to communicate with <a href="https://github.com/libp2p/js-libp2p">js-lip2p</a>.</p>
</li>
<li>
<p><a href="https://docs.libp2p.io/concepts/stream-multiplexing/#yamux">yamux</a> - <em>yamux</em> is
a multiplexing protocol like <em>mplex</em> and developed by HashiCorp. It is the
de-facto standard for the Polkadot Host. This protocol should be prioritized
over <em>mplex</em>. <a href="#sect-protocols-substreams">Section 4.7</a> describes the subprotocol in more
detail.</p>
</li>
<li>
<p><a href="https://developers.google.com/protocol-buffers/docs/reference/proto3-spec">Protocol
Buffers</a> - Protocol Buffers is a language-neutral, platform-neutral mechanism
for serializing structured data and is developed by Google. The Polkadot Host
uses Protocol Buffers to serialize specific messages, as clarified in
<a href="#sect-network-messages">Section 4.8</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_node_identities"><a class="link" href="#_node_identities">4.3. Node Identities</a></h3>
<div class="paragraph">
<p>Each Polkadot Host node maintains an ED25519 key pair which is used to
identify the node. The public key is shared with the rest of the network
allowing the nodes to establish secure communication channels.</p>
</div>
<div class="paragraph">
<p>Each node must have its own unique ED25519 key pair. When two or more nodes use
the same key, the network will interpret those nodes as a single node, which
will result in undefined behaviour and can result in equivocation. Furthermore,
the node’s <em>PeerId</em> as defined in <a href="#defn-peer-id">Definition 38</a> is derived from its public
key. <em>PeerId</em> is used to identify each node when they are discovered in the
course of the discovery mechanism described in <a href="#sect-discovery-mechanism">Section 4.4</a>.</p>
</div>
<div id="defn-peer-id" class="exampleblock">
<div class="title">Definition 38. <a href="#defn-peer-id">PeerId</a></div>
<div class="content">
<div class="paragraph">
<p>The Polkadot node’s <em>PeerId</em>, formally referred to as \$P_(id)\$, is derived
from the ED25519 public key and is structured as defined in the
<a href="https://docs.libp2p.io/concepts/peer-id/">libp2p specification</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-discovery-mechanism"><a class="link" href="#sect-discovery-mechanism">4.4. Discovery mechanism</a></h3>
<div class="paragraph">
<p>The Polkadot Host uses various mechanisms to find peers within the
network, to establish and maintain a list of peers and to share that
list with other peers from the network as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Bootstrap nodes</strong> are hard-coded node identities and addresses provided by the
genesis state (<a href="#chapter-genesis">Chapter 12</a>).</p>
</li>
<li>
<p><strong>mDNS</strong> is a protocol that performs a broadcast to the local network. Nodes
that might be listening can respond to the broadcast.
<a href="https://github.com/libp2p/specs/blob/master/discovery/mdns.md">The libp2p mDNS
specification</a> defines this process in more detail. This protocol is an optional
implementation detail for Polkadot Host implementers and is not required to
participate in the Polkadot network.</p>
</li>
<li>
<p><strong>Kademlia requests</strong> invoking Kademlia requests, where nodes respond with their
list of available peers. Kademlia requests are performed on a specific substream
as described in <a href="#sect-protocols-substreams">Section 4.7</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="sect-connection-establishment"><a class="link" href="#sect-connection-establishment">4.5. Connection establishment</a></h3>
<div class="paragraph">
<p>Polkadot nodes connect to peers by establishing a TCP connection. Once
established, the node initiates a handshake with the remote peers on the
encryption layer. An additional layer on top of the encryption layer, known as
the multiplexing layer, allows a connection to be split into substreams, as
described by the
<a href="https://docs.libp2p.io/concepts/stream-multiplexing/#yamux">yamux specification</a>,
either by the local or remote node.</p>
</div>
<div class="paragraph">
<p>The Polkadot node supports two types of substream protocols.
<a href="#sect-protocols-substreams">Section 4.7</a> describes the usage of each type in more detail:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Request-Response substreams</strong>: After the protocol is negotiated by the
multiplexing layer, the initiator sends a single message containing a request.
The responder then sends a response, after which the substream is then
immediately closed. The requests and responses are prefixed with their
<a href="https://en.wikipedia.org/wiki/LEB128">LEB128</a> encoded length.</p>
</li>
<li>
<p><strong>Notification substreams</strong>. After the protocol is negotiated, the initiator
sends a single handshake message. The responder can then either accept the
substream by sending its own handshake or reject it by closing the substream.
After the substream has been accepted, the initiator can send an unbound number
of individual messages. The responder keeps its sending side of the substream
open, despite not sending anything anymore, and can later close it in order to
signal to the initiator that it no longer wishes to communicate.</p>
<div class="paragraph">
<p>Handshakes and messages are prefixed with their
<a href="https://en.wikipedia.org/wiki/LEB128">LEB128</a> encoded lengths. A handshake can be
empty, in which case the length prefix would be <em>0</em>.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Connections are established by using the following protocols:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>/noise</code> - a protocol that is announced when a connection to a peer is
established.</p>
</li>
<li>
<p><code>/multistream/1.0.0</code> - a protocol that is announced when negotiating an
encryption protocol or a substream.</p>
</li>
<li>
<p><code>/yamux/1.0.0</code> - a protocol used during the <em>mplex</em> or <em>yamux</em> negotiation.
See <a href="#sect-protocols-substreams">Section 4.7</a> for more information.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Polkadot Host can establish a connection with any peer of which it
knows the address. The Polkadot Host supports multiple networking
protocols:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>TCP/IP</strong> with addresses in the form of <code>/ip4/1.2.3.4/tcp/</code> to establish a TCP
connection and negotiate encryption and a multiplexing layer.</p>
</li>
<li>
<p><strong>Websockets</strong> with addresses in the form of <code>/ip4/1.2.3.4/ws/</code> to establish a
TCP connection and negotiate the Websocket protocol within the connection.
Additionally, encryption and multiplexing layer is negotiated within the
WebSocket connection.</p>
</li>
<li>
<p><strong>DNS</strong> addresses in form of <code>/dns/example.com/tcp/</code> and <code>/dns/example.com/ws/</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The addressing system is described in the
<a href="https://docs.libp2p.io/concepts/addressing/">libp2p addressing</a> specification.
After a base-layer protocol is established, the Polkadot Host will apply the
Noise protocol to establish the encryption layer as described in
<a href="#sect-encryption-layer">Section 4.6</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="sect-encryption-layer"><a class="link" href="#sect-encryption-layer">4.6. Encryption Layer</a></h3>
<div class="paragraph">
<p>Polkadot protocol uses the <em>libp2p</em> Noise framework to build an encryption
protocol. The Noise protocol is a framework for building encryption protocols.
<em>libp2p</em> utilizes that protocol for establishing encrypted communication
channels. Refer to the <a href="https://github.com/libp2p/specs/tree/master/noise">libp2p
Secure Channel Handshake</a> specification for a detailed description.</p>
</div>
<div class="paragraph">
<p>Polkadot nodes use the <a href="https://noiseexplorer.com/patterns/XX/">XX handshake
pattern</a> to establish a connection between peers. The three following steps are
required to complete the handshake process:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The initiator generates a keypair and sends the public key to the responder.
The <a href="https://github.com/libp2p/specs/tree/master/noise">Noise specification</a> and
the <a href="https://github.com/libp2p/specs/blob/master/peer-ids/peer-ids.md">libp2p
PeerId specification</a> describe keypairs in more detail.</p>
</li>
<li>
<p>The responder generates its own key pair and sends its public key back to the
initiator. After that, the responder derives a shared secret and uses it to
encrypt all further communication. The responder now sends its static Noise
public key (which may change anytime and does not need to be persisted on disk),
its <em>libp2p</em> public key and a signature of the static Noise public key signed
with the <em>libp2p</em> public key.</p>
</li>
<li>
<p>The initiator derives a shared secret and uses it to encrypt all further
communication. It also sends its static Noise public key, <em>libp2p</em> public key
and signature to the responder.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>After these three steps, both the initiator and responder derive a new shared
secret using the static and session-defined Noise keys, which are used to
encrypt all further communication.</p>
</div>
</div>
<div class="sect2">
<h3 id="sect-protocols-substreams"><a class="link" href="#sect-protocols-substreams">4.7. Protocols and Substreams</a></h3>
<div class="paragraph">
<p>After the node establishes a connection with a peer, the use of multiplexing
allows the Polkadot Host to open substreams. <em>libp2p</em> uses the
<a href="https://docs.libp2p.io/concepts/stream-multiplexing/#mplex"><em>mplex protocol</em></a> or
the <a href="https://docs.libp2p.io/concepts/stream-multiplexing/#yamux"><em>yamux protocol</em></a>
to manage substreams and to allow the negotiation of <em>application-specific
protocols</em>, where each protocol serves a specific utility.</p>
</div>
<div class="paragraph">
<p>The Polkadot Host uses multiple substreams whose usage depends on a specific
purpose. Each substream is either a <em>Request-Response substream</em> or a
<em>Notification substream</em>, as described in
<a href="#sect-connection-establishment">Section 4.5</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>/ipfs/ping/</code> - Open a standardized substream <em>libp2p</em> to a peer and
initialize a ping to verify if a connection is still alive. If the peer does not
respond, the connection is dropped. This is a <em>Request-Response substream</em>.</p>
<div class="paragraph">
<p>Further specification and reference implementation are available in the
<a href="https://docs.libp2p.io/concepts/protocols/#ping">libp2p documentation</a>.</p>
</div>
</li>
<li>
<p><code>/ipfs/id/1.0.0</code> - Open a standardized <em>libp2p</em> substream to a peer to ask for
information about that peer. This is a <em>Request-Response substream</em>.</p>
<div class="paragraph">
<p>Further specification and reference implementation are available in the
<a href="https://docs.libp2p.io/concepts/protocols/#ping">libp2p documentation</a>.</p>
</div>
</li>
<li>
<p><code>/dot/kad</code> - Open a standardized substream for Kademlia <code>FIND_NODE</code> requests.
This is a <em>Request-Response substream</em>, as defined by the <em>libp2p</em> standard.</p>
<div class="paragraph">
<p>Further specification and reference implementation are available on
<a href="https://en.wikipedia.org/wiki/Kademlia">Wikipedia</a> respectively the
<a href="https://github.com/libp2p/go-libp2p-kad-dht">golang Github repository</a>.</p>
</div>
</li>
<li>
<p><code>/dot/light/2</code> - a request and response protocol that allows a light client to
request information about the state. This is a <em>Request-Response substream</em>.</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Light client messages are currently not documented.
</td>
</tr>
</table>
</div>
</li>
<li>
<p><code>/dot/block-announces/1</code> - a substream/notification protocol which sends
blocks to connected peers. This is a <em>Notification substream</em>.</p>
<div class="paragraph">
<p>The messages are specified in <a href="#sect-msg-block-announce">Section 4.8.1</a>.</p>
</div>
</li>
<li>
<p><code>/dot/sync/2</code> - a request and response protocol that allows the Polkadot Host
to request information about blocks. This is a <em>Request-Response substream</em>.</p>
<div class="paragraph">
<p>The messages are specified in <a href="#sect-msg-block-request">Section 4.8.2</a>.</p>
</div>
</li>
<li>
<p><code>/dot/sync/warp</code> - a request and response protocol that allows the Polkadot Host
to perform a warp sync request. This is a <em>Request-Response substream</em>.</p>
<div class="paragraph">
<p>The messages are specified in <a href="#sect-warp-sync">Section 4.9.3</a>.</p>
</div>
</li>
<li>
<p><code>/dot/transactions/1</code> - a substream/notification protocol which sends
transactions to connected peers. This is a <em>Notification substream</em>.</p>
<div class="paragraph">
<p>The messages are specified in <a href="#sect-msg-transactions">Section 4.8.5</a>.</p>
</div>
</li>
<li>
<p><code>/paritytech/grandpa/1</code> - a substream/notification protocol that sends GRANDPA
votes to connected peers. This is a <em>Notification substream</em>.</p>
<div class="paragraph">
<p>The messages are specified in <a href="#sect-msg-grandpa">Section 4.8.6</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This substream will change in the future. See
<a href="https://github.com/paritytech/substrate/issues/7252">issue #7252</a>. *
<code>/paritytech/beefy/1</code> - a substream/notification protocol which sends signed
BEEFY statements, as described in <a href="#sect-grandpa-beefy">Section 5.5</a>, to connected peers.
This is a <em>Notification</em> substream.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The messages are specified in <a href="#sect-msg-grandpa-beefy">Section 4.8.7</a>.</p>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The prefixes on those substreams are known as protocol
identifiers and are used to segregate communications to specific
networks. This prevents any interference with other networks. is used
exclusively for Polkadot. Kusama, for example, uses the protocol
identifier.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="sect-network-messages"><a class="link" href="#sect-network-messages">4.8. Network Messages</a></h3>
<div class="paragraph">
<p>The Polkadot Host must actively communicate with the network in order to
participate in the validation process or act as a full node.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Polkadot network originally only used SCALE encoding for all message
formats. Meanwhile, Protobuf has been adopted for certain messages. The encoding
of each listed message is always SCALE encoded unless Protobuf is explicitly
mentioned. Encoding and message formats are subject to change.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="sect-msg-block-announce"><a class="link" href="#sect-msg-block-announce">4.8.1. Announcing blocks</a></h4>
<div class="paragraph">
<p>When the node creates or receives a new block, it must be announced to the
network. Other nodes within the network will track this announcement and can
request information about this block. The mechanism for tracking announcements
and requesting the required data is implementation-specific.</p>
</div>
<div class="paragraph">
<p>Block announcements, requests and responses are sent over the substream as
described in <a href="#defn-block-announce-handshake">Definition 39</a>.</p>
</div>
<div id="defn-block-announce-handshake" class="exampleblock">
<div class="title">Definition 39. <a href="#defn-block-announce-handshake">Block Announce Handshake</a></div>
<div class="content">
<div class="paragraph">
<p>The <code>BlockAnnounceHandshake</code> initializes a substream to a remote peer. Once
established, all <code>BlockAnounce</code> messages (<a href="#defn-block-announce">Definition 40</a>) created by
the node are sent to the <code>/dot/block-announces/1</code> substream.</p>
</div>
<div class="paragraph">
<p>The <code>BlockAnnounceHandshake</code> is a structure of the following
format:</p>
</div>
<div class="stemblock">
<div class="content">
\$BA_h = "Enc"_("SC")(R, N_B, h_B, h_G)\$
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="stemblock">
<div class="content">
\$R = {(1,"The node is a full node"),(2,"The node is a light client"),(4,"The node is a validator"):}\$
\$N_B = "Best block number according to the node"\$
\$h_B = "Best block hash according to the node"\$
\$h_G = "Genesis block hash according to the node"\$
</div>
</div>
</div>
</div>
<div id="defn-block-announce" class="exampleblock">
<div class="title">Definition 40. <a href="#defn-block-announce">Block Announce</a></div>
<div class="content">
<div class="paragraph">
<p>The <code>BlockAnnounce</code> message is sent to the specified substream and indicates to
remote peers that the node has either created or received a new block.</p>
</div>
<div class="paragraph">
<p>The message is a structure of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$BA = "Enc"_("SC")("Head"(B),b)\$
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="stemblock">
<div class="content">
\$"Head"(B) = "Header of the announced block"\$
\$b = {(0,"Is not part of the best chain"),(1,"Is the best block according to the node"):}\$
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-msg-block-request"><a class="link" href="#sect-msg-block-request">4.8.2. Requesting Blocks</a></h4>
<div class="paragraph">
<p>Block requests can be used to retrieve a range of blocks from peers. Those
messages are sent over the <code>/dot/sync/2</code> substream.</p>
</div>
<div id="defn-msg-block-request" class="exampleblock">
<div class="title">Definition 41. <a href="#defn-msg-block-request">Block Request</a></div>
<div class="content">
<div class="paragraph">
<p>The <code>BlockRequest</code> message is a Protobuf serialized structure of the following format:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 12.5%;">
<col style="width: 50%;">
<col style="width: 12.5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Id</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uint32</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bits of block data to request</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\$B_f\$</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>oneof</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Start from this block</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\$B_S\$</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bytes`</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">End at this block (<em>optional</em>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\$B_e\$</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Direction</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sequence direction</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>uint32</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum amount (<em>optional</em>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">\$B_m\$</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$B_f\$ indicates all the fields that should be included in the request.
its <strong>big-endian</strong> encoded bitmask that applies to all desired fields with bitwise
OR operations. For example, the \$B_f\$ value to request <em>Header</em> and
<em>Justification</em> is <em>0001 0001</em> (17).</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Header</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0000 0001</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Body</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0000 0010</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Justification</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0001 0000</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>\$B_s\$ is a Protobuf structure indicating a varying data
type of the following values:</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Id</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bytes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The block hash</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bytes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The block number</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>\$B_e\$ is either the block hash or block number depending
on the value of \$B_s\$. an implementation-defined maximum is
used when unspecified.</p>
</li>
<li>
<p><em>Direction</em> is a Protobuf structure indicating the sequence direction of the
requested blocks. The structure is a varying data type
(<a href="#defn-varrying-data-type">Definition 151</a>) of the following format:</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Id</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enumerate in ascending order (from child to parent)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enumerate in descending order (from parent to canonical child)</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>\$B_m\$ is the number of blocks to be returned. An implementation defined
maximum is used when unspecified.</p>
</li>
</ul>
</div>
</div>
</div>
<div id="defn-msg-block-response" class="exampleblock">
<div class="title">Definition 42. <a href="#defn-msg-block-response">Block Response</a></div>
<div class="content">
<div class="paragraph">
<p>The <code>BlockResponse</code> message is received after sending a <code>BlockRequest</code> message
to a peer. The message is a Protobuf serialized structure of the following
format:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 11.1111%;">
<col style="width: 55.5556%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Id</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Repeated <em>BlockData</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Block data for the requested sequence</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>where <em>BlockData</em> is a Protobuf structure containing the requested blocks. Do
note that the optional values are either present or absent depending on the
requested fields (bitmask value). The structure has the following format:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 18.1818%;">
<col style="width: 9.0909%;">
<col style="width: 45.4545%;">
<col style="width: 27.2728%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Id</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bytes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Block header hash</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#defn-block-header-hash">Definition 34</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bytes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Block header (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#defn-block-header">Definition 32</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">repeated <code>bytes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Block body (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#defn-block-body">Definition 35</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bytes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Block receipt (optional)</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bytes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Block message queue (optional)</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bytes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Justification (optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#defn-grandpa-justification">Definition 79</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bool</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates whether the justification is empty (i.e. should be ignored)</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-msg-state-request"><a class="link" href="#sect-msg-state-request">4.8.3. Requesting States</a></h4>
<div class="paragraph">
<p>The Polkadot Host can request the state in form of a key/value list at a
specified block.</p>
</div>
<div class="paragraph">
<p>When receiving state entries from the state response messages
(<a href="#defn-msg-state-response">Definition 44</a>), the node can verify the entries with the entry
proof (id <em>1</em> in <em>KeyValueStorage</em>) against the merkle root in the block header
(of the block specified in <a href="#defn-msg-state-request">Definition 43</a>). Once the state response
message claims that all entries have been sent (id <em>3</em> in <em>KeyValueStorage</em>),
the node can use all collected entry proofs and validate it against the merkel
root to confirm that claim.</p>
</div>
<div class="paragraph">
<p>See the the synchronization section for more information (<a href="#sect-network-sync">Section 4.9</a>).</p>
</div>
<div id="defn-msg-state-request" class="exampleblock">
<div class="title">Definition 43. <a href="#defn-msg-state-request">State Request</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>state request</strong> is sent to a peer to request the state at a specified block.
The message is a single 32-byte Blake2 hash which indicates the block from which
the sync should start.</p>
</div>
<div class="paragraph">
<p>Depending on what substream is used, he remote peer either sends back a state
response (<a href="#defn-msg-state-response">Definition 44</a>) on the <code>/dot/sync/2</code> substream or a warp
sync proof (<a href="#defn-warp-sync-proof">Definition 45</a>) on the <code>/dot/sync/warp</code>.</p>
</div>
</div>
</div>
<div id="defn-msg-state-response" class="exampleblock">
<div class="title">Definition 44. <a href="#defn-msg-state-response">State Response</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>state response</strong> is sent to the peer that initialized the state request
(<a href="#defn-msg-state-request">Definition 43</a>) and contains a list of key/value entries with an
associated proof. This response is sent continuously until all key/value pairs
have been submitted.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 14.2857%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Id</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>repeated KeyValueStateEntry</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">State entries</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bytes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">State proof</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>where <em>KeyValueStateEntry</em> is of the following format:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 14.2857%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Id</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bytes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Root of the entry, empty if top level</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>repeated StateEntry</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Collection of key/values</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bool</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Equal 'true' if there are no more keys to return.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>and <em>StateEntry</em>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 14.2857%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Id</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bytes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The key of the entry</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bytes</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value of the entry</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-msg-warp-sync"><a class="link" href="#sect-msg-warp-sync">4.8.4. Warp Sync</a></h4>
<div class="paragraph">
<p>The warp sync protocols allows nodes to retrieve blocks from remote peers where
authority set changes occured. This can be used to speed up synchronization to
the latest state.</p>
</div>
<div class="paragraph">
<p>See the the synchronization section for more information (<a href="#sect-network-sync">Section 4.9</a>).</p>
</div>
<div id="defn-warp-sync-proof" class="exampleblock">
<div class="title">Definition 45. <a href="#defn-warp-sync-proof">Warp Sync Proof</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>warp sync proof</strong> message, \$P\$, is sent to the peer that initialized
the state request (<a href="#defn-msg-state-request">Definition 43</a>) on the <code>/dot/sync/warp</code> substream
and contains accumulated proof of multiple authority set changes
(<a href="#sect-consensus-message-digest">Section 5.1.2</a>). It&#8217;s a datastructure of the following
format:</p>
</div>
<div class="stemblock">
<div class="content">
\$P = (f_x...f_y, c)\$
</div>
</div>
<div class="paragraph">
<p>\$f_x...f_y\$ is an array consisting of warp sync fragments of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$f_x = (B_h, J^(r,"stage")(B))\$
</div>
</div>
<div class="paragraph">
<p>where \$B_h\$ is the last block header containing a digest item
(<a href="#defn-digest">Definition 33</a>) signaling an authority set change from which the next
authority set change can be fetched from. \$J^(r,"stage")(B)\$ is the GRANDPA
justification (<a href="#defn-grandpa-justification">Definition 79</a>) and \$c\$ is a boolean that
indicates whether the warp sync has been completed.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-msg-transactions"><a class="link" href="#sect-msg-transactions">4.8.5. Transactions</a></h4>
<div class="paragraph">
<p>Transactions (<a href="#sect-extrinsics">Section 3.2</a>) are sent directly to peers with which the
Polkadot Host has an open transaction substream (<a href="#defn-transactions-message">Definition 46</a>).
Polkadot Host implementers should implement a mechanism that only sends a
transaction once to each peer and avoids sending duplicates. Sending duplicate
transactions might result in undefined consequences such as being blocked for
bad behaviour by peers.</p>
</div>
<div class="paragraph">
<p>The mechanism for managing transactions is further described in Section
<a href="#sect-extrinsics">Section 3.2</a>.</p>
</div>
<div id="defn-transactions-message" class="exampleblock">
<div class="title">Definition 46. <a href="#defn-transactions-message">Transaction Message</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>transactions message</strong> is the structure of how the transactions are sent
over the network. It is represented by \$M_T\$ and is defined as follows:</p>
</div>
<div class="stemblock">
<div class="content">
\$M_T := "Enc"_("SC")(C_1,...,C_n)\$
</div>
</div>
<div class="paragraph">
<p>in which:</p>
</div>
<div class="stemblock">
<div class="content">
\$C_i := "Enc"_("SC")(E_i)\$
</div>
</div>
<div class="paragraph">
<p>Where each \$E_i\$ is a byte array and represents a separate
extrinsic. The Polkadot Host is agnostic about the content of an
extrinsic and treats it as a blob of data.</p>
</div>
<div class="paragraph">
<p>Transactions are sent over the <code>/dot/transactions/1</code> substream.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-msg-grandpa"><a class="link" href="#sect-msg-grandpa">4.8.6. GRANDPA Messages</a></h4>
<div class="paragraph">
<p>The exchange of GRANDPA messages is conducted on the substream. The process for
the creation and distributing these messages is described in <a href="#sect-finality">Section 5.3</a>.
The underlying messages are specified in this section.</p>
</div>
<div id="defn-gossip-message" class="exampleblock">
<div class="title">Definition 47. <a href="#defn-gossip-message">Grandpa Gossip Message</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>GRANDPA gossip message</strong>, \$M\$, is a varying datatype
(<a href="#defn-varrying-data-type">Definition 151</a>) which identifies the message type that is cast by
a voter followed by the message itself.</p>
</div>
<div class="stemblock">
<div class="content">
\$M = {(0,"Vote message", V_m),(1,"Commit message", C_m),(2,"Neighbor message", N_m),(3,"Catch-up request message",R_m),(4,"Catch-up message",U_m):}\$
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$V_m\$ is defined in <a href="#defn-grandpa-vote-msg">Definition 48</a>.</p>
</li>
<li>
<p>\$C_m\$ is defined in <a href="#defn-grandpa-commit-msg">Definition 50</a>.</p>
</li>
<li>
<p>\$N_m\$ is defined in <a href="#defn-grandpa-neighbor-msg">Definition 51</a>.</p>
</li>
<li>
<p>\$R_m\$ is defined in <a href="#defn-grandpa-catchup-request-msg">Definition 52</a>.</p>
</li>
<li>
<p>\$U_M\$ is defined in <a href="#defn-grandpa-catchup-response-msg">Definition 53</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div id="defn-grandpa-vote-msg" class="exampleblock">
<div class="title">Definition 48. <a href="#defn-grandpa-vote-msg">GRANDPA Vote Messages</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>GRANDPA vote message</strong> by voter \$v\$, \$M_v^(r,"stage")\$, is gossip to
the network by voter \$v\$ with the following structure:</p>
</div>
<div class="stemblock">
<div class="content">
\$M_v^(r,"stage")(B) := "Enc"_("SC")(r,"id"_(bbb V),"SigMsg")\$
\$"SigMsg" := ("msg","Sig"_(v_i)^(r,"stage"),v_("id"))\$
\$"msg" := "Enc"_("SC")("stage",V_v^(r,"stage")(B))\$
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$r\$ is an unsigned 64-bit integer indicating the Grandpa round number
(<a href="#defn-voting-rounds">Definition 77</a>).</p>
</li>
<li>
<p>\$"id"_(bbb V)\$ is an unsigned 64-bit integer indicating the authority Set Id (<a href="#defn-authority-list">Definition 58</a>).</p>
</li>
<li>
<p>\$"Sig"_(v_i)^(r,"stage")\$ is a 512-bit byte array containing the
signature of the authority (<a href="#defn-sign-round-vote">Definition 78</a>).</p>
</li>
<li>
<p>\$v_(id)\$ is a 256-bit byte array containing the <em>ed25519</em> public key of the authority.</p>
</li>
<li>
<p>\$"stage"\$ is a 8-bit integer of value <em>0</em> if it&#8217;s a pre-vote sub-round, <em>1</em> if it&#8217;s a pre-commit sub-round or <em>2</em> if it&#8217;s a primary proposal message.</p>
</li>
<li>
<p>\$V_v^(r,"stage")(B)\$ is the GRANDPA vote for block \$B\$ (<a href="#defn-voting-rounds">Definition 77</a>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This message is the sub-component of the GRANDPA gossip message
(<a href="#defn-gossip-message">Definition 47</a>) of type Id 0.</p>
</div>
</div>
</div>
<div id="defn-grandpa-justifications-compact" class="exampleblock">
<div class="title">Definition 49. <a href="#defn-grandpa-justifications-compact">GRANDPA Compact Justification Format</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>GRANDPA compact justification format</strong> is an optimized data structure to
store a collection of pre-commits and their signatures to be submitted as part
of a commit message. Instead of storing an array of justifications, it uses the
following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$J_(v_(0,...n))^(r,"comp") := ({V_(v_0)^(r,pc),... V_(v_n)^(r,pc)},{("Sig"_(v_0)^(r,pc),v_("id"_0)), ... ("Sig"_(v_n)^(r,pc),v_("id"_n))})\$
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$V_(v_i)^(r,pc)\$ is a 256-bit byte array containing the pre-commit vote of authority \$v_i\$ (<a href="#defn-voting-rounds">Definition 77</a>).</p>
</li>
<li>
<p>\$"Sig"_(v_i)^(r,pc)\$ is a 512-bit byte array containing the pre-commit
signature of authority \$v_i\$ (<a href="#defn-sign-round-vote">Definition 78</a>).</p>
</li>
<li>
<p>\$v_("id"_n)\$ is a 256-bit byte array containing the public key of authority \$v_i\$.</p>
</li>
</ul>
</div>
</div>
</div>
<div id="defn-grandpa-commit-msg" class="exampleblock">
<div class="title">Definition 50. <a href="#defn-grandpa-commit-msg">GRANDPA Commit Message</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>GRANDPA commit message</strong> for block \$B\$ in round \$r\$,
\$M_v^(r,"Fin")(B)\$, is a message broadcasted by voter \$v\$ to the
network indicating that voter \$v\$ has finalized block \$B\$ in round
\$r\$. It has the following structure:</p>
</div>
<div class="stemblock">
<div class="content">
\$M_v^(r,"Fin")(B) := "Enc"_("SC")(r,"id"_(bbb V),V_v^r(B),J_(v_(0,...n))^(r,"comp"))\$
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$r\$ is an unsigned 64-bit integer indicating the round number (<a href="#defn-voting-rounds">Definition 77</a>).</p>
</li>
<li>
<p>\$id_(bbb V)\$ is the authority set Id (<a href="#defn-authority-list">Definition 58</a>).</p>
</li>
<li>
<p>\$V_v^r(B)\$ is a 256-bit array containing the GRANDPA vote for block
\$B\$ (<a href="#defn-vote">Definition 76</a>).</p>
</li>
<li>
<p>\$J_(v_(0,...n))^(r,"comp")\$ is the compacted GRANDPA justification
containing observed pre-commit of authorities \$v_0\$ to \$v_n\$
(<a href="#defn-grandpa-justifications-compact">Definition 49</a>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This message is the sub-component of the GRANDPA gossip message
(<a href="#defn-gossip-message">Definition 47</a>) of type Id <em>1</em>.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sect-grandpa-neighbor-msg"><a class="link" href="#sect-grandpa-neighbor-msg">4.8.6.1. GRANDPA Neighbor Messages</a></h5>
<div class="paragraph">
<p>Neighbor messages are sent to all connected peers but they are not
repropagated on reception. A message should be send whenever the
messages values change and at least every 5 minutes. The sender should
take the recipients state into account and avoid sending messages to
peers that are using a different voter sets or are in a different round.
Messages received from a future voter set or round can be dropped and
ignored.</p>
</div>
<div id="defn-grandpa-neighbor-msg" class="exampleblock">
<div class="title">Definition 51. <a href="#defn-grandpa-neighbor-msg">GRANDPA Neighbor Message</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>GRANDPA Neighbor Message</strong> is defined as:</p>
</div>
<div class="stemblock">
<div class="content">
\$M^("neigh") := "Enc"_("SC")(v,r,"id"_(bbb V),H_h(B_("last")))\$
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$v\$ is an unsigned 8-bit integer indicating the version of the neighbor message, currently <em>1</em>.</p>
</li>
<li>
<p>\$r\$ is an unsigned 64-bit integer indicating the round number (<a href="#defn-voting-rounds">Definition 77</a>).</p>
</li>
<li>
<p>\$"id"_(bbb V)\$ is an unsigned 64-bit integer indicating the authority
Id (<a href="#defn-authority-list">Definition 58</a>).</p>
</li>
<li>
<p>\$H_i(B_("last"))\$ is an unsigned 32-bit integer indicating the block number of the last finalized block \$B_("last")\$.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This message is the sub-component of the GRANDPA gossip message
(<a href="#defn-gossip-message">Definition 47</a>) of type Id <em>2</em>.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sect-grandpa-catchup-messages"><a class="link" href="#sect-grandpa-catchup-messages">4.8.6.2. GRANDPA Catch-up Messages</a></h5>
<div class="paragraph">
<p>Whenever a Polkadot node detects that it is lagging behind the finality
procedure, it needs to initiate a <em>catch-up</em> procedure. GRANDPA Neighbor
messages (<a href="#defn-grandpa-neighbor-msg">Definition 51</a>) reveal the round number for the last
finalized GRANDPA round which the node’s peers have observed. This provides the
means to identify a discrepancy in the latest finalized round number observed
among the peers. If such a discrepancy is observed, the node needs to initiate
the catch-up procedure explained in <a href="#sect-grandpa-catchup">Section 5.4.1</a>).</p>
</div>
<div class="paragraph">
<p>In particular, this procedure involves sending a <em>catch-up request</em> and
processing <em>catch-up response</em> messages.</p>
</div>
<div id="defn-grandpa-catchup-request-msg" class="exampleblock">
<div class="title">Definition 52. <a href="#defn-grandpa-catchup-request-msg">Catch-Up Request Message</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>GRANDPA catch-up request message</strong> for round \$r\$,
\$M_(i,v)^("Cat"-q)("id"_(bbb V),r)\$, is a message sent from node \$i\$
to its voting peer node \$v\$ requesting the latest status of a GRANDPA round
\$r' &gt;r\$ of the authority set \$bbb V_("id")\$ along with the
justification of the status and has the following structure:</p>
</div>
<div class="stemblock">
<div class="content">
\$M_(i,v)^(r,"Cat"-q) := "Enc"_("SC")(r,"id"_(bbb V))\$
</div>
</div>
<div class="paragraph">
<p>This message is the sub-component of the GRANDPA Gossip message
(<a href="#defn-gossip-message">Definition 47</a>) of type Id <em>3</em>.</p>
</div>
</div>
</div>
<div id="defn-grandpa-catchup-response-msg" class="exampleblock">
<div class="title">Definition 53. <a href="#defn-grandpa-catchup-response-msg">Catch-Up Response Message</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>GRANDPA catch-up response message</strong> for round \$r\$,
\$M_(v,i)^("Cat"-s)("id"_(bbb V),r)\$, is a message sent by a node \$v\$
to node \$i\$ in response of a catch-up request
\$M_(v,i)^("Cat"-q)("id"_(bbb V),r')\$ in which \$r &gt;= r'\$ is the
latest GRANDPA round which v has prove of its finalization and has the following
structure:</p>
</div>
<div class="stemblock">
<div class="content">
\$M_(v,i)^("Cat"-s) := "Enc"_("SC")("id"_(bbb V), r, J_(0,...n)^(r,"pv")(B), J_(0,...m)^(r,"pc")(B),H_h(B'),H_i(B'))\$
</div>
</div>
<div class="paragraph">
<p>Where \$B\$ is the highest block which \$v\$ believes to be finalized in
round \$r\$ (<a href="#defn-voting-rounds">Definition 77</a>). \$B'\$ is the highest ancestor of
all blocks voted on in the arrays of justifications \$J_(0,...n)^(r,"pv")(B)\$
and \$J_(0,...m)^(r,"pc")(B)\$ (<a href="#defn-grandpa-justification">Definition 79</a>) with the
exception of the equivocatory votes.</p>
</div>
<div class="paragraph">
<p>This message is the sub-component of the GRANDPA Gossip message
(<a href="#defn-gossip-message">Definition 47</a>) of type Id <em>4</em>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-msg-grandpa-beefy"><a class="link" href="#sect-msg-grandpa-beefy">4.8.7. GRANDPA BEEFY</a></h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The BEEFY protocol is currently in early development and subject to
change.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This section defines the messages required for the GRANDPA BEEFY protocol
(<a href="#sect-grandpa-beefy">Section 5.5</a>). Those messages are sent over the <code>/paritytech/beefy/1</code>
substream.</p>
</div>
<div id="defn-grandpa-beefy-commitment" class="exampleblock">
<div class="title">Definition 54. <a href="#defn-grandpa-beefy-commitment">Commitment</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>commitment</strong>, \$C\$, contains the information extracted from the finalized
block at height \$H_i(B_("last"))\$ as specified in the message body and a
datastructure of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$C = (R_h,H_i(B_("last")),"id"_(bbb V))\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$R_h\$ is the MMR root of all the block header hashes leading up to the
latest, finalized block.</p>
</li>
<li>
<p>\$H_i(B_("last"))\$ is the block number this commitment is for. Namely the
latest, finalized block.</p>
</li>
<li>
<p>\$"id"_(bbb V)\$ is the current authority set Id (<a href="#defn-authority-set-id">Definition 74</a>).</p>
</li>
</ul>
</div>
</div>
</div>
<div id="defn-msg-beefy-gossip" class="exampleblock">
<div class="title">Definition 55. <a href="#defn-msg-beefy-gossip">Vote Message</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>vote message</strong>, \$M_v\$, is direct vote created by the Polkadot Host on every
BEEFY round and is gossiped to its peers. The message is a datastructure of the
following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$M_v = "Enc"_("SC")(C,A_("id")^("bfy"),A_("sig"))\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$C\$ is the BEEFY commitment (<a href="#defn-grandpa-beefy-commitment">Definition 54</a>).</p>
</li>
<li>
<p>\$A_("id")^("bfy")\$ is the ECDSA public key of the Polkadot Host.</p>
</li>
<li>
<p>\$A_("sig")\$ is the signature created with \$A_("id")^("bfy")\$ by
signing the statement \$R_h\$ in \$C\$.</p>
</li>
</ul>
</div>
</div>
</div>
<div id="defn-grandpa-beefy-signed-commitment" class="exampleblock">
<div class="title">Definition 56. <a href="#defn-grandpa-beefy-signed-commitment">Signed Commitment</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>signed commitment</strong>, \$M_("sc")\$, is a datastructure of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$M_("SC") = "Enc"_("SC")(C,S_n)\$
\$S_n = (A_0^("sig"),... A_n^("sig"))\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$C\$ is the BEEFY commitment (<a href="#defn-grandpa-beefy-commitment">Definition 54</a>).</p>
</li>
<li>
<p>\$S_n\$ is an array where its exact size matches the number of validators
in the current authority set as specified by \$"id"_(bbb V)\$
(<a href="#defn-authority-set-id">Definition 74</a>) in \$C\$. Individual items are of the type
<em>Option</em> (<a href="#defn-option-type">Definition 152</a>) which can contain a signature of a validator
which signed the same statement (\$R_h\$ in \$C\$) and is active in the
current authority set. It’s critical that the signatures are sorted based on
their corresponding public key entry in the authority set.</p>
<div class="paragraph">
<p>For example, the signature of the validator at index 3 in the authority set must
be placed at index <em>3</em> in \$S_n\$. If not signature is available for that
validator, then the <em>Option</em> variant is <em>None</em> inserted (<a href="#defn-option-type">Definition 152</a>).
This sorting allows clients to map public keys to their corresponding
signatures.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<div id="defn-grandpa-beefy-signed-commitment-witness" class="exampleblock">
<div class="title">Definition 57. <a href="#defn-grandpa-beefy-signed-commitment-witness">Signed Commitment Witness</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>signed commitment witness</strong>, \$M_("SC")^w\$, is a light version of the signed
BEEFY commitment (<a href="#defn-grandpa-beefy-signed-commitment">Definition 56</a>). Instead of
containing the entire list of signatures, it only claims which validator signed
the statement.</p>
</div>
<div class="paragraph">
<p>The message is a datastructure of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$M_("SC")^w = "Enc"_("SC")(C,V_(0,... n), R_("sig"))\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$C\$ is the BEEFY commitment (<a href="#defn-grandpa-beefy-commitment">Definition 54</a>).</p>
</li>
<li>
<p>\$V_(0,... n)\$ is an array where its exact size matches the number of
validators in the current authority set as specified by \$"id"_(bbb V)\$ in
\$C\$. Individual items are booleans which indicate whether the validator has
signed the statement (<em>true</em>) or not (<em>false</em>). It’s critical that the boolean
indicators are sorted based on their corresponding public key entry in the
authority set.</p>
<div class="paragraph">
<p>For example, the boolean indicator of the validator at index 3 in the authority
set must be placed at index <em>3</em> in \$V_n\$. This sorting allows clients to
map public keys to their corresponding boolean indicators.</p>
</div>
</li>
<li>
<p>\$R_("sig")\$ is the MMR root of the signatures in the original signed
BEEFY commitment (<a href="#defn-grandpa-beefy-signed-commitment">Definition 56</a>).</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-network-sync"><a class="link" href="#sect-network-sync">4.9. Synchronization</a></h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Synchronization is mostly application specific and the protocol does not
mandate how synchronization must be conducted. The network messages are
specified in <a href="#sect-network-messages">Section 4.8</a>. This section makes some recommendations
how a synchronization mechanism can be constructed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Many applications that interact with the Polkadot network to some extent must be
able to retrieve certain information about the network. Depending on the
utility, this includes validators that interact with Polkadot&#8217;s consensus and
need access to the full state, either from the past or just the most up-to-date
state, or light clients that are only interest in the minimum information
required in order to verify some claims about the state of the network, such as
the balance of a specific account. To allow implemenations to quickly retrieve
the required information, different types of synchronization protocols are
available, respectivel Full, Fast and Warp sync suited for different needs.</p>
</div>
<div class="sect3">
<h4 id="_full_sync"><a class="link" href="#_full_sync">4.9.1. Full Sync</a></h4>
<div class="paragraph">
<p>The full sync protocols is the "default" protocol that&#8217;s suited for many types
of implementations, such as archive nodes (nodes that store everything),
validators that participate in Polkadots consensus and light clients that only
verify claims about the state of the network. Full sync works by listening to
announced blocks (<a href="#sect-msg-block-announce">Section 4.8.1</a>) and requesting the blocks from
the announcing peers, or just the block headers in case of light clients.</p>
</div>
<div class="paragraph">
<p>The full sync protocol usually downloads the entire chain, but no such
requirements must be met. If an implemenation only wants the latest, finalized
state, it can combine it with protocols such as fast sync (<a href="#sect-fast-sync">Section 4.9.2</a>)
and/or warp sync (<a href="#sect-warp-sync">Section 4.9.3</a>) to make synchronization as fast as
possible.</p>
</div>
</div>
<div class="sect3">
<h4 id="sect-fast-sync"><a class="link" href="#sect-fast-sync">4.9.2. Fast Sync</a></h4>
<div class="paragraph">
<p>Fast sync works by downloading the block header history and validating the
auhtority set changes (<a href="#sect-authority-set">Section 5.1.1</a>) in order to arrive at a specific
(usually the most recent) header. After the desired header has been reached and
verified, the state can be downloaded and imported (<a href="#sect-msg-state-request">Section 4.8.3</a>).
Once this process has been completed, the node can proceed with a full sync.</p>
</div>
</div>
<div class="sect3">
<h4 id="sect-warp-sync"><a class="link" href="#sect-warp-sync">4.9.3. Warp Sync</a></h4>
<div class="paragraph">
<p>Warp sync (<a href="#sect-msg-warp-sync">Section 4.8.4</a>) only downloads the block headers where
authority set changes occured, so called fragments (<a href="#defn-warp-sync-proof">Definition 45</a>),
and by verifying the GRANDPA justifications (<a href="#defn-grandpa-justification">Definition 79</a>).
This protocols allows nodes to arrive at the desired state much faster than fast
sync.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chap-consensus"><a class="link" href="#chap-consensus">5. Consensus</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Consensus in the Polkadot Host is achieved during the execution of two
different procedures. The first procedure is the block-production and
the second is finality. The Polkadot Host must run these procedures if
(and only if) it is running on a validator node.</p>
</div>
<div class="sect2">
<h3 id="_common_consensus_structures"><a class="link" href="#_common_consensus_structures">5.1. Common Consensus Structures</a></h3>
<div class="sect3">
<h4 id="sect-authority-set"><a class="link" href="#sect-authority-set">5.1.1. Consensus Authority Set</a></h4>
<div class="paragraph">
<p>Because Polkadot is a proof-of-stake protocol, each of its consensus engines has
its own set of nodes represented by known public keys, which have the authority
to influence the protocol in pre-defined ways explained in this Section. To
verify the validity of each block, the Polkadot node must track the current list
of authorities (<a href="#defn-authority-list">Definition 58</a>) for that block.</p>
</div>
<div id="defn-authority-list" class="exampleblock">
<div class="title">Definition 58. <a href="#defn-authority-list">Authority List</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>authority list</strong> of block \$B\$ for consensus engine \$C\$ noted as
\$"Auth"_C(B)\$ is an array that contains the following pair of types for
each of its authorities \$A in "Auth"_C(B)\$:</p>
</div>
<div class="stemblock">
<div class="content">
\$(pk_A,w_A)\$
</div>
</div>
<div class="paragraph">
<p>\$pk_A\$ is the session public key (<a href="#defn-session-key">Definition 147</a>) of authority
\$A\$. And \$w_A\$ is an unsigned 64-bit integer indicating the authority
weight. The value of \$"Auth"_C(B)\$ is part of the Polkadot state. The value
for \$"Auth"_C(B_0)\$ is set in the genesis state (<a href="#chapter-genesis">Chapter 12</a>) and
can be retrieved using a runtime entry corresponding to consensus engine
\$C\$.</p>
</div>
<div class="paragraph">
<p>In Polkadot, all authorities have the weight \$w_A = 1\$. The weight
\$w_A\$ exists for potential improvements in the protocol and could have a
use-case in the future.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-consensus-message-digest"><a class="link" href="#sect-consensus-message-digest">5.1.2. Runtime-to-Consensus Engine Message</a></h4>
<div class="paragraph">
<p>The authority list (<a href="#defn-authority-list">Definition 58</a>) is part of the Polkadot state and
the Runtime has the authority to update this list in the course of any state
transitions. The Runtime informs the corresponding consensus engine about the
changes in the authority set by adding the appropriate consensus message
(<a href="#defn-consensus-message-digest">Definition 59</a>) in the form of a digest item
(<a href="#defn-digest">Definition 33</a>) to the block header of block \$B\$ which caused the
transition in the authority set.</p>
</div>
<div class="paragraph">
<p>The Polkadot Host must inspect the digest header of each block and delegate
consensus messages to their consensus engines. The BABE and GRANDPA consensus
engine must react based on the type of consensus messages it receives. The
active GRANDPA authorities can only vote for blocks that occurred after the
finalized block in which they were selected. Any votes for blocks before the
came into effect would get rejected.</p>
</div>
<div id="defn-consensus-message-digest" class="exampleblock">
<div class="title">Definition 59. <a href="#defn-consensus-message-digest">Consensus Message</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>consensus message</strong>, \$"CM"\$, is a digest item (<a href="#defn-digest">Definition 33</a>) of type
<em>4</em> and consists one of the following tuple pairs, where the first item is a
string which serves as an identifier.</p>
</div>
<div class="stemblock">
<div class="content">
\$"CM" = {(,("'BABE'", "CM"_b)),(,("'FRNK'", "CM"_g)),(,("'BEEF'", "CM"_y)):}\$
</div>
</div>
<div class="paragraph">
<p>\$"CM"_b\$, the consensus message for BABE, is of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$"CM"_b = {(1,("Auth"_C, r)),(2,A_i),(3,D):}\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>1</em> implies <strong>next epoch data</strong>: The Runtime issues this message on every first
block of an epoch. The supplied authority set (<a href="#defn-authority-list">Definition 58</a>),
\$"Auth"_C\$, and randomness (<a href="#defn-epoch-randomness">Definition 72</a>), \$r\$, are used
in the next epoch \$cc E_n + 1\$.</p>
</li>
<li>
<p><em>2</em> implies <strong>on disabled</strong>: A 32-bit integer, \$A_i\$, indicating the
individual authority in the current authority list that should be immediately
disabled until the next authority set changes. This message initial intension
was to cause an imediatly suspension of all authority functionality with the
specified authority.</p>
</li>
<li>
<p><em>3</em> implies <strong>next epoch descriptor</strong>: These messages are only issued on
configuration change and in the first block of an epoch. The supplied
configuration data are intended to be used from the next epoch onwards.</p>
<div class="paragraph">
<p>\$D\$ is a varying datatype of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$D = {(1, (c,2_("nd"))):}\$
</div>
</div>
<div class="paragraph">
<p>where \$c\$ is the probability that a slot will not be empty
(<a href="#defn-babe-constant">Definition 64</a>). It is encoded as a tuple of two unsigned 64-bit
integers \$(c_("nominator"),c_("denominator"))\$ which are used to compute
the rational \$c = c_("nominator")/c_("denominator")\$.</p>
</div>
<div class="paragraph">
<p>\$2_("nd")\$ describes what secondary slot (<a href="#defn-babe-secondary-slots">Section 5.2.2.2</a>),
if any, is to be used. It is encoded as one-byte varying datatype:</p>
</div>
<div class="stemblock">
<div class="content">
\$s_"2nd" = {
	(0,-&gt;,"no secondary slot"),
	(1,-&gt;,"plain secondary slot"),
	(2,-&gt;,"secondary slot with VRF output")
:}\$
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>\$"CM"_g\$, the consensus message for GRANDPA, is of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$"CM"_g = {(1,("Auth"_C,N_("delay"))),(2,(m,"Auth"_C,N_("delay"))),(3,"A"_i),(4,N_("delay")),(5,N_("delay")):}\$
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$N_("delay")\$ is an unsigned 32-bit integer indicating how deep in the
chain the announcing block must be before the change is applied.</p>
</li>
<li>
<p><em>1</em> implies <strong>scheduled change</strong>: Schedule an authority set change after the
given delay of \$N_("delay") := |"SubChain"(B,B')|\$ where \$B'\$ in the
definition of \$N_("delay")\$, is a block <em>finalized</em> by the finality
consensus engine. The earliest digest of this type in a single block will be
respected. No change should be scheduled if one is already finalized and the
delay has not passed completely. If such an inconsistency occurs, the scheduled
change should be ignored.</p>
</li>
<li>
<p><em>2</em> implies <strong>forced change</strong>: Force an authority set change after the given
delay of \$N_("delay") := |"SubChain"(B,B')|\$ where \$B'\$ in the
definition of \$N_("delay")\$, is an <em>imported</em> block that has been validated
by the block production consensus engine. Hence, the authority changeset is
valid for every subchain containing <em>B</em> and where the delay has been exceeded.
If one or more blocks gets finalized before the change takes effect, the
authority set change should be disregarded. The earliest digest of this type in
a single block will be respected. No change should be scheduled if one is
already finalized and the delay has not passed completely. If such an
inconsistency occurs, the scheduled change should be ignored.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
\$m\$, which indicates the block finalization median, is to-be-defined.
</td>
</tr>
</table>
</div>
</li>
<li>
<p><em>3</em> implies <strong>on disabled</strong>: An index to the individual authority in the
current authority list that should be immediately disabled until the next
authority set changes. When an authority gets disabled, the node should stop
performing any authority functionality from that authority, including authoring
blocks and casting GRANDPA votes for finalization. Similarly, other nodes should
ignore all messages from the indicated authority which pertain to their
authority role.</p>
</li>
<li>
<p><em>4</em> implies <strong>pause</strong>: A signal to pause the current authority set after the
given delay of \$N_("delay") := |"SubChain"(B,B')|\$ where \$B'\$ in the
definition of \$N_("delay")\$, is a block <em>finalized</em> by the finality
consensus engine. After finalizing block \$B'\$, the authorities should stop
voting.</p>
</li>
<li>
<p><em>5</em> implies <strong>resume</strong>: A signal to resume the current authority set after the
given delay of \$N_("delay") := |"SubChain"(B,B')|\$ where \$B'\$ in the
definition of \$N_("delay")\$, is an <em>imported</em> block and validated by the
block production consensus engine. After authoring block \$B'\$, the
authorities should resume voting.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The BEEFY protocol is still under construction. The following part will be
updated in the future and certain information will be clarified.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>\$"CM"_y\$, the consensus message for BEEFY (<a href="#sect-grandpa-beefy">Section 5.5</a>), is of
the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$"CM"_y = {(1,(V_B,V_i)),(2,A_i),(3,R):}\$
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>1</em> implies that the remote <strong>authorities have changed</strong>. \$V_B\$ is the
array of the new BEEFY authorities&#8217;s public keys and \$V_i\$ is the
identifier of the remote validator set.</p>
</li>
<li>
<p><em>2</em> implies <strong>on disabled</strong>: an index to the individual authorty in \$V_B\$
that should be immediatly disabled until the next authority change.</p>
</li>
<li>
<p><em>3</em> implies <strong>MMR root</strong>: a 32-byte array containing the MMR root.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-block-production"><a class="link" href="#sect-block-production">5.2. Block Production</a></h3>
<div class="paragraph">
<p>The Polkadot Host uses BABE protocol for block production. It is designed based
on Ouroboros praos . BABE execution happens in sequential non-overlapping phases
known as an <strong><em>epoch</em></strong>. Each epoch on its turn is divided into a predefined
number of slots. All slots in each epoch are sequentially indexed starting from
0. At the beginning of each epoch, the BABE node needs to run Algorithm as
defined in <a href="#algo-block-production-lottery">Section 5.2.2.1</a> to find out in which slots it
should produce a block and gossip to the other block producers. In turn, the
block producer node should keep a copy of the block tree and grow it as it
receives valid blocks from other block producers. A block producer prunes the
tree in parallel by eliminating branches that do not include the most recent
finalized blocks (<a href="#defn-pruned-tree">Definition 11</a>).</p>
</div>
<div class="sect3">
<h4 id="_preliminaries_3"><a class="link" href="#_preliminaries_3">5.2.1. Preliminaries</a></h4>
<div class="sect4">
<h5 id="_block_producer"><a class="link" href="#_block_producer">5.2.1.1. Block Producer</a></h5>
<div class="paragraph">
<p>A <strong>block producer</strong>, noted by \$cc P_j\$, is a node running the Polkadot
Host which is authorized to keep a transaction queue and which it gets a turn in
producing blocks.</p>
</div>
</div>
<div class="sect4">
<h5 id="_block_authoring_session_key_pair"><a class="link" href="#_block_authoring_session_key_pair">5.2.1.2. Block Authoring Session Key Pair</a></h5>
<div class="paragraph">
<p><strong>Block authoring session key pair</strong> \$(sk_j^s,pk_j^s)\$ is an SR25519 key pair
which the block producer \$cc P_j\$ signs by their account key
(<a href="#defn-account-key">Definition 144</a>) and is used to sign the produced block as well as to
compute its lottery values in Algorithm as defined in
<a href="#algo-block-production-lottery">Section 5.2.2.1</a>.</p>
</div>
<div id="defn-epoch-slot" class="exampleblock">
<div class="title">Definition 60. <a href="#defn-epoch-slot">Epoch and Slot</a></div>
<div class="content">
<div class="paragraph">
<p>A block production <strong>epoch</strong>, formally referred to as \$cc E\$, is a
period with a pre-known starting time and fixed-length during which the set of
block producers stays constant. Epochs are indexed sequentially, and we refer to
the \$n^(th)\$ epoch since genesis by \$cc E_n\$. Each epoch is divided
into equal-length periods known as block production <strong>slots</strong>, sequentially
indexed in each epoch. The index of each slot is called a <strong>slot number</strong>. The
equal length duration of each slot is called the <strong>slot duration</strong> and indicated
by \$cc T\$. Each slot is awarded to a subset of block producers during
which they are allowed to generate a block.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Substrate refers to an epoch as "session" in some places, however,
epoch should be the preferred and official name for these periods.
</td>
</tr>
</table>
</div>
</div>
</div>
<div id="defn-epoch-duration" class="exampleblock">
<div class="title">Definition 61. <a href="#defn-epoch-duration">Epoch and Slot Duration</a></div>
<div class="content">
<div class="paragraph">
<p>We refer to the number of slots in epoch \$cc E_n\$ by \$sc_n\$.
\$sc_n\$ is set to the <code>duration</code> field in the returned data from the call of
the Runtime entry <code>BabeApi_configuration</code> (<a href="#sect-rte-babeapi-epoch">Section 26.8.1</a>) at
genesis. For a given block \$B\$, we use the notation <strong>\(s_B\)</strong> to
refer to the slot during which \$B\$ has been produced. Conversely, for slot
\$s\$, \$cc B_c\$ is the set of Blocks generated at slot \$s\$.</p>
</div>
<div class="paragraph">
<p><a href="#defn-epoch-subchain">Definition 62</a> provides an iterator over the blocks produced during a
specific epoch.</p>
</div>
</div>
</div>
<div id="defn-epoch-subchain" class="exampleblock">
<div class="title">Definition 62. <a href="#defn-epoch-subchain">Epoch Subchain</a></div>
<div class="content">
<div class="paragraph">
<p>By \$"SubChain"(cc E_n\$) for epoch \$cc E_n\$, we refer to the path
graph of \$BT\$ containing all the blocks generated during the slots of epoch
\$cc E_n\$. When there is more than one block generated at a slot, we
choose the one which is also on \$"Longest-Chain"(BT)\$.</p>
</div>
</div>
</div>
<div id="defn-equivovation" class="exampleblock">
<div class="title">Definition 63. <a href="#defn-equivocation">Equivocation</a></div>
<div class="content">
<div class="paragraph">
<p>A block producer <strong>equivocates</strong> if they produce more than one block at the same
slot. The proof of equivocation are the given distinct headers that were signed
by the validator and which include the slot number.</p>
</div>
<div class="paragraph">
<p>The Polkadot Host must detect equivocations committed by other validators and
submit those to the Runtime as described in
<a href="#sect-babeapi_submit_report_equivocation_unsigned_extrinsic">Section 26.8.6</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-block-production-lottery"><a class="link" href="#sect-block-production-lottery">5.2.2. Block Production Lottery</a></h4>
<div class="paragraph">
<p>The babe constant (<a href="#defn-babe-constant">Definition 64</a>) is initialized at genesis to the
value returned by calling <code>BabeApi_configuration</code> (<a href="#sect-rte-babeapi-epoch">Section 26.8.1</a>).
For efficiency reasons, it is generally updated by the Runtime through the <em>next
config data</em> consensus message (<a href="#defn-consensus-message-digest">Definition 59</a>) in the digest
of the first block of an epoch for the next epoch.</p>
</div>
<div class="paragraph">
<p>A block producer aiming to produce a block during \$cc E_n\$ should run
Algorithm as defined in <a href="#algo-block-production-lottery">Section 5.2.2.1</a> to identify the slots
it is awarded. These are the slots during which the block producer is allowed to
build a block. The \$sk\$ is the block producer lottery secret key and
\$n\$ is the index of the epoch for whose slots the block producer is running
the lottery.</p>
</div>
<div class="paragraph">
<p>In order to ensure consistent block production, BABE uses secondary slots in
case no authority won the (primary) block production lottery. Unlike the
lottery, secondary slot assignees are know upfront publically
(<a href="#defn-babe-secondary-slots">Section 5.2.2.2</a>). The Runtime provides information on how
or if secondary slots are executed (<a href="#sect-rte-babeapi-epoch">Section 26.8.1</a>), explained
further in <a href="#defn-babe-secondary-slots">Section 5.2.2.2</a>.</p>
</div>
<div id="defn-babe-constant" class="exampleblock">
<div class="title">Definition 64. <a href="#defn-babe-constant">BABE Constant</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>BABE constant</strong> is the probability that a slot will not be empty and used in
the winning threshold calculation (<a href="#defn-winning-threshold">Definition 65</a>). It&#8217;s expressed
as a rational, \$(x, y)\$, where \$x\$ is the numerator and \$y\$ is
the denominator.</p>
</div>
</div>
</div>
<div id="defn-winning-threshold" class="exampleblock">
<div class="title">Definition 65. <a href="#defn-winning-threshold">Winning Threshold</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>Winning threshold</strong> denoted by \$T_(cc E_n)\$ is the threshold that is
used alongside the result of Algorithm as defined in
<a href="#algo-block-production-lottery">Section 5.2.2.1</a> to decide if a block producer is the winner of
a specific slot. \$T_(cc E_n)\$ is calculated  as follows:</p>
</div>
<div class="stemblock">
<div class="content">
\$T_(E_n) := 1 - (1 - c)^(1/("AuthorityDirectory"^(E_n)))\$
</div>
</div>
<div class="paragraph">
<p>where the \$"AuthorityDirectory"^(cc E_n)\$ is the set of BABE authorities
for epoch \$cc E_n\$ and \$c in (0, 1)\$ is the BABE constant
(<a href="#defn-babe-constant">Definition 64</a>).</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="algo-block-production-lottery"><a class="link" href="#algo-block-production-lottery">5.2.2.1. Primary Block Production Lottery</a></h5>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>A block producer aiming to produce a block during \$cc E_n\$ should run the
\$"Block-Production-Lottery"\$ algorithm to identify the slots it is awarded.
These are the slots during which the block producer is allowed to build a block.
The session secret key, \$sk\$, is the block producer lottery secret key and
\$n\$ is the index of the epoch for whose slots the block producer is running
the lottery.</p>
</div>
<div class="paragraph">
<p>Algorithm: \$"Block-Production-Lottery"(sk)\$</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>\$r larr "Epoch-Randomness"(n)\$</p>
</li>
<li>
<p>\$"for " s := 1 " to " sc_n\$</p>
</li>
<li>
<p>\$"    " (o, p) larr "VRF"(r,s,e_i,s_k, p_k)\$</p>
</li>
<li>
<p>\$"    " A\[i] larr (o, p)\$</p>
</li>
<li>
<p>\$"return " A\$</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>where \$"Epoch-Randomness"\$ is defined in (<a href="#defn-epoch-randomness">Definition 72</a>),
\$sc_n\$ is defined in <a href="#defn-epoch-duration">Definition 61</a> , \$"VRF"\$ creates the
BABE VRF transcript (<a href="#defn-babe-vrf-transcript">Section 5.2.2.3</a>) and \$e_i\$ is the epoch
index, retrieved from the Runtime (<a href="#sect-rte-babeapi-epoch">Section 26.8.1</a>). \$s_k\$ and
\$p_k\$ is the secret key respectively the public key of the authority. For
any slot \$s\$ in epoch \$n\$ where \$d &lt; r\$, the block producer is
required to produce a block.</p>
</div>
<div class="paragraph">
<p>Note that the secondary slots (<a href="#defn-babe-secondary-slots">Section 5.2.2.2</a>) are running
along side the primary block production lottery and mainly serve as a fallback
to in case no authority was selected in the primary lottery.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="defn-babe-secondary-slots"><a class="link" href="#defn-babe-secondary-slots">5.2.2.2. Secondary Slots</a></h5>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Secondary slots</strong> work along side primary slot to ensure consistent block
production, as described in <a href="#sect-block-production-lottery">Section 5.2.2</a>. The secondary
assignee of a block is determined by calculating a specific value, \$i_d\$,
which indicates the index in the authority set (<a href="#defn-authority-list">Definition 58</a>). The
corresponding authority in that set has the right to author a secondary block.
This calculation is done for every slot in the epoch, \$s in sc_n\$
(<a href="#defn-epoch-duration">Definition 61</a>).</p>
</div>
<div class="stemblock">
<div class="content">
\$p larr h("Enc"_"SC"(r,s))\$
\$i_d larr p mod A_l\$
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$r\$ is the Epoch randomness (<a href="#defn-epoch-randomness">Definition 72</a>).</p>
</li>
<li>
<p>\$s\$ is the slot number (<a href="#defn-epoch-slot">Definition 60</a>).</p>
</li>
<li>
<p>\$"Enc"_"SC"(...)\$ encodes its inner value to the corresponding SCALE value.</p>
</li>
<li>
<p>\$h(...)\$ creates a 256-bit Blake2 hash from its inner value.</p>
</li>
<li>
<p>\$A_l\$ is the lengths of the authority list (<a href="#defn-authority-list">Definition 58</a>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If \$i_d\$ points to the authority, that authority must claim the secondary
slot by creating a BABE VRF transcript (<a href="#defn-babe-vrf-transcript">Section 5.2.2.3</a>). The
resulting values \$o\$ and \$p\$ are then used in the Pre-Digest item
(<a href="#defn-babe-header">Definition 70</a>). In case of secondary slots with plain outputs,
respectively the Pre-Digest being of value <em>2</em>, the transcript respectively the
VRF is skipped.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="defn-babe-vrf-transcript"><a class="link" href="#defn-babe-vrf-transcript">5.2.2.3. BABE Slot VRF transcript</a></h5>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>The BABE block production lottery requires a specific transcript structure
(<a href="#defn-vrf-transcript">Definition 142</a>). That structure is used by both primary slots
(<a href="#algo-block-production-lottery">Section 5.2.2.1</a>) and secondary slots
(<a href="#defn-babe-secondary-slots">Section 5.2.2.2</a>).</p>
</div>
<div class="stemblock">
<div class="content">
\$t_1 larr "Transcript"("'BABE'")\$
\$t_2 larr "append"(t_1, "'slot number'", s)\$
\$t_3 larr "append"(t_2, "'current epoch'", e_i)\$
\$t_4 larr "append"(t_3, "'chain randomness'", r)\$
\$t_5 larr "append"(t_4, "'vrf-nm-pk'", p_k)\$
\$t_6 larr "meta-ad"(t_5, "'VRFHash'", "False")\$
\$t_7 larr "meta-ad"(t_6, 64_"le", "True")\$
\$h larr "prf"(t_7, "False")\$
\$o = s_k * h\$
\$p larr "dleq_prove"(t_7, h)\$
</div>
</div>
<div class="paragraph">
<p>The operators are defined in <a href="#defn-strobe-operations">Definition 143</a>, \$"dleq_prove"\$ in
<a href="#defn-vrf-dleq-prove">Definition 140</a>. The computed outputs, \$o\$ and \$p\$, are
included in the block Pre-Digest (<a href="#defn-babe-header">Definition 70</a>).</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-slot-number-calculation"><a class="link" href="#sect-slot-number-calculation">5.2.3. Slot Number Calculation</a></h4>
<div class="paragraph">
<p>It is imperative for the security of the network that each block producer
correctly determines the current slot numbers at a given time by regularly
estimating the local clock offset in relation to the network
(<a href="#defn-relative-syncronization">Definition 67</a>).</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>The calculation described in this section is still to be implemented and
deployed</strong>: For now, each block producer is required to synchronize its local
clock using NTP instead. The current slot \$s\$ is then calculated by \$s
= t_"unix"/cc T\$ where \$cc T\$ is defined in <a href="#defn-epoch-slot">Definition 60</a> and
\$t_"unix"\$ is defined in <a href="#defn-unix-time">Definition 9</a>. That also entails that slot
numbers are currently not reset at the beginning of each epoch.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Polkadot does this synchronization without relying on any external clock source
(e.g. through the or the ). To stay in synchronization, each producer is
therefore required to periodically estimate its local clock offset in relation
to the rest of the network.</p>
</div>
<div class="paragraph">
<p>This estimation depends on the two fixed parameters \$k\$
(<a href="#defn-prunned-best">Definition 68</a>) and \$s_(cq)\$ (<a href="#defn-chain-quality">Definition 69</a>). These are
chosen based on the results of a
<a href="https://research.web3.foundation/en/latest/polkadot/block-production/Babe.html#-5.-security-analysis">formal
security analysis</a>, currently assuming a \$1 s\$ clock drift per day and
targeting a probability lower than \$0.5%\$ for an adversary to break BABE in
3 years with resistance against a network delay up to \$1 / 3\$ of the slot
time and a Babe constant (<a href="#defn-babe-constant">Definition 64</a>) of \$c = 0.38\$.</p>
</div>
<div class="paragraph">
<p>All validators are then required to run Algorithm as defined in
<a href="#algo-slot-time">Section 5.2.3.2</a> at the beginning of each sync period (<a href="#defn-sync-period">Section 5.2.3.4</a>)
to update their synchronization using all block arrival times of the previous
period. The algorithm should only be run once all the blocks in this period have
been finalized, even if only probabilistically (<a href="#defn-prunned-best">Definition 68</a>). The
target slot to which to synchronize should be the first slot in the new sync
period.</p>
</div>
<div id="defn-slot-offset" class="exampleblock">
<div class="title">Definition 66. <a href="#defn-slot-offset">Slot Offset</a></div>
<div class="content">
<div class="paragraph">
<p>Let \$s_i\$ and \$s_j\$ be two slots belonging to epochs \$cc E_k\$
and \$cc E_l\$. By <strong>Slot-Offset</strong>\$(s_i,s_j)\$ we refer to the function
whose value is equal to the number of slots between \$s_i\$ and \$s_j\$
(counting \$s_j\$) on the time continuum. As such, we have
<strong>Slot-Offset</strong>\$(s_i, s_i) = 0\$.</p>
</div>
<div class="paragraph">
<p>It is imperative for the security of the network that each block producer
correctly determines the current slot numbers at a given time by regularly
estimating the local clock offset in relation to the network
(<a href="#defn-relative-syncronization">Definition 67</a>).</p>
</div>
</div>
</div>
<div id="defn-relative-syncronization" class="exampleblock">
<div class="title">Definition 67. <a href="#defn-relative-syncronization">Relative Time Synchronization</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>relative time synchronization</strong> is a tuple of a slot number and a local
clock timestamp \$(s_"sync",t_"sync")\$ describing the last point at
which the slot numbers have been synchronized with the local clock.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="algo-slot-offset"><a class="link" href="#algo-slot-offset">5.2.3.1. Slot Offset</a></h5>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Algorithm: \$"Slot-Time"(s)\$</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>\$"return " t_"sync" + "Slot-Offset"(s_"sync",s) xx cc T\$</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>where \$s\$ is the slot number.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="algo-slot-time"><a class="link" href="#algo-slot-time">5.2.3.2. Slot Time Median Algorithm</a></h5>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Algorithm: \$"Median-Algorithm"(cc P, s_"sync")\$</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>\$T_s larr {}\$</p>
</li>
<li>
<p>\$"for " B_i in cc P\$</p>
</li>
<li>
<p>\$"    " t_"est"^B larr T_(B_i) + "Slot-Offset"(S_(B_i), s_"sync") xx cc T\$</p>
</li>
<li>
<p>\$"    " T_s larr T_S	uu t_"est"^(B_i)\$</p>
</li>
<li>
<p>\$"return Median"(T_s)\$</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$cc P\$ is the sync period used for the estimate.</p>
</li>
<li>
<p>\$s_"sync"\$ is the slot time to estimate.</p>
</li>
<li>
<p>\$"Slot-Offset"\$ is defined in <a href="#algo-slot-offset">Section 5.2.3.1</a>.</p>
</li>
<li>
<p>\$cc T\$ is the slot duration defined in <a href="#defn-epoch-slot">Definition 60</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div id="defn-prunned-best" class="exampleblock">
<div class="title">Definition 68. <a href="#defn-prunned-best">Pruned Best Chain</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>pruned best chain</strong> \$C^(r^k)\$ is the longest selected chain
(<a href="#defn-longest-chain">Definition 13</a>) with the last \$k\$ Blocks pruned. We chose \$k
= 140\$. The <strong>last (probabilistic) finalized block</strong> describes the last block in
this pruned best chain.</p>
</div>
</div>
</div>
<div id="defn-chain-quality" class="exampleblock">
<div class="title">Definition 69. <a href="#defn-chain-quality">Chain Quality</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>chain quality</strong> \$s_(cq)\$ represents the number of slots that are used
to estimate the local clock offset. Currently, it is set to \$s_(cq) =
3000\$.</p>
</div>
<div class="paragraph">
<p>The prerequisite for such a calculation is that each producer stores the arrival
time of each block (<a href="#defn-block-time">Section 5.2.3.3</a>) measured by a clock that is otherwise
not adjusted by any external protocol.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="defn-block-time"><a class="link" href="#defn-block-time">5.2.3.3. Block Arrival Time</a></h5>
<div class="paragraph">
<p>The <strong>block arrival time</strong> of block \$B\$ for node \$j\$ formally
represented by \$T_B^j\$ is the local time of node \$j\$ when node
\$j\$ has received block \$B\$ for the first time. If the node \$j\$
itself is the producer of \$B\$, \$T_B^j\$ is set equal to the time that
the block is produced. The index \$j\$ in \$T_B^j\$ notation may be
dropped and B’s arrival time is referred to by \$T_B\$ when there is no
ambiguity about the underlying node.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Currently it still lacks a clear definition of when block arrival times
are considered valid and how to differentiated imported block on initial sync
from &#8220;fresh&#8221; blocks that were just produced.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="defn-sync-period"><a class="link" href="#defn-sync-period">5.2.3.4. Sync Period</a></h5>
<div class="paragraph">
<p>A is an interval at which each validator (re-)evaluates its local clock offsets.
The first sync period \$fr E_1\$ starts just after the genesis block is
released. Consequently, each sync period \$fr E_i\$ starts after \$fr
E_(i - 1)\$. The length of the sync period (<a href="#defn-chain-quality">Definition 69</a>) is equal to
\$s_(qc)\$and expressed in the number of slots.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="block-production"><a class="link" href="#block-production">5.2.4. Block Production</a></h4>
<div class="paragraph">
<p>Throughout each epoch, each block producer should run Algorithm as defined in
<a href="#algo-block-production">Section 5.2.4.1</a> to produce blocks during the slots it has been awarded
during that epoch. The produced block needs to carry the <em>Pre-Digest</em>
(<a href="#defn-babe-header">Definition 70</a>) as well as the <em>block signature</em>
(<a href="#defn-block-signature">Definition 71</a>) as Pre-Runtime and Seal digest items.</p>
</div>
<div id="defn-babe-header" class="exampleblock">
<div class="title">Definition 70. <a href="#defn-babe-header">Pre-Digest</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>Pre-Digest</strong>, or BABE header, \$P\$, is a varying datatype of the
following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$P = {(1,-&gt;,(a_"id",s,o,p)),(2,-&gt;,(a_"id",s)),(3,-&gt;,(a_"id",s,o,p)):}\$
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>1</em> indicates a primary slot with VRF outputs, <em>2</em> a secondary slot with plain
outputs and <em>3</em> a secondary slot with VRF outputs
(<a href="#sect-block-production-lottery">Section 5.2.2</a>). Plain outputs are no longer actively used
and only exist for backwards compatibility reasons, respectively to sync old
blocks.</p>
</li>
<li>
<p>\$a_"id"\$ is the unsigned 32-bit integer indicating the index of the
authority in the authority set (<a href="#sect-authority-set">Section 5.1.1</a>) who authored the
block.</p>
</li>
<li>
<p>\$s\$ is the slot number (<a href="#defn-epoch-slot">Definition 60</a>).</p>
</li>
<li>
<p>\$o\$ is VRF output (<a href="#algo-block-production-lottery">Section 5.2.2.1</a> respectively
<a href="#defn-babe-secondary-slots">Section 5.2.2.2</a>).</p>
</li>
<li>
<p>\$p\$ is VRF proof (<a href="#algo-block-production-lottery">Section 5.2.2.1</a> respectively
<a href="#defn-babe-secondary-slots">Section 5.2.2.2</a>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Pre-Digest must be included as a digest item of Pre-Runtime type in the
header digest (<a href="#defn-digest">Definition 33</a>) \$H_d(B)\$.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="algo-block-production"><a class="link" href="#algo-block-production">5.2.4.1. Invoke Block Authoring</a></h5>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Algorithm: \$"Invoke-Block-Authoring"(sk, pk, n, "BT")\$</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>\$A larr "Block-Production-Lottery"(sk, n)\$</p>
</li>
<li>
<p>\$"for " s larr 1 " to " "sc"_n\$</p>
</li>
<li>
<p>\$"    " "Wait"("until Slot-Time"(s))\$</p>
</li>
<li>
<p>\$"    " (d, pi) larr A\[s]\$</p>
</li>
<li>
<p>\$"    " "if " d &lt; r\$</p>
</li>
<li>
<p>\$"    " "    " C_"Best" larr "Longest-Chain"("BT")\$</p>
</li>
<li>
<p>\$"    " "    " B_s larr "Build-Block"(C_"Best")\$</p>
</li>
<li>
<p>\$"    " "    " "Add-Digest-Item"(B_s, "Pre-Runtime", E_"id"("BABE"),H_"BABE"(B_s))\$</p>
</li>
<li>
<p>\$"    " "    " "Add-Digest-Item"(B_s, "Seal", S_B)\$</p>
</li>
<li>
<p>\$"    " "    " "Broadcast-Block"(B_s)\$</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>where \$"BT"\$ is the current block tree, \$"Block-Production-Lottery"\$
is defined in <a href="#algo-block-production-lottery">Section 5.2.2.1</a> and \$"Add-Digest-Item"\$
appends a digest item to the end of the header digest \$H_d(B)\$
(<a href="#defn-digest">Definition 33</a>).</p>
</div>
</div>
</div>
<div id="defn-block-signature" class="exampleblock">
<div class="title">Definition 71. <a href="#defn-block-signature">Block Signature</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>Block Signature</strong> \$S_B\$ is a signature of the block header hash
(<a href="#defn-block-header-hash">Definition 34</a>) and defined as</p>
</div>
<div class="stemblock">
<div class="content">
\$"Sig"_("SR25519","sk"_j^s)(H_h(B))\$
</div>
</div>
<div class="paragraph">
<p>\$S_B\$ should be included in \$H_d(B)\$ as the Seal digest item
(<a href="#defn-digest">Definition 33</a>) of value:</p>
</div>
<div class="stemblock">
<div class="content">
\$(E_"id"("BABE"),S_B)\$
</div>
</div>
<div class="paragraph">
<p>in which, \$E_"id"("BABE")\$ is the BABE consensus engine unique identifier
(<a href="#defn-consensus-message-digest">Definition 59</a>). The Seal digest item is referred to as the
<strong>BABE Seal</strong>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-epoch-randomness"><a class="link" href="#sect-epoch-randomness">5.2.5. Epoch Randomness</a></h4>
<div class="paragraph">
<p>At the beginning of each epoch, \$cc E_n\$ the host will receive the
randomness seed \$cc R_(cc E_(n+1))\$ (<a href="#defn-epoch-randomness">Definition 72</a>)
necessary to participate in the block production lottery in the next epoch
\$cc E_(n+1)\$ from the Runtime, through the consensus message
(<a href="#defn-consensus-message-digest">Definition 59</a>) in the digest of the first block.</p>
</div>
<div id="defn-epoch-randomness" class="exampleblock">
<div class="title">Definition 72. <a href="#defn-epoch-randomness">Randomness Seed</a></div>
<div class="content">
<div class="paragraph">
<p>For epoch \$cc E\$, there is a 32-byte \$cc R_(cc E)\$ computed based on
the previous epochs VRF outputs. For \$cc E_0\$ and \$cc E_1\$, the
randomness seed is provided in the genesis state (<a href="#sect-rte-babeapi-epoch">Section 26.8.1</a>).
For any further epochs, the randomness is retrieved from the consensus message
(<a href="#defn-consensus-message-digest">Definition 59</a>).</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-verifying-authorship"><a class="link" href="#sect-verifying-authorship">5.2.6. Verifying Authorship Right</a></h4>
<div class="paragraph">
<p>When a Polkadot node receives a produced block, it needs to verify if the block
producer was entitled to produce the block in the given slot by running
Algorithm as defined in <a href="#algo-verify-authorship-right">Section 5.2.6.1</a>. The Algorithm as
defined in <a href="#algo-verify-slot-winner">Section 5.2.6.2</a> runs as part of the verification process,
when a node is importing a block.</p>
</div>
<div class="sect4">
<h5 id="algo-verify-authorship-right"><a class="link" href="#algo-verify-authorship-right">5.2.6.1. Verify Authorship Right</a></h5>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Algorithm: \$tt "Verify-Authorship-Right"("Head"_s(B))\$</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>\$s larr "Slot-Number-At-Given-Time"(T_B)\$</p>
</li>
<li>
<p>\$cc E_c larr "Current-Epoch"()\$</p>
</li>
<li>
<p>\$(D_1, ..., D_("length"(H_d(B)))) larr H_d(B)\$</p>
</li>
<li>
<p>\$D_s larr D_("length"(H_d(B)))\$</p>
</li>
<li>
<p>\$H_d(B) larr (D_1, ..., D_("length"(H_d(B))-1)) " // remove the seal from the digest"\$</p>
</li>
<li>
<p>\$("id","Sig"_B) larr "Dec"_("SC")(D_s)\$</p>
</li>
<li>
<p>\$"if " "id" != "Seal-Id"\$</p>
</li>
<li>
<p>\$"    " "error 'Seal missing'"\$</p>
</li>
<li>
<p>\$"AuthorId" larr "AuthorityDirectory"^(cc E_c)\[H_("BABE")(B)."SignerIndex"]\$</p>
</li>
<li>
<p>\$"Verify-Signature"("AuthorId", H_h(B), "Sig"_B)\$</p>
</li>
<li>
<p>\$"if " EE B' in "BT": H_h(B) != H_h(B) " and " s_B = s'_B " and " "SignerIndex"_B = "SignerIndex"_(B')\$</p>
</li>
<li>
<p>\$"    " "error 'Block producer is equivocating'"\$</p>
</li>
<li>
<p>\$"Verify-Slot-Winner"((d_B, pi_B),s,"AuthorId")\$</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$"Head"_s(B)\$ is the header of the block that&#8217;s being verified.</p>
</li>
<li>
<p>\$T_B\$ is \$B\$’s arrival time (<a href="#defn-block-time">Section 5.2.3.3</a>).</p>
</li>
<li>
<p>\$H_d(B)\$ is the digest sub-component (<a href="#defn-digest">Definition 33</a>) of
\$"Head"(B)\$ (<a href="#defn-block-header">Definition 32</a>).</p>
</li>
<li>
<p>The Seal \$D_s\$ is the last element in the digest array \$H_d(B)\$ as
described in <a href="#defn-digest">Definition 33</a>.</p>
</li>
<li>
<p>\$Seal-Id\$ is the type index showing that a digest item (<a href="#defn-digest">Definition 33</a>)
of varying type (<a href="#defn-scale-variable-type">Definition 154</a>) is of type <em>Seal</em>.</p>
</li>
<li>
<p>\$"AuthorityDirectory"^(cc E_c)\$ is the set of Authority ID for block
producers of epoch \$cc E_c\$.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>\$"AuthorId"\$ is the public session key of the block producer.</p>
</li>
</ol>
</div>
</li>
<li>
<p>\$Verify-Slot-Winner\$ is defined in Algorithm as described in
<a href="#algo-verify-slot-winner">Section 5.2.6.2</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="algo-verify-slot-winner"><a class="link" href="#algo-verify-slot-winner">5.2.6.2. Verify Slot Winner</a></h5>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Algorithm: \$tt "Verify-Slot-Winner"(B)\$</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>\$cc E_c larr "Current-Epoch"\$</p>
</li>
<li>
<p>\$p larr "Epoch-Randomness"(c)\$</p>
</li>
<li>
<p>\$"Verify-VRF"(p, H_"BABE".(pi, d),H_"BABE"(B).s,c)\$</p>
</li>
<li>
<p>\$"if"  d_B &gt;= t\$</p>
</li>
<li>
<p>\$"    " "error 'Block producer is not a winner of the slot'"\$</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>\$"Epoch-Randomness"\$ is defined in <a href="#defn-epoch-randomness">Definition 72</a>.</p>
</li>
<li>
<p>\$H_"BABE"(B)\$ is the BABE header defined in <a href="#defn-babe-header">Definition 70</a>.</p>
</li>
<li>
<p>\$(d_B,pi_B)\$ is the block lottery result for block \$B\$.</p>
</li>
<li>
<p>\$"Verify-VRF"\$ is described in <a href="#sect-vrf">Section 10.4</a>.</p>
</li>
<li>
<p>\$t\$ is the winning threshold as defined in <a href="#defn-winning-threshold">Definition 65</a>.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-block-building"><a class="link" href="#sect-block-building">5.2.7. Block Building Process</a></h4>
<div class="paragraph">
<p>The block building process is triggered by the Algorithm as defined in
<a href="#algo-block-production">Section 5.2.4.1</a> of the consensus engine which runs the Algorithm as
defined in <a href="#algo-build-block">Section 5.2.7.1</a></p>
</div>
<div class="sect4">
<h5 id="algo-build-block"><a class="link" href="#algo-build-block">5.2.7.1. Build Block</a></h5>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Algorithm: \$tt "Build-Block"(C_"Best", s)\$</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>\$P_B larr "Head"(C_"Best")\$</p>
</li>
<li>
<p>\$"Head"(B) larr (H_p larr H_h(P_B), H_i larr H_i(P_B)+1,H_r larr phi, H_e larr phi, H_d larr phi)\$</p>
</li>
<li>
<p>\$"Call-Runtime-Entry"(tt "Core_initialize_block", "Head"(B))\$</p>
</li>
<li>
<p>\$"I-D" larr "Call-Runtime-Entry"(tt "BlockBuilder_inherent_extrinsic", "Inherent-Data")\$</p>
</li>
<li>
<p>\$"for " E " in " "I-D"\$</p>
</li>
<li>
<p>\$"    " "Call-Runtime-Entry"(tt "BlockBuilder_apply_extrinsics", E)\$</p>
</li>
<li>
<p>\$"while not End-of-Slot"(s)\$</p>
</li>
<li>
<p>\$"    " E larr "Next-Ready-Extrinsic"()\$</p>
</li>
<li>
<p>\$"    " R larr "Call-Runtime-Entry"(tt "BlockBuilder_apply_extrinsics", E)\$</p>
</li>
<li>
<p>\$"    " "if Block-Is-Full"(R)\$</p>
</li>
<li>
<p>\$"    " "    " "break"\$</p>
</li>
<li>
<p>\$"    " "if Should-Drop"(R)\$</p>
</li>
<li>
<p>\$"    " "    " "Drop"(E)\$</p>
</li>
<li>
<p>\$"Head"(B) larr "Call-Runtime-Entry"(tt "BlockBuilder_finalize_block", B)\$</p>
</li>
<li>
<p>\$B larr "Add-Seal"(B)\$</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$C_"Best"\$ is the chain head at which the block should be constructed
("parent").</p>
</li>
<li>
<p>\$s\$ is the slot number.</p>
</li>
<li>
<p>\$"Head"(B)\$ is defined in <a href="#defn-block-header">Definition 32</a>.</p>
</li>
<li>
<p>\$"Call-Runtime-Entry"\$ is defined in <a href="#defn-call-into-runtime">Definition 30</a>.</p>
</li>
<li>
<p>\$"Inherent-Data"\$ is defined in <a href="#defn-inherent-data">Section 3.2.3.1</a>.</p>
</li>
<li>
<p>\$"End-Of-Slot"\$ indicates the end of the BABE slot as defined
<a href="#algo-slot-time">Section 5.2.3.2</a> respectively <a href="#defn-epoch-slot">Definition 60</a>.</p>
</li>
<li>
<p>\$"Next-Ready-Extrinsic"\$ indicates picking an extrinsic from the
extrinsics queue (<a href="#defn-transaction-queue">Definition 31</a>).</p>
</li>
<li>
<p>\$"Block-Is-Full"\$ indicates that the maximum block size is being used.</p>
</li>
<li>
<p>\$"Should-Drop"\$ determines based on the result \$R\$ whether the
extrinsic should be dropped or remain in the extrinsics queue and scheduled for
the next block. The <em>ApplyExtrinsicResult</em> (<a href="#defn-rte-apply-extrinsic-result">Definition 178</a>)
describes this behavior in more detail.</p>
</li>
<li>
<p>\$"Drop"\$ indicates removing the extrinsic from the extrinsic queue
(<a href="#defn-transaction-queue">Definition 31</a>).</p>
</li>
<li>
<p>\$"Add-Seal"\$ adds the seal to the block (&lt;&lt;&gt;&gt;) before sending it to
peers. The seal is removed again before submitting it to the Runtime.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-finality"><a class="link" href="#sect-finality">5.3. Finality</a></h3>
<div class="paragraph">
<p>The Polkadot Host uses GRANDPA Finality protocol to finalize blocks.
Finality is obtained by consecutive rounds of voting by the validator
nodes. Validators execute GRANDPA finality process in parallel to Block
Production as an independent service. In this section, we describe the
different functions that GRANDPA service performs to successfully
participate in the block-finalization process.</p>
</div>
<div class="sect3">
<h4 id="_preliminaries_4"><a class="link" href="#_preliminaries_4">5.3.1. Preliminaries</a></h4>
<div id="defn-grandpa-voter" class="exampleblock">
<div class="title">Definition 73. <a href="#defn-grandpa-voter">GRANDPA Voter</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>GRANDPA Voter</strong>,
\$v\$, represented by a key pair
\$(K_v^("pr"),v_("id"))\$
where \$k_v^("pr")\$ represents an
<em>ed25519</em> private key, is a
node running a GRANDPA protocol and broadcasting votes to finalize
blocks in a Polkadot Host-based chain. The <strong>set of all GRANDPA voters</strong>
for a given block B is indicated by \$bbb V_B\$. In that
regard, we have [To do: change function name, only call at genesis,
adjust V_B over the sections]</p>
</div>
<div class="stemblock">
<div class="content">
\$bbb V = tt "grandpa_authorities"(B)\$
</div>
</div>
<div class="paragraph">
<p>where \$tt "grandpa_authorities"\$ is a function entry of the Runtime
described in <a href="#sect-rte-grandpa-auth">Section 26.7.1</a>. We refer to \$bbb V_B\$ as
\$bbb V\$ when there is no chance of ambiguity.</p>
</div>
<div class="paragraph">
<p>Analogously we say that a Polkadot node is a <strong>non-voter node</strong> for block
\$B\$, if it does not own any of the key pairs in
\$bbb V_B\$.</p>
</div>
</div>
</div>
<div id="defn-authority-set-id" class="exampleblock">
<div class="title">Definition 74. <a href="#defn-authority-set-id">Authority Set Id</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>authority set Id</strong> (\$"id"_(bbb V)\$) is an incremental counter which
tracks the amount of authority list changes that occurred
(<a href="#defn-consensus-message-digest">Definition 59</a>). Starting with the value of zero at genesis,
the Polkadot Host increments this value by one every time a <strong>Scheduled Change</strong>
or a <strong>Forced Change</strong> occurs. The authority set Id is an unsigned 64-bit integer.</p>
</div>
</div>
</div>
<div id="defn-grandpa-state" class="exampleblock">
<div class="title">Definition 75. <a href="#defn-grandpa-state">GRANDPA State</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>GRANDPA state</strong>, \$"GS"\$, is defined as:</p>
</div>
<div class="stemblock">
<div class="content">
\$"GS" := {bbb V, "id"_(bbb V),r}\$
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$bbb V\$: is the set of voters.</p>
</li>
<li>
<p>\$"id"_(bbb V)\$: is the authority set ID (<a href="#defn-authority-set-id">Definition 74</a>).</p>
</li>
<li>
<p>\$r\$: is the voting round number.</p>
</li>
</ul>
</div>
</div>
</div>
<div id="defn-vote" class="exampleblock">
<div class="title">Definition 76. <a href="#defn-vote">GRANDPA Vote</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>GRANDPA vote</strong> or simply a vote for block \$B\$ is an ordered pair defined
as</p>
</div>
<div class="stemblock">
<div class="content">
\$V(B) := (H_h(B),H_i(B))\$
</div>
</div>
<div class="paragraph">
<p>where \$H_h(B)\$ and \$H_i (B)\$ are the block hash
(<a href="#defn-block-header-hash">Definition 34</a>) and the block number (<a href="#defn-block-header">Definition 32</a>).</p>
</div>
</div>
</div>
<div id="defn-voting-rounds" class="exampleblock">
<div class="title">Definition 77. <a href="#defn-voting-rounds">Voting Rounds</a></div>
<div class="content">
<div class="paragraph">
<p>Voters engage in a maximum of two sub-rounds of voting for each round \$r\$.
The first sub-round is called <strong>pre-vote</strong> and the second sub-round is called
<strong>pre-commit</strong>.</p>
</div>
<div class="paragraph">
<p>By \$V_v^(r,"pv")\$ and \$V_v^(r,"pc")\$ we refer to the vote cast by
voter \$v\$ in round \$r\$ (for block \$B\$) during the pre-vote and
the pre-commit sub-round respectively.</p>
</div>
<div class="paragraph">
<p>Voting is done by means of broadcasting voting messages (<a href="#sect-msg-grandpa">Section 4.8.6</a>)
to the network. Validators inform their peers about the block finalized in round
\$r\$ by broadcasting a commit message (<a href="#algo-grandpa-round">Algorithm 1</a>).</p>
</div>
</div>
</div>
<div id="defn-sign-round-vote" class="exampleblock">
<div class="title">Definition 78. <a href="#defn-sign-round-vote">Vote Signature</a></div>
<div class="content">
<div class="paragraph">
<p>\$"Sign"_(v_i)^(r,"stage")\$ refers to the signature of a voter for a specific
message in a round and is formally defined as:</p>
</div>
<div class="stemblock">
<div class="content">
\$"Sign"_(v_i)^(r,"stage") := "Sig"_("ed25519")("msg",r,"id"_(bbb V))\$
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$"msg"\$: is an byte array containing the message to be signed
(<a href="#defn-vote">Definition 76</a>).</p>
</li>
<li>
<p>\$r\$: is an unsigned 64-bit integer is the round number.</p>
</li>
<li>
<p>\$"id"_(bbb V)\$: is an unsigned 64-bit integer indicating the authority
set Id (<a href="#defn-authority-list">Definition 58</a>).</p>
</li>
</ul>
</div>
</div>
</div>
<div id="defn-grandpa-justification" class="exampleblock">
<div class="title">Definition 79. <a href="#defn-grandpa-justification">Justification</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>justification</strong> for block \$B\$ in round \$r\$,
\$J^(r,"stage")(B)\$, is a vector of pairs of the type:</p>
</div>
<div class="stemblock">
<div class="content">
\$(V(B'),"Sign"_(v_i)^(r,"stage")(B'),v_("id"))\$
</div>
</div>
<div class="paragraph">
<p>in which either</p>
</div>
<div class="stemblock">
<div class="content">
\$B' &gt;= B\$
</div>
</div>
<div class="paragraph">
<p>or \$V_(v_i)^(r,"pc")(B')\$ is an equivocatory vote.</p>
</div>
<div class="paragraph">
<p>In all cases, \$"Sign"_(v_i)^(r,"stage")(B')\$ is the signature
(<a href="#defn-sign-round-vote">Definition 78</a>) of voter \$v_i in bbb V_B\$ broadcasted during
either the pre-vote (stage = pv) or the pre-commit (stage = pc) sub-round of
round r. A <strong>valid justification</strong> must only contain up-to-one valid vote from
each voter and must not contain more than two equivocatory votes from each
voter.</p>
</div>
</div>
</div>
<div id="defn-finalizing-justification" class="exampleblock">
<div class="title">Definition 80. <a href="#defn-finalizing-justification">Finalizing Justification</a></div>
<div class="content">
<div class="paragraph">
<p>We say \$J^(r,"pc")(B)\$ <strong>justifies the finalization</strong> of \$B' &gt;= B\$ <strong>for
a non-voter node</strong> \$n\$ if the number of valid signatures in
\$J^(r,"pc")(B)\$ for \$B'\$ is greater than \$2/3|bbb V_B|\$.</p>
</div>
<div class="paragraph">
<p>Note that \$J^(r,"pc")(B)\$ can only be used by a non-voter node to finalize
a block. In contrast, a voter node can only be assured of the finality
(<a href="#defn-finalized-block">Definition 88</a>) of block \$B\$ by actively participating in the
voting process. That is by invoking Algorithm as defined in
<a href="#algo-grandpa-round">Algorithm 1</a>.</p>
</div>
<div class="paragraph">
<p>The GRANDPA protocol dictates how an honest voter should vote in each sub-round,
which is described by Algorithm as defined in <a href="#algo-grandpa-round">Algorithm 1</a>. After
defining what constitutes a vote in GRANDPA, we define how GRANDPA counts votes.</p>
</div>
</div>
</div>
<div id="defn-equivocation" class="exampleblock">
<div class="title">Definition 81. <a href="#defn-equivocation">Equivocation</a></div>
<div class="content">
<div class="paragraph">
<p>Voter \$v\$ <strong>equivocates</strong> if they broadcast two or more valid votes to blocks
during one voting sub-round. In such a situation, we say that \$v\$ is an
<strong>equivocator</strong> and any vote \$V_v^(r,"stage")(B)\$ cast by \$v\$ in that
sub-round is an <strong>equivocatory vote</strong>, and</p>
</div>
<div class="stemblock">
<div class="content">
\$cc E^(r,"stage")\$
</div>
</div>
<div class="paragraph">
<p>represents the set of all equivocators voters in sub-round <em>stage</em> of
round \$r\$. When we want to refer to the number of equivocators whose
equivocation has been observed by voter \$v\$ we refer to it by:</p>
</div>
<div class="stemblock">
<div class="content">
\$cc E_("obs"(v))^(r,"stage")\$
</div>
</div>
<div class="paragraph">
<p>The Polkadot Host must detect equivocations committed by other validators and
submit those to the Runtime as described in
<a href="#sect-grandpaapi_submit_report_equivocation_unsigned_extrinsic">Section 26.7.2</a>.</p>
</div>
<div class="paragraph">
<p>A vote \$V_v^(r,"stage") = V(B)\$ is <strong>invalid</strong> if</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$H (B)\$ does not correspond to a valid block.</p>
</li>
<li>
<p>\$B\$ is not an (eventual) descendant of a previously finalized block.</p>
</li>
<li>
<p>\$M_v^(r,"stage")\$ does not bear a valid signature.</p>
</li>
<li>
<p>\$"id"_(bbb V)\$ does no match the current \$bbb V\$.</p>
</li>
<li>
<p>\$V_v^(r,"stage")\$ is an equivocatory vote.</p>
</li>
</ul>
</div>
</div>
</div>
<div id="defn-observed-direct-votes" class="exampleblock">
<div class="title">Definition 82. <a href="#defn-observed-direct-votes">Set of Observed Direct Votes</a></div>
<div class="content">
<div class="paragraph">
<p>For validator \$v\$, <strong>the set of observed direct votes for Block \$B\$ in
round \$r\$</strong>, formally denoted by \$"VD"_("obs"(v))^(r,"stage")(B)\$ is
equal to the union of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>set of <em>valid</em> votes \$V_(v_i)^(r,"stage")\$ cast in round \$r\$ and
received by \$v\$ such that \$V_(v_i)^(r,"stage") = V(B)\$.</p>
</li>
</ul>
</div>
</div>
</div>
<div id="defn-observed-votes" class="exampleblock">
<div class="title">Definition 83. <a href="#defn-observed-votes">Set of Total Observed Votes</a></div>
<div class="content">
<div class="paragraph">
<p>We refer to <strong>the set of total votes observed by voter \$v\$ in sub-round
<em>stage</em> of round \$r\$</strong> by \$V_("obs"(v))^(r,"stage")\$.</p>
</div>
<div class="paragraph">
<p>The <strong>set of all observed votes by \$v\$ in the sub-round stage of round
\$r\$ for block \$B\$</strong>, <strong>\$V_("obs"(v))^(r,"stage")\$</strong> is equal to all
of the observed direct votes cast for block \$B\$ and all of the \$B\$’s
descendants defined formally as:</p>
</div>
<div class="stemblock">
<div class="content">
\$V_("obs"(v))^(r,"stage")(B) := uuu_(v_i in bbb V, B &gt;= B') "VD"_("obs"(v))^(r,"stage")(B')\$
</div>
</div>
<div class="paragraph">
<p>The <strong>total number of observed votes for Block \$B\$ in round \$r\$</strong> is
defined to be the size of that set plus the total number of equivocator voters:</p>
</div>
<div class="stemblock">
<div class="content">
\$#V_("obs"(v))^(r,"stage")(B) := |V_("obs"(v))^(r,"stage")(B)|+|cc E_("obs"(v))^(r,"stage")|\$
</div>
</div>
<div class="paragraph">
<p>Note that for genesis state we always have
\$#V_("obs"(v))^(r,"pv")(B) = |bbb V|\$.</p>
</div>
</div>
</div>
<div id="defn-total-potential-votes" class="exampleblock">
<div class="title">Definition 84. <a href="#defn-total-potential-votes">Set of Total Potential Votes</a></div>
<div class="content">
<div class="paragraph">
<p>Let \$V_("unobs"(v))^(r,"stage")\$ be the set of voters whose vote in the
given stage has not been received. We define the <strong>total number of potential
votes for Block \$B\$ in round \$r\$</strong> to be:</p>
</div>
<div class="stemblock">
<div class="content">
\$#V_("obs"(v),"pot")^(r,"stage")(B) := |V_("obs"(v))^(r,"stage")(B)|+|V_("unobs"(v))^(r,"stage")|+"Min"(1/3|bbb V|,|bbb V|-|V_("obs"(v))^(r,"stage")(B)|-|V_("unobs"(v))^(r,"stage")|)\$
</div>
</div>
</div>
</div>
<div id="defn-grandpa-ghost" class="exampleblock">
<div class="title">Definition 85. <a href="#defn-grandpa-ghost">Current Pre-Voted Block</a></div>
<div class="content">
<div class="paragraph">
<p>The current <strong>pre-voted</strong> block \$B_v^(r,"pv")\$ also know as GRANDPA GHOST is
the block chosen by Algorithm as described in <a href="#algo-grandpa-ghost">Section 5.3.4.3</a>:</p>
</div>
<div class="stemblock">
<div class="content">
\$B_v^(r,"pv") := "GRANDPA-GHOST"(r)\$
</div>
</div>
<div class="paragraph">
<p>Finally, we define when a voter \$v\$ sees a round as completable, that is
when they are confident that \$B_v^(r,"pv")\$ is an upper bound for what is
going to be finalized in this round.</p>
</div>
</div>
</div>
<div id="defn-grandpa-completable" class="exampleblock">
<div class="title">Definition 86. <a href="#defn-grandpa-completable">Completable Round</a></div>
<div class="content">
<div class="paragraph">
<p>We say that
round \$r\$ is <strong>completable</strong> if
\$|V_("obs"(v))^(r,"pc")|+ cc E_("obs"(v))^(r,"pc") &gt; 2/3 bbb V\$
and for all \$B' &gt; B_v^(r,"pv")\$:</p>
</div>
<div class="stemblock">
<div class="content">
\$|V_("obs"(v))^(r,"pc")|- cc E_("obs"(v))^(r,"pc") - |V_("obs"(v))^(r,"pc")(B')|&gt; 2/3|bbb V|\$
</div>
</div>
<div class="paragraph">
<p>Note that in practice we only need to check the inequality for those \$B' &gt;
B_v^(r,"pv")\$ where \$|V_("obs"(v))^(r,"pc")(B')| &gt; 0\$.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_initiating_the_grandpa_state"><a class="link" href="#_initiating_the_grandpa_state">5.3.2. Initiating the GRANDPA State</a></h4>
<div class="paragraph">
<p>In order to participate coherently in the voting process, a validator must
initiate its state and sync it with other active validators. In particular,
considering that voting is happening in different distinct rounds where each
round of voting is assigned a unique sequential round number \$r_v\$, it
needs to determine and set its round counter \$r\$ equal to the voting round
\$r_n\$ currently undergoing in the network. Algorithm as defined in
<a href="#algo-initiate-grandpa">Section 5.3.2.2</a> mandates the initialization procedure for GRANDPA
protocol for a joining validator.</p>
</div>
<div class="paragraph">
<p>The process of joining a new voter set is different from the one of rejoining
the current voter set after a network disconnect. The details of this
distinction are described further in this section.</p>
</div>
<div class="sect4">
<h5 id="_voter_set_changes"><a class="link" href="#_voter_set_changes">5.3.2.1. Voter Set Changes</a></h5>
<div class="paragraph">
<p>A GRANDPA voter node which is initiating GRANDPA protocol as part of joining a
new authority set is required to execute the Algorithm as described in
<a href="#algo-initiate-grandpa">Section 5.3.2.2</a>. The algorithm mandates the initialization procedure
for GRANDPA protocol. Note that GRANDPA round number reset to 0 for every
authority set change.</p>
</div>
<div class="paragraph">
<p>Voter set changes are signalled by Runtime via a consensus engine message
(<a href="#sect-consensus-message-digest">Section 5.1.2</a>). When Authorities process such messages they
must not vote on any block with a higher number than the block at which the
change is supposed to happen. The new authority set should reinitiate GRANDPA
protocol by executing Algorithm as defined in <a href="#algo-initiate-grandpa">Section 5.3.2.2</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="algo-initiate-grandpa"><a class="link" href="#algo-initiate-grandpa">5.3.2.2. Initiate Grandpa</a></h5>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Algorithm: \$"Initiate-Grandpa"(r_("last"), B_("last"))\$</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>\$"Last-Finalized-Block" larr B_("last")\$</p>
</li>
<li>
<p>\$"Best-Final-Candidate"(0) larr B_("last")\$</p>
</li>
<li>
<p>\$"GRANDPA-GHOST"(0) larr B_("last")\$</p>
</li>
<li>
<p>\$"Last-Completed-Round" larr 0\$</p>
</li>
<li>
<p>\$r_n larr 1\$</p>
</li>
<li>
<p>\$"Play-Grandpa-Round"(r_n)\$</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>where \$B_("last")\$ is the last block which has been finalized on the chain
(<a href="#defn-finalized-block">Definition 88</a>). \$r_("last")\$ is equal to the latest round the
voter has observed that other voters are voting on. The voter obtains this
information through various gossiped messages including those mentioned in
<a href="#defn-finalized-block">Definition 88</a>. \$r_("last")\$ is set to <em>0</em> if the GRANDPA node is
initiating the GRANDPA voting process as a part of a new authority set. This is
because the GRANDPA round number resets to <em>0</em> for every authority set change.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_rejoining_the_same_voter_set"><a class="link" href="#_rejoining_the_same_voter_set">5.3.3. Rejoining the Same Voter Set</a></h4>
<div class="paragraph">
<p>When a voter node rejoins the network after a disconnect from the voter set and
with the condition that there has been no change to the voter set at the time of
the disconnect, the node must continue performing the GRANDPA protocol at the
same state as before getting disconnected from the network, ignoring any
possible progress in GRANDPA finalization. Following reconnection, the node
eventually gets updated to the current GRANDPA round and synchronizes its state
with the rest of the voting set through the process called Catchup
(<a href="#sect-grandpa-catchup">Section 5.4.1</a>).</p>
</div>
</div>
<div class="sect3">
<h4 id="_voting_process_in_round_r"><a class="link" href="#_voting_process_in_round_r">5.3.4. Voting Process in Round \$r\$</a></h4>
<div class="paragraph">
<p>For each round \$r\$, an honest voter \$v\$ must participate in the voting
process by following the Algorithm as defined in <a href="#algo-grandpa-round">Algorithm 1</a>.</p>
</div>
<div class="sidebarblock">
<div class="content">
          <div id="algo-grandpa-round" class="imageblock">
            <div class="content"><div class="ps-root">
<div class="ps-algorithm with-caption">
<p class="ps-line" style="text-indent:-1.2em;padding-left:1.2em;">
<span class="ps-keyword">Algorithm 1 </span>Play-Grandpa-Round(r)</p>
<div class="ps-algorithmic with-linenum">
<div class="ps-block" style="margin-left:1.7999999999999998em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">1:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mrow><mi>r</mi><mo separator="true">,</mo><mi>v</mi></mrow></msub><mo>←</mo></mrow><annotation encoding="application/x-tex">t_{r, v} \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> Current local time</p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">2:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>primary</mtext><mo>←</mo></mrow><annotation encoding="application/x-tex">\textrm{primary} \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8623000000000001em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">primary</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Derive-Primary</span>(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span>)</p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">3:</span><span class="ps-keyword">if </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mo>=</mo><mtext>primary</mtext></mrow><annotation encoding="application/x-tex">v = \textrm{primary}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8623000000000001em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">primary</span></span></span></span></span><span class="ps-keyword"> then</span></p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">4:</span><span style="font-style:normal;font-variant:small-caps;">Broadcast</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msubsup><mi>M</mi><mi>v</mi><mrow><mi>r</mi><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mtext>Fin</mtext></mrow></msubsup></mrow><annotation encoding="application/x-tex">(M_{v}^{r - 1, \textrm{Fin}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0913309999999998em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord text mtight"><span class="mord textrm mtight">Fin</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>(<span style="font-style:normal;font-variant:small-caps;">Best-Final-Candidate</span>(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span>-1))</p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">5:</span><span class="ps-keyword">if </span><span style="font-style:normal;font-variant:small-caps;">Best-Final-Candidate</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>r</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(r - 1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>⩾</mo></mrow><annotation encoding="application/x-tex">\geqslant</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7733399999999999em;vertical-align:-0.13667em;"></span><span class="mrel amsrm">⩾</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Last-Finalized-Block</span><span class="ps-keyword"> then</span></p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">6:</span><span style="font-style:normal;font-variant:small-caps;">Broadcast(</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>M</mi><mi>v</mi><mrow><mi>r</mi><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mtext>Prim</mtext></mrow></msubsup></mrow><annotation encoding="application/x-tex">M_{v}^{r - 1, \textrm{Prim}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.088331em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord text mtight"><span class="mord textrm mtight">Prim</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>(<span style="font-style:normal;font-variant:small-caps;">Best-Final-Candidate</span>(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span>-1)))</p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">7:</span><span class="ps-keyword">end if</span></p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">8:</span><span class="ps-keyword">end if</span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">9:</span><span style="font-style:normal;font-variant:small-caps;">Receive-Messages</span>(<span style="font-weight:bold;">until</span> Time <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>⩾</mo><msub><mi>t</mi><mrow><msub><mi>r</mi><mo separator="true">,</mo></msub><mi>v</mi></mrow></msub><mo>+</mo><mn>2</mn><mo>×</mo><mi>T</mi></mrow><annotation encoding="application/x-tex">\geqslant t_{r_,v} + 2 \times T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7733399999999999em;vertical-align:-0.13667em;"></span><span class="mrel amsrm">⩾</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.9623999999999999em;vertical-align:-0.34731999999999996em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.0676em;"><span style="top:-2.357em;margin-left:-0.02778em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mpunct mtight">,</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34731999999999996em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span><span style="font-weight:bold;">or</span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span><span style="font-weight:bold;">is</span> completable)</p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">10:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">L \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Best-Final-Candidate</span>(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span>-1)</p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">11:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">N \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Best-PreVote-Candidate</span>(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span>)</p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">12:</span><span style="font-style:normal;font-variant:small-caps;">Broadcast</span>(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>M</mi><mi>v</mi><mrow><mi>r</mi><mo separator="true">,</mo><mtext>pv</mtext></mrow></msubsup><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">M_v^{r, \textrm{pv}} (N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-2.4530000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mpunct mtight">,</span><span class="mord text mtight"><span class="mord textrm mtight">pv</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span>)</p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">13:</span><span style="font-style:normal;font-variant:small-caps;">Receive-Messages</span>(<span style="font-weight:bold;">until</span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>B</mi><mi>v</mi><mrow><mi>r</mi><mo separator="true">,</mo><mtext>pv</mtext></mrow></msubsup><mo>⩾</mo><mi>L</mi></mrow><annotation encoding="application/x-tex">B^{r,\textrm{pv}}_v \geqslant L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.93033em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-2.4530000000000003em;margin-left:-0.05017em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mpunct mtight">,</span><span class="mord text mtight"><span class="mord textrm mtight">pv</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel amsrm">⩾</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">L</span></span></span></span><span style="font-weight:bold;">and</span> (Time <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>⩾</mo><msub><mi>t</mi><mrow><msub><mi>r</mi><mo separator="true">,</mo></msub><mi>v</mi></mrow></msub><mo>+</mo><mn>4</mn><mo>×</mo><mi>T</mi></mrow><annotation encoding="application/x-tex">\geqslant t_{r_,v} + 4 \times T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7733399999999999em;vertical-align:-0.13667em;"></span><span class="mrel amsrm">⩾</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.9623999999999999em;vertical-align:-0.34731999999999996em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.0676em;"><span style="top:-2.357em;margin-left:-0.02778em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mpunct mtight">,</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.34731999999999996em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span>  <span style="font-weight:bold;">or</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span><span style="font-weight:bold;">is</span> completable))</p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">14:</span><span style="font-style:normal;font-variant:small-caps;">Broadcast(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>M</mi><mi>v</mi><mrow><mi>r</mi><mo separator="true">,</mo><mtext>pc</mtext></mrow></msubsup></mrow><annotation encoding="application/x-tex">M_v^{r, \textrm{pc}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.93033em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-2.4530000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mpunct mtight">,</span><span class="mord text mtight"><span class="mord textrm mtight">pc</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>B</mi><mi>v</mi><mrow><mi>r</mi><mo separator="true">,</mo><mtext>pv</mtext></mrow></msubsup></mrow><annotation encoding="application/x-tex">B_v^{r, \textrm{pv}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.93033em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-2.4530000000000003em;margin-left:-0.05017em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mpunct mtight">,</span><span class="mord text mtight"><span class="mord textrm mtight">pv</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>))</span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">15:</span><span class="ps-keyword">repeat</span></p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">16:</span><span style="font-style:normal;font-variant:small-caps;">Receive-Messages</span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">17:</span><span style="font-style:normal;font-variant:small-caps;">Attempt-To-Finalize-At-Round</span>(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span>)</p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">18:</span><span class="ps-keyword">until </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> <span style="font-weight:bold;">is</span> completable <span style="font-weight:bold;">and</span> <span style="font-style:normal;font-variant:small-caps;">Finalizable</span>(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span>) <span style="font-weight:bold;">and</span> <span style="font-style:normal;font-variant:small-caps;">Last-Finalized-Block</span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>⩾</mo></mrow><annotation encoding="application/x-tex">\geqslant</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7733399999999999em;vertical-align:-0.13667em;"></span><span class="mrel amsrm">⩾</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Best-Final-Candidate</span>(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">r - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>)</p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">19:</span><span style="font-style:normal;font-variant:small-caps;">Play-Grandpa-round</span>(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">r + 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>)</p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">20:</span><span class="ps-keyword">repeat</span></p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">21:</span><span style="font-style:normal;font-variant:small-caps;">Receive-Messages</span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">22:</span><span style="font-style:normal;font-variant:small-caps;">Attempt-To-Finalize-At-Round</span>(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span>)</p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">23:</span><span class="ps-keyword">until </span><span style="font-style:normal;font-variant:small-caps;">Last-Finalized-Block</span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>⩾</mo></mrow><annotation encoding="application/x-tex">\geqslant</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7733399999999999em;vertical-align:-0.13667em;"></span><span class="mrel amsrm">⩾</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Best-Final-Candidate</span>(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span>)</p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">24:</span><span class="ps-keyword">if </span><span style="font-style:normal;font-variant:small-caps;">Last-Completed-Round</span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mi>r</mi></mrow><annotation encoding="application/x-tex"> &lt; r </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span><span class="ps-keyword"> then</span></p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">25:</span><span style="font-style:normal;font-variant:small-caps;">Last-Completed-Round</span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>←</mo><mi>r</mi></mrow><annotation encoding="application/x-tex">\leftarrow r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span></p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">26:</span><span class="ps-keyword">end if</span></p>
</div>
</div>
</div>
</div></div>
            <div class="title">Algorithm 1. <a href="#algo-grandpa-round">Play-Grandpa-Round(r)</a></div>
          </div>
<div class="dlist">
<dl>
<dt class="hdlist1">where</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>\$T\$ is sampled from a log-normal distribution whose mean and standard
deviation are equal to the average network delay for a message to be sent and
received from one validator to another.</p>
</li>
<li>
<p>\$"Derive-Primary"\$ is described in <a href="#algo-derive-primary">Section 5.3.4.1</a>.</p>
</li>
<li>
<p>The condition of <em>completablitiy</em> is defined in <a href="#defn-grandpa-completable">Definition 86</a>.</p>
</li>
<li>
<p>\$"Best-Final-Candidate"\$ function is explained in <a href="#algo-grandpa-best-candidate">Section 5.3.4.2</a>.</p>
</li>
<li>
<p>\$"Attempt-To-Finalize-At-Round"(r)\$ is described in <a href="#algo-attempt-to–finalize">Algorithm 2</a>.</p>
</li>
<li>
<p>\$"Finalizable"\$ is defined in <a href="#algo-finalizable">Algorithm 3</a>.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect4">
<h5 id="algo-derive-primary"><a class="link" href="#algo-derive-primary">5.3.4.1. Derive Primary</a></h5>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Algorithm: \$"Derive-Primary"(r)\$</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>\$"return r mod" |bbb V|\$</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>where \$r\$ is the GRANDPA round whose primary is to be determined.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="algo-grandpa-best-candidate"><a class="link" href="#algo-grandpa-best-candidate">5.3.4.2. Best Final Candidate</a></h5>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Algorithm: \$"Best-Final-Candidate"(r)\$</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>\$B_v^(r,pv) larr "GRANDPA-GHOST"(r)\$</p>
</li>
<li>
<p>\$"if " r = 0\$</p>
</li>
<li>
<p>\$"    " "return " B_v^(r,pv)\$</p>
</li>
<li>
<p>\$"else"\$</p>
</li>
<li>
<p>\$"    " cc C larr {B'|B' &lt;= B_v^(r,pv):#V_("obv"(v),pot)^(r,pc) &gt; 2//3 \|bbb V\|}\$</p>
</li>
<li>
<p>\$"    " "if " cc C = phi\$</p>
</li>
<li>
<p>\$"    " "    " "return " B_v^(r,pv)\$</p>
</li>
<li>
<p>\$"    " "else"\$</p>
</li>
<li>
<p>\$"    " "    " "return " E in cc C: H_n(E)="Max"(H_n(B'):B' in cc C)\$</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>where \$#V_("obv"(v),pot)^(r,pc)\$</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="algo-grandpa-ghost"><a class="link" href="#algo-grandpa-ghost">5.3.4.3. Grandpa Ghost</a></h5>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Algorithm: \$"GRANDPA-GHOST"(r)\$</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>\$"if " r = 0\$</p>
</li>
<li>
<p>\$"    " G larr B_("last")\$</p>
</li>
<li>
<p>\$"else"\$</p>
</li>
<li>
<p>\$"    " L larr "Best-Final-Candidate"(r-1)\$</p>
</li>
<li>
<p>\$"    " P larr {AA B &gt; L \|#V_("obs"(v))^(r,pv)(B) &gt;= 2//3 \|bbb V\|}\$</p>
</li>
<li>
<p>\$"    " "if P" = phi\$</p>
</li>
<li>
<p>\$"    " "    " G larr L\$</p>
</li>
<li>
<p>\$"    " "else"\$</p>
</li>
<li>
<p>\$"    " "    " G in P: H_n(G) = "Max"(H_n(B)\|AA B in P)\$</p>
</li>
<li>
<p>\$"return G"\$</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$B_("last")\$ is the last block which has been finalized on the chain
(<a href="#defn-finalized-block">Definition 88</a>).</p>
</li>
<li>
<p>\$#V_("obs"(v))^(r,pv)(B)\$ is defined in <a href="#defn-observed-votes">Definition 83</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_best_prevote_candidate"><a class="link" href="#_best_prevote_candidate">5.3.4.4. Best PreVote Candidate</a></h5>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Algorithm: \$"Best-PreVote-Candidate"(r)\$</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>\$B_v^(r,pv) larr "GRANDPA-GHOST"(r)\$</p>
</li>
<li>
<p>\$"if Received"(M_(v_("primary"))^(r,"prim")(B)) " and " B_v^(r,pv) &gt;= B &gt; L\$</p>
</li>
<li>
<p>\$"    " N larr B\$</p>
</li>
<li>
<p>\$"else"\$</p>
</li>
<li>
<p>\$"    " N larr B_v^(r,pv)\$</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$B_("last")\$ is the last block which has been finalized on the chain
(<a href="#defn-finalized-block">Definition 88</a>).</p>
</li>
<li>
<p>\$#V_("obs"(v))^(r,pv)(B)\$ is defined in <a href="#defn-observed-votes">Definition 83</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
          <div id="algo-attempt-to–finalize" class="imageblock">
            <div class="content"><div class="ps-root">
<div class="ps-algorithm with-caption">
<p class="ps-line" style="text-indent:-1.2em;padding-left:1.2em;">
<span class="ps-keyword">Algorithm 2 </span>Attempt-To-Finalize-At-Round(r)</p>
<div class="ps-algorithmic with-linenum">
<div class="ps-block" style="margin-left:1.7999999999999998em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">1:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">L \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span><span style="font-style:normal;font-variant:small-caps;">Last-Finalized-Block</span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">2:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">E \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span><span style="font-style:normal;font-variant:small-caps;">Best-Final-Candidate</span>(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span>)</p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">3:</span><span class="ps-keyword">if </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo>⩾</mo><mi>L</mi></mrow><annotation encoding="application/x-tex">E \geqslant L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8200000000000001em;vertical-align:-0.13667em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel amsrm">⩾</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">L</span></span></span></span><span style="font-weight:bold;">and</span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>V</mi><mrow><mtext>obs</mtext><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><mrow><mi>r</mi><mo separator="true">,</mo><mtext>pc</mtext></mrow></msubsup><mo stretchy="false">(</mo><mi>E</mi><mo stretchy="false">)</mo><mo>&gt;</mo><mn>2</mn><mi mathvariant="normal">/</mi><mn>3</mn><mi mathvariant="normal">∣</mi><mi mathvariant="double-struck">V</mi><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">{V^{r, \textrm{pc}}_{\textrm{obs}(v)}}(E) &gt; 2 / 3 |\mathbb{V}|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2974999999999999em;vertical-align:-0.5151999999999999em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7823em;"><span style="top:-2.3598em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord textrm mtight">obs</span></span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.1809080000000005em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mpunct mtight">,</span><span class="mord text mtight"><span class="mord textrm mtight">pc</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5151999999999999em;"><span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2/3∣</span><span class="mord mathbb">V</span><span class="mord">∣</span></span></span></span><span class="ps-keyword"> then</span></p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">4:</span><span style="font-style:normal;font-variant:small-caps;">Last-Finalized-Block</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>←</mo><mi>E</mi></mrow><annotation encoding="application/x-tex">\leftarrow E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">5:</span><span class="ps-keyword">if </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>M</mi><mi>v</mi><mrow><mi>r</mi><mo separator="true">,</mo><mtext>Fin</mtext></mrow></msubsup><mo stretchy="false">(</mo><mi>E</mi><mo stretchy="false">)</mo><mo mathvariant="normal">∉</mo></mrow><annotation encoding="application/x-tex">M_v^{r, \textrm{Fin}} (E) \notin</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0913309999999998em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mpunct mtight">,</span><span class="mord text mtight"><span class="mord textrm mtight">Fin</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mord"><span class="mrel">∈</span></span><span class="mord vbox"><span class="thinbox"><span class="llap"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="inner"><span class="mord"><span class="mord">/</span><span class="mspace" style="margin-right:0.05555555555555555em;"></span></span></span><span class="fix"></span></span></span></span></span></span></span></span><span style="font-style:normal;font-variant:small-caps;">Received-Messages</span><span class="ps-keyword"> then</span></p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">6:</span><span style="font-style:normal;font-variant:small-caps;">Broadcast</span>(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>M</mi><mi>v</mi><mrow><mi>r</mi><mo separator="true">,</mo><mtext>Fin</mtext></mrow></msubsup><mo stretchy="false">(</mo><mi>E</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">M_v^{r, \textrm{Fin}} (E)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0913309999999998em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mpunct mtight">,</span><span class="mord text mtight"><span class="mord textrm mtight">Fin</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mclose">)</span></span></span></span>)</p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">7:</span><span class="ps-keyword">return </span></p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">8:</span><span class="ps-keyword">end if</span></p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">9:</span><span class="ps-keyword">end if</span></p>
</div>
</div>
</div>
</div></div>
            <div class="title">Algorithm 2. <a href="#algo-attempt-to–finalize">Attempt-To-Finalize-At-Round(r)</a></div>
          </div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
          <div id="algo-finalizable" class="imageblock">
            <div class="content"><div class="ps-root">
<div class="ps-algorithm with-caption">
<p class="ps-line" style="text-indent:-1.2em;padding-left:1.2em;">
<span class="ps-keyword">Algorithm 3 </span>Finalizable(r)</p>
<div class="ps-algorithmic with-linenum">
<div class="ps-block" style="margin-left:1.7999999999999998em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">1:</span><span class="ps-keyword">if </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> <span style="font-weight:bold;">is not</span>   Completable<span class="ps-keyword"> then</span></p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">2:</span><span class="ps-keyword">return </span><span style="font-weight:bold;">False</span></p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">3:</span><span class="ps-keyword">end if</span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">4:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">G \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">G</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span><span style="font-style:normal;font-variant:small-caps;">GRANDPA-GHOST</span>(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>J</mi><mrow><mi>r</mi><mo separator="true">,</mo><mi>p</mi><mi>v</mi></mrow></msup><mo stretchy="false">(</mo><mi>B</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">J^{r, pv} (B)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.664392em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span></span></span></span>)</p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">5:</span><span class="ps-keyword">if </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mo>=</mo><mi>ϕ</mi></mrow><annotation encoding="application/x-tex">G = \phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">G</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">ϕ</span></span></span></span><span class="ps-keyword"> then</span></p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">6:</span><span class="ps-keyword">return </span><span style="font-weight:bold;">False</span></p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">7:</span><span class="ps-keyword">end if</span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">8:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mi>r</mi></msub><mo>←</mo></mrow><annotation encoding="application/x-tex">E_r \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Best-Final-Candidate</span>(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span>)</p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">9:</span><span class="ps-keyword">if </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mi>r</mi></msub><mo mathvariant="normal">≠</mo><mi>ϕ</mi></mrow><annotation encoding="application/x-tex">E_r \neq \phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mord"><span class="mrel"></span></span></span><span class="fix"></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">ϕ</span></span></span></span> <span style="font-weight:bold;">and</span> <span style="font-style:normal;font-variant:small-caps;">Best-Final-Candidate</span>(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">r - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>) <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>⩽</mo><msub><mi>E</mi><mi>r</mi></msub><mo>⩽</mo><mi>G</mi></mrow><annotation encoding="application/x-tex">\leqslant E_r \leqslant G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7733399999999999em;vertical-align:-0.13667em;"></span><span class="mrel amsrm">⩽</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel amsrm">⩽</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">G</span></span></span></span><span class="ps-keyword"> then</span></p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">10:</span><span class="ps-keyword">return </span><span style="font-weight:bold;">True</span></p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">11:</span><span class="ps-keyword">else</span></p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">12:</span><span class="ps-keyword">return </span><span style="font-weight:bold;">False</span></p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">13:</span><span class="ps-keyword">end if</span></p>
</div>
</div>
</div>
</div></div>
            <div class="title">Algorithm 3. <a href="#algo-finalizable">Finalizable(r)</a></div>
          </div>
<div class="paragraph">
<p>where the condition for <em>completability</em> is defined in <a href="#defn-grandpa-completable">Definition 86</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Note that we might not always succeed in finalizing our best final candidate due to the possibility of equivocation. We might even not finalize anything in a round (although Algorithm <a href="#algo-grandpa-round">Algorithm 1</a> prevents us from moving to the round \$r+1\$ before finalizing the best final candidate of round \$r-1\$) The example in <a href="#exmp-candid-unfinalized">Definition 87</a> serves to demonstrate a situation where the best final candidate of a round cannot be finalized during its own round:</p>
</div>
<div id="exmp-candid-unfinalized" class="exampleblock">
<div class="title">Definition 87. Unfinalized Candidate</div>
<div class="content">
<div class="paragraph">
<p>Let us assume
that we have 100 voters and there are two blocks in the chain
(\$B_1 &lt; B_2\$). At round 1, we get 67 pre-votes for
\$B_2\$ and at least one pre-vote for \$B_1\$ which
means that \$"GRANDPA-GHOST"(1) = B_2\$.</p>
</div>
<div class="paragraph">
<p>Subsequently, potentially honest voters who could claim not seeing all the
pre-votes for \$B_2\$ but receiving the pre-votes for \$B_1\$ would
pre-commit to \$B_1\$. In this way, we receive 66 pre-commits for \$B_1\$
and 1 pre-commit for \$B_2\$. Henceforth, we finalize \$B_1\$ since we
have a threshold commit (67 votes) for \$B_1\$.</p>
</div>
<div class="paragraph">
<p>At this point, though, we have
\$tt "Best-Final-Candidate"(r) = B_2\$ as
\$#V_("obs"(v),"pot")^(r,"stage")(B_2) = 67\$
and \$2 &gt; 1\$.</p>
</div>
<div class="paragraph">
<p>However, at this point, the round is already completable as we know that we have
\$tt "GRANDPA-GHOST"(1) = B_2\$ as an upper limit on what we can finalize and
nothing greater than \$B_2\$ can be finalized at \$r = 1\$. Therefore, the
condition of Algorithm as described in <a href="#algo-grandpa-round">Algorithm 1</a> is
satisfied and we must proceed to round 2.</p>
</div>
<div class="paragraph">
<p>Nonetheless, we must continue to attempt to finalize round <em>1</em> in the background
as the condition of the Algorithm as defined in <a href="#algo-attempt-to–finalize">Algorithm 2</a> has
not been fulfilled.</p>
</div>
<div class="paragraph">
<p>This prevents us from proceeding to round 3 until either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We finalize \$B_2\$ in round 2, or</p>
</li>
<li>
<p>We receive an extra pre-commit vote for \$B_1\$ in round 1. This will make
it impossible to finalize \$B_2\$ in round 1, no matter to whom the remaining
pre-commits are going to be cast for (even with considering the possibility of
1/3 of voter equivocating) and therefore we have \$tt
"Best-Final-Candidate"(r) = B_1\$.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both scenarios unblock the Algorithm as defined in <a href="#algo-grandpa-round">Algorithm 1</a>,
\$tt "Last-Finalized-Block" &gt;= tt "Best-Final-Candidate"(r - 1)\$ albeit in
different ways: the former with increasing the \$tt "Last-Finalized-Block"\$
and the latter with decreasing \$tt "Best-Final-Candidate"(r - 1)\$.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-block-finalization"><a class="link" href="#sect-block-finalization">5.4. Block Finalization</a></h3>
<div id="defn-finalized-block" class="exampleblock">
<div class="title">Definition 88. <a href="#defn-finalized-block">Finalized</a></div>
<div class="content">
<div class="paragraph">
<p>A Polkadot relay chain node \$n\$ should consider block \$B\$ as
<strong>finalized</strong> if any of the following criteria hold for \$B' &gt;= B\$:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$V_("obs"(n))^(r,"pc")(B') &gt; 2/3|bbb V_(B')|\$.</p>
</li>
<li>
<p>It receives a \$M_v^(r,"Fin")(B')\$ message in which \$J^r(B)\$
justifies the finalization (<a href="#defn-grandpa-justification">Definition 79</a>).</p>
</li>
<li>
<p>It receives a block data message for \$B'\$ with \$"Just"(B')\$
(<a href="#sect-justified-block-header">Section 3.3.1.1</a>) which justifies the finalization.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Any round \$r\$ if the node \$n\$ is <em>not</em> a GRANDPA voter.</p>
</li>
<li>
<p>Only for round \$r\$ for which the node \$n\$ has invoked Algorithm <a href="#algo-grandpa-round">Algorithm 1</a> and round \$r+1\$ if \$n\$ is a GRANDPA voter and has already caught up to its peers according to the process described in Section <a href="#sect-grandpa-catchup">Section 5.4.1</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that all Polkadot relay chain nodes are supposed to process GRANDPA commit
messages regardless of their GRANDPA voter status.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-grandpa-catchup"><a class="link" href="#sect-grandpa-catchup">5.4.1. Catching up</a></h4>
<div class="paragraph">
<p>When a Polkadot node (re)joins the network during the process described in
<a href="#chapter-bootstrapping">[chapter-bootstrapping]</a>, it requests the history of state transitions in the form of blocks, which it is missing.</p>
</div>
<div class="paragraph">
<p>Nonetheless, the process is different for a GRANDPA voter node. When a voter node joins the network, it needs to gather the justification (<a href="#defn-grandpa-justification">Definition 79</a>) of the rounds it has missed. Through this process, they can safely join the voting process of the current round, on which the voting is taking place.</p>
</div>
<div class="sect4">
<h5 id="sect-sending-catchup-request"><a class="link" href="#sect-sending-catchup-request">5.4.1.1. Sending the catch-up requests</a></h5>
<div class="paragraph">
<p>When a Polkadot voter node has the same authority list as a peer voter node who is reporting
a higher number for the <em>finalized round</em> field, it should send a catch-up
request message (<a href="#defn-grandpa-catchup-request-msg">Definition 52</a>) to the reporting peer. This will allow the node to
to catch up to the more advanced finalized round, provided that the
following criteria hold:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The peer node is a GRANDPA voter, and:</p>
</li>
<li>
<p>The last known finalized round for the Polkadot node is at least 2 rounds
behind the finalized round for the peer.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_processing_the_catch_up_requests"><a class="link" href="#_processing_the_catch_up_requests">5.4.1.2. Processing the catch-up requests</a></h5>
<div class="paragraph">
<p>Only GRANDPA voter nodes are required to respond to the catch-up requests. Additionally, it is only GRANDPA voters who are supposed to send catch-up requests. As such GRANDPA voters could safely ignore the catch-up requests from non-voter nodes. When a GRANDPA voter node receives a catch-up request message, it needs to execute the algorithm as defined in <a href="#algo-process-catchup-request">Section 5.4.1.2.1</a>. Note: a voter node should not respond to catch-up requests for rounds that are actively being voted on, those are the rounds for which Algorithm <a href="#algo-grandpa-round">Algorithm 1</a> is not concluded.</p>
</div>
<div class="sect5">
<h6 id="algo-process-catchup-request"><a class="link" href="#algo-process-catchup-request">Process Catchup Request</a></h6>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Algorithm: \$"Process-Catchup-Request"(M_(i,v)^("Cat"-q)("id"_(bbb V),r))\$</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>\$"if " M_(i,v)^("Cat"-q)("id"_(bbb V),r)."id"_(bbb V) != "id"_(bbb V)\$</p>
</li>
<li>
<p>\$"    " "error 'Catching up on the different set'"\$</p>
</li>
<li>
<p>\$"if " i !in bbb P\$</p>
</li>
<li>
<p>\$"    " "error 'Requesting catching up from a non-peer'"\$</p>
</li>
<li>
<p>\$"if " r &gt; "Last-Completed-Round"\$</p>
</li>
<li>
<p>\$"    " "error 'Catching up on a round in the future'"\$</p>
</li>
<li>
<p>\$"Send"(i,M_(i,v)^("Cat"-q)("id"_(bbb V),r))\$</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$M_(i,v)^("Cat"-q)("id"_(bbb V),r)\$ is the catch-up message received
from peer \$i\$ (<a href="#defn-grandpa-catchup-request-msg">Definition 52</a>).</p>
</li>
<li>
<p>\$"id"_(bbb V)\$ is the voter set id with which the serving node is
operating</p>
</li>
<li>
<p>\$r\$ is the round number for which the catch-up is requested for.</p>
</li>
<li>
<p>\$bbb P\$ is the set of immediate peers of node \$v\$.</p>
</li>
<li>
<p>\$tt "Last-Completed-Round"\$ is initiated in the Algorithm as defined in
<a href="#algo-initiate-grandpa">Section 5.3.2.2</a> and gets updated by the Algorithm as defined in
<a href="#algo-grandpa-round">Algorithm 1</a>.</p>
</li>
<li>
<p>\$M_(v,i)^("Cat"-s)("id"_(bbb V),r)\$ is the catch-up response
(<a href="#defn-grandpa-catchup-response-msg">Definition 53</a>).</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_processing_catch_up_responses"><a class="link" href="#_processing_catch_up_responses">5.4.1.3. Processing catch-up responses</a></h5>
<div class="paragraph">
<p>A Catch-up response message contains critical information for the requester node
to update their view on the active rounds which are being voted on by GRANDPA
voters. As such, the requester node should verify the content of the catch-up
response message and subsequently updates its view of the state of the finality
of the Relay chain according to Algorithm <a href="#algo-process-catchup-response">Section 5.4.1.3.1</a>.</p>
</div>
<div class="sect5">
<h6 id="algo-process-catchup-response"><a class="link" href="#algo-process-catchup-response">Process Catchup Response</a></h6>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Algorithm: \$"Process-Catchup-Response"(M_(v,i)^("Cat"-s)("id"_(bbb V),r))\$</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>\$M_(v,i)^("Cat"-s)("id"_(bbb V),r)."id"_(bbb V),r,J^(r,pv)(B),J^(r,pc)(B),H_h(B'),H_i(B') larr "Dec"_("SC")(M_(v,i)^("Cat"-s)("id"_(bbb V),r))\$</p>
</li>
<li>
<p>\$"if " M_(v,i)^("Cat"-s)("id"_(bbb V),r)."id"_(bbb V) != "id"_(bbb V)\$</p>
</li>
<li>
<p>\$"    " "error 'Catching up on different set'"\$</p>
</li>
<li>
<p>\$"if " r &lt;= "Leading-Round"\$</p>
</li>
<li>
<p>\$"    " "error 'Catching up in to the past'"\$</p>
</li>
<li>
<p>\$J^(r,pv)(B) " is not valid"\$</p>
</li>
<li>
<p>\$"    " "error 'Invalid pre-vote justification'"\$</p>
</li>
<li>
<p>\$J^(r,pc)(B) " is not valid"\$</p>
</li>
<li>
<p>\$"    " "error 'Invalid pre-commit justification'"\$</p>
</li>
<li>
<p>\$G larr "GRANDPA-GHOST"(J^(r,pv)(B))\$</p>
</li>
<li>
<p>\$"if " G = phi\$</p>
</li>
<li>
<p>\$"    " "error 'GHOST-less catchup'"\$</p>
</li>
<li>
<p>\$"if " r " is not completable"\$</p>
</li>
<li>
<p>\$"    " "error 'Catch-up round is not completable'"\$</p>
</li>
<li>
<p>\$"if " J^(r,pc)(B) " justifies " B' " finalization"\$</p>
</li>
<li>
<p>\$"    " "error 'Unjustified catchup target finalization'"\$</p>
</li>
<li>
<p>\$"Last-Completed-Round" larr r\$</p>
</li>
<li>
<p>\$"if " i in bbb V\$</p>
</li>
<li>
<p>\$"    " "Play-Grandpa-Round(r+1)"\$</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>where \$M_(v,i)^("Cat"-s)("id"_(bbb V),r)\$ is the catch-up response
received from node \$v\$ (<a href="#defn-grandpa-catchup-response-msg">Definition 53</a>).</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-grandpa-beefy"><a class="link" href="#sect-grandpa-beefy">5.5. Bridge design (BEEFY)</a></h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The BEEFY protocol is currently in early development and subject to
change. The specification has not been completed yet.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The BEEFY (Bridge Effiency Enabling Finality Yielder) is a secondary protocol to
GRANDPA to support efficient bridging between the Polkadot network (relay chain)
and remote, segregated blockchains, such as Ethereum, which were not built with
the Polkadot interchain operability in mind. The protocol allows participants of
the remote network to verify finality proofs created by the Polkadot relay chain
validators. In other words: clients in the Ethereum network should able to
verify that the Polkadot network is at a specific state.</p>
</div>
<div class="paragraph">
<p>Storing all the information necessary to verify the state of the remote chain,
such as the block headers, is too expensive. BEEFY stores the information in a
space-efficient way and clients can request additional information over the
protocol.</p>
</div>
<div class="sect3">
<h4 id="_preliminaries_5"><a class="link" href="#_preliminaries_5">5.5.1. Preliminaries</a></h4>
<div id="defn-mmr" class="exampleblock">
<div class="title">Definition 89. <a href="#defn-mmr">Merkle Mountain Ranges</a></div>
<div class="content">
<div class="paragraph">
<p>Merkle Mountain Ranges, <strong>MMR</strong>, are used
as an efficient way to send block headers and signatures to light clients.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
MMRs have not been defined yet.
</td>
</tr>
</table>
</div>
</div>
</div>
<div id="defn-beefy-statement" class="exampleblock">
<div class="title">Definition 90. <a href="#defn-beefy-statement">Statement</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>statement</strong> is the same piece of information which every relay chain
validator is voting on. Namely, the MMR root of all the block header hashes
leading up to the latest, finalized block.</p>
</div>
</div>
</div>
<div id="defn-beefy-witness-data" class="exampleblock">
<div class="title">Definition 91. <a href="#defn-beefy-witness-data">Witness Data</a></div>
<div class="content">
<div class="paragraph">
<p><strong>Witness data</strong> contains the statement (<a href="#defn-beefy-statement">Definition 90</a>), an array
indicating which validator of the Polkadot network voted for the statement (but
not the signatures themselves) and a MMR root of the signatures. The indicators
of which validator voted for the statement are just claims and provide no
proofs. The network message is defined in
<a href="#defn-grandpa-beefy-signed-commitment-witness">Definition 57</a> and the relayer saves it on the
chain of the remote network.</p>
</div>
</div>
</div>
<div id="defn-beefy-light-client" class="exampleblock">
<div class="title">Definition 92. <a href="#defn-beefy-light-client">Light Client</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>light client</strong> is an abstract entity in a remote network such as Ethereum. It
can be a node or a smart contract with the intent of requesting finality proofs
from the Polkadot network. A light client reads the witness data
(<a href="#defn-beefy-witness-data">Definition 91</a> from the chain, then requests the signatures
directly from the relayer in order to verify those.</p>
</div>
<div class="paragraph">
<p>The light client is expected to know who the validators are and has
access to their public keys.</p>
</div>
</div>
</div>
<div id="defn-beefy-relayer" class="exampleblock">
<div class="title">Definition 93. <a href="#defn-beefy-relayer">Relayer</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>relayer</strong> (or "prover") is an abstract entity which takes finality proofs from
the Polkadot network and makes those available to the light clients. Inherently,
the relayer tries to convince the light clients that the finality proofs have
been voted for by the Polkadot relay chain validators. The relayer operates
offchain and can for example be a node or a collection of nodes.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_voting_on_statements"><a class="link" href="#_voting_on_statements">5.5.2. Voting on Statements</a></h4>
<div class="paragraph">
<p>The Polkadot Host signs a statement (<a href="#defn-beefy-statement">Definition 90</a>) and gossips it as
part of a vote (<a href="#defn-msg-beefy-gossip">Definition 55</a>) to its peers on every new, finalized
block. The Polkadot Host uses ECDSA for signing the statement, since Ethereum
has better compatibility for it compared to SR25519 or ED25519.</p>
</div>
</div>
<div class="sect3">
<h4 id="sect-beefy-committing-witnesses"><a class="link" href="#sect-beefy-committing-witnesses">5.5.3. Committing Witnesses</a></h4>
<div class="paragraph">
<p>The relayer (<a href="#defn-beefy-relayer">Definition 93</a>) participates in the Polkadot network by
collecting the gossiped votes (<a href="#defn-msg-beefy-gossip">Definition 55</a>). Those votes are
converted into the witness data structure (<a href="#defn-beefy-witness-data">Definition 91</a>).
The relayer saves the data on the chain of the remote network. The occurrence of
saving witnesses on remote networks is undefined.</p>
</div>
</div>
<div class="sect3">
<h4 id="_requesting_signed_commitments"><a class="link" href="#_requesting_signed_commitments">5.5.4. Requesting Signed Commitments</a></h4>
<div class="paragraph">
<p>A light client (<a href="#defn-beefy-light-client">Definition 92</a>) fetches the witness data
(<a href="#defn-beefy-witness-data">Definition 91</a>) from the chain. Once the light client knows which
validators apparently voted for the specified statement, it needs to request the
signatures from the relayer to verify whether the claims are actually true. This
is achieved by requesting signed commitments
(<a href="#defn-grandpa-beefy-signed-commitment">Definition 56</a>).</p>
</div>
<div class="paragraph">
<p>How those signed commitments are requested by the light client and delivered by
the relayer varies among networks or implementations. On Ethereum, for example,
the light client can request the signed commitments in form of a transaction,
which results in a response in form of a transaction.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter-anv"><a class="link" href="#chapter-anv">6. Availability &amp; Validity</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Polkadot serves as a replicated shared-state machine designed to resolve
scalability issues and interoperability among blockchains. The validators of
Polkadot execute transactions and participate in the consensus of Polkadots
primary chain, the so called relay chain. Parachains are independent networks
that maintain their own state and are connected to the relay chain. Those
parachains can take advantage of the relay chain consensus mechanism, including
sending and receiving messages to and from other parachains. Parachain nodes
that send parachain blocks, known as candidates, to the validators in order to
be inlcuded in relay chain are referred to as collators.</p>
</div>
<div class="paragraph">
<p>The Polkadot relay chain validators are responsible for guaranteeing the
validity of both relay chain and parachain blocks. Additionally, the validators
are required to keep enough parachain blocks that should be included in the
relay chain available in their local storage in order to make those retrievable
by peers, who lack the information, to reliably confirm the issued validity
statements about parachain blocks. The Availability &amp; Validity (AnV) protocol
consists of multiple steps for successfully upholding those responsibilities.</p>
</div>
<div class="paragraph">
<p>Parachain blocks themselves are produced by collators (<a href="#sect-collations">Section 6.1</a>),
whereas the relay chain validators only verify their validity (and later, their
availability). It is possible that the collators of a parachain  produces
multiple parachain block candidates for a child of a specific block.
Subsequently, they send the block candidates to the the relay chain validators
who are assigned to the specific parachain. The assignment is determined by the
Runtime (<a href="#sect-candidate-backing">Section 6.2</a>). Those validators are then required to
check the validity of submitted candidates (<a href="#sect-candidate-validation">Section 6.3</a>), then
issue and collect statements (<a href="#sect-candidate-statements">Section 6.2.1</a>) about the validity
of candidates to other validators. This process is known as candidate backing.
Once a candidate meets a specified criteria for inclusion, the selected relay
chain block author then choses any of the backed candidate for each parachain
and includes those into the relay chain block (<a href="#sect-candidate-inclusion">Section 6.2.2</a>).</p>
</div>
<div class="paragraph">
<p>Every relay chain validator must fetch the proposed candidates and issue votes
on whether they have the candidate saved in their local storage, so called
availability votes (<a href="#sect-availability-votes">Section 6.4.1</a>), then also collect the votes
sent by other validators and include them in the relay chain state
(<a href="#sect-candidate-inclusion">Section 6.2.2</a>). This process ensures that only relay chain
blocks get finalized where each candidate is available on enough nodes of
validators.</p>
</div>
<div class="paragraph">
<p>Parachain candidates contained in non-finalized (Section ?) relay chain blocks
must then be retrieved by a secondary set of relay chain validators, unrelated
from the candidate backing process, who are randomly assigned to determine the
validity of specific parachains based on a VRF lottery and are then required to
vote on the validity of those candidates. This process is known as approval
voting (<a href="#sect-approval-voting">Section 6.5</a>). If a validator does not have the candidate
data, it must recover the candidate data (<a href="#sect-candidate-recovery">Section 6.4.2</a>).</p>
</div>
<div class="sect2">
<h3 id="sect-collations"><a class="link" href="#sect-collations">6.1. Collations</a></h3>
<div class="paragraph">
<p>Collations are proposed candidates <a href="#defn-candidate">Section 6.8.2</a> to the Polkadot relay
chain validators. The Polkodat network protocol is agnostic on what candidate
productionis mechanism each parachain uses and does not specify or mandate any
of such production methods (e.g. BABE-GRANDPA, Aura, etc). Furthermore, the
relay chain validator host implementation itself does not directly interpret or
process teh internal transactions of the candidate, but rather rely on the
parachain Runtime to validate the candidate (<a href="#sect-candidate-validation">Section 6.3</a>).
Collators, which are parachain nodes which produce candidate proposals and send
them to the relay chain validator, must prepare pieces of data
(<a href="#defn-collation">Definition 94</a>) in order to correctly comply with the requirements of the
parachain protocol.</p>
</div>
<div id="defn-collation" class="exampleblock">
<div class="title">Definition 94. <a href="#defn-collation">Collation</a></div>
<div class="content">
<div class="paragraph">
<p>A collation is a datastructure which contains the proposed parachain candidate,
including an optional validation parachain Runtime update and upward messages.
The collation datastructure, C, is a datastructure of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$C = (M,H,R,h,P,p,w)\$
\$M = (u_n,…u_m)\$
\$H = (z_n,…z_m)\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$M\$ is an array of upward messages (<a href="#defn-upward-message">Section 6.8.8</a>), \$u\$,
interpreted by the relay chain itself.</p>
</li>
<li>
<p>\$H\$ is an array of outbound horizontal messages
(<a href="#defn-outbound-hrmp-message">Section 6.8.10</a>), \$z\$, interpreted by other parachains.</p>
</li>
<li>
<p>\$R\$ is an <em>Option</em> type (<a href="#defn-option-type">Definition 152</a>) which can contain a
parachain Runtime update. The new Runtime code is an array of bytes.</p>
</li>
<li>
<p>\$h\$ is the head data (<a href="#defn-head-data">Section 6.8.4</a>) produced as a result of
execution of the parachain specific logic.</p>
</li>
<li>
<p>\$P\$ is the PoV block (<a href="#defn-para-block">Section 6.8.3</a>).</p>
</li>
<li>
<p>\$p\$ is an unsigned 32-bit integer indicating the number of processed
downward messages (<a href="#defn-downward-message">Section 6.8.9</a>).</p>
</li>
<li>
<p>\$w\$ is an unsigned 32-bit integer indicating the mark up to which all
inbound HRMP messages have been processed by the parachain.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-candidate-backing"><a class="link" href="#sect-candidate-backing">6.2. Candidate Backing</a></h3>
<div class="paragraph">
<p>The Polkadot validator receives an arbitrary number of parachain candidates with
associated proofs from untrusted collators. The validator must verify and select
a specific quantity of the proposed candidates and issue those as backable
candidates to its peers. A candidate is considered backable when at least 2/3 of
all assigned validators have issued a <em>Valid</em> statement about that candidate, as
described in <a href="#sect-candidate-statements">Section 6.2.1</a>. Validators can retrieve
information about assignments via the Runtime APIs
<a href="#sect-rt-api-validator-groups">Section 26.6.2</a> respectively
<a href="#sect-rt-api-availability-cores">Section 26.6.3</a>.</p>
</div>
<div class="sect3">
<h4 id="sect-candidate-statements"><a class="link" href="#sect-candidate-statements">6.2.1. Statements</a></h4>
<div class="paragraph">
<p>The assigned validator checks the validity of the proposed parachains blocks
(<a href="#sect-candidate-validation">Section 6.3</a>) and issues <em>Valid</em> statements
(<a href="#net-msg-full-statement">[net-msg-full-statement]</a>) to its peers if the verification succeeded.
Broadcasting failed verification as <em>Valid</em> statements is a slashable offense. The
validator must only issue one <em>Seconded</em> statement, based on an arbitrary metric,
which implies an explicit vote for a candidate to be included in the relay
chain.</p>
</div>
<div class="paragraph">
<p>This protocol attempts to produce as many backable candidates as possible, but
does not attempt to determine a final candidate for inclusion. Once a parachain
candidate has been seconded by at least one other validator and enough Valid
statements have been issued about that candidate to meet the 2/3 quorum, the
candidate is ready to be included in the relay chain
(<a href="#sect-candidate-inclusion">Section 6.2.2</a>).</p>
</div>
<div class="paragraph">
<p>The validator issues validity statements votes in form of a validator protocol
message (<a href="#net-msg-validator-protocol-message">Definition 106</a>).</p>
</div>
<div id="defn-statement" class="exampleblock">
<div class="title">Definition 95. <a href="#defn-statement">Statement</a></div>
<div class="content">
<div class="paragraph">
<p>A statement, \$S\$, is a datastructure of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$S = (d,A_i,A_s)\$
\$d = {(1,-&gt;,C_r),(2,-&gt;,C_h):}\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$d\$ is a varying datatype where <em>1</em> indicates that the validator
“seconds” a candidate, meaning that the candidate should be included in the
relay chain, followed by the committed candidate receipt
(<a href="#defn-committed-candidate-receipt">Definition 98</a>), \$C_r\$. <em>2</em> indicates that the
validator has deemed the candidate valid, followed by the candidate hash.</p>
</li>
<li>
<p>\$C_h\$ is the candidate hash.</p>
</li>
<li>
<p>\$A_i\$ is the validator index in the authority set that signed this statement.</p>
</li>
<li>
<p>\$A_s\$ is the signature of the validator.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-candidate-inclusion"><a class="link" href="#sect-candidate-inclusion">6.2.2. Inclusion</a></h4>
<div class="paragraph">
<p>The Polkadot validator includes the backed candidates as parachain inherent data
(<a href="#defn-parachain-inherent-data">Definition 96</a>) into a block as described <a href="#sect-inherents">Section 3.2.3</a>.
The relay chain block author decides on whatever metric which candidate should
be selected for inclusion, as long as that candidate is valid and meets the
validity quorum of 2/3+ as described <a href="#sect-candidate-statements">Section 6.2.1</a>. The
candidate approval process (<a href="#sect-approval-voting">Section 6.5</a>) ensures that only relay
chain blocks are finalized where each candidate for each availability core meets
the requirement of 2/3+ availability votes.</p>
</div>
<div id="defn-parachain-inherent-data" class="exampleblock">
<div class="title">Definition 96. <a href="#defn-parachain-inherent-data">Parachain Inherent Data</a></div>
<div class="content">
<div class="paragraph">
<p>The parachain inherent data contains backed candidates and is included when
authoring a relay chain block. The datastructure, \$I\$, is of the following
format:</p>
</div>
<div class="stemblock">
<div class="content">
\$I = (A,T,D,P_h)\$
\$T = (C_0,…C_n)\$
\$D = (*d_n,…d_m)\$
\$C = (R,V,i)\$
\$V = (a_n,…a_m)\$
\$a = {(1,-&gt;,s),(2,-&gt;,s):}\$
\$A = (L_n,…L_m)\$
\$L = (b,v_i,s)\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$A\$ is an array of signed bitfields by validators claiming the candidate
is available (or not). The array must be sorted by validator index corresponding
to the authority set (<a href="#defn-authority-list">Definition 58</a>).</p>
</li>
<li>
<p>\$T\$ is an array of backed candidates for inclusing in the current block.</p>
</li>
<li>
<p>\$D\$ is an array of disputes.</p>
</li>
<li>
<p>\$P_h\$ is the parachain parent head data (<a href="#defn-head-data">Section 6.8.4</a>).</p>
</li>
<li>
<p>\$d\$ is a dispute statement (<a href="#net-msg-dispute-request">Section 6.7.2.1</a>).</p>
</li>
<li>
<p>\$R\$ is a committed candidate receipt (<a href="#defn-committed-candidate-receipt">Definition 98</a>).</p>
</li>
<li>
<p>\$V\$ is an array of validity votes themselves, expressed as signatures.</p>
</li>
<li>
<p>\$i\$ is a bitfield of indices of the validators within the validator
group (<a href="#defn-validator-groups">Section 6.8.7</a>).</p>
</li>
<li>
<p>\$a\$ is either an implicit or explicit attestation of the validity of a
parachain candidate, where <em>1</em> implies an implicit vote (in correspondence of a
<em>Seconded</em> statement) and <em>2</em> implies an explicit attestation (in correspondence
of a <em>Valid</em> statement). Both variants are followed by the signature of the
validator.</p>
</li>
<li>
<p>\$s\$ is the signature of the validator.</p>
</li>
<li>
<p>\$b\$ the availability bitfield (<a href="#sect-availability-votes">Section 6.4.1</a>).</p>
</li>
<li>
<p>\$v_i\$ is the validator index of the authority set (<a href="#defn-authority-list">Definition 58</a>).</p>
</li>
</ul>
</div>
</div>
</div>
<div id="defn-candidate-receipt" class="exampleblock">
<div class="title">Definition 97. <a href="#defn-candidate-receipt">Candidate Receipt</a></div>
<div class="content">
<div class="paragraph">
<p>A candidate receipt, \$R\$, contains information about the candidate and a
proof of the results of its execution. It&#8217;s a datastructure of the following
format:</p>
</div>
<div class="stemblock">
<div class="content">
\$R = (D,C_h)\$
</div>
</div>
<div class="paragraph">
<p>where \$D\$ is the candidate descriptor (<a href="#defn-candidate-descriptor">Definition 99</a>) and
\$C_h\$ is the hash of candidate commitments
(<a href="#defn-candidate-commitments">Definition 100</a>).</p>
</div>
</div>
</div>
<div id="defn-committed-candidate-receipt" class="exampleblock">
<div class="title">Definition 98. <a href="#defn-committed-candidate-receipt">Committed Candidate Receipt</a></div>
<div class="content">
<div class="paragraph">
<p>The committed candidate receipt, \$R\$, contains information about the
candidate and the the result of its execution that is included in the relay
chain. This type is similar to the candidate receipt
(<a href="#defn-candidate-receipt">Definition 97</a>), but actually contains the execution results rather
than just a hash of it. It&#8217;s a datastructure of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$R = (D,C)\$
</div>
</div>
<div class="paragraph">
<p>where \$D\$ is the candidate descriptor (<a href="#defn-candidate-descriptor">Definition 99</a>) and
\$C\$ is the candidate commitments (<a href="#defn-candidate-commitments">Definition 100</a>).</p>
</div>
</div>
</div>
<div id="defn-candidate-descriptor" class="exampleblock">
<div class="title">Definition 99. <a href="#defn-candidate-descriptor">Candidate Descriptor</a></div>
<div class="content">
<div class="paragraph">
<p>The candidate descriptor, \$D\$, is a unique descriptor of a candidate
receipt. It&#8217;s a datastructure of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$D = (p,H,C_i,V,B,r,s,p_h,R_h)\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$p\$ is the parachain Id (<a href="#defn-para-id">Section 6.8.5</a>).</p>
</li>
<li>
<p>\$H\$ is the hash of the relay chain block the candidate is executed in the context of.</p>
</li>
<li>
<p>\$C_i\$ is the collators public key.</p>
</li>
<li>
<p>\$V\$ is the hash of the persisted validation data (<a href="#defn-persisted-validation-data">Definition 188</a>).</p>
</li>
<li>
<p>\$B\$ is the hash of the PoV block.</p>
</li>
<li>
<p>\$r\$ is the root of the block&#8217;s erasure encoding Merkle tree.</p>
</li>
<li>
<p>\$s\$ the collator signature of the concatenated components \$p\$,
\$H\$, \$R_h\$ and \$B\$.</p>
</li>
<li>
<p>\$p_h\$ is the hash of the parachain head data (<a href="#defn-head-data">Section 6.8.4</a>) of this candidate.</p>
</li>
<li>
<p>\$R_h\$ is the hash of the parachain Runtime.</p>
</li>
</ul>
</div>
</div>
</div>
<div id="defn-candidate-commitments" class="exampleblock">
<div class="title">Definition 100. <a href="#defn-candidate-commitments">Candidate Commitments</a></div>
<div class="content">
<div class="paragraph">
<p>The candidate commitments, \$C\$, is the result of the execution and
validation of a parachain (or parathread) candidate whose produced values must
be committed to the relay chain. Those values are retrieved from the validation
result (<a href="#defn-validation-result">Definition 102</a>). A candidate commitment is a datastructure
of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$C =(M_u,M_h,R,h,p,w)\$
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$M_u\$ is an array of upward messages sent by the parachain. Each
individual message, m, is an array of bytes.</p>
</li>
<li>
<p>\$M_h\$ is an array of individual outbound horizontal messages
(<a href="#defn-outbound-hrmp-message">Section 6.8.10</a>) sent by the parachain.</p>
</li>
<li>
<p>\$R\$ is an <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) that can contain a new
parachain Runtime in case of an update.</p>
</li>
<li>
<p>\$h\$ is the parachain head data (<a href="#defn-head-data">Section 6.8.4</a>).</p>
</li>
<li>
<p>\$p\$ is a unsigned 32-bit integer indicating the number of downward
messages that were processed by the parachain. It is expected that the parachain
processes the messages from first to last.</p>
</li>
<li>
<p>\$w\$ is a unsigned 32-bit integer indicating the watermark which specifies
the relay chain block number up to which all inbound horizontal messages have
been processed.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-candidate-validation"><a class="link" href="#sect-candidate-validation">6.3. Candidate Validation</a></h3>
<div class="paragraph">
<p>Received candidates submitted by collators and must have its validity verified
by the assigned Polkadot validators. For each candidate to be valid, the
validator must successfully verify the following conditions in the following
order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The candidate does not exceed any parameters in the persisted validation data
(<a href="#defn-persisted-validation-data">Definition 188</a>).</p>
</li>
<li>
<p>The signature of the collator is valid.</p>
</li>
<li>
<p>Validate the candidate by executing the parachain Runtime (<a href="#sect-parachain-runtime">Section 6.3.1</a>)..</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If all steps are valid, the Polkadot validator must create the necessary
candidate commitments (<a href="#defn-candidate-commitments">Definition 100</a>) and submit the
appropriate statement for each candidate
(<a href="#sect-candidate-statements">Section 6.2.1</a>).</p>
</div>
<div class="sect3">
<h4 id="sect-parachain-runtime"><a class="link" href="#sect-parachain-runtime">6.3.1. Parachain Runtime</a></h4>
<div class="paragraph">
<p>Parachain Runtimes are stored in the relay chain state, and can either be
fetched by the parachain Id or the Runtime hash via the relay chain Runtime API
as described in <a href="#sect-rt-api-validation-code">Section 26.6.7</a> and
<a href="#sect-rt-api-validation-code-by-hash">Section 26.6.8</a> respectively. The retrieved parachain
Runtime might need to be decompressed based on the magic identifier as described
in <a href="#sect-runtime-compression">Section 6.3.2</a>.</p>
</div>
<div class="paragraph">
<p>In order to validate a parachain block, the Polkadot validator must prepare the
validation parameters (<a href="#defn-validation-parameters">Definition 101</a>), then use its local Wasm
execution environment (<a href="#sect-code-executor">Section 3.1.3</a>) to execute the validate_block
parachain Runtime API by passing on the validation parameters as an argument.
The parachain Runtime function returns the validation result
(<a href="#defn-validation-result">Definition 102</a>).</p>
</div>
<div id="defn-validation-parameters" class="exampleblock">
<div class="title">Definition 101. <a href="#defn-validation-parameters">Validation Parameters</a></div>
<div class="content">
<div class="paragraph">
<p>The validation parameters structure, \$P\$, is required to validate a
candidate against a parachain Runtime. It&#8217;s a datastructure of the following
format:</p>
</div>
<div class="stemblock">
<div class="content">
\$P = (h,b,B_i,S_r)\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$h\$ is the parachain head data (<a href="#defn-head-data">Section 6.8.4</a>).</p>
</li>
<li>
<p>\$b\$ is the block body (<a href="#defn-para-block">Section 6.8.3</a>).</p>
</li>
<li>
<p>\$B_i\$ is the latest relay chain block number.</p>
</li>
<li>
<p>\$S_r\$ is the relay chain block storage root (<a href="#sect-merkl-proof">Section 2.1.4</a>).</p>
</li>
</ul>
</div>
</div>
</div>
<div id="defn-validation-result" class="exampleblock">
<div class="title">Definition 102. <a href="#defn-validation-result">Validation Result</a></div>
<div class="content">
<div class="paragraph">
<p>The validation result is returned by the <code>validate_block</code> parachain Runtime API
after attempting to validate a parachain block. Those results are then used in
candidate commitments (<a href="#defn-candidate-commitments">Definition 100</a>), which then will be
inserted into the relay chain via the parachain inherent data
(<a href="#defn-parachain-inherent-data">Definition 96</a>). The validation result, \$V\$, is a
datastructure of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$V   = (h,R,M_u,M_h,p_,w)\$
\$M_u = (m_0,…m_n)\$
\$M_h = (t_0,…t_n)\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$h\$ is the parachain head data (<a href="#defn-head-data">Section 6.8.4</a>).</p>
</li>
<li>
<p>\$R\$ is an <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) that can contain a new
parachain Runtime in case of an update.</p>
</li>
<li>
<p>\$M_u\$ is an array of upward messages sent by the parachain. Each
individual message, m, is an array of bytes.</p>
</li>
<li>
<p>\$M_h\$ is an array of individual outbound horizontal messages
(<a href="#defn-outbound-hrmp-message">Section 6.8.10</a>) sent by the parachain.</p>
</li>
<li>
<p>\$p\$ is a unsigned 32-bit integer indicating the number of downward
messages that were processed by the parachain. It is expected that the parachain
processes the messages from first to last.</p>
</li>
<li>
<p>\$w\$ is a unsigned 32-bit integer indicating the watermark which specifies
the relay chain block number up to which all inbound horizontal messages have
been processed.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-runtime-compression"><a class="link" href="#sect-runtime-compression">6.3.2. Runtime Compression</a></h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Runtime compression is not documented yet.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-availability"><a class="link" href="#sect-availability">6.4. Availability</a></h3>
<div class="sect3">
<h4 id="sect-availability-votes"><a class="link" href="#sect-availability-votes">6.4.1. Availability Votes</a></h4>
<div class="paragraph">
<p>The Polkadot validator must issue a bitfield (<a href="#defn-bitfield-array">Section 6.8.12</a>) which
indicates votes for the availabilty of candidates. Issued bitfields can be used
by the validator and other peers to determine which backed candidates meet the
2/3+ availability quorum.</p>
</div>
<div class="paragraph">
<p>Candidates are inserted into the relay chain in form of parachain inherent data
(<a href="#sect-candidate-inclusion">Section 6.2.2</a>) by a block author. A validator can retrieve that
data by calling the appropriate Runtime API entry
(<a href="#sect-rt-api-availability-cores">Section 26.6.3</a>), then create a bitfield indicating for
which candidate the validator has availability data stored and broadcast it to
the network as defined in Definition 7.38. When sending the bitfield distrubtion
message, the validator must ensure \$B_h\$ is set approriately, therefore
clarifying to which state the bitfield is referring to, given that candidates
can vary based on the chain fork.</p>
</div>
<div class="paragraph">
<p>Missing availability data of candidates must be recovered by the validator as
described in <a href="#sect-candidate-recovery">Section 6.4.2</a>. If previously issued bitfields are no
longer accurate, i.e. the availability data has been recovered or the candidate
of an availablity core has changed, the validator must create a new bitfield and
boradcast it to the network. Candidates must be kept available by validators for
a specific amount of time. If a candidate does not receive any backing,
validators should keep it available for about one hour, in case the state of
backing does change. Backed and even approved candidates
(<a href="#sect-approval-voting">Section 6.5</a>) must be kept by validators for about 25 hours, since
disputes (<a href="#sect-disputes">Section 6.6</a>) can occur and the candidate needs to be checked
again.</p>
</div>
<div class="paragraph">
<p>The validator issues availability votes in form of a validator protocol message
(<a href="#net-msg-collator-protocol-message">Definition 107</a>).</p>
</div>
</div>
<div class="sect3">
<h4 id="sect-candidate-recovery"><a class="link" href="#sect-candidate-recovery">6.4.2. Candidate Recovery</a></h4>
<div class="paragraph">
<p>The availability distribution of the Polkadot validator must be able to recover
parachain candidates that the validator is assigned to, in order to determine
whether the candidate should be backed (<a href="#sect-candidate-backing">Section 6.2</a>) respectively
whether the candidate should be approved (<a href="#sect-approval-voting">Section 6.5</a>).
Additionally, peers can send availability requests as defined in
<a href="#net-msg-chunk-fetching-request">Definition 114</a> and <a href="#net-msg-available-data-request">Definition 116</a> to the
validator, which the validator should be able to respond to.</p>
</div>
<div class="paragraph">
<p>Candidates are recovered by sending requests for specific indices of erasure
encoded chunks (<a href="#sect-erasure-encoding">Section 13.1</a>). A validator should request chunks by
picking peers randomly and must recover at least \$f+1\$ chunks, where
\$n=3f+k\$ and \$k in {1,2,3}\$. \$n\$ is the number of validators as
specified in the session info, which can be fetched by the Runtime API as
described in <a href="#sect-rt-api-session-info">Section 26.6.11</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-approval-voting"><a class="link" href="#sect-approval-voting">6.5. Approval Voting</a></h3>
<div class="paragraph">
<p>The approval voting process ensures that only valid parachain blocks are
finalized on the relay chain. After <em>backable</em> parachain candidates were
submitted to the relay chain (<a href="#sect-candidate-inclusion">Section 6.2.2</a>), which can be
retrieved via the Runtime API (<a href="#sect-rt-api-availability-cores">Section 26.6.3</a>), validators
need to determine their assignments for each parachain and issue approvals for
valid candidates, respectively disputes for invalid candidates. Since it cannot
be expected that each validator verifies every single parachain candidate, this
mechanism ensures that enough honest validators are selected to verify parachain
candidates in order prevent the finalization of invalid blocks. If an honest
validator detects an invalid block which was approved by one or more validators,
the honest validator must issue a disputes which wil cause escalations,
resulting in consequences for all malicious parties, i.e. slashing. This
mechanism is described more in <a href="#sect-availability-assignment-criteria">Section 6.5.1</a>.</p>
</div>
<div class="sect3">
<h4 id="sect-availability-assignment-criteria"><a class="link" href="#sect-availability-assignment-criteria">6.5.1. Assignment Criteria</a></h4>
<div class="paragraph">
<p>Validators determine their assignment based on a VRF mechanism, similiar to the
BABE consensus mechanism. First, validators generate an availability core VRF
assignment (<a href="#defn-availability-core-vrf-assignment">Definition 104</a>), which indicates which
availability core a validator is assigned to. Then a delayed availability core
VRF assignment is generated which indicates at what point a validator should
start the approval process. The delays are based on “tranches”
(<a href="#sect-tranches">Section 6.5.2</a>).</p>
</div>
<div class="paragraph">
<p>An assigned validator never broadcasts their assignment until relevant. Once the
assigned validator is ready to check a candidate, the validator broadcasts their
assignment by issuing an approval distribution message
(<a href="#net-msg-approval-distribution">Definition 111</a>), where \$M\$ is of variant <em>0</em>. Other
assigned validators that receive that network message must keep track of if,
expecting an approval vote following shortly after. Assigned validators can
retrieve the candidate by using the availability recovery
(<a href="#sect-candidate-recovery">Section 6.4.2</a>) and then validate the candidate
(<a href="#sect-candidate-validation">Section 6.3</a>).</p>
</div>
<div class="paragraph">
<p>The validator issues approval votes in form of a validator protocol message
(<a href="#net-msg-validator-protocol-message">Definition 106</a>) respectively disputes
(<a href="#sect-disputes">Section 6.6</a>).</p>
</div>
</div>
<div class="sect3">
<h4 id="sect-tranches"><a class="link" href="#sect-tranches">6.5.2. Tranches</a></h4>
<div class="paragraph">
<p>Validators use a subjective, tick-based system to determine when the approval
process should start. A validator starts the tick-based system when a new
availability core candidates have been proposed, which can be retrieved via the
Runtime API (<a href="#sect-rt-api-availability-cores">Section 26.6.3</a>) , and increments the tick every
<em>500 milliseconds</em>. Each tick/increment is referred to as a “tranche”,
represented as an integer, starting at <em>0</em>.</p>
</div>
<div class="paragraph">
<p>As described in <a href="#sect-availability-assignment-criteria">Section 6.5.1</a>, the validator first
executes the VRF mechanism to determine which parachains (availability cores)
the validator is assigned to, then an additional VRF mechanism for each assigned
parachain to determine the <em>delayed assignment</em>. The delayed assignment
indicates the tranche at which the validator should start the approval process.
A tranche of value <em>0</em> implies that the assignment should be started immediately,
while later assignees of later tranches wait until it&#8217;s their term to issue
assignments, determined by their subjective, tick-based system.</p>
</div>
<div class="paragraph">
<p>Validators are required to track broadcasted assignments by other validators
assigned to the same parachain, including verifying the VRF output. Once a valid
assignment from a peer was received, the validator must wait for the following
approval vote within a certain period as described in
<a href="#sect-rt-api-session-info">Section 26.6.11</a> by orienting itself on its local, tick-based
system. If the waiting time after a broadcasted assignment exceeds the specified
period, the validator interprets this behavior as a “no-show”, indicating that
more validators should commit on their tranche until enough approval votes have
been collected.</p>
</div>
<div class="paragraph">
<p>If enough approval votes have been collected as described in
<a href="#sect-rt-api-session-info">Section 26.6.11</a>, then assignees of later tranches do not have to
start the approval process. Therefore, this tranche system serves as a mechanism
to ensure that enough candidate approvals from a random set of validators are
created without requiring all assigned validators to check the candidate.</p>
</div>
<div id="defn-relay-vrf-story" class="exampleblock">
<div class="title">Definition 103. <a href="#defn-relay-vrf-story">Relay VRF Story</a></div>
<div class="content">
<div class="paragraph">
<p>The relay VRF story is an array of random bytes derived from the VRF submitted
within the block by the block author. The relay VRF story, T, is used as input
to determine approval voting criteria and generated the following way:</p>
</div>
<div class="stemblock">
<div class="content">
\$T = sf "Transcript"(b_r,b_s,e_i,A)\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$sf "Transcript"\$ constructs a VRF transcript (<a href="#defn-vrf-transcript">Definition 142</a>).</p>
</li>
<li>
<p>\$b_r\$ is the BABE randomness of the current epoch (<a href="#defn-epoch-randomness">Definition 72</a>).</p>
</li>
<li>
<p>\$b_s\$ is the current BABE slot (<a href="#defn-epoch-slot">Definition 60</a>).</p>
</li>
<li>
<p>\$e_i\$ is the current BABE epoch index (<a href="#defn-epoch-slot">Definition 60</a>).</p>
</li>
<li>
<p>\$A\$ is the public key of the authority.</p>
</li>
</ul>
</div>
</div>
</div>
<div id="defn-availability-core-vrf-assignment" class="exampleblock">
<div class="title">Definition 104. <a href="#defn-availability-core-vrf-assignment">Availability Core VRF Assignment</a></div>
<div class="content">
<div class="paragraph">
<p>An availability core VRF assignment is computed by a relay chain validator to
determine which availability core (<a href="#defn-availability-core">Section 6.8.6</a>) a validator is
assigned to and should vote for approvals. Computing this assignement relies on
the VRF mechanism, transcripts and STROBE operations described further in
<a href="#sect-vrf">Section 10.4</a>.</p>
</div>
<div class="paragraph">
<p>The Runtime dictates how many assignments should be conducted by a validator, as
specified in the session index which can be retrieved via the Runtime API
(<a href="#sect-rt-api-session-info">Section 26.6.11</a>). The amount of assignments is referred to as
“samples”. For each iteration of the number of samples, the validator calculates
an individual assignment, \$T\$, where the little-endian encoded sample
number, \$S\$, is incremented by one. At the beginning of the iteration,
\$S\$ starts at value <em>0</em>.</p>
</div>
<div class="paragraph">
<p>The validator executes the following steps to retrieve a (possibly valid) core index:</p>
</div>
<div class="stemblock">
<div class="content">
\$t_1 larr "Transcript"("'A&amp;V MOD'")\$
\$t_2 larr "append"(t_1, "'RC-VRF'", R_s)\$
\$t_3 larr "append"(t_2, "'sample'", S)\$
\$t_4 larr "append"(t_3, "'vrf-nm-pk'", p_k)\$
\$t_5 larr "meta-ad"(t_4, "'VRFHash'", "False")\$
\$t_6 larr "meta-ad"(t_5, 64_("le"), "True")\$
\$i larr "prf"(t_6, "False")\$
\$o = s_k * i\$
</div>
</div>
<div class="paragraph">
<p>where \$s_k\$ is the secret key, \$p_k\$ is the public key and
\$64_("le")\$ is the integer <em>64</em> encoded as little endian. \$R_s\$ is the
relay VRF story as defined in <a href="#defn-relay-vrf-story">Definition 103</a>. Following:</p>
</div>
<div class="stemblock">
<div class="content">
\$t_1 larr "Transcript"("'VRFResult'")\$
\$t_2 larr "append"(t_1, "''", "'A&amp;V CORE'")\$
\$t_3 larr "append"(t_2, "'vrf-in'", i)\$
\$t_4 larr "append"(t_3, "'vrf-out'", o)\$
\$t_5 larr "meta-ad"(t_4, "''", "False")\$
\$t_6 larr "meta-ad"(t_5, 4_"le", "True")\$
\$c larr "prf"(t_6, "False")\$
\$r_c = c mod a_c\$
</div>
</div>
<div class="paragraph">
<p>where \$4_("le")\$ is the integer <em>4</em> encoded as little endian, \$c\$ is the
4-byte challenge interpreted as a little endian encoded interger and \$a_c\$
is the number of availability cores used during the active session, as defined
in the session info retrieved by the Runtime API (<a href="#sect-rt-api-session-info">Section 26.6.11</a>).
The resulting integer, \$c_i\$, indicates the parachain Id
(<a href="#defn-para-id">Section 6.8.5</a>). If the parachain Id doesn&#8217;t exist, as can be retrieved by the Runtime
API (<a href="#sect-rt-api-availability-cores">Section 26.6.3</a>), the validator discards that value and
continues with the next iteration. If the Id does exist, the validators
continues with the following steps:</p>
</div>
<div class="stemblock">
<div class="content">
\$t_1 larr "Transcript"("'A&amp;V ASSIGNED'")\$
\$t_2 larr "append"(t_1, "'core'", r_c)\$
\$p larr "dleq_prove"(t_2, i)\$
</div>
</div>
<div class="paragraph">
<p>where \$"dleq_prove"\$ is described in <a href="#defn-vrf-dleq-prove">Definition 140</a>.</p>
</div>
<div class="paragraph">
<p>TODO: Clarify usage of "AssignmentCert", deprecate the following:</p>
</div>
</div>
</div>
<div id="delayed-availability-core-vrf-assignment" class="exampleblock">
<div class="title">Definition 105. <a href="#delayed-availability-core-vrf-assignment">Delayed Availability Core VRF Assignment</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>delayed availability core VRF assignments</strong> determined at what point a
validator should start the approval process as described in <a href="#sect-tranches">Section 6.5.2</a>.
Computing this assignement relies on the VRF mechanism, transcripts and STROBE
operations described further in <a href="#sect-vrf">Section 10.4</a>.</p>
</div>
<div class="paragraph">
<p>The validator executes the following steps:</p>
</div>
<div class="stemblock">
<div class="content">
\$t_1 larr sf "Transcript"("'A&amp;V DELAY'")\$
\$t_2 larr sf "append"(t_1,"'RC-VRF'",R_s)\$
\$t_3 larr sf "append"(t_2, "'core'",c_i)\$
\$t_4 larr "append"(t_3, "'vrf-nm-pk'", p_k)\$
\$t_5 larr "meta-ad"(t_4, "'VRFHash'", "False")\$
\$t_6 larr "meta-ad"(t_5, 64_("le"), "True")\$
\$i larr "prf"(t_6, "False")\$
\$o = s_k * i\$
\$p larr sf "dleq_prove"(t_6, i)\$
</div>
</div>
<div class="paragraph">
<p>The resulting value \$p\$ is the VRF proof (<a href="#defn-vrf-proof">Definition 139</a>).
\$"dleq_prove"\$ is described in <a href="#defn-vrf-dleq-prove">Definition 140</a>.</p>
</div>
<div class="paragraph">
<p>The tranche, \$d\$, is determined as:</p>
</div>
<div class="stemblock">
<div class="content">
\$t_1 larr "Transcript"("'VRFResult'")\$
\$t_2 larr "append"(t_1, "''", "'A&amp;V TRANCHE'")\$
\$t_3 larr "append"(t_2, "'vrf-in'", i)\$
\$t_4 larr "append"(t_3, "'vrf-out'", o)\$
\$t_5 larr "meta-ad"(t_4, "''", "False")\$
\$t_6 larr "meta-ad"(t_5, 4_("le"), "True")\$
\$c larr "prf"(t_6, "False")\$
\$d = sf d mod (d_c+d_z) - d_z\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$d_c\$ is the number of delayed tranches by total as specified by the
session info, retrieved via the Runtime API (<a href="#sect-rt-api-session-info">Section 26.6.11</a>).</p>
</li>
<li>
<p>\$d_z\$ is the zeroth delay tranche width as specified by the session info,
retrieved via the Runtime API (<a href="#sect-rt-api-session-info">Section 26.6.11</a>)..</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The resulting tranche, \$n\$, cannot be less than \$0\$. If the tranche is
less than \$0\$, then \$d=0\$.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-disputes"><a class="link" href="#sect-disputes">6.6. Disputes</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Disputes are not documented yet.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="sect-anv-network-messages"><a class="link" href="#sect-anv-network-messages">6.7. Network Messages</a></h3>
<div class="paragraph">
<p>The availability and validity process requires certain network messages to be exchanged between validators and collators.</p>
</div>
<div class="sect3">
<h4 id="_notification_messges"><a class="link" href="#_notification_messges">6.7.1. Notification Messges</a></h4>
<div class="paragraph">
<p>The notification messages are exchanged between validators, including messages
sent by collators to validators. The protocol messages are exchanged based on a
streaming notification substream (<a href="#sect-connection-establishment">Section 4.5</a>). The
messages are SCALE encoded (<a href="#sect-scale-codec">Section 11.1</a>).</p>
</div>
<div id="net-msg-validator-protocol-message" class="exampleblock">
<div class="title">Definition 106. <a href="#net-msg-validator-protocol-message">Validator Protocol Message</a></div>
<div class="content">
<div class="paragraph">
<p>The validator protocol message is a varying datatype used by validators to
broadcast relevant information about certain steps in the A&amp;V process.
Specifically, this includes the backing process (<a href="#sect-candidate-backing">Section 6.2</a>) and
the approval process (<a href="#sect-approval-voting">Section 6.5</a>). The validator protocol message,
\$M\$, is a varying datatype of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$M = {(1,-&gt;,M_f),(3,-&gt;,M_s),(4,-&gt;,M_a):}\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$M_f\$ is a bitfield distribution message (<a href="#net-msg-bitfield-dist-msg">Definition 110</a>).</p>
</li>
<li>
<p>\$M_s\$ is a statement distribution message (<a href="#net-msg-statement-distribution">Definition 109</a>).</p>
</li>
<li>
<p>\$M_a\$ is a approval distribution message (<a href="#net-msg-approval-distribution">Definition 111</a>).</p>
</li>
</ul>
</div>
</div>
</div>
<div id="net-msg-collator-protocol-message" class="exampleblock">
<div class="title">Definition 107. <a href="#net-msg-collator-protocol-message">Collation Protocol Message</a></div>
<div class="content">
<div class="paragraph">
<p>The collation protocol message, M, is a varying datatype of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$M = {(0,-&gt;,M_c):}\$
</div>
</div>
<div class="paragraph">
<p>where \$M_c\$ is the collator message (<a href="#net-msg-collator-message">Definition 108</a>).</p>
</div>
</div>
</div>
<div id="net-msg-collator-message" class="exampleblock">
<div class="title">Definition 108. <a href="#net-msg-collator-message">Collator Message</a></div>
<div class="content">
<div class="paragraph">
<p>The collator message is sent as part of the collator protocol message
(<a href="#net-msg-collator-protocol-message">Definition 107</a>). The collator message, \$M\$, is a
varying datatype of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$M = {(0,-&gt;,(C_i,P_i,C_s)),(1,-&gt;,H),(4,-&gt;,(B_h,S)):}\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$M\$ is a varying datatype where <em>0</em> indicates the intent to advertise a
collation and <em>1</em> indicates the advertisement of a collation to a validator. <em>4</em>
indicates that a collation sent to a validator was seconded.</p>
</li>
<li>
<p>\$C_i\$ is the public key of the collator.</p>
</li>
<li>
<p>\$P_i\$ is the parachain Id (<a href="#defn-para-id">Section 6.8.5</a>).</p>
</li>
<li>
<p>\$C_s\$ is the signature of the collator using the <em>PeerId</em> of the collators node.</p>
</li>
<li>
<p>\$H\$ is the hash of the parachain block (<a href="#defn-para-block">Section 6.8.3</a>).</p>
</li>
<li>
<p>\$S\$ is a full statement (<a href="#defn-statement">Definition 95</a>).</p>
</li>
</ul>
</div>
</div>
</div>
<div id="net-msg-statement-distribution" class="exampleblock">
<div class="title">Definition 109. <a href="#net-msg-statement-distribution">Statement Distribution Message</a></div>
<div class="content">
<div class="paragraph">
<p>The statement distribution message is sent as part of the validator protocol
message (<a href="#net-msg-collator-protocol-message">Definition 107</a>) indicates the validity vote of a
validator for a given candidate, described further in
<a href="#sect-candidate-statements">Section 6.2.1</a>. The statement distribution message,
\$M\$, is of varying type of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$M   = {(0,-&gt;,(B_h,S)),(1,-&gt;,S_m):}\$
\$S_m = (B_h,C_h,A_i,A_s)\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$M\$ is a varying datatype where <em>0</em> indicates a signed statement and <em>1</em>
contains metadata about a seconded statement with a larger payload, such as a
runtime upgrade. The candidate itself can be fetched via the request/response
message (<a href="#net-msg-statement-fetching-request">Definition 120</a>).</p>
</li>
<li>
<p>\$B_h\$ is the hash of the relay chain parent, indicating the state this message is for.</p>
</li>
<li>
<p>\$S\$ is a full statement (<a href="#defn-statement">Definition 95</a>).</p>
</li>
<li>
<p>\$A_i\$ is the validator index in the authority set
(<a href="#defn-authority-list">Definition 58</a>) that signed this message.</p>
</li>
<li>
<p>\$A_s\$ is the signature of the validator.</p>
</li>
</ul>
</div>
</div>
</div>
<div id="net-msg-bitfield-dist-msg" class="exampleblock">
<div class="title">Definition 110. <a href="#net-msg-bitfield-dist-msg">Bitfield Distribution Message</a></div>
<div class="content">
<div class="paragraph">
<p>The bitfield distribution message is sent as part of the validator protocol
message (<a href="#net-msg-validator-protocol-message">Definition 106</a>) and indicates the availability
vote of a validator for a given candidate, described further in
<a href="#sect-availability-votes">Section 6.4.1</a>. This message is sent in form of a validator
protocol message (<a href="#net-msg-validator-protocol-message">Definition 106</a>). The bitfield
distribution message, \$M\$, is a datastructure of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$M = {(0,-&gt;,(B_h,P)):}\$
\$P = (d,A_i,A_s)\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$B_h\$ is the hash of the relay chain parent, indicating the state this message is for.</p>
</li>
<li>
<p>\$d\$ is the bitfield array (<a href="#defn-bitfield-array">Section 6.8.12</a>).</p>
</li>
<li>
<p>\$A_i\$ is the validator index in the authority set
(<a href="#defn-authority-list">Definition 58</a>) that signed this message.</p>
</li>
<li>
<p>\$A_s\$ is the signature of the validator.</p>
</li>
</ul>
</div>
</div>
</div>
<div id="net-msg-approval-distribution" class="exampleblock">
<div class="title">Definition 111. <a href="#net-msg-approval-distribution">Approval Distribution Message</a></div>
<div class="content">
<div class="paragraph">
<p>The approval distribution message is sent as part of the validator protocol
message (<a href="#net-msg-validator-protocol-message">Definition 106</a>) and indicates the approval vote
of a validator for a given candidate, described further in
<a href="#sect-availability-assignment-criteria">Section 6.5.1</a>. The approval distribution message,
\$M\$, is a varying datatype of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$M   = {(0,-&gt;,((C_,I_)_0…(C,I)_n)),(1,-&gt;,(V_0,…V_n)):}\$
\$C   = (B_h,A_i,c_a)\$
\$c_a = (c_k,P_o,P_p)\$
\$c_k = {(0→s),(1→i):}\$
\$V   = (B_h,I,A_i,A_s)\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$M\$ is a varying datatype where <em>0</em> indicates assignments for candidates in
recent, unfinalized blocks and <em>1</em> indicates approvals for candidates in some
recent, unfinalized block.</p>
</li>
<li>
<p>\$C\$ is an assignment criterion which refers to the candidate under which
the assignment is relevant by the block hash.</p>
</li>
<li>
<p>\$I\$ is an unsigned 32-bit integer indicating the index of the candidate,
corresponding the the order of the availability cores
(<a href="#sect-rt-api-availability-cores">Section 26.6.3</a>).</p>
</li>
<li>
<p>\$B_h\$ is the relay chain block hash where the candidate appears.</p>
</li>
<li>
<p>\$A_i\$ is the authority set Id (<a href="#defn-authority-list">Definition 58</a>) of the validator
that created this message.</p>
</li>
<li>
<p>\$A_s\$ is the signature of the validator issuing this message.</p>
</li>
<li>
<p>\$c_a\$ is the certification of the assignment.</p>
</li>
<li>
<p>\$c_k\$ is a varying datatype where <em>0</em> indicates an assignment based on
the VRF that authorized the relay chain block where the candidate was included,
followed by a sample number, \$s\$. <em>1</em> indicates an assignment story based
on the VRF that authorized the relay chain block where the candidate was
included combined with the index of a particular core. This is described further
in <a href="#sect-approval-voting">Section 6.5</a>.</p>
</li>
<li>
<p>\$P_o\$ is a VRF output and \$P_p\$ its corresponding proof.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_request_response"><a class="link" href="#_request_response">6.7.2. Request &amp; Response</a></h4>
<div class="paragraph">
<p>The request &amp; response network messages are sent and received between peers in
the Polkadot network, including collators and non-validator nodes. Those
messages are conducted on the request-response substreams
(<a href="#sect-connection-establishment">Section 4.5</a>). The network messages are SCALE encoded as
described in Section ?.</p>
</div>
<div id="net-msg-pov-fetching-request" class="exampleblock">
<div class="title">Definition 112. <a href="#net-msg-pov-fetching-request">PoV Fetching Request</a></div>
<div class="content">
<div class="paragraph">
<p>The PoV fetching request is sent by clients who want to retrieve a PoV block
from a node. The request is a datastructure of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$C_h\$
</div>
</div>
<div class="paragraph">
<p>where \$C_h\$ is the 256-bit hash of the PoV block. The response message is
defined in <a href="#net-msg-pov-fetching-response">Definition 113</a>.</p>
</div>
</div>
</div>
<div id="net-msg-pov-fetching-response" class="exampleblock">
<div class="title">Definition 113. <a href="#net-msg-pov-fetching-response">PoV Fetching Response</a></div>
<div class="content">
<div class="paragraph">
<p>The PoV fetching response is sent by nodes to the clients who issued a PoV
fetching request (<a href="#net-msg-pov-fetching-request">Definition 112</a>). The response, \$R\$, is
a varying datatype of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$R = {(0,-&gt;,B),(1,-&gt;,phi):}\$
</div>
</div>
<div class="paragraph">
<p>where <em>0</em> is followed by the PoV block and <em>1</em> indicates that the PoV block was
not found.</p>
</div>
</div>
</div>
<div id="net-msg-chunk-fetching-request" class="exampleblock">
<div class="title">Definition 114. <a href="#net-msg-chunk-fetching-request">Chunk Fetching Request</a></div>
<div class="content">
<div class="paragraph">
<p>The chunk fetching request is sent by clients who want to retrieve chunks of a
parachain candidate. The request is a datastructure of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$(C_h,i)\$
</div>
</div>
<div class="paragraph">
<p>where \$C_h\$ is the 256-bit hash of the parachain candidate and \$i\$ is a
32-bit unsigned integer indicating the index of the chunk to fetch. The response
message is defined in <a href="#net-msg-chunk-fetching-response">Definition 115</a>.</p>
</div>
</div>
</div>
<div id="net-msg-chunk-fetching-response" class="exampleblock">
<div class="title">Definition 115. <a href="#net-msg-chunk-fetching-response">Chunk Fetching Response</a></div>
<div class="content">
<div class="paragraph">
<p>The chunk fetching response is sent by nodes to the clients who issued a chunk
fetching request (<a href="#net-msg-chunk-fetching-request">Definition 114</a>). The response, \$R\$, is
a varying datatype of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$R = {(0,-&gt;,C_r),(1,-&gt;,phi):}\$
\$C_r = (c,c_p)\$
</div>
</div>
<div class="paragraph">
<p>where <em>0</em> is followed by the chunk response, \$C_r\$ and __1 indicates that
the requested chunk was not found. \$C_r\$ contains the erasure-encoded chunk
of data belonging to the candidate block, \$c\$, and \$c_p\$ is that
chunks proof in the Merkle tree. Both \$c\$ and \$c_p\$ are byte arrays of
type \$(b_n…b_m)\$.</p>
</div>
</div>
</div>
<div id="net-msg-available-data-request" class="exampleblock">
<div class="title">Definition 116. <a href="#net-msg-available-data-request">Available Data Request</a></div>
<div class="content">
<div class="paragraph">
<p>The available data request is sent by clients who want to retrieve the PoV block
of a parachain candidate. The request is a datastructure of the following
format:</p>
</div>
<div class="stemblock">
<div class="content">
\$C_h\$
</div>
</div>
<div class="paragraph">
<p>where \$C_h\$ is the 256-bit candidate hash to get the available data for.
The response message is defined in <a href="#net-msg-available-data-response">Definition 117</a>.</p>
</div>
</div>
</div>
<div id="net-msg-available-data-response" class="exampleblock">
<div class="title">Definition 117. <a href="#net-msg-available-data-response">Available Data Response</a></div>
<div class="content">
<div class="paragraph">
<p>The available data response is sent by nodes to the clients who issued a
available data request (<a href="#net-msg-available-data-request">Definition 116</a>). The response,
\$R\$, is a varying datatype of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$R = {(0,-&gt;,A),(1,-&gt;,phi):}\$
\$A = (P_{ov},D_{pv})\$
</div>
</div>
<div class="paragraph">
<p>where <em>0</em> is followed by the available data, \$A\$, and <em>1</em> indicates the the
requested candidate hash was not found. \$P_{ov}\$ is the PoV block
(<a href="#defn-para-block">Section 6.8.3</a>) and \$D_{pv}\$ is the persisted validation data
(<a href="#defn-persisted-validation-data">Definition 188</a>).</p>
</div>
</div>
</div>
<div id="net-msg-collation-fetching-request" class="exampleblock">
<div class="title">Definition 118. <a href="#net-msg-collation-fetching-request">Collation Fetching Request</a></div>
<div class="content">
<div class="paragraph">
<p>The collation fetching request is sent by clients who want to retrieve the
advertised collation at the specified relay chain block. The request is a
datastructure of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$(B_h,P_{id})\$
</div>
</div>
<div class="paragraph">
<p>where \$B_h\$ is the hash of the relay chain block and \$P_{id}\$ is the
parachain Id (<a href="#defn-para-id">Section 6.8.5</a>). The response message is defined in
<a href="#net-msg-collation-fetching-response">Definition 119</a>.</p>
</div>
</div>
</div>
<div id="net-msg-collation-fetching-response" class="exampleblock">
<div class="title">Definition 119. <a href="#net-msg-collation-fetching-response">Collation Fetching Response</a></div>
<div class="content">
<div class="paragraph">
<p>The collation fetching response is sent by nodes to the clients who issued a
collation fetching request (<a href="#net-msg-collation-fetching-request">Definition 118</a>). The
response, \$R\$, is a varying datatype of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$R = {(0,-&gt;,(C_r,B)):}\$
</div>
</div>
<div class="paragraph">
<p>where \$0\$ is followed by the candidate receipt
(<a href="#defn-candidate-receipt">Definition 97</a>), \$C_r\$, as and the PoV block
(<a href="#defn-para-block">Section 6.8.3</a>), \$B\$. This type does not notify the client about a
statement that was not found.</p>
</div>
</div>
</div>
<div id="net-msg-statement-fetching-request" class="exampleblock">
<div class="title">Definition 120. <a href="#net-msg-statement-fetching-request">Statement Fetching Request</a></div>
<div class="content">
<div class="paragraph">
<p>The statement fetching request is sent by clients who want to retrieve
statements about a given candidate. The request is a datastructure of the
following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$(B_h,C_h)\$
</div>
</div>
<div class="paragraph">
<p>where \$B_h\$ is the hash of the relay chain parent and \$C_h\$ is the
candidate hash that was used to create a committed candidate receipt
(<a href="#defn-committed-candidate-receipt">Definition 98</a>). The response message is defined in
<a href="#net-msg-statement-fetching-response">Definition 121</a>.</p>
</div>
</div>
</div>
<div id="net-msg-statement-fetching-response" class="exampleblock">
<div class="title">Definition 121. <a href="#net-msg-statement-fetching-response">Statement Fetching Response</a></div>
<div class="content">
<div class="paragraph">
<p>The statement fetching response is sent by nodes to the clients who issued a
collation fetching request (<a href="#net-msg-statement-fetching-request">Definition 120</a>). The
response, \$R\$, is a varying datatype of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$R = {(0,-&gt;,C_r):}\$
</div>
</div>
<div class="paragraph">
<p>where \$C_r\$ is the committed candidate receipt
(<a href="#defn-committed-candidate-receipt">Definition 98</a>). No response is returned if no statement
is found.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="net-msg-dispute-request"><a class="link" href="#net-msg-dispute-request">6.7.2.1. Dispute Request</a></h5>
<div class="paragraph">
<p>The dispute request is sent by clients who want to issue a dispute about a
candidate. The request, \$D_r\$, is a datastructure of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$D_r = (C_r,S_i,I_v,V_v)\$
\$I_v = (A_i,A_s,k_i)\$
\$V_v = (A_i,A_s,k_v)\$
\$k_i = {(0,-&gt;,phi):}\$
\$k_v = {(0,-&gt;,phi),(1,-&gt;,C_h),(2,-&gt;,C_h),(3,-&gt;,phi):}\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$C_r\$ is the candidate that is being disputed. The structure is a
candidate receipt (<a href="#defn-candidate-receipt">Definition 97</a>).</p>
</li>
<li>
<p>\$S_i\$ is an unsigned 32-bit integer indicating the session index the candidate appears in.</p>
</li>
<li>
<p>\$I_v\$ is the invalid vote that makes up the request.</p>
</li>
<li>
<p>\$V_v\$ is the valid vote that makes this dispute request valid.</p>
</li>
<li>
<p>\$A_i\$ is an unsigned 32-bit integer indicating the validator index in the
authority set (<a href="#defn-authority-list">Definition 58</a>).</p>
</li>
<li>
<p>\$A_s\$ is the signature of the validator.</p>
</li>
<li>
<p>\$k_i\$ is a varying datatype and implies the dispute statement. <em>0</em>
indicates an explicit statement.</p>
</li>
<li>
<p>\$k_v\$ is a varying datatype and implies the dispute statement.</p>
<div class="ulist">
<ul>
<li>
<p>\$0\$ indicates an explicit statement.</p>
</li>
<li>
<p>\$1\$ indicates a seconded statement on a candidate, \$C_h\$, from the
backing phase. \$C_h\$ is the hash of the candidate.</p>
</li>
<li>
<p>\$2\$ indicates a valid statement on a candidate, \$C_h\$, from the
backing phase. \$C_h\$ is the hash of the candidate.</p>
</li>
<li>
<p>\$3\$ indicates an approval vote from the approval checking phase.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The response message is defined in <a href="#net-msg-dispute-response">Section 6.7.2.2</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="net-msg-dispute-response"><a class="link" href="#net-msg-dispute-response">6.7.2.2. Dispute Response</a></h5>
<div class="paragraph">
<p>The dispute response is sent by nodes to the clients who who issued a dispute
request (<a href="#net-msg-dispute-request">Section 6.7.2.1</a>). The response, \$R\$, is a varying type
of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$R = {(0,-&gt;,phi):}\$
</div>
</div>
<div class="paragraph">
<p>where \$0\$ indicates that the dispute was successfully processed.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-anv-definitions"><a class="link" href="#sect-anv-definitions">6.8. Definitions</a></h3>
<div class="sect3">
<h4 id="defn-collator"><a class="link" href="#defn-collator">6.8.1. Collator</a></h4>
<div class="paragraph">
<p>A collator is a parachain node that sends parachain blocks, known as candidates as defined in Definition 7.2, to the relay chain validators. The relay chain validators are not concerned how the collator works or how it creates candidates.</p>
</div>
</div>
<div class="sect3">
<h4 id="defn-candidate"><a class="link" href="#defn-candidate">6.8.2. Candidate</a></h4>
<div class="paragraph">
<p>A candidate is a submitted parachain block as defined in Definition 7.3 to the relay chain validators. A parachain block stops being referred to as a candidate as soon it has been finalized.</p>
</div>
</div>
<div class="sect3">
<h4 id="defn-para-block"><a class="link" href="#defn-para-block">6.8.3. Parachain Block</a></h4>
<div class="paragraph">
<p>A parachain block or a Proof-of-Validity block (PoV block) contains the necessary data to for parachain specific state transition logic. Relay chain validators are not concerned with the inner structure of the block and treat it as a byte array.</p>
</div>
</div>
<div class="sect3">
<h4 id="defn-head-data"><a class="link" href="#defn-head-data">6.8.4. Head Data</a></h4>
<div class="paragraph">
<p>The head data is contains information about a parachain block as defined in Definition 7.3. The head data is returned by executing the parachain Runtime and relay chain validators are not concerned with its inner structure and treat it as a byte arrays.</p>
</div>
</div>
<div class="sect3">
<h4 id="defn-para-id"><a class="link" href="#defn-para-id">6.8.5. Parachain Id</a></h4>
<div class="paragraph">
<p>The Parachain Id is a unique, unsigned 32-bit integer which serves as an identifier of a parachain, assigned by the Runtime.</p>
</div>
</div>
<div class="sect3">
<h4 id="defn-availability-core"><a class="link" href="#defn-availability-core">6.8.6. Availability Core</a></h4>
<div class="paragraph">
<p>Availability cores are slots used to process parachains. The Runtime assigns each parachain to a availability core and validators can fetch information about the cores, such as parachain block candidates, by calling the appropriate Runtime API as described in Section 7.8.3. Validators are not concerned with the internal workings from the Runtimes perspective.</p>
</div>
</div>
<div class="sect3">
<h4 id="defn-validator-groups"><a class="link" href="#defn-validator-groups">6.8.7. Validator Groups</a></h4>
<div class="paragraph">
<p>Validator groups indicate which validators are responsible for creating backable candidates for certain parachains, as described in Section 7.4, and are assigned by the Runtime. Validators are not concerned with the internal workings from the Runtimes perspective. Collators can use this information for submitting blocks.</p>
</div>
</div>
<div class="sect3">
<h4 id="defn-upward-message"><a class="link" href="#defn-upward-message">6.8.8. Upward Message</a></h4>
<div class="paragraph">
<p>An upward message is an opaque byte array sent from a parachain to a relay chain.</p>
</div>
</div>
<div class="sect3">
<h4 id="defn-downward-message"><a class="link" href="#defn-downward-message">6.8.9. Downward Message</a></h4>
<div class="paragraph">
<p>A downward message is an opaque byte array received by the parachain from the relay chain.</p>
</div>
</div>
<div class="sect3">
<h4 id="defn-outbound-hrmp-message"><a class="link" href="#defn-outbound-hrmp-message">6.8.10. Outbound HRMP Message</a></h4>
<div class="paragraph">
<p>An outbound HRMP message (Horizontal Relay-routed Message Passing) is sent from the perspective of a sender of a parachain to an other parachain by passing it through the relay chain. It&#8217;s a datastructure of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$(I,M)\$
</div>
</div>
<div class="paragraph">
<p>where I is the recipient Id as defined in Definition 7.5 and M is an upward message as defined in Definition 7.8.</p>
</div>
</div>
<div class="sect3">
<h4 id="defn-inbound-hrmp-message"><a class="link" href="#defn-inbound-hrmp-message">6.8.11. Inbound HRMP Message</a></h4>
<div class="paragraph">
<p>An inbound HRMP message (Horizontal Relay-routed Message Passing) is seen from the perspective of a recipient parachain sent from an other parachain by passing it through the relay chain. It&#8217;s a datastructure of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$(N,M)\$
</div>
</div>
<div class="paragraph">
<p>where N is the relay chain block number at which the message was passed down to the recipient parachain and M is a downward message as defined in Definition 7.9.</p>
</div>
</div>
<div class="sect3">
<h4 id="defn-bitfield-array"><a class="link" href="#defn-bitfield-array">6.8.12. Bitfield Array</a></h4>
<div class="paragraph">
<p>A bitfield array contains single-bit values which indidate whether a candidate is available. The number of items is equal of to the number of availability cores as defined in Definition 7.6 and each bit represents a vote on the corresponding core in the given order. Respectively, if the single bit equals 1, then the Polkadot validator claims that the availability core is occupied, there exists a committed candidate receipt as defined in Definition 7.17 and that the validator has a stored chunk of the parachain block as defined in Definition 7.6.2.</p>
</div>
</div>
</div>
</div>
</div>
<h1 id="_runtime_specification" class="sect0"><a class="link" href="#_runtime_specification">Runtime Specification</a></h1>
<div class="openblock partintro">
<div class="content">
Description of various useful Runtime internals
</div>
</div>
<div class="sect1">
<h2 id="_extrinsics"><a class="link" href="#_extrinsics">7. Extrinsics</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_2"><a class="link" href="#_introduction_2">7.1. Introduction</a></h3>
<div class="paragraph">
<p>An extrinsic is a SCALE encoded array consisting of a version number,
signature, and varying data types indicating the resulting Runtime
function to be called, including the parameters required for that
function to be executed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_preliminaries_6"><a class="link" href="#_preliminaries_6">7.2. Preliminaries</a></h3>
<div id="defn-extrinsic" class="exampleblock">
<div class="title">Definition 122. Extrinsic</div>
<div class="content">
<div class="paragraph">
<p>An extrinsic , \(tx\), is a tuple consisting of the extrinsic
version, \(T_v\) (<a href="#defn-extrinsic-version">Definition 123</a>), and the body of
the extrinsic, \(T_b\).</p>
</div>
<div class="stemblock">
<div class="content">
\[tx := (T_v, T_b)\]
</div>
</div>
<div class="paragraph">
<p>The value of \(T_b\) varies for each version. The current
version 4 is described in <a href="#sect-version-four">Section 7.3.1</a>.</p>
</div>
</div>
</div>
<div id="defn-extrinsic-version" class="exampleblock">
<div class="title">Definition 123. Extrinsic Version</div>
<div class="content">
<div class="paragraph">
<p>\(T_v\) is a 8-bit bitfield and defines the extrinsic version. The
required format of an extrinsic body, \(T_b\), is dictated by the
Runtime. Older or unsupported version are rejected.</p>
</div>
<div class="paragraph">
<p>The first bit of \(T_v\) indicates whether the transaction is
<strong>signed</strong> (\(1\)) or <strong>unsigned</strong> (\(0\)). The
remaining 7-bits represent the version number. As an example, for
extrinsic format version 4, an signed extrinsic represents
\(T_v\) as <code>132</code> while a unsigned extrinsic represents it as <code>4</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_extrinsics_body"><a class="link" href="#_extrinsics_body">7.3. Extrinsics Body</a></h3>
<div class="sect3">
<h4 id="sect-version-four"><a class="link" href="#sect-version-four">7.3.1. Version 4</a></h4>
<div class="paragraph">
<p>Version 4 of the Polkadot extrinsic format is defined as follows:</p>
</div>
<div class="stemblock">
<div class="content">
\[T_b := (A_i, Sig, E, M_i, F_i(m))\]
</div>
</div>
<div class="paragraph">
<p>where each values represents:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\(A_i\): the 32-byte address of the sender (<a href="#defn-extrinsic-address">Definition 124</a>).</p>
</li>
<li>
<p>\(Sig\): the signature of the sender (<a href="#defn-extrinsic-signature">Definition 125</a>).</p>
</li>
<li>
<p>\(E\): the extra data for the extrinsic (<a href="#defn-extra-data">Definition 126</a>).</p>
</li>
<li>
<p>\(M_i\): the indicator of the Polkadot module (<a href="#defn-module-indicator">Definition 127</a>).</p>
</li>
<li>
<p>\(F_i(m)\): the indicator of the function of the Polkadot module (<a href="#defn-function-indicator">Definition 128</a>).</p>
</li>
</ul>
</div>
<div id="defn-extrinsic-address" class="exampleblock">
<div class="title">Definition 124. Extrinsic Address</div>
<div class="content">
<div class="paragraph">
<p>Account Id, \(A_i\), is the 32-byte address of the sender of the
extrinsic as described in the
<a href="https://github.com/paritytech/substrate/wiki/External-Address-Format-(SS58)">external
SS58 address format</a>.</p>
</div>
</div>
</div>
<div id="defn-extrinsic-signature" class="exampleblock">
<div class="title">Definition 125. Extrinsic Signature</div>
<div class="content">
<div class="paragraph">
<p>The signature, \(Sig\), is a varying data type indicating the used
signature type, followed by the signature created by the extrinsic author.
The following types are supported:</p>
</div>
<div class="stemblock">
<div class="content">
\[Sig := \begin{cases}
         0, &amp; \text{Ed25519, followed by: } (b_0, ...,b_{63}) \\
         1, &amp; \text{Sr25519, followed by: } (b_0, ...,b_{63}) \\
         2, &amp; \text{Ecdsa, followed by: } (b_0, ...,b_{64})
       \end{cases}\]
</div>
</div>
<div class="paragraph">
<p>Signature types vary in sizes, but each individual type is always
fixed-size and therefore does not contain a length prefix. <code>Ed25519</code> and
<code>Sr25519</code> signatures are 512-bit while <code>Ecdsa</code> is 520-bit, where the
last 8 bits are the recovery ID.</p>
</div>
<div class="paragraph">
<p>The signature is created by signing payload \(P\).</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{aligned}
  P &amp;:= \begin{cases}
          Raw, &amp; \text{if } |Raw| \leq 256 \\
          Blake2(Raw), &amp; \text{if } |Raw| &gt; 256 \\
        \end{cases} \\
  Raw &amp;:= (M_i, F_i(m), E, R_v, F_v, H_h(G), H_h(B)) \\
\end{aligned}\]
</div>
</div>
<div class="paragraph">
<p>where each value represents:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\(M_i\): the module indicator (<a href="#defn-module-indicator">Definition 127</a>).</p>
</li>
<li>
<p>\(F_i(m)\): the function indicator of the module (<a href="#defn-function-indicator">Definition 128</a>).</p>
</li>
<li>
<p>\(E\): the extra data (<a href="#defn-extra-data">Definition 126</a>).</p>
</li>
<li>
<p>\(R_v\): a UINT32 containing the specification version of <code>14</code>.</p>
</li>
<li>
<p>\(F_v\): a UINT32 containing the format version of <code>2</code>.</p>
</li>
<li>
<p>\(H_h(G)\): a 32-byte array containing the genesis hash.</p>
</li>
<li>
<p>\(H_h(B)\): a 32-byte array containing the hash of the block
which starts the mortality period, as described in <a href="#defn-extrinsic-mortality">Definition 129</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div id="defn-extra-data" class="exampleblock">
<div class="title">Definition 126. Extra Data</div>
<div class="content">
<div class="paragraph">
<p>Extra data, \(E\), is a tuple containing additional meta data about
the extrinsic and the system it is meant to be executed in.</p>
</div>
<div class="stemblock">
<div class="content">
\[E := (T_{mor}, N, P_t)\]
</div>
</div>
<div class="paragraph">
<p>where each value represents:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\(T_{mor}\): contains the SCALE encoded mortality of the
extrinsic (<a href="#defn-extrinsic-mortality">Definition 129</a>).</p>
</li>
<li>
<p>\(N\): a compact integer containing the nonce of the sender.
The nonce must be incremented by one for each extrinsic created,
otherwise the Polkadot network will reject the extrinsic.</p>
</li>
<li>
<p>\(P_t\): a compact integer containing the transactor pay
including tip.</p>
</li>
</ul>
</div>
</div>
</div>
<div id="defn-module-indicator" class="exampleblock">
<div class="title">Definition 127. Module Indicator</div>
<div class="content">
<div class="paragraph">
<p>\(M_i\) is an indicator for the Runtime to which Polkadot <em>module</em>,
\(m\), the extrinsic should be forwarded to.</p>
</div>
<div class="paragraph">
<p>\(M_i\) is a varying data type pointing to every module
exposed to the network.</p>
</div>
<div class="stemblock">
<div class="content">
\[M_i := \begin{cases}
  0, &amp; \text{System} \\
  1, &amp; \text{Utility} \\
  ... &amp; \\
  7, &amp; \text{Balances} \\
  ... &amp;
\end{cases}\]
</div>
</div>
</div>
</div>
<div id="defn-function-indicator" class="exampleblock">
<div class="title">Definition 128. Function Indicator</div>
<div class="content">
<div class="paragraph">
<p>\(F_i(m)\) is a tuple which contains an indicator,
\(m_i\), for the Runtime to which <em>function</em> within the
Polkadot <em>module</em>, \(m\), the extrinsic should be forwarded
to. This indicator is followed by the concatenated and SCALE encoded
parameters of the corresponding function, \(params\).</p>
</div>
<div class="stemblock">
<div class="content">
\[F_i(m) := (m_i, params)\]
</div>
</div>
<div class="paragraph">
<p>The value of \(m_i\) varies for each Polkadot module, since
every module offers different functions. As an example, the <code>Balances</code>
module has the following functions:</p>
</div>
<div class="stemblock">
<div class="content">
\[Balances_i := \begin{cases}
  0, &amp; \text{transfer} \\
  1, &amp; \text{set_balance} \\
  2, &amp; \text{force_transfer} \\
  3, &amp; \text{transfer_keep_alive} \\
  ... &amp;
\end{cases}\]
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mortality"><a class="link" href="#_mortality">7.3.2. Mortality</a></h4>
<div id="defn-extrinsic-mortality" class="exampleblock">
<div class="title">Definition 129. Extrinsic Mortality</div>
<div class="content">
<div class="paragraph">
<p>Extrinsic <strong>mortality</strong> is a mechanism which ensures that an extrinsic is only
valid within a certain period of the ongoing Polkadot lifetime. Extrinsics can
also be immortal, as clarified in <a href="#sect-mortality-encoding">Section 7.3.2.2</a>.</p>
</div>
<div class="paragraph">
<p>The mortality mechanism works with two related values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\(M_{per}\): the period of validity in terms of block
numbers from the block hash specified as \(H_h(B)\) in the
payload (<a href="#defn-extrinsic-signature">Definition 125</a>). The
requirement is \(M_{per} \geq 4\) and \(M_{per}\)
must be the power of two, such as <code>32</code>, <code>64</code>, <code>128</code>, etc.</p>
</li>
<li>
<p>\(M_{pha}\): the phase in the period that this extrinsic’s
lifetime begins. This value is calculated with a formula and validators
can use this value in order to determine which block hash is included in
the payload. The requirement is \(M_{pha} &lt; M_{per}\).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order to tie a transaction’s lifetime to a certain block
(\(H_i(B)\)) after it was issued, without wasting precious
space for block hashes, block numbers are divided into regular periods
and the lifetime is instead expressed as a "phase"
(\(M_{pha}\)) from these regular boundaries:</p>
</div>
<div class="stemblock">
<div class="content">
\[M_{pha} = H_i(B)\ mod\ M_{per}\]
</div>
</div>
<div class="paragraph">
<p>\(M_{per}\) and \(M_{pha}\) are then included in the
extrinsic, as clarified in <a href="#defn-extra-data">Definition 126</a>, in the SCALE encoded form of
\(T_{mor}\) (<a href="#sect-mortality-encoding">Section 7.3.2.2</a>). Polkadot validators can use
\(M_{pha}\) to figure out the block hash included in the payload,
which will therefore result in a valid signature if the extrinsic is within the
specified period or an invalid signature if the extrinsic "died".</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_example"><a class="link" href="#_example">7.3.2.1. Example</a></h5>
<div class="paragraph">
<p>The extrinsic author choses \(M_{per} = 256\) at block
<code>10'000</code>, resulting with \(M_{pha} = 16\). The extrinsic is
then valid for blocks ranging from <code>10'000</code> to <code>10'256</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="sect-mortality-encoding"><a class="link" href="#sect-mortality-encoding">7.3.2.2. Encoding</a></h5>
<div class="paragraph">
<p>\(T_{mor}\) refers to the SCALE encoded form of type
\(M_{per}\) and \(M_{pha}\). \(T_{mor}\)
is the size of two bytes if the extrinsic is considered mortal, or
simply one bytes with the value equal to zero if the extrinsic is
considered immortal.</p>
</div>
<div class="stemblock">
<div class="content">
\[T_{mor} := Enc_{SC}(M_{per}, M_{pha})\]
</div>
</div>
<div class="paragraph">
<p>The SCALE encoded representation of mortality \(T_{mor}\)
deviates from most other types, as it’s specialized to be the smallest
possible value, as described in Algorithm
<a href="#algo-mortality-encode">Algorithm 4</a> and <a href="#algo-mortality-decode">Algorithm 5</a>.</p>
</div>
<div class="paragraph">
<p>If the extrinsic is immortal, specify a single byte with the value equal
to zero.</p>
</div>
<div class="sidebarblock">
<div class="content">
          <div id="algo-mortality-encode" class="imageblock">
            <div class="content"><div class="ps-root">
<div class="ps-algorithm with-caption">
<p class="ps-line" style="text-indent:-1.2em;padding-left:1.2em;">
<span class="ps-keyword">Algorithm 4 </span>Encode Mortality</p>
<div class="ps-algorithmic with-linenum">
<p class="ps-line" style="text-indent:-1.2em;padding-left:1.2em;">
<span class="ps-keyword">Require: </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mi>p</mi><mi>e</mi><mi>r</mi></mrow></msub><mo separator="true">,</mo><msub><mi>M</mi><mrow><mi>p</mi><mi>h</mi><mi>a</mi></mrow></msub></mrow><annotation encoding="application/x-tex">M_{per}, M_{pha}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">er</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">ha</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></p>
<div class="ps-block" style="margin-left:1.7999999999999998em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">1:</span><span class="ps-keyword">return </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mspace width="0.5em"/><mtext mathvariant="bold">if</mtext><mspace width="0.5em"/><mrow><mtext mathvariant="italic">extrinsic</mtext><mtext> </mtext><mtext mathvariant="italic">is</mtext><mtext> </mtext><mtext mathvariant="italic">immortal</mtext></mrow></mrow><annotation encoding="application/x-tex">0 \enspace \textbf{if} \enspace \textit{extrinsic is immortal}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.5em;"></span><span class="mord text"><span class="mord textbf">if</span></span><span class="mspace" style="margin-right:0.5em;"></span><span class="mord text"><span class="mord textit">extrinsic is immortal</span></span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">2:</span><span style="font-weight:bold;">init</span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo>=</mo></mrow><annotation encoding="application/x-tex">factor = </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span></span></span></span><span style="font-style:normal;font-variant:small-caps;">Limit</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>M</mi><mrow><mi>p</mi><mi>e</mi><mi>r</mi></mrow></msub><mo>&gt;</mo><mo>&gt;</mo><mn>12</mn><mo separator="true">,</mo><mtext> </mtext><mn>1</mn><mo separator="true">,</mo><mtext> </mtext><mi>ϕ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(M_{per} &gt;&gt; 12,\ 1,\ \phi)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">er</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">12</span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">ϕ</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">3:</span><span style="font-weight:bold;">init</span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>e</mi><mi>f</mi><mi>t</mi><mo>=</mo></mrow><annotation encoding="application/x-tex">left = </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span></span></span></span><span style="font-style:normal;font-variant:small-caps;">Limit</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo></mrow><annotation encoding="application/x-tex">(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span></span></span></span><span style="font-style:normal;font-variant:small-caps;">TZ</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>M</mi><mrow><mi>p</mi><mi>e</mi><mi>r</mi></mrow></msub><mo stretchy="false">)</mo><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mtext> </mtext><mn>1</mn><mo separator="true">,</mo><mtext> </mtext><mn>15</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(M_{per})-1,\ 1,\ 15)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">er</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">15</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">4:</span><span style="font-weight:bold;">init</span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mo>=</mo><mfrac><msub><mi>M</mi><mrow><mi>p</mi><mi>h</mi><mi>a</mi></mrow></msub><mrow><mi>f</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>o</mi><mi>r</mi></mrow></mfrac><mo>&lt;</mo><mo>&lt;</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">right = \frac{M_{pha}}{factor} &lt;&lt; 4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">h</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.4725189999999997em;vertical-align:-0.481108em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9914109999999998em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">or</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.51308em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:-0.10903em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">ha</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29011428571428566em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.481108em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">4</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">5:</span><span class="ps-keyword">return </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>e</mi><mi>f</mi><mi>t</mi><mi mathvariant="normal">∣</mi><mi>r</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">left|right</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">h</span><span class="mord mathnormal">t</span></span></span></span></p>
</div>
</div>
</div>
</div></div>
            <div class="title">Algorithm 4. <a href="#algo-mortality-encode">Encode Mortality</a></div>
          </div>
          <div id="algo-mortality-decode" class="imageblock">
            <div class="content"><div class="ps-root">
<div class="ps-algorithm with-caption">
<p class="ps-line" style="text-indent:-1.2em;padding-left:1.2em;">
<span class="ps-keyword">Algorithm 5 </span>Decode Mortality</p>
<div class="ps-algorithmic with-linenum">
<p class="ps-line" style="text-indent:-1.2em;padding-left:1.2em;">
<span class="ps-keyword">Require: </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi>m</mi><mi>o</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">T_{mor}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">or</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></p>
<div class="ps-block" style="margin-left:1.7999999999999998em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">1:</span><span class="ps-keyword">return </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="italic">Immortal</mtext><mspace width="0.5em"/><mtext mathvariant="bold">if</mtext><mspace width="0.5em"/><msubsup><mi>T</mi><mrow><mi>m</mi><mi>o</mi><mi>r</mi></mrow><mrow><mi>b</mi><mn>0</mn></mrow></msubsup><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\textit{Immortal} \enspace \textbf{if} \enspace T^{b0}_{mor} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.096108em;vertical-align:-0.247em;"></span><span class="mord text"><span class="mord textit">Immortal</span></span><span class="mspace" style="margin-right:0.5em;"></span><span class="mord text"><span class="mord textbf">if</span></span><span class="mspace" style="margin-right:0.5em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-2.4530000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">or</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">2:</span><span style="font-weight:bold;">init</span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>n</mi><mi>c</mi><mo>=</mo><msubsup><mi>T</mi><mrow><mi>m</mi><mi>o</mi><mi>r</mi></mrow><mrow><mi>b</mi><mn>0</mn></mrow></msubsup><mo>+</mo><mo stretchy="false">(</mo><msubsup><mi>T</mi><mrow><mi>m</mi><mi>o</mi><mi>r</mi></mrow><mrow><mi>b</mi><mn>1</mn></mrow></msubsup><mo>&lt;</mo><mo>&lt;</mo><mn>8</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">enc = T^{b0}_{mor} + (T^{b1}_{mor} &lt;&lt; 8)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.096108em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-2.4530000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">or</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.099108em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-2.4530000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">or</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">8</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">3:</span><span style="font-weight:bold;">init</span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mi>p</mi><mi>e</mi><mi>r</mi></mrow></msub><mo>=</mo><mn>2</mn><mo>&lt;</mo><mo>&lt;</mo><mo stretchy="false">(</mo><mi>e</mi><mi>n</mi><mi>c</mi><mtext> </mtext><mi>m</mi><mi>o</mi><mi>d</mi><mtext> </mtext><mo stretchy="false">(</mo><mn>1</mn><mo>&lt;</mo><mo>&lt;</mo><mn>4</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">M_{per} = 2 &lt;&lt; (enc\ mod\ (1 &lt;&lt; 4))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">er</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68354em;vertical-align:-0.0391em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mspace"> </span><span class="mord mathnormal">m</span><span class="mord mathnormal">o</span><span class="mord mathnormal">d</span><span class="mspace"> </span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mclose">))</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">4:</span><span style="font-weight:bold;">init</span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo>=</mo></mrow><annotation encoding="application/x-tex">factor = </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span></span></span></span><span style="font-style:normal;font-variant:small-caps;">Limit</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>M</mi><mrow><mi>p</mi><mi>e</mi><mi>r</mi></mrow></msub><mo>&gt;</mo><mo>&gt;</mo><mn>12</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mi>ϕ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(M_{per} &gt;&gt; 12, 1, \phi)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">er</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">12</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">ϕ</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">5:</span><span style="font-weight:bold;">init</span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mi>p</mi><mi>h</mi><mi>a</mi></mrow></msub><mo>=</mo><mo stretchy="false">(</mo><mi>e</mi><mi>n</mi><mi>c</mi><mo>&gt;</mo><mo>&gt;</mo><mn>4</mn><mo stretchy="false">)</mo><mo>∗</mo><mi>f</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>o</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">M_{pha} = (enc &gt;&gt; 4) * factor</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">ha</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">6:</span><span class="ps-keyword">return </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>M</mi><mrow><mi>p</mi><mi>e</mi><mi>r</mi></mrow></msub><mo separator="true">,</mo><msub><mi>M</mi><mrow><mi>p</mi><mi>h</mi><mi>a</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(M_{per}, M_{pha})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">er</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">ha</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></p>
</div>
</div>
</div>
</div></div>
            <div class="title">Algorithm 5. <a href="#algo-mortality-decode">Decode Mortality</a></div>
          </div>
<div class="ulist">
<ul>
<li>
<p>\(T^{b0}_{mor}\): the first byte of \(T_{mor}\).</p>
</li>
<li>
<p>\(T^{b1}_{mor}\): the second byte of \(T_{mor}\).</p>
</li>
<li>
<p>Limit(\(num\), \(min\), \(max\)):
Ensures that \(num\) is between \(min\) and
\(max\). If \(min\) or \(max\) is defined
as \(\phi\), then there is no requirement for the specified
minimum/maximum.</p>
</li>
<li>
<p>TZ(\(num\)): returns the number of trailing zeros in the
binary representation of \(num\). For example, the binary
representation of <code>40</code> is <code>0010 1000</code>, which has three trailing zeros.</p>
</li>
<li>
<p>\(&gt;&gt;\): performs a binary right shift operation.</p>
</li>
<li>
<p>\(&lt;&lt;\): performs a binary left shift operation.</p>
</li>
<li>
<p>\(|\) : performs a bitwise OR operation.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_weights"><a class="link" href="#_weights">8. Weights</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_motivation"><a class="link" href="#_motivation">8.1. Motivation</a></h3>
<div class="paragraph">
<p>The Polkadot network, like any other permissionless system, needs to
implement a mechanism to measure and to limit the usage in order to
establish an economic incentive structure, to prevent the network
overload, and to mitigate DoS vulnerabilities. In particular, Polkadot
enforces a limited time-window for block producers to create a block,
including limitations on block size, which can make the selection and
execution of certain extrinsics too expensive and decelerate the
network.</p>
</div>
<div class="paragraph">
<p>In contrast to some other systems such as Ethereum which implement fine
measurement for each executed low-level operation by smart contracts,
known as gas metering, Polkadot takes a more relaxed approach by
implementing a measuring system where the cost of the transactions
(referred to as ’extrinsics’) are determined before execution and are
known as the weight system.</p>
</div>
<div class="paragraph">
<p>The Polkadot weight system introduces a mechanism for block producers to
measure the cost of running the extrinsics and determine how "heavy" it
is in terms of execution time. Within this mechanism, block producers
can select a set of extrinsics and saturate the block to its fullest
potential without exceeding any limitations (as described in
<a href="#sect-limitations">Section 8.2.1</a>). Moreover, the weight system can be used to
calculate a fee for executing each extrinsics according to its weight
(as described in <a href="#sect-fee-calculation">Section 8.6.1</a>).</p>
</div>
<div class="paragraph">
<p>Additionally, Polkadot introduces a specified block ratio (as defined in
<a href="#sect-limitations">Section 8.2.1</a>), ensuring that only a certain portion of the total block
size gets used for regular extrinsics. The remaining space is reserved for
critical, operational extrinsics required for the functionality by Polkadot
itself.</p>
</div>
<div class="paragraph">
<p>To begin, we introduce in <a href="#sect-assumptions">Section 8.2</a> the assumption upon which the
Polkadot transaction weight system is designed. In <a href="#sect-limitations">Section 8.2.1</a>, we
discuss the limitation Polkadot needs to enforce on the block size. In
<a href="#sect-runtime-primitives">Section 8.3</a>, we describe in detail the procedure upon which the
weight of any transaction should be calculated. In <a href="#sect-practical-examples">Section 8.5</a>,
we present how we apply this procedure to compute the weight of particular
runtime functions.</p>
</div>
</div>
<div class="sect2">
<h3 id="sect-assumptions"><a class="link" href="#sect-assumptions">8.2. Assumptions</a></h3>
<div class="paragraph">
<p>In this section, we define the concept of weight and we discuss the
considerations that need to be accounted for when assigning weight to
transactions. These considerations are essential in order for the weight
system to deliver its fundamental mission, i.e. the fair distribution of
network resources and preventing a network overload. In this regard,
weights serve as an indicator on whether a block is considered full and
how much space is left for remaining, pending extrinsics. Extrinsics
which require too many resources are discarded. More formally, the
weight system should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>prevent the block from being filled with too many extrinsics</p>
</li>
<li>
<p>avoid extrinsics where its execution takes too long, by assigning a
transaction fee to each extrinsic proportional to their resource
consumption.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These concepts are formalized in <a href="#defn-block-length">Definition 130</a> and
<a href="#defn-polkadot-block-limits">Definition 133</a>:</p>
</div>
<div id="defn-block-length" class="exampleblock">
<div class="title">Definition 130. Block Length</div>
<div class="content">
<div class="paragraph">
<p>For a block \(B\) with \(Head(B)\) and \(Body(B)\) the
block length of \(B\), \(Len(B)\), is defined as the amount of
raw bytes of \(B\).</p>
</div>
</div>
</div>
<div id="defn-target-time-per-block" class="exampleblock">
<div class="title">Definition 131. Target Time per Block</div>
<div class="content">
<div class="paragraph">
<p>Ṯargeted time per block denoted by \(T(B)\) implies the amount of
seconds that a new block should be produced by a validator. The transaction
weights must consider \(T(B)\) in order to set restrictions on time
intensive transactions in order to saturate the block to its fullest potential
until \(T(B)\) is reached.</p>
</div>
</div>
</div>
<div id="def:block-target-time" class="exampleblock">
<div class="title">Definition 132. Block Target Time</div>
<div class="content">
<div class="paragraph">
<p>Available block ration reserved for normal, noted by \(R(B)\), is
defined as the maximum weight of none-operational transactions in the Body of
\(B\) divided by \(Len(B)\).</p>
</div>
</div>
</div>
<div id="defn-polkadot-block-limits" class="exampleblock">
<div class="title">Definition 133. Block Limits</div>
<div class="content">
<div class="paragraph">
<p>P̱olkadot block limits as defined here should be respected by each block producer
for the produced block \(B\) to be deemed valid:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\(Len(B) \le 5 \times 1'024 \times 1'024 = 5'242'880\) Bytes</p>
</li>
<li>
<p>\(T(B) = 6\ seconds\)</p>
</li>
<li>
<p>\(R(B) \le 0.75\)</p>
</li>
</ul>
</div>
</div>
</div>
<div id="defn:weight-function" class="exampleblock">
<div class="title">Definition 134. Weight Function</div>
<div class="content">
<div class="paragraph">
<p>The P̱olkadot transaction weight function denoted by \(\mathcal{W}\) as follows:</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{aligned}
  \mathcal{W} &amp;: \mathcal{E} \rightarrow \mathbb{N} \\
  \mathcal{W} &amp;: E \mapsto w
\end{aligned}\]
</div>
</div>
<div class="paragraph">
<p>where \(w\) is a non-negative integer representing the weight of the
extrinsic \(E\). We define the weight of all inherent extrinsics as
defined in the <a href="#sect-inherents">Section 3.2.3</a> to be equal to 0. We extend the definition of
\(\mathcal{W}\) function to compute the weight of the block as sum of
weight of all extrinsics it includes:</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{aligned}
  \mathcal{W} &amp;: \mathcal{B}\rightarrow \mathbb{N} \\
  \mathcal{W} &amp;: B \mapsto \sum_{E\in B}(W(E))
\end{aligned}\]
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the remainder of this section, we discuss the requirements to which
the weight function needs to comply to.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Computations of function \(\mathcal{W}(E)\) must be
determined before execution of that \(E\).</p>
</li>
<li>
<p>Due to the limited time window, computations of \(\mathcal{W}\)
must be done quickly and consume few resources themselves.</p>
</li>
<li>
<p>\(\mathcal{W}\) must be self contained and must not require I/O on
the chain state. \(\mathcal{W}(E)\) must depend solely on the Runtime
function representing \(E\) and its parameters.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Heuristically, "heaviness" corresponds to the execution time of an
extrinsic. In that way, the \(\mathcal{W}\) value for various extrinsics should be
proportional to their execution time. For example, if Extrinsic A takes
three times longer to execute than Extrinsic B, then Extrinsic A should
roughly weighs 3 times of Extrinsic B. Or:</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathcal{W}(A) \approx 3 \times \mathcal{W}(B)\]
</div>
</div>
<div class="paragraph">
<p>Nonetheless, \(\mathcal{W}(E)\) can be manipulated depending on the
priority of \(E\) the chain is supposed to endorse.</p>
</div>
<div class="sect3">
<h4 id="sect-limitations"><a class="link" href="#sect-limitations">8.2.1. Limitations</a></h4>
<div class="paragraph">
<p>In this section we discuss how applying the limitation defined in
<a href="#defn-polkadot-block-limits">Definition 133</a> can be translated to limitation \(\mathcal{W}\).
In order to be able to translate those into concrete numbers, we need to
identify an arbitrary maximum weight to which we scale all other computations.
For that we first define the block weight and then assume a maximum on it block
length in <a href="#defn-block-weight">Definition 135</a>:</p>
</div>
<div id="defn-block-weight" class="exampleblock">
<div class="title">Definition 135. Block Weight</div>
<div class="content">
<div class="paragraph">
<p>We define the block weight of block \(B\), formally denoted as
\(\mathcal{W}(B)\), to be:</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathcal{W}(B) = \sum^{|\mathcal{E}|}_{n = 0} (W(E_n))\]
</div>
</div>
<div class="paragraph">
<p>We require that:</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathcal{W}(B) &lt; 2'000'000'000'000\]
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The weights must fulfil the requirements as noted by the fundamentals
and limitations, and can be assigned as the author sees fit. As a simple
example, consider a maximum block weight of 1’000’000’000, an available
ratio of 75% and a targeted transaction throughput of 500 transactions,
we could assign the (average) weight for each transaction at about
1’500’000. Block producers have economic incentive to include as many
extrinsics as possible (without exceeding limitations) into a block
before reaching the targeted block time. Weights give indicators to
block producers on which extrinsics to include in order to reach the
blocks fullest potential.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-runtime-primitives"><a class="link" href="#sect-runtime-primitives">8.3. Calculation of the weight function</a></h3>
<div class="paragraph">
<p>In order to calculate weight of block \(B\),
\(\mathcal{W}(B)\), one needs to evaluate the weight of each
transaction included in the block. Each transaction causes the execution
certain Runtime functions. As such, to calculate the weight of a
transaction, those functions must be analyzed in order to determine
parts of the code which can significantly contribute to the execution
time and consume resources such as loops, I/O operations, and data
manipulation. Subsequently the performance and execution time of each
part will be evaluated based on variety of input parameters. Based on
those observations, weights are assigned Runtime functions or parameters
which contribute to long execution times. These sub component of the
code are discussed in <a href="#sect-primitive-types">Section 8.4.1</a>.</p>
</div>
<div class="paragraph">
<p>The general algorithm to calculate \(\mathcal{W}(E)\) is described in
the <a href="#sect-benchmarking">Section 8.4</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="sect-benchmarking"><a class="link" href="#sect-benchmarking">8.4. Benchmarking</a></h3>
<div class="paragraph">
<p>Calculating the extrinsic weight solely based on theoretical complexity
of the underlying implementation proves to be too complicated and
unreliable at the same time. Certain decisions in the source code
architecture, internal communication within the Runtime or other design
choices could add enough overhead to make the asymptotic complexity
practically meaningless.</p>
</div>
<div class="paragraph">
<p>On the other hand, benchmarking an extrinsics in a black-box fashion
could (using random parameters) most centainly results in missing corner
cases and worst case senarios. Instead, we benchmark all available
Runtime functions which are invoked in the course of execution of
extrinsics with a large collection of carefully selected input
parameters and use the result of the benchmarking process to evaluate
\(\mathcal{W}(E)\).</p>
</div>
<div class="paragraph">
<p>In order to select useful parameters, the Runtime functions have to be
analysed to fully understand which behaviors or conditions can result in
expensive execution times, which is described closer in <a href="#sect-primitive-types">Section 8.4.1</a>.
Not every possible benchmarking outcome can be invoked by varying input
parameters of the Runtime function. In some circumstances, preliminary work
is required before a specific benchmark can be reliably measured, such as
creating certain preexisting entries in the storage or other changes to the
environment.</p>
</div>
<div class="paragraph">
<p>The Practical Examples (<a href="#sect-practical-examples">Section 8.5</a>) covers the
analysis process and the implementation of preliminary work in more
detail.</p>
</div>
<div class="sect3">
<h4 id="sect-primitive-types"><a class="link" href="#sect-primitive-types">8.4.1. Primitive Types</a></h4>
<div class="paragraph">
<p>The Runtime reuses components, known as "primitives", to interact with
the state storage. The execution cost of those primitives can be
measured and a weight should be applied for each occurrence within the
Runtime code.</p>
</div>
<div class="paragraph">
<p>For storage, Polkadot uses three different types of storage types across
its modules, depending on the context:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Value</strong>: Operations on a single value. The final key-value pair is
stored under the key:</p>
<div class="listingblock">
<div class="content">
<pre>    hash(module_prefix) + hash(storage_prefix)</pre>
</div>
</div>
</li>
<li>
<p><strong>Map</strong>: Operations on mulitple values, datasets, where each entry has
its corresponding, unique key. The final key-value pair is stored under
the key:</p>
<div class="listingblock">
<div class="content">
<pre>    hash(module_prefix) + hash(storage_prefix) + hash(encode(key))</pre>
</div>
</div>
</li>
<li>
<p><strong>Double map</strong>: Just like <strong>Map</strong>, but uses two keys instead of one. This
type is also known as "child storage", where the first key is the
"parent key" and the second key is the "child key". This is useful in
order to scope storage entries (child keys) under a certain <code>context</code>
(parent key), which is arbitrary. Therefore, one can have separated
storage entries based on the context. The final key-value pair is stored
under the key:</p>
<div class="listingblock">
<div class="content">
<pre>    hash(module_prefix) + hash(storage_prefix)
      + hash(encode(key1)) + hash(encode(key2))</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>It depends on the functionality of the Runtime module (or its
sub-processes, rather) which storage type to use. In some cases, only a
single value is required. In others, multiple values need to be fetched
or inserted from/into the database.</p>
</div>
<div class="paragraph">
<p>Those lower level types get abstracted over in each individual Runtime
module using the <code>decl_storage!</code> macro. Therefore, each module specifies
its own types that are used as input and output values. The abstractions
do give indicators on what operations must be closely observed and where
potential performance penalties and attack vectors are possible.</p>
</div>
<div class="sect4">
<h5 id="sect-primitive-types-considerations"><a class="link" href="#sect-primitive-types-considerations">8.4.1.1. Considerations</a></h5>
<div class="paragraph">
<p>The storage layout is mostly the same for every primitive type,
primarily differentiated by using special prefixes for the storage key.
Big differences arise on how the primitive types are used in the Runtime
function, on whether single values or entire datasets are being worked
on. Single value operations are generally quite cheap and its execution
time does not vary depending on the data that’s being processed.
However, excessive overhead can appear when I/O operations are executed
repeatedly, such as in loops. Especially, when the amount of loop
iterations can be influenced by the caller of the function or by certain
conditions in the state storage.</p>
</div>
<div class="paragraph">
<p>Maps, in contrast, have additional overhead when inserting or retrieving
datasets, which vary in sizes. Additionally, the Runtime function has to
process each item inside that list.</p>
</div>
<div class="paragraph">
<p>Indicators for performance penalties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Fixed iterations and datasets</strong> - Fixed iterations and datasets can
increase the overall cost of the Runtime functions, but the execution
time does not vary depending on the input parameters or storage entries.
A base Weight is appropriate in this case.</p>
</li>
<li>
<p><strong>Adjustable iterations and datasets</strong> - If the amount of iterations or
datasets depend on the input parameters of the caller or specific
entries in storage, then a certain weight should be applied for each
(additional) iteration or item. The Runtime defines the maximum value
for such cases. If it doesn’t, it unconditionally has to and the Runtime
module must be adjusted. When selecting parameters for benchmarking, the
benchmarks should range from the minimum value to the maximum value, as
described in <a href="#defn-max-value">Definition 136</a>.</p>
</li>
<li>
<p><strong>Input parameters</strong> - Input parameters that users pass on to the
Runtime function can result in expensive operations. Depending on the
data type, it can be appropriate to add additional weights based on
certain properties, such as data size, assuming the data type allows
varying sizes. The Runtime must define limits on those properties. If it
doesn’t, it unconditionally has to and the Runtime module must be
adjusted. When selecting parameters for benchmarking, the benchmarks
should range from the minimum values to the maximum value, as described
in paragraph <a href="#defn-max-value">Definition 136</a>.</p>
</li>
</ul>
</div>
<div id="defn-max-value" class="exampleblock">
<div class="title">Definition 136. Maximum Value</div>
<div class="content">
<div class="paragraph">
<p>What the maximum value should be really depends on the functionality that the
Runtime function is trying to provide. If the choice for that value is not
obvious, then it’s advised to run benchmarks on a big range of values and pick a
conservative value below the <code>targeted time per block</code> limit as described in
section <a href="#sect-limitations">Section 8.2.1</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_parameters"><a class="link" href="#_parameters">8.4.2. Parameters</a></h4>
<div class="paragraph">
<p>The inputs parameters highly vary depending on the Runtime function and
must therefore be carefully selected. The benchmarks should use input
parameters which will most likely be used in regular cases, as intended
by the authors, but must also consider worst case scenarios and inputs
which might decelerate or heavily impact performance of the function.
The input parameters should be randomised in order to cause various
effects in behaviors on certain values, such as memory relocations and
other outcomes that can impact performance.</p>
</div>
<div class="paragraph">
<p>It’s not possible to benchmark every single value. However, one should
select a range of inputs to benchmark, spanning from the minimum value
to the maximum value which will most likely exceed the expected usage of
that function. This is described in more detail in
<a href="#sect-primitive-types-considerations">Section 8.4.1.1</a>. The benchmarks should run
individual executions/iterations within that range, where the chosen
parameters should give insight on the execution time. Selecting
imprecise parameters or too extreme ranges might indicate an inaccurate
result of the function as it will be used in production. Therefore, when
a range of input parameters gets benchmarked, the result of each
individual parameter should be recorded and optionally visualized, then
the necessary adjustment can be made. Generally, the worst case scenario
should be assigned as the weight value for the corresponding runtime
function.</p>
</div>
<div class="paragraph">
<p>Additionally, given the distinction theoretical and practical usage, the
author reserves the right to make adjustments to the input parameters
and assigned weights according to the observed behavior of the actual,
real-world network.</p>
</div>
<div class="sect4">
<h5 id="_weight_refunds"><a class="link" href="#_weight_refunds">8.4.2.1. Weight Refunds</a></h5>
<div class="paragraph">
<p>When assigning the final weight, the worst case scenario of each runtime
function should be used. The runtime can then additional "refund" the
amount of weights which were overestimated once the runtime function is
actually executed.</p>
</div>
<div class="paragraph">
<p>The Polkadot runtime only returns weights if the difference between the
assigned weight and the actual weight calculated during execution is
greater than 20%.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_storage_io_cost"><a class="link" href="#_storage_io_cost">8.4.3. Storage I/O cost</a></h4>
<div class="paragraph">
<p>It is advised to benchmark the raw I/O operations of the database and
assign "base weights" for each I/O operation type, such as insertion,
deletion, querying, etc. When a runtime function is executed, the
runtime can then add those base weights of each used operation in order
to calculate the final weight.</p>
</div>
</div>
<div class="sect3">
<h4 id="_environment"><a class="link" href="#_environment">8.4.4. Environment</a></h4>
<div class="paragraph">
<p>The benchmarks should be executed on clean systems without interference
of other processes or software. Additionally, the benchmarks should be
executed on multiple machines with different system resources, such as
CPU performance, CPU cores, RAM and storage speed.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-practical-examples"><a class="link" href="#sect-practical-examples">8.5. Practical examples</a></h3>
<div class="paragraph">
<p>This section walks through Runtime functions available in the Polkadot
Runtime to demonstrate the analysis process as described in
<a href="#sect-primitive-types">Section 8.4.1</a>.</p>
</div>
<div class="paragraph">
<p>In order for certain benchmarks to produce conditions where resource
heavy computation or excessive I/O can be observed, the benchmarks might
require some preliminary work on the environment, since those conditions
cannot be created with simply selected parameters. The analysis process
shows indicators on how the preliminary work should be implemented.</p>
</div>
<div class="sect3">
<h4 id="_practical_example_1_request_judgement"><a class="link" href="#_practical_example_1_request_judgement">8.5.1. Practical Example #1: <code>request_judgement</code></a></h4>
<div class="paragraph">
<p>In Polkadot, accounts can save information about themselves on-chain,
known as the "Identity Info". This includes information such as display
name, legal name, email address and so on. Polkadot offers a set of
trusted registrars, entities elected by a Polkadot public referendum,
which can verify the specified contact addresses of the identities, such
as Email, and vouch on whether the identity actually owns those
accounts. This can be achieved, for example, by sending a challenge to
the specified address and requesting a signature as a response. The
verification is done off-chain, while the final judgement is saved
onchain, directly in the corresponding Identity Info. It’s also note
worthy that Identity Info can contain additional fields, set manually by
the corresponding account holder.</p>
</div>
<div class="paragraph">
<p>Information such as legal name must be verified by ID card or passport
submission.</p>
</div>
<div class="paragraph">
<p>The function <code>request_judgement</code> from the <code>identity</code> pallet allows users
to request judgement from a specific registrar.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(func $request_judgement (param $req_index int) (param $max_fee int))</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>req_index</code>: the index which is assigned to the registrar.</p>
</li>
<li>
<p><code>max_fee</code>: the maximum fee the requester is willing to pay. The
judgement fee varies for each registrar.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Studying this function reveals multiple design choices that can impact
performance, as it will be revealed by this analysis.</p>
</div>
<div class="sect4">
<h5 id="_analysis"><a class="link" href="#_analysis">8.5.1.1. Analysis</a></h5>
<div class="paragraph">
<p>First, it fetches a list of current registrars from storage and then
searches that list for the specified registrar index.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><span class="k">let</span> <span class="n">registrars</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">Registrars</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="nf">get</span><span class="p">();</span>
<span class="k">let</span> <span class="n">registrar</span> <span class="o">=</span> <span class="n">registrars</span><span class="nf">.get</span><span class="p">(</span><span class="n">reg_index</span> <span class="k">as</span> <span class="nb">usize</span><span class="p">)</span><span class="nf">.and_then</span><span class="p">(</span><span class="nn">Option</span><span class="p">::</span><span class="n">as_ref</span><span class="p">)</span>
  <span class="nf">.ok_or</span><span class="p">(</span><span class="nn">Error</span><span class="p">::</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">EmptyIndex</span><span class="p">)</span><span class="o">?</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, it searches for the Identity Info from storage, based on the
sender of the transaction.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><span class="k">let</span> <span class="k">mut</span> <span class="n">id</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">IdentityOf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="nf">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sender</span><span class="p">)</span><span class="nf">.ok_or</span><span class="p">(</span><span class="nn">Error</span><span class="p">::</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">NoIdentity</span><span class="p">)</span><span class="o">?</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Identity Info contains all fields that have a data in them, set by
the corresponding owner of the identity, in an ordered form. It then
proceeds to search for the specific field type that will be inserted or
updated, such as email address. If the entry can be found, the
corresponding value is to the value passed on as the function parameters
(assuming the registrar is not "stickied", which implies it cannot be
changed). If the entry cannot be found, the value is inserted into the
index where a matching element can be inserted while maintaining sorted
order. This results in memory reallocation, which increases resource
consumption.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><span class="k">match</span> <span class="n">id</span><span class="py">.judgements</span><span class="nf">.binary_search_by_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg_index</span><span class="p">,</span> <span class="p">|</span><span class="n">x</span><span class="p">|</span> <span class="n">x</span><span class="na">.0</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">Ok</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="k">if</span> <span class="n">id</span><span class="py">.judgements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="na">.1</span><span class="nf">.is_sticky</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">Err</span><span class="p">(</span><span class="nn">Error</span><span class="p">::</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">StickyJudgement</span><span class="p">)</span><span class="o">?</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">id</span><span class="py">.judgements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
  <span class="p">},</span>
  <span class="nf">Err</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="n">id</span><span class="py">.judgements</span><span class="nf">.insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">item</span><span class="p">),</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the end, the function deposits the specified <code>max_fee</code> balance, which
can later be redeemed by the registrar. Then, an event is created to
insert the Identity Info into storage. The creation of events is
lightweight, but its execution is what will actually commit the state
changes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><span class="nn">T</span><span class="p">::</span><span class="nn">Currency</span><span class="p">::</span><span class="nf">reserve</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sender</span><span class="p">,</span> <span class="n">registrar</span><span class="py">.fee</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="o">&lt;</span><span class="n">IdentityOf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="nf">insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sender</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
<span class="k">Self</span><span class="p">::</span><span class="nf">deposit_event</span><span class="p">(</span><span class="nn">RawEvent</span><span class="p">::</span><span class="nf">JudgementRequested</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">reg_index</span><span class="p">));</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sect-considerations"><a class="link" href="#sect-considerations">8.5.1.2. Considerations</a></h5>
<div class="paragraph">
<p>The following points must be considered:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Varying count of registrars.</p>
</li>
<li>
<p>Varying count of preexisting accounts in storage.</p>
</li>
<li>
<p>The specified registrar is searched for in the Identity Info. An
identity can be judged by as many registrars as the identity owner
issues requests for, therefore increase its footprint in the state
storage. Additionally, if a new value gets inserted into the byte array,
memory get reallocated. Depending on the size of the Identity Info, the
execution time can vary.</p>
</li>
<li>
<p>The Identity Info can contain only a few fields or many. It is
legitimate to introduce additional weights for changes the owner/sender
has influence over, such as the additional fields in the Identity Info.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_benchmarking_framework"><a class="link" href="#_benchmarking_framework">8.5.1.3. Benchmarking Framework</a></h5>
<div class="paragraph">
<p>The Polkadot Runtime specifies the <code>MaxRegistrars</code> constant, which will
prevent the list of registrars of reaching an undesired length. This
value should have some influence on the benchmarking process.</p>
</div>
<div class="paragraph">
<p>The benchmarking implementation of for the function
\(request\_judgement\) can be defined as follows:</p>
</div>
<div class="sidebarblock">
<div class="content">
          <div id="algo-6" class="imageblock">
            <div class="content"><div class="ps-root">
<div class="ps-algorithm with-caption">
<p class="ps-line" style="text-indent:-1.2em;padding-left:1.2em;">
<span class="ps-keyword">Algorithm 6 </span>&quot;request_judgement&quot;` Runtime function benchmark</p>
<div class="ps-algorithmic with-linenum">
<p class="ps-line" style="text-indent:-1.2em;padding-left:1.2em;">
<span class="ps-keyword">Ensure: </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">W</mi></mrow><annotation encoding="application/x-tex">\mathcal{W}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">W</span></span></span></span></p>
<div class="ps-block" style="margin-left:1.7999999999999998em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">1:</span><span style="font-weight:bold;">init</span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mo stretchy="false">{</mo><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">collection = \{\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mclose">}</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">2:</span><span class="ps-keyword">for </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>m</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi><mo>←</mo><mn>1</mn><mo separator="true">,</mo><mi>M</mi><mi>a</mi><mi>x</mi><mi>R</mi><mi>e</mi><mi>g</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>a</mi><mi>r</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">amount \leftarrow 1,MaxRegistrars</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">am</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">a</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">rs</span></span></span></span><span class="ps-keyword"> do</span></p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">3:</span><span style="font-style:normal;font-variant:small-caps;">Generate-Registrars</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>a</mi><mi>m</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(amount)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">am</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">4:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>r</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">caller \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Create-Account</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi mathvariant="normal">&quot;</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">&quot;</mi><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(&quot;caller&quot;, 1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">&quot;</span><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord">&quot;</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">5:</span><span style="font-style:normal;font-variant:small-caps;">Set-Balance</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>r</mi><mo separator="true">,</mo><mn>100</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(caller, 100)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">100</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">6:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">time \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">im</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Timer</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo></mrow><annotation encoding="application/x-tex">(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span></span></span></span><span style="font-style:normal;font-variant:small-caps;">Request-Judgement</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo></mrow><annotation encoding="application/x-tex">(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span></span></span></span><span style="font-style:normal;font-variant:small-caps;">Random</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>a</mi><mi>m</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mn>100</mn><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(amount), 100))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">am</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">100</span><span class="mclose">))</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">7:</span><span style="font-style:normal;font-variant:small-caps;">Add-To</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>c</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo separator="true">,</mo><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(collection, time)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">im</span><span class="mord mathnormal">e</span><span class="mclose">)</span></span></span></span></p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">8:</span><span class="ps-keyword">end for</span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">9:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">W</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">\mathcal{W} \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">W</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Compute-Weight</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>c</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(collection)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">10:</span><span class="ps-keyword">return </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">W</mi></mrow><annotation encoding="application/x-tex">\mathcal{W}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">W</span></span></span></span></p>
</div>
</div>
</div>
</div></div>
            <div class="title">Algorithm 6. <a href="#algo-6">"request\_judgement"` Runtime function benchmark</a></div>
          </div>
<div class="dlist">
<dl>
<dt class="hdlist1">where</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Generate-Registrars(\(amount\))</p>
<div class="paragraph">
<p>Creates number of registrars and inserts those records into storage.</p>
</div>
</li>
<li>
<p>Create-Account(\(name\), \(index\))</p>
<div class="paragraph">
<p>Creates a Blake2 hash of the concatenated input of name and index represent-
ing the address of a account. This function only creates an address and does not
conduct any I/O.</p>
</div>
</li>
<li>
<p>Set-Balance(\(account\), \(balance\))</p>
<div class="paragraph">
<p>Sets a initial balance for the specified account in the storage state.</p>
</div>
</li>
<li>
<p>Timer(\(function\))</p>
<div class="paragraph">
<p>Measures the time from the start of the specified f unction to its completion.</p>
</div>
</li>
<li>
<p>Request-Judgement(\(registrar\_index\), \(max\_fee\))</p>
<div class="paragraph">
<p>Calls the corresponding request_judgement Runtime function and passes on
the required parameters.</p>
</div>
</li>
<li>
<p>Random(\(num\))</p>
<div class="paragraph">
<p>Picks a random number between 0 and num. This should be used when the
benchmark should account for unpredictable values.</p>
</div>
</li>
<li>
<p>Add-To(\(collection\), \(time\))</p>
<div class="paragraph">
<p>Adds a returned time measurement (time) to collection.</p>
</div>
</li>
<li>
<p>Compute-Weight(\(collection\))</p>
<div class="paragraph">
<p>Computes the resulting weight based on the time measurements in the collection.
The worst case scenario should be chosen (the highest value).</p>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-practical-example-payout-stakers"><a class="link" href="#sect-practical-example-payout-stakers">8.5.2. Practical Example #2: <code>payout_stakers</code></a></h4>
<div class="sect4">
<h5 id="_analysis_2"><a class="link" href="#_analysis_2">8.5.2.1. Analysis</a></h5>
<div class="paragraph">
<p>The function <code>payout_stakers</code> from the <code>staking</code> Pallet can be called by
a single account in order to payout the reward for all nominators who
back a particular validator. The reward also covers the validator’s
share. This function is interesting because it iterates over a range of
nominators, which varies, and does I/O operation for each of them.</p>
</div>
<div class="paragraph">
<p>First, this function makes few basic checks to verify if the specified
era is not higher then the current era (as it is not in the future) and
is within the allowed range also known as "history depth", as specified
by the Runtime. After that, it fetches the era payout from storage and
additionally verifies whether the specified account is indeed a
validator and receives the corresponding "Ledger". The Ledger keeps
information about the stash key, controller key and other informatin
such as actively bonded balance and a list of tracked rewards. The
function only retains the entries of the history depth, and conducts a
binary search for the specified era.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><span class="k">let</span> <span class="n">era_payout</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">ErasValidatorReward</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="nf">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">era</span><span class="p">)</span>
  <span class="nf">.ok_or_else</span><span class="p">(||</span> <span class="nn">Error</span><span class="p">::</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">InvalidEraToReward</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="k">let</span> <span class="n">controller</span> <span class="o">=</span> <span class="k">Self</span><span class="p">::</span><span class="nf">bonded</span><span class="p">(</span><span class="o">&amp;</span><span class="n">validator_stash</span><span class="p">)</span><span class="nf">.ok_or</span><span class="p">(</span><span class="nn">Error</span><span class="p">::</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">NotStash</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="k">let</span> <span class="k">mut</span> <span class="n">ledger</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">Ledger</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="nf">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controller</span><span class="p">)</span><span class="nf">.ok_or_else</span><span class="p">(||</span> <span class="nn">Error</span><span class="p">::</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">NotController</span><span class="p">)</span><span class="o">?</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><span class="n">ledger</span><span class="py">.claimed_rewards</span><span class="nf">.retain</span><span class="p">(|</span><span class="o">&amp;</span><span class="n">x</span><span class="p">|</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">current_era</span><span class="nf">.saturating_sub</span><span class="p">(</span><span class="n">history_depth</span><span class="p">));</span>
<span class="k">match</span> <span class="n">ledger</span><span class="py">.claimed_rewards</span><span class="nf">.binary_search</span><span class="p">(</span><span class="o">&amp;</span><span class="n">era</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="nf">Err</span><span class="p">(</span><span class="nn">Error</span><span class="p">::</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">::</span><span class="n">AlreadyClaimed</span><span class="p">)</span><span class="o">?</span><span class="p">,</span>
  <span class="nf">Err</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="n">ledger</span><span class="py">.claimed_rewards</span><span class="nf">.insert</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">era</span><span class="p">),</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The retained claimed rewards are inserted back into storage.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><span class="o">&lt;</span><span class="n">Ledger</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="nf">insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controller</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ledger</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As an optimization, Runtime only fetches a list of the 64 highest staked
nominators, although this might be changed in the future. Accordingly,
any lower staked nominator gets no reward.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><span class="k">let</span> <span class="n">exposure</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">ErasStakersClipped</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="nf">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">era</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ledger</span><span class="py">.stash</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, the function gets the era reward points from storage.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><span class="k">let</span> <span class="n">era_reward_points</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">ErasRewardPoints</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="nf">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">era</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After that, the payout is split among the validator and its nominators.
The validators receives the payment first, creating an insertion into
storage and sending a deposit event to the scheduler.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="n">imbalance</span><span class="p">)</span> <span class="o">=</span> <span class="k">Self</span><span class="p">::</span><span class="nf">make_payout</span><span class="p">(</span>
  <span class="o">&amp;</span><span class="n">ledger</span><span class="py">.stash</span><span class="p">,</span>
  <span class="n">validator_staking_payout</span> <span class="o">+</span> <span class="n">validator_commission_payout</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">Self</span><span class="p">::</span><span class="nf">deposit_event</span><span class="p">(</span><span class="nn">RawEvent</span><span class="p">::</span><span class="nf">Reward</span><span class="p">(</span><span class="n">ledger</span><span class="py">.stash</span><span class="p">,</span> <span class="n">imbalance</span><span class="nf">.peek</span><span class="p">()));</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, the nominators receive their payout rewards. The functions loops
over the nominator list, conducting an insertion into storage and a
creation of a deposit event for each of the nominators.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><span class="k">for</span> <span class="n">nominator</span> <span class="k">in</span> <span class="n">exposure</span><span class="py">.others</span><span class="nf">.iter</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">let</span> <span class="n">nominator_exposure_part</span> <span class="o">=</span> <span class="nn">Perbill</span><span class="p">::</span><span class="nf">from_rational_approximation</span><span class="p">(</span>
    <span class="n">nominator</span><span class="py">.value</span><span class="p">,</span>
    <span class="n">exposure</span><span class="py">.total</span><span class="p">,</span>
  <span class="p">);</span>

  <span class="k">let</span> <span class="n">nominator_reward</span><span class="p">:</span> <span class="n">BalanceOf</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">nominator_exposure_part</span> <span class="o">*</span> <span class="n">validator_leftover_payout</span><span class="p">;</span>
  <span class="c1">// We can now make nominator payout:</span>
  <span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="n">imbalance</span><span class="p">)</span> <span class="o">=</span> <span class="k">Self</span><span class="p">::</span><span class="nf">make_payout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nominator</span><span class="py">.who</span><span class="p">,</span> <span class="n">nominator_reward</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">Self</span><span class="p">::</span><span class="nf">deposit_event</span><span class="p">(</span><span class="nn">RawEvent</span><span class="p">::</span><span class="nf">Reward</span><span class="p">(</span><span class="n">nominator</span><span class="py">.who</span><span class="nf">.clone</span><span class="p">(),</span> <span class="n">imbalance</span><span class="nf">.peek</span><span class="p">()));</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="considerations-1"><a class="link" href="#considerations-1">8.5.2.2. Considerations</a></h5>
<div class="paragraph">
<p>The following points must be considered:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Ledger contains a varying list of claimed rewards. Fetching,
retaining and searching through it can affect execution time. The
retained list is inserted back into storage.</p>
</li>
<li>
<p>Looping through a list of nominators and creating I/O operations for
each increases execution time. The Runtime fetches up to 64 nominators.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_benchmarking_framework_2"><a class="link" href="#_benchmarking_framework_2">8.5.2.3. Benchmarking Framework</a></h5>
<div id="defn-history-depth" class="exampleblock">
<div class="title">Definition 137. History Depth</div>
<div class="content">
<div class="paragraph">
<p>H̱istory Depth indicated as <code>MaxNominatorRewardedPerValidator</code> is a fixed
constant specified by the Polkadot Runtime which dictates the number of Eras
the Runtime will reward nominators and validators for.</p>
</div>
</div>
</div>
<div id="defn-max_nominator_reward_per_validator" class="exampleblock">
<div class="title">Definition 138. Maximum Nominator Reward</div>
<div class="content">
<div class="paragraph">
<p>M̱aximum Nominator Rewarded Per Validator indicated as
<code>MaxNominatorRewardedPerValidator</code>, specifies the maximum amount of the
highest-staked nominators which will get a reward. Those values should have
some influence in the benchmarking process.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The benchmarking implementation for the function
\(payout\_stakers\) can be defined as follows:</p>
</div>
<div class="sidebarblock">
<div class="content">
          <div id="algo-7" class="imageblock">
            <div class="content"><div class="ps-root">
<div class="ps-algorithm with-caption">
<p class="ps-line" style="text-indent:-1.2em;padding-left:1.2em;">
<span class="ps-keyword">Algorithm 7 </span>&quot;payout_stakers&quot; Runtime function benchmark</p>
<div class="ps-algorithmic with-linenum">
<p class="ps-line" style="text-indent:-1.2em;padding-left:1.2em;">
<span class="ps-keyword">Ensure: </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">W</mi></mrow><annotation encoding="application/x-tex">\mathcal{W}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">W</span></span></span></span></p>
<div class="ps-block" style="margin-left:1.7999999999999998em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">1:</span><span style="font-weight:bold;">init</span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mo stretchy="false">{</mo><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">collection = \{\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mclose">}</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">2:</span><span class="ps-keyword">for </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>m</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi><mo>←</mo><mn>1</mn><mo separator="true">,</mo><mi>M</mi><mi>a</mi><mi>x</mi><mi>N</mi><mi>o</mi><mi>m</mi><mi>i</mi><mi>n</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mi>R</mi><mi>e</mi><mi>w</mi><mi>a</mi><mi>r</mi><mi>d</mi><mi>e</mi><mi>d</mi><mi>P</mi><mi>e</mi><mi>r</mi><mi>V</mi><mi>a</mi><mi>l</mi><mi>i</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">amount \leftarrow 1,MaxNominatorRewardedPerValidator</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">am</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">a</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">o</span><span class="mord mathnormal">mina</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord mathnormal">Va</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span></span></span></span><span class="ps-keyword"> do</span></p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">3:</span><span class="ps-keyword">for </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>r</mi><mi>a</mi><mi mathvariant="normal">_</mi><mi>d</mi><mi>e</mi><mi>p</mi><mi>t</mi><mi>h</mi><mo>←</mo><mn>1</mn><mo separator="true">,</mo><mi>H</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>o</mi><mi>r</mi><mi>y</mi><mi>D</mi><mi>e</mi><mi>p</mi><mi>t</mi><mi>h</mi></mrow><annotation encoding="application/x-tex">era\_depth \leftarrow 1,HistoryDepth</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord mathnormal">a</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">pt</span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">oryDe</span><span class="mord mathnormal">pt</span><span class="mord mathnormal">h</span></span></span></span><span class="ps-keyword"> do</span></p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">4:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mi>a</mi><mi>l</mi><mi>i</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">validator \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Generate-Validator</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">()</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">5:</span><span style="font-style:normal;font-variant:small-caps;">Validate</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>i</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(validator)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">6:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>o</mi><mi>m</mi><mi>i</mi><mi>n</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mi>s</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">nominators \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">o</span><span class="mord mathnormal">mina</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ors</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Generate-Nominators</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>a</mi><mi>m</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(amount)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">am</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">7:</span><span class="ps-keyword">for </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>o</mi><mi>m</mi><mi>i</mi><mi>n</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo>∈</mo><mi>n</mi><mi>o</mi><mi>m</mi><mi>i</mi><mi>n</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">nominator \in nominators</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69862em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">o</span><span class="mord mathnormal">mina</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">o</span><span class="mord mathnormal">mina</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ors</span></span></span></span><span class="ps-keyword"> do</span></p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-4.5em;">8:</span><span style="font-style:normal;font-variant:small-caps;">Nominate</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>i</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo separator="true">,</mo><mi>n</mi><mi>o</mi><mi>m</mi><mi>i</mi><mi>n</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(validator, nominator)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">o</span><span class="mord mathnormal">mina</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mclose">)</span></span></span></span></p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">9:</span><span class="ps-keyword">end for</span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">10:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>r</mi><mi>a</mi><mi mathvariant="normal">_</mi><mi>i</mi><mi>n</mi><mi>d</mi><mi>e</mi><mi>x</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">era\_index \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord mathnormal">a</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">in</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Create-Rewards</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>i</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo separator="true">,</mo><mi>n</mi><mi>o</mi><mi>m</mi><mi>i</mi><mi>n</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mi>s</mi><mo separator="true">,</mo><mi>e</mi><mi>r</mi><mi>a</mi><mi mathvariant="normal">_</mi><mi>d</mi><mi>e</mi><mi>p</mi><mi>t</mi><mi>h</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(validator, nominators, era\_depth)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">o</span><span class="mord mathnormal">mina</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ors</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord mathnormal">a</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">pt</span><span class="mord mathnormal">h</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">11:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">time \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">im</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Timer</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo></mrow><annotation encoding="application/x-tex">(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span></span></span></span><span style="font-style:normal;font-variant:small-caps;">Payout-Stakers</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>v</mi><mi>a</mi><mi>l</mi><mi>i</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>e</mi><mi>r</mi><mi>a</mi><mi mathvariant="normal">_</mi><mi>i</mi><mi>n</mi><mi>d</mi><mi>e</mi><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(validator), era\_index)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord mathnormal">a</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">in</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">12:</span><span style="font-style:normal;font-variant:small-caps;">Add-To(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">collection</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">time</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">im</span><span class="mord mathnormal">e</span></span></span></span>)</span></p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">13:</span><span class="ps-keyword">end for</span></p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">14:</span><span class="ps-keyword">end for</span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">15:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">W</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">\mathcal{W} \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">W</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Compute-Weight</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>c</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(collection)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">16:</span><span class="ps-keyword">return </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">W</mi></mrow><annotation encoding="application/x-tex">\mathcal{W}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">W</span></span></span></span></p>
</div>
</div>
</div>
</div></div>
            <div class="title">Algorithm 7. <a href="#algo-7">"payout\_stakers" Runtime function benchmark</a></div>
          </div>
<div class="dlist">
<dl>
<dt class="hdlist1">where</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Generate-Validator()</p>
<div class="paragraph">
<p>Creates a validators with some unbonded balances.</p>
</div>
</li>
<li>
<p>Validate(\(validator\))</p>
<div class="paragraph">
<p>Bonds balances of validator and bonds balances.</p>
</div>
</li>
<li>
<p>Generate-Nominators(\(amount\))</p>
<div class="paragraph">
<p>Creates the amount of nominators with some unbonded balances.</p>
</div>
</li>
<li>
<p>Nominate(\(validator\), \(nominator\))</p>
<div class="paragraph">
<p>Starts nomination of nominator for validator by bonding balances.</p>
</div>
</li>
<li>
<p>Create-Rewards(\(validator\), \(nominators\), \(era\_depth\))</p>
<div class="paragraph">
<p>Starts an Era and creates pending rewards for validator and nominators.</p>
</div>
</li>
<li>
<p>Timer(\(function\))</p>
<div class="paragraph">
<p>Measures the time from the start of the specified f unction to its completion.</p>
</div>
</li>
<li>
<p>Add-To(\(collection\), \(time\))</p>
<div class="paragraph">
<p>Adds a returned time measurement (time) to collection.</p>
</div>
</li>
<li>
<p>Compute-Weight(\(collection\))</p>
<div class="paragraph">
<p>Computes the resulting weight based on the time measurements in the collection.
The worst case scenario should be chosen (the highest value).</p>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_practical_example_3_transfer"><a class="link" href="#_practical_example_3_transfer">8.5.3. Practical Example #3: <code>transfer</code></a></h4>
<div class="paragraph">
<p>The \(transfer\) function of the <code>balances</code> module is designed
to move the specified balance by the sender to the receiver.</p>
</div>
<div class="sect4">
<h5 id="_analysis_3"><a class="link" href="#_analysis_3">8.5.3.1. Analysis</a></h5>
<div class="paragraph">
<p>The source code of this function is quite short:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><span class="k">let</span> <span class="n">transactor</span> <span class="o">=</span> <span class="nf">ensure_signed</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="k">let</span> <span class="n">dest</span> <span class="o">=</span> <span class="nn">T</span><span class="p">::</span><span class="nn">Lookup</span><span class="p">::</span><span class="nf">lookup</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="o">&lt;</span><span class="k">Self</span> <span class="k">as</span> <span class="n">Currency</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="nf">transfer</span><span class="p">(</span>
  <span class="o">&amp;</span><span class="n">transactor</span><span class="p">,</span>
  <span class="o">&amp;</span><span class="n">dest</span><span class="p">,</span>
  <span class="n">value</span><span class="p">,</span>
  <span class="nn">ExistenceRequirement</span><span class="p">::</span><span class="n">AllowDeath</span>
<span class="p">)</span><span class="o">?</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, one need to pay close attention to the property <code>AllowDeath</code>
and to how the function treat existingand non-existing accounts
differently. Two types of behaviors are to consider:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the transfer completely depletes the sender account balance to zero
(or bellow the minimum "keep-alive" requirement), it removes the address
and all associated data from storage.</p>
</li>
<li>
<p>If recipient account has no balance, the transfer also needs to create
the recipient account.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="considerations-2"><a class="link" href="#considerations-2">8.5.3.2. Considerations</a></h5>
<div class="paragraph">
<p>Specific parameters can could have a significant impact for this
specific function. In order to trigger the two behaviors mentioned
above, the following parameters are selected:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Type</strong></th>
<th class="tableblock halign-right valign-top"></th>
<th class="tableblock halign-left valign-top"><strong>From</strong></th>
<th class="tableblock halign-left valign-top"><strong>To</strong></th>
<th class="tableblock halign-left valign-top"><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Account index</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>index</code> in&#8230;&#8203;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used as a seed for account
creation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Balance</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>balance</code> in&#8230;&#8203;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sender balance and transfer amount</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Executing a benchmark for each balance increment within the balance
range for each index increment within the index range will generate too
many variants (\(1000 \times 999\)) and highly increase
execution time. Therefore, this benchmark is configured to first set the
balance at value 1’000 and then to iterate from 1 to 1’000 for the index
value. Once the index value reaches 1’000, the balance value will reset
to 2 and iterate to 1’000 (see algorithm
<a href="#algo-benchmark-transfer">Algorithm 8</a> for more
detail):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>index</code>: 1, <code>balance</code>: 1000</p>
</li>
<li>
<p><code>index</code>: 2, <code>balance</code>: 1000</p>
</li>
<li>
<p><code>index</code>: 3, <code>balance</code>: 1000</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
<li>
<p><code>index</code>: 1000, <code>balance</code>: 1000</p>
</li>
<li>
<p><code>index</code>: 1000, <code>balance</code>: 2</p>
</li>
<li>
<p><code>index</code>: 1000, <code>balance</code>: 3</p>
</li>
<li>
<p><code>index</code>: 1000, <code>balance</code>: 4</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The parameters itself do not influence or trigger the two worst
conditions and must be handled by the implemented benchmarking tool. The
\(transfer\) benchmark is implemented as defined in algorithm
<a href="#algo-benchmark-transfer">Algorithm 8</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_benchmarking_framework_3"><a class="link" href="#_benchmarking_framework_3">8.5.3.3. Benchmarking Framework</a></h5>
<div class="paragraph">
<p>The benchmarking implementation for the Polkadot Runtime function
\(transfer\) is defined as follows (starting with the Main
function):</p>
</div>
<div class="sidebarblock">
<div class="content">
          <div id="algo-benchmark-transfer" class="imageblock">
            <div class="content"><div class="ps-root">
<div class="ps-algorithm with-caption">
<p class="ps-line" style="text-indent:-1.2em;padding-left:1.2em;">
<span class="ps-keyword">Algorithm 8 </span>&quot;transfer&quot; Runtime function benchmark</p>
<div class="ps-algorithmic with-linenum">
<p class="ps-line" style="text-indent:-1.2em;padding-left:1.2em;">
<span class="ps-keyword">Ensure: </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">collection</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span></span></span></span>: a collection of time measurements of all benchmark iterations</p>
<div class="ps-block" style="margin-left:1.7999999999999998em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">1:</span><span class="ps-keyword">function </span><span class="ps-funcname">Main</span>()</p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">2:</span><span style="font-weight:bold;">init</span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mo stretchy="false">{</mo><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">collection = \{ \}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mclose">}</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">3:</span><span style="font-weight:bold;">init</span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>a</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo>=</mo><msup><mn>1</mn><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mn>000</mn></mrow><annotation encoding="application/x-tex">balance = 1&#x27;000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">ba</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">an</span><span class="mord mathnormal">ce</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord">000</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">4:</span><span class="ps-keyword">for </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>n</mi><mi>d</mi><mi>e</mi><mi>x</mi><mo>←</mo><mn>1</mn><mo separator="true">,</mo><msup><mn>1</mn><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mn>000</mn></mrow><annotation encoding="application/x-tex">index \gets 1,1&#x27;000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">in</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.946332em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord">000</span></span></span></span><span class="ps-keyword"> do</span></p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">5:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">time \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">im</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Run-Benchmark</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>i</mi><mi>n</mi><mi>d</mi><mi>e</mi><mi>x</mi><mo separator="true">,</mo><mi>b</mi><mi>a</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(index, balance)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">in</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">ba</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">an</span><span class="mord mathnormal">ce</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">6:</span><span style="font-style:normal;font-variant:small-caps;">Add-To</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>c</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo separator="true">,</mo><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(collection, time)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">im</span><span class="mord mathnormal">e</span><span class="mclose">)</span></span></span></span></p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">7:</span><span class="ps-keyword">end for</span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">8:</span><span style="font-weight:bold;">init</span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>n</mi><mi>d</mi><mi>e</mi><mi>x</mi><mo>=</mo><msup><mn>1</mn><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mn>000</mn></mrow><annotation encoding="application/x-tex">index = 1&#x27;000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">in</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord">000</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">9:</span><span class="ps-keyword">for </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>a</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo>←</mo><mn>2</mn><mo separator="true">,</mo><msup><mn>1</mn><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mn>000</mn></mrow><annotation encoding="application/x-tex">balance \gets 2,1&#x27;000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">ba</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">an</span><span class="mord mathnormal">ce</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.946332em;vertical-align:-0.19444em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord">000</span></span></span></span><span class="ps-keyword"> do</span></p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">10:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">time \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">im</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Run-Benchmark</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>i</mi><mi>n</mi><mi>d</mi><mi>e</mi><mi>x</mi><mo separator="true">,</mo><mi>b</mi><mi>a</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(index, balance)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">in</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">ba</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">an</span><span class="mord mathnormal">ce</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">11:</span><span style="font-style:normal;font-variant:small-caps;">Add-To</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>c</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo separator="true">,</mo><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(collection, time)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">im</span><span class="mord mathnormal">e</span><span class="mclose">)</span></span></span></span></p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">12:</span><span class="ps-keyword">end for</span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">13:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">W</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">\mathcal{W} \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">W</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Compute-Weight</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>c</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(collection)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">14:</span><span class="ps-keyword">return </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">W</mi></mrow><annotation encoding="application/x-tex">\mathcal{W}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">W</span></span></span></span></p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">15:</span><span class="ps-keyword">end function</span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">16:</span><span class="ps-keyword">function </span><span class="ps-funcname">Run-Benchmark</span>(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>n</mi><mi>d</mi><mi>e</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">index</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">in</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>a</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">balance</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">ba</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">an</span><span class="mord mathnormal">ce</span></span></span></span>)</p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">17:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>e</mi><mi>n</mi><mi>d</mi><mi>e</mi><mi>r</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">sender \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">se</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Create-Account</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mtext mathvariant="italic">&quot;caller&quot;</mtext><mo separator="true">,</mo><mi>i</mi><mi>n</mi><mi>d</mi><mi>e</mi><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(\textit{&quot;caller&quot;}, index)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord textit">&quot;caller&quot;</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">in</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">18:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>e</mi><mi>c</mi><mi>i</mi><mi>p</mi><mi>i</mi><mi>e</mi><mi>n</mi><mi>t</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">recipient \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">rec</span><span class="mord mathnormal">i</span><span class="mord mathnormal">p</span><span class="mord mathnormal">i</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Create-Accouny</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mtext mathvariant="italic">&quot;recipient&quot;</mtext><mo separator="true">,</mo><mi>i</mi><mi>n</mi><mi>d</mi><mi>e</mi><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(\textit{&quot;recipient&quot;}, index)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord textit">&quot;recipient&quot;</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">in</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">19:</span><span style="font-style:normal;font-variant:small-caps;">Set-Balance</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>n</mi><mi>d</mi><mi>e</mi><mi>r</mi><mo separator="true">,</mo><mi>b</mi><mi>a</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(sender, balance)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">ba</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">an</span><span class="mord mathnormal">ce</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">20:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">time \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">im</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Timer</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo></mrow><annotation encoding="application/x-tex">(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span></span></span></span><span style="font-style:normal;font-variant:small-caps;">Transfer</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>n</mi><mi>d</mi><mi>e</mi><mi>r</mi><mo separator="true">,</mo><mi>r</mi><mi>e</mi><mi>c</mi><mi>i</mi><mi>p</mi><mi>i</mi><mi>e</mi><mi>n</mi><mi>t</mi><mo separator="true">,</mo><mi>b</mi><mi>a</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(sender, recipient, balance))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">rec</span><span class="mord mathnormal">i</span><span class="mord mathnormal">p</span><span class="mord mathnormal">i</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">ba</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">an</span><span class="mord mathnormal">ce</span><span class="mclose">))</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">21:</span><span class="ps-keyword">return </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">time</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">im</span><span class="mord mathnormal">e</span></span></span></span></p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">22:</span><span class="ps-keyword">end function</span></p>
</div>
</div>
</div>
</div></div>
            <div class="title">Algorithm 8. <a href="#algo-benchmark-transfer">"transfer" Runtime function benchmark</a></div>
          </div>
<div class="dlist">
<dl>
<dt class="hdlist1">where</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Create-Account(\(name\), \(index\))</p>
<div class="paragraph">
<p>Creates a Blake2 hash of the concatenated input of name and index representing the address of a account. This function only creates an address and does not conduct any I/O.</p>
</div>
</li>
<li>
<p>Set-Balance(\(account\), \(balance\))</p>
<div class="paragraph">
<p>Sets a initial balance for the specified account in the storage state.</p>
</div>
</li>
<li>
<p>Transfer(\(sender\), \(recipient\), \(balance\))</p>
<div class="paragraph">
<p>Transfers the specified balance from sender to recipient by calling the corresponding Runtime function. This represents the target Runtime function to be benchmarked.</p>
</div>
</li>
<li>
<p>Add-To(\(collection\), \(time\))</p>
<div class="paragraph">
<p>Adds a returned time measurement (time) to collection.</p>
</div>
</li>
<li>
<p>Timer(\(function\))</p>
<div class="paragraph">
<p>Adds a returned time measurement (time) to collection.</p>
</div>
</li>
<li>
<p>Compute-Weight(\(collection\))</p>
<div class="paragraph">
<p>Computes the resulting weight based on the time measurements in the collection. The worst case scenario should be chosen (the highest value).</p>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_practical_example_4_withdraw_unbounded"><a class="link" href="#_practical_example_4_withdraw_unbounded">8.5.4. Practical Example #4: <code>withdraw_unbounded</code></a></h4>
<div class="paragraph">
<p>The <code>withdraw_unbonded</code> function of the <code>staking</code> module is designed to
move any unlocked funds from the staking management system to be ready
for transfer. It contains some operations which have some I/O overhead.</p>
</div>
<div class="sect4">
<h5 id="_analysis_4"><a class="link" href="#_analysis_4">8.5.4.1. Analysis</a></h5>
<div class="paragraph">
<p>Similarly to the <code>payout_stakers</code> function
(<a href="#sect-practical-example-payout-stakers">Section 8.5.2</a>), this function fetches
the Ledger which contains information about the stash, such as bonded
balance and unlocking balance (balance that will eventually be freed and
can be withdrawn).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><span class="k">if</span> <span class="k">let</span> <span class="nf">Some</span><span class="p">(</span><span class="n">current_era</span><span class="p">)</span> <span class="o">=</span> <span class="k">Self</span><span class="p">::</span><span class="nf">current_era</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">ledger</span> <span class="o">=</span> <span class="n">ledger</span><span class="nf">.consolidate_unlocked</span><span class="p">(</span><span class="n">current_era</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The function <code>consolidate_unlocked</code> does some cleaning up on the ledger,
where it removes outdated entries from the unlocking balance (which
implies that balance is now free and is no longer awaiting unlock).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><span class="k">let</span> <span class="k">mut</span> <span class="n">total</span> <span class="o">=</span> <span class="k">self</span><span class="py">.total</span><span class="p">;</span>
<span class="k">let</span> <span class="n">unlocking</span> <span class="o">=</span> <span class="k">self</span><span class="py">.unlocking</span><span class="nf">.into_iter</span><span class="p">()</span>
  <span class="nf">.filter</span><span class="p">(|</span><span class="n">chunk</span><span class="p">|</span> <span class="k">if</span> <span class="n">chunk</span><span class="py">.era</span> <span class="o">&gt;</span> <span class="n">current_era</span> <span class="p">{</span>
    <span class="k">true</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">total</span><span class="nf">.saturating_sub</span><span class="p">(</span><span class="n">chunk</span><span class="py">.value</span><span class="p">);</span>
    <span class="k">false</span>
  <span class="p">})</span>
  <span class="nf">.collect</span><span class="p">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This function does a check on wether the updated ledger has any balance
left in regards to staking, both in terms of locked, staking balance and
unlocking balance. If not amount is left, the all information related to
the stash will be deleted. This results in multiple I/O calls.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><span class="k">if</span> <span class="n">ledger</span><span class="py">.unlocking</span><span class="nf">.is_empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">ledger</span><span class="py">.active</span><span class="nf">.is_zero</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// This account must have called `unbond()` with some value that caused the active</span>
  <span class="c1">// portion to fall below existential deposit + will have no more unlocking chunks</span>
  <span class="c1">// left. We can now safely remove all staking-related information.</span>
  <span class="k">Self</span><span class="p">::</span><span class="nf">kill_stash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stash</span><span class="p">,</span> <span class="n">num_slashing_spans</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
  <span class="c1">// remove the lock.</span>
  <span class="nn">T</span><span class="p">::</span><span class="nn">Currency</span><span class="p">::</span><span class="nf">remove_lock</span><span class="p">(</span><span class="n">STAKING_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stash</span><span class="p">);</span>
  <span class="c1">// This is worst case scenario, so we use the full weight and return None</span>
  <span class="nb">None</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The resulting call to <code>Self::kill_stash()</code> triggers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><span class="nn">slashing</span><span class="p">::</span><span class="nn">clear_stash_metadata</span><span class="p">::</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">stash</span><span class="p">,</span> <span class="n">num_slashing_spans</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="o">&lt;</span><span class="n">Bonded</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="nf">remove</span><span class="p">(</span><span class="n">stash</span><span class="p">);</span>
<span class="o">&lt;</span><span class="n">Ledger</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="nf">remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controller</span><span class="p">);</span>
<span class="o">&lt;</span><span class="n">Payee</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="nf">remove</span><span class="p">(</span><span class="n">stash</span><span class="p">);</span>
<span class="o">&lt;</span><span class="n">Validators</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="nf">remove</span><span class="p">(</span><span class="n">stash</span><span class="p">);</span>
<span class="o">&lt;</span><span class="n">Nominators</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="nf">remove</span><span class="p">(</span><span class="n">stash</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, if there’s some balance left, the adjusted ledger simply
gets updated back into storage.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><span class="c1">// This was the consequence of a partial unbond. just update the ledger and move on.</span>
<span class="k">Self</span><span class="p">::</span><span class="nf">update_ledger</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controller</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ledger</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, it withdraws the unlocked balance, making it ready for
transfer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="rust"><span class="k">let</span> <span class="n">value</span> <span class="o">=</span> <span class="n">old_total</span> <span class="o">-</span> <span class="n">ledger</span><span class="py">.total</span><span class="p">;</span>
<span class="k">Self</span><span class="p">::</span><span class="nf">deposit_event</span><span class="p">(</span><span class="nn">RawEvent</span><span class="p">::</span><span class="nf">Withdrawn</span><span class="p">(</span><span class="n">stash</span><span class="p">,</span> <span class="n">value</span><span class="p">));</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_parameters_2"><a class="link" href="#_parameters_2">8.5.4.2. Parameters</a></h5>
<div class="paragraph">
<p>The following parameters are selected:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Type</strong></th>
<th class="tableblock halign-right valign-top"></th>
<th class="tableblock halign-left valign-top"><strong>From</strong></th>
<th class="tableblock halign-left valign-top"><strong>To</strong></th>
<th class="tableblock halign-left valign-top"><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Account index</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>index</code> in&#8230;&#8203;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used as a seed for account
creation</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This benchmark does not require complex parameters. The values are used
solely for account generation.</p>
</div>
</div>
<div class="sect4">
<h5 id="considerations-3"><a class="link" href="#considerations-3">8.5.4.3. Considerations</a></h5>
<div class="paragraph">
<p>Two important points in the <code>withdraw_unbonded</code> function must be
considered. The benchmarks should trigger both conditions</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The updated ledger is inserted back into storage.</p>
</li>
<li>
<p>If the stash gets killed, then multiple, repetitive deletion calls are
performed in the storage.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_benchmarking_framework_4"><a class="link" href="#_benchmarking_framework_4">8.5.4.4. Benchmarking Framework</a></h5>
<div class="paragraph">
<p>The benchmarking implementation for the Polkadot Runtime function
<code>withdraw_unbonded</code> is defined as follows:</p>
</div>
<div class="sidebarblock">
<div class="content">
          <div id="algo-benchmark-withdraw" class="imageblock">
            <div class="content"><div class="ps-root">
<div class="ps-algorithm with-caption">
<p class="ps-line" style="text-indent:-1.2em;padding-left:1.2em;">
<span class="ps-keyword">Algorithm 9 </span>&quot;withdraw_unbonded&quot; Runtime function benchmark</p>
<div class="ps-algorithmic with-linenum">
<p class="ps-line" style="text-indent:-1.2em;padding-left:1.2em;">
<span class="ps-keyword">Ensure: </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">W</mi></mrow><annotation encoding="application/x-tex">\mathcal{W}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">W</span></span></span></span></p>
<div class="ps-block" style="margin-left:1.7999999999999998em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">1:</span><span class="ps-keyword">function </span><span class="ps-funcname">Main</span>()</p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">2:</span><span style="font-weight:bold;">init</span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mo stretchy="false">{</mo><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">collection = \{\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mclose">}</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">3:</span><span class="ps-keyword">for </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>a</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo>←</mo><mn>1</mn><mo separator="true">,</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">balance \gets 1,100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">ba</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">an</span><span class="mord mathnormal">ce</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">100</span></span></span></span><span class="ps-keyword"> do</span></p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">4:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>s</mi><mi>h</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">stash \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Create-Account</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mtext mathvariant="italic">&quot;stash&quot;</mtext><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(\textit{&quot;stash&quot;}, 1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord textit">&quot;stash&quot;</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">5:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>r</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>r</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">controller \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">co</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ro</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Create-Account</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mtext mathvariant="italic">&quot;controller&quot;</mtext><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(\textit{&quot;controller&quot;}, 1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord textit">&quot;controller&quot;</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">6:</span><span style="font-style:normal;font-variant:small-caps;">Set-Balance</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>s</mi><mi>h</mi><mo separator="true">,</mo><mn>100</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(stash, 100)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">h</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">100</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">7:</span><span style="font-style:normal;font-variant:small-caps;">Set-Balance</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>c</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>r</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>r</mi><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(controller, 1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">co</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ro</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">8:</span><span style="font-style:normal;font-variant:small-caps;">Bond</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>s</mi><mi>h</mi><mo separator="true">,</mo><mi>c</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>r</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>r</mi><mo separator="true">,</mo><mi>b</mi><mi>a</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(stash, controller, balance)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">h</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">co</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ro</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">ba</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">an</span><span class="mord mathnormal">ce</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">9:</span><span style="font-style:normal;font-variant:small-caps;">Pass-Era</span>()</p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">10:</span><span style="font-style:normal;font-variant:small-caps;">UnBond</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>c</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>r</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>r</mi><mo separator="true">,</mo><mi>b</mi><mi>a</mi><mi>l</mi><mi>a</mi><mi>n</mi><mi>c</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(controller, balance)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">co</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ro</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">ba</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">an</span><span class="mord mathnormal">ce</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">11:</span><span style="font-style:normal;font-variant:small-caps;">Pass-Era</span>()</p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">12:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">time \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">im</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Timer</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo></mrow><annotation encoding="application/x-tex">(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span></span></span></span><span style="font-style:normal;font-variant:small-caps;">Withdraw-Unbonded</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>c</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>r</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>r</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(controller))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">co</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ro</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mclose">))</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-3em;">13:</span><span style="font-style:normal;font-variant:small-caps;">Add-To</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>c</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo separator="true">,</mo><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(collection, time)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">im</span><span class="mord mathnormal">e</span><span class="mclose">)</span></span></span></span></p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">14:</span><span class="ps-keyword">end for</span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">15:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">W</mi><mo>←</mo></mrow><annotation encoding="application/x-tex">\mathcal{W} \leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">W</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span></span></span></span> <span style="font-style:normal;font-variant:small-caps;">Compute-Weight</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>c</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(collection)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">16:</span><span class="ps-keyword">return </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">W</mi></mrow><annotation encoding="application/x-tex">\mathcal{W}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">W</span></span></span></span></p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">17:</span><span class="ps-keyword">end function</span></p>
</div>
</div>
</div>
</div></div>
            <div class="title">Algorithm 9. <a href="#algo-benchmark-withdraw">"withdraw\_unbonded" Runtime function benchmark</a></div>
          </div>
<div class="dlist">
<dl>
<dt class="hdlist1">where</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Create-Account(\(name\), \(index\))</p>
<div class="paragraph">
<p>Creates a Blake2 hash of the concatenated input of name and index representing
the address of a account. This function only creates an address and does not
conduct any I/O.</p>
</div>
</li>
<li>
<p>Set-Balance(\(account\), \(balance\))</p>
<div class="paragraph">
<p>Sets a initial balance for the specified account in the storage state.</p>
</div>
</li>
<li>
<p>Bond(\(stash\), \(controller\), \(amount\))</p>
<div class="paragraph">
<p>Bonds the specified amount for the stash and controller pair.</p>
</div>
</li>
<li>
<p>UnBond(\(account\), \(amount\))</p>
<div class="paragraph">
<p>Unbonds the specified amount for the given account.</p>
</div>
</li>
<li>
<p>Pass-Era()</p>
<div class="paragraph">
<p>Pass one era. Forces the function <code>withdraw_unbonded</code> to update the ledger and
eventually delete information.</p>
</div>
</li>
<li>
<p>Withdraw-Unbonded(\(controller\))</p>
<div class="paragraph">
<p>Withdraws the the full unbonded amount of the specified controller account. This
represents the target Runtime function to be benchmarked.</p>
</div>
</li>
<li>
<p>Add-To(\(collection\), \(time\))</p>
<div class="paragraph">
<p>Adds a returned time measurement (time) to collection.</p>
</div>
</li>
<li>
<p>Timer(\(function\))</p>
<div class="paragraph">
<p>Measures the time from the start of the specified f unction to its completion.</p>
</div>
</li>
<li>
<p>Compute-Weight(\(collection\))</p>
<div class="paragraph">
<p>Computes the resulting weight based on the time measurements in the collection.
The worst case scenario should be chosen (the highest value).</p>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_fees"><a class="link" href="#_fees">8.6. Fees</a></h3>
<div class="paragraph">
<p>Block producers charge a fee in order to be economically sustainable.
That fee must always be covered by the sender of the transaction.
Polkadot has a flexible mechanism to determine the minimum cost to
include transactions in a block.</p>
</div>
<div class="sect3">
<h4 id="sect-fee-calculation"><a class="link" href="#sect-fee-calculation">8.6.1. Fee Calculation</a></h4>
<div class="paragraph">
<p>Polkadot fees consists of three parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Base fee: a fixed fee that is applied to every transaction and set by
the Runtime.</p>
</li>
<li>
<p>Length fee: a fee that gets multiplied by the length of the
transaction, in bytes.</p>
</li>
<li>
<p>Weight fee: a fee for each, varying Runtime function. Runtime
implementers need to implement a conversion mechanism which determines
the corresponding currency amount for the calculated weight.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The final fee can be summarized as:</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{aligned}
fee &amp;= base\ fee \\
    &amp;{} + length\ of\ transaction\ in\ bytes \times length\ fee \\
    &amp;{} + weight\ to\ fee \\
\end{aligned}\]
</div>
</div>
</div>
<div class="sect3">
<h4 id="_definitions_in_polkadot"><a class="link" href="#_definitions_in_polkadot">8.6.2. Definitions in Polkadot</a></h4>
<div class="paragraph">
<p>The Polkadot Runtime defines the following values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Base fee: 100 uDOTs</p>
</li>
<li>
<p>Length fee: 0.1 uDOTs</p>
</li>
<li>
<p>Weight to fee conversion:</p>
<div class="stemblock">
<div class="content">
\[weight\ fee = weight \times (100\ uDOTs \div (10 \times 10'000))\]
</div>
</div>
<div class="paragraph">
<p>A weight of 10’000 (the smallest non-zero weight) is mapped to
\(\frac{1}{10}\) of 100 uDOT. This fee will never exceed the
max size of an unsigned 128 bit integer.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_fee_multiplier"><a class="link" href="#_fee_multiplier">8.6.3. Fee Multiplier</a></h4>
<div class="paragraph">
<p>Polkadot can add a additional fee to transactions if the network becomes
too busy and starts to decelerate the system. This fee can create an
incentive to avoid the production of low priority or insignificant
transactions. In contrast, those additional fees will decrease if the
network calms down and it can execute transactions without much
difficulties.</p>
</div>
<div class="paragraph">
<p>That additional fee is known as the <code>Fee Multiplier</code> and its value is
defined by the Polkadot Runtime. The multiplier works by comparing the
saturation of blocks; if the previous block is less saturated than the
current block (implying an uptrend), the fee is slightly increased.
Similarly, if the previous block is more saturated than the current
block (implying a downtrend), the fee is slightly decreased.</p>
</div>
<div class="paragraph">
<p>The final fee is calculated as:</p>
</div>
<div class="stemblock">
<div class="content">
\[final\ fee = fee \times Fee\ Multiplier\]
</div>
</div>
<div class="sect4">
<h5 id="_update_multiplier"><a class="link" href="#_update_multiplier">8.6.3.1. Update Multiplier</a></h5>
<div class="paragraph">
<p>The <code>Update Multiplier</code> defines how the multiplier can change. The
Polkadot Runtime internally updates the multiplier after each block
according the following formula:</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{aligned}
  diff &amp;=&amp; (target\ weight - previous\ block\ weight) \\
  v &amp;=&amp; 0.00004 \\
  next\ weight &amp;=&amp; weight \times (1 + (v \times diff) + (v \times diff)^2 / 2) \\
\end{aligned}\]
</div>
</div>
<div class="paragraph">
<p>Polkadot defines the <code>target_weight</code> as 0.25 (25%). More information
about this algorithm is described in the
<a href="https://research.web3.foundation/en/latest/polkadot/Token%20Economics.html#relay-chain-transaction-fees-and-per-block-transaction-limits">Web3 Foundation research paper</a>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_consensus"><a class="link" href="#_consensus">9. Consensus</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_babe_digest_messages"><a class="link" href="#_babe_digest_messages">9.1. BABE digest messages</a></h3>
<div class="paragraph">
<p>The Runtime is required to provide the BABE authority list and
randomness to the host via a consensus message in the header of the
first block of each epoch.</p>
</div>
<div class="paragraph">
<p>The digest published in Epoch \(\mathcal{E}_n\) is enacted in
\(\mathcal{E}_{n+1}\). The randomness in this digest is
computed based on the all the VRF outputs up to including Epoch
\(\mathcal{E}_{n-2}\) while the authority set is based on all
transaction included up to Epoch \(\mathcal{E}_{n-1}\).</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>The computation of the randomeness seed is described in Algorithm
<a href="#algo-epoch-randomness">Algorithm 10</a> which uses the
concept of epoch subchain as described in host specification and the
value \(d_B\), which is the VRF output computed for slot
\(s_B\).</p>
</div>
          <div id="algo-epoch-randomness" class="imageblock">
            <div class="content"><div class="ps-root">
<div class="ps-algorithm with-caption">
<p class="ps-line" style="text-indent:-1.2em;padding-left:1.2em;">
<span class="ps-keyword">Algorithm 10 </span>Epoch-Randomness(n&gt;2: epoch index)</p>
<div class="ps-algorithmic with-linenum">
<div class="ps-block" style="margin-left:1.7999999999999998em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">1:</span><span style="font-weight:bold;">init</span> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ρ</mi><mo>←</mo><mi>ϕ</mi></mrow><annotation encoding="application/x-tex">\rho \leftarrow \phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">ρ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">ϕ</span></span></span></span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">2:</span><span class="ps-keyword">for </span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> in <span style="font-style:normal;font-variant:small-caps;">SubChain</span>(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">E</mi><mrow><mi>n</mi><mo>−</mo><mn>2</mn></mrow></msub></mrow><annotation encoding="application/x-tex">\mathcal{E}_{n-2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.891661em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.08944em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.301108em;"><span style="top:-2.5500000000000003em;margin-left:-0.08944em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span></span></span></span>)<span class="ps-keyword"> do</span></p>
<div class="ps-block" style="margin-left:1.2em;">
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:-1.5em;">3:</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ρ</mi><mo>←</mo><mi>ρ</mi><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><msub><mi>d</mi><mi>B</mi></msub></mrow><annotation encoding="application/x-tex">\rho \leftarrow \rho || d_B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">ρ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ρ</span><span class="mord">∣∣</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></p>
</div>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">4:</span><span class="ps-keyword">end for</span></p>
<p class="ps-line ps-code">
<span class="ps-linenum" style="left:0em;">5:</span><span class="ps-keyword">return </span><span style="font-style:normal;font-variant:small-caps;">Blake2b</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo></mrow><annotation encoding="application/x-tex">(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span></span></span></span><span style="font-style:normal;font-variant:small-caps;">Epoch-Randomness</span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi>n</mi><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi>ρ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(n-1)||n||\rho)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mord">∣∣</span><span class="mord mathnormal">n</span><span class="mord">∣∣</span><span class="mord mathnormal">ρ</span><span class="mclose">)</span></span></span></span></p>
</div>
</div>
</div>
</div></div>
            <div class="title">Algorithm 10. <a href="#algo-epoch-randomness">Epoch-Randomness(n>2: epoch index)</a></div>
          </div>
</div>
</div>
</div>
</div>
</div>
<h1 id="_additional_information" class="sect0"><a class="link" href="#_additional_information">Additional information</a></h1>
<div class="openblock partintro">
<div class="content">
Appendix chapter containing various protocol details
</div>
</div>
<div class="sect1">
<h2 id="chapter-crypto-algos"><a class="link" href="#chapter-crypto-algos">10. Cryptographic Algorithms</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="sect-hash-functions"><a class="link" href="#sect-hash-functions">10.1. Hash Functions</a></h3>

</div>
<div class="sect2">
<h3 id="sect-blake2"><a class="link" href="#sect-blake2">10.2. BLAKE2</a></h3>
<div class="paragraph">
<p>BLAKE2 is a collection of cryptographic hash functions known for their high
speed. Their design closely resembles BLAKE which has been a finalist in the
SHA-3 competition.</p>
</div>
<div class="paragraph">
<p>Polkadot is using the Blake2b variant which is optimized for 64-bit platforms.
Unless otherwise specified, the Blake2b hash function with a 256-bit output is
used whenever Blake2b is invoked in this document. The detailed specification
and sample implementations of all variants of Blake2 hash functions can be found
in RFC 7693 [<a href="#saarinen_blake2_2015">1</a>].</p>
</div>
</div>
<div class="sect2">
<h3 id="sect-randomness"><a class="link" href="#sect-randomness">10.3. Randomness</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
TBH
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="sect-vrf"><a class="link" href="#sect-vrf">10.4. VRF</a></h3>
<div class="paragraph">
<p>A Verifiable Random Function (VRF) is a mathematical operation that takes some
input and produces a random number using a secret key along with a proof of
authenticity that this random number was generated using the submitter&#8217;s secret
key and the given input. The proof can be verified by any challenger to ensure
the random number generation is valid and has not been tampered with (for
example to the benfit of submitter).</p>
</div>
<div class="paragraph">
<p>In Polkadot, VRFs are used for the BABE block production lottery by the
Algorithm as defined in <a href="#algo-block-production-lottery">Section 5.2.2.1</a>  and the parachain
approval voting mechanism (<a href="#sect-approval-voting">Section 6.5</a>). The VRF uses mechanism
similar to algorithms introduced in the following papers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://eprint.iacr.org/2017/099.pdf">Making NSEC5 Practical for DNSSEC</a>.</p>
</li>
<li>
<p><a href="https://blog.cloudflare.com/privacy-pass-the-math/#dleqproofs">DLEQ Proofs</a>.</p>
</li>
<li>
<p><a href="https://tools.ietf.org/id/draft-goldbe-vrf-01.html">Verifiable Random Functions (VRFs)</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It essentially generates a deterministic elliptic curve based Schnorr
signature as a verifiable random value. The elliptic curve group used in the VRF
function is the Ristretto group specified in:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://ristretto.group/" class="bare">https://ristretto.group/</a></p>
</li>
</ul>
</div>
<div id="defn-vrf-proof" class="exampleblock">
<div class="title">Definition 139. <a href="#defn-vrf-proof">VRF Proof</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>VRF proof</strong> proves the correctness for an associated VRF output. The VRF
proof, \$P\$, is a datastructure of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$P = (C,S)\$
\$S = (b_0, ... b_31)\$
</div>
</div>
<div class="paragraph">
<p>where \$C\$ is the challenge and \$S\$ is the 32-byte Schnorr poof. Both
are expressed as Curve25519 scalars as defined in Definition
<a href="#defn-vrf-dleq-prove">Definition 140</a>.</p>
</div>
</div>
</div>
<div id="defn-vrf-dleq-prove" class="exampleblock">
<div class="title">Definition 140. <a href="#defn-vrf-dleq-prove"><code>DLEQ Prove</code></a></div>
<div class="content">
<div class="paragraph">
<p>The \$"dleq_prove"(t, i)\$ function creates a proof for a given input, \$i\$,
based on the provided transcript, \$T\$.</p>
</div>
<div class="paragraph">
<p>First:</p>
</div>
<div class="stemblock">
<div class="content">
\$t_1 = "append"(t, "'proto-name'", "'DLEQProof'")\$
\$t_2 = "append"(t_1, "'vrf:h'", i)\$
</div>
</div>
<div class="paragraph">
<p>Then the witness scalar is calculated, \$s_w\$, where \$w\$ is the
32-byte secret seed used for nonce generation in the context of sr25519.</p>
</div>
<div class="stemblock">
<div class="content">
\$t_3 = "meta-AD"(t_2, "'proving\\00'", "more=False")\$
\$t_4 = "meta-AD"(t_3, w_l, "more=True")\$
\$t_5 = "KEY"(t_4, w, "more=False")\$
\$t_6 = "meta-AD"(t_5, "'rng'", "more=False")\$
\$t_7 = "KEY"(t_6, r, "more=False")\$
\$t_8 = "meta-AD"(t_7, e_(64), "more=False")\$
\$(phi, s_w) = "PRF"(t_8, "more=False")\$
</div>
</div>
<div class="paragraph">
<p>where \$w_l\$ is length of the witness, encoded as a 32-bit little-endian
integer. \$r\$ is a 32-byte array containing the secret witness scalar.</p>
</div>
<div class="stemblock">
<div class="content">
\$l_1 = "append"(t_2, "'vrf:R=g^r'", s_w)\$
\$l_2 = "append"(l_1, "'vrf:h^r'", s_i)\$
\$l_3 = "append"(l_2, "'vrf:pk'", s_p)\$
\$l_4 = "append"(l_3, "'vrf:h^sk'", "vrf"_o)\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$s_i\$ is the compressed Ristretto point of the scalar input.</p>
</li>
<li>
<p>\$s_p\$ is the compressed Ristretto point of the public key.</p>
</li>
<li>
<p>\$s_w\$ is the compressed Ristretto point of the wittness:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For the 64-byte challange:</p>
</div>
<div class="stemblock">
<div class="content">
\$l_5 = "meta-AD"(l_4, "'prove'", "more=False")\$
\$l_6 = "meta-AD"(l_5, e_(64), "more=True")\$
\$C = "PRF"(l_6, "more=False")\$
</div>
</div>
<div class="paragraph">
<p>And the Schnorr proof:</p>
</div>
<div class="stemblock">
<div class="content">
\$S = s_w - (C * p)\$
</div>
</div>
<div class="paragraph">
<p>where \$p\$ is the secret key.</p>
</div>
</div>
</div>
<div id="defn-vrf-dleq-verify" class="exampleblock">
<div class="title">Definition 141. <a href="#defn-vrf-dleq-verify"><code>DLEQ Verify</code></a></div>
<div class="content">
<div class="paragraph">
<p>The \$"dleq_verify"(i, o, P, p_k)\$ function verifiers the VRF input,
\$i\$ against the output, \$o\$, with the associated proof
(<a href="#defn-vrf-proof">Definition 139</a>) and public key, \$p_k\$.</p>
</div>
<div class="stemblock">
<div class="content">
\$t_1 = "append"(t, "'proto-name'", "'DLEQProof'")\$
\$t_2 = "append"(t_1, "'vrf:h'", s_i)\$
\$t_3 = "append"(t_2, "'vrf:R=g^r'", R)\$
\$t_4 = "append"(t_3, "'vrf:h^r'", H)\$
\$t_5 = "append"(t_4, "'vrf:pk'", p_k)\$
\$t_6 = "append"(t_5, "'vrf:h^sk'", o)\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$R\$ is calculated as:</p>
<div class="stemblock">
<div class="content">
\$R = C in P xx p_k + S in P + B\$
</div>
</div>
<div class="paragraph">
<p>where \$B\$ is the Ristretto basepoint.</p>
</div>
</li>
<li>
<p>\$H\$ is calculated as:</p>
<div class="stemblock">
<div class="content">
\$H = C in P xx o + S in P xx i\$
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The challange is valid if \$C in P\$ equals \$y\$:</p>
</div>
<div class="stemblock">
<div class="content">
\$t_7 = "meta-AD"(t_6, "'prove'", "more=False")\$
\$t_8 = "meta-AD"(t_7, e_(64), "more=True")\$
\$y = "PRF"(t_8, "more=False")\$
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_transcript"><a class="link" href="#_transcript">10.4.1. Transcript</a></h4>
<div class="paragraph">
<p>A VRF transcript serves as a domain-specific separator of cryptographic
protocols and is represented as a mathematical object, as defined by Merlin,
which defines how that object is generated and encoded. The usage of the
transcript is implementation specific, such as for certain mechanisms in the
Availability &amp; Validity chapter (<a href="#chapter-anv">Chapter 6</a>), and is therefore described in
more detail in those protocols. The input value used to generate the
transactions is referred to as a <em>context</em> (<a href="#defn-vrf-context">[defn-vrf-context]</a>).</p>
</div>
<div id="defn-vrf-transcript" class="exampleblock">
<div class="title">Definition 142. <a href="#defn-vrf-transcript">VRF Transcript</a></div>
<div class="content">
<div class="paragraph">
<p>A <strong>transcript</strong>, or VRF transcript, is a STROBE object, \$"obj"\$, as defined
in the STROBE documentation, respectively section
<a href="https://strobe.sourceforge.io/specs/#object">"5. State of a STROBE object"</a>.</p>
</div>
<div class="stemblock">
<div class="content">
\$"obj" = ("st","pos","pos"_("begin"),I_0)\$
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The duplex state, \$"st"\$, is a 200-byte array created by the
<a href="https://keccak.team/keccak_specs_summary.html">keccak-f1600 sponge function</a> on
the <a href="https://strobe.sourceforge.io/specs/#object.initial">initial STROBE state</a>.
Specifically, <code>R</code> is of value <code>166</code> and <code>X.Y.Z</code> is of value <code>1.0.2</code>.</p>
</li>
<li>
<p>\$"pos"\$ has the initial value of <code>0</code>.</p>
</li>
<li>
<p>\$"pos"_("begin")\$ has the initial value of <code>0</code>.</p>
</li>
<li>
<p>\$I_0\$ has the initial value of <code>0</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then, the <code>meta-AD</code> operation (<a href="#defn-strobe-operations">Definition 143</a>) (where <code>more=False</code>) is
used to add the protocol label <code>Merlin v1.0</code> to \$"obj"\$ followed by
<em>appending</em> (<a href="#sect-vrf-appending-messages">Section 10.4.1.1</a>) label <code>dom-step</code> and its
corresponding context, \$ctx\$, resulting in the final transcript, \$T\$.</p>
</div>
<div class="stemblock">
<div class="content">
\$t = "meta-AD"(obj, "'Merlin v1.0'", "False")\$
\$T = "append"(t, "'dom-step'", "ctx")\$
</div>
</div>
<div class="paragraph">
<p>\$"ctx"\$ serves as an arbitrary identifier/separator and its value is
defined by the protocol specification individually. This transcript is treated
just like a STROBE object, wherein any operations (<a href="#defn-strobe-operations">Definition 143</a>)
on it modify the values such as \$"pos"\$ and \$"pos"_("begin")\$.</p>
</div>
<div class="paragraph">
<p>Formally, when creating a transcript we refer to it as \$"Transcript"(ctx)\$.</p>
</div>
</div>
</div>
<div id="defn-strobe-operations" class="exampleblock">
<div class="title">Definition 143. <a href="#defn-strobe-operations">STROBE Operations</a></div>
<div class="content">
<div class="paragraph">
<p>STROBE operations are described in the
<a href="https://strobe.sourceforge.io/specs/">STROBE specification</a>, respectively section
<a href="https://strobe.sourceforge.io/specs/#ops">"6. Strobe operations"</a>. Operations are
indicated by their corresponding bitfield, as described in section
<a href="https://strobe.sourceforge.io/specs/#ops.flags">"6.2. Operations and flags"</a> and
implemented as described in section
<a href="https://strobe.sourceforge.io/specs/#ops.impl">"7. Implementation of operations"</a></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sect-vrf-appending-messages"><a class="link" href="#sect-vrf-appending-messages">10.4.1.1. Appending Messages</a></h5>
<div class="paragraph">
<p>Appending messages, or "data", to the transcript (<a href="#defn-vrf-transcript">Definition 142</a>) first
requires <code>meta-AD</code> operations for a given label of the messages, including the
size of the message, followed by an <code>AD</code> operation on the message itself. The
size of the message is a 4-byte, little-endian encoded integer.</p>
</div>
<div class="stemblock">
<div class="content">
\$T_0 = "meta-AD"(T, l, "False")\$
\$T_1 = "meta-AD"(T_0, m_l, "True")\$
\$T_2 = "AD"(T_1, m, "False")\$
</div>
</div>
<div class="paragraph">
<p>where \$T\$ is the transcript (<a href="#defn-vrf-transcript">Definition 142</a>), \$l\$ is the
given label and \$m\$ the message, respectively \$m_l\$ representing its
size. \$T_2\$ is the resulting transcript with the appended data. STROBE
operations are described in <a href="#defn-strobe-operations">Definition 143</a>.</p>
</div>
<div class="paragraph">
<p>Formally, when appending a message we refer to it as \$"append"(T, l, m)\$.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-cryptographic-keys"><a class="link" href="#sect-cryptographic-keys">10.5. Cryptographic Keys</a></h3>
<div class="paragraph">
<p>Various types of keys are used in Polkadot to prove the identity of the actors
involved in the Polkadot Protocols. To improve the security of the users, each
key type has its own unique function and must be treated differently, as
described by this Section.</p>
</div>
<div id="defn-account-key" class="exampleblock">
<div class="title">Definition 144. <a href="#defn-account-key">Account Key</a></div>
<div class="content">
<div class="paragraph">
<p><strong>Account key \$(sk^a,pk^a)\$</strong> is a key pair of type of either of the schemes in the following
table:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. List of the public key scheme which can be used for an account key</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key Scheme</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sr25519</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Schnorr signature on Ristretto compressed ed25519 points as implemented in TODO</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ed25519</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The standard ed25519 signature complying with TODO</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">secp256k1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only for outgoing transfer transactions.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>An account key can be used to sign transactions among other accounts and
balance-related functions. There are two prominent subcategories of account keys
namely "stash keys" and "controller keys", each being used for a different
function. Keys defined in Definitions <a href="#defn-account-key">Definition 144</a>, <a href="#defn-stash-key">Definition 145</a>
and <a href="#defn-controller-key">Definition 146</a> are created and managed by the user independent of
the Polkadot implementation. The user notifies the network about the used keys
by submitting a transaction, as defined in
link_sect-creating-controller-key[9.5.2] and link_sect-certifying-keys[9.5.5]
respectively.</p>
</div>
</div>
</div>
<div id="defn-stash-key" class="exampleblock">
<div class="title">Definition 145. <a href="#defn-stash-key">Stash Key</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>Stash key</strong> is a type of account key that holds funds bonded for staking
(described in Section link_sect-staking-funds[9.5.1]) to a particular
controller key (defined in Definition
<a href="#defn-controller-key">Definition 146</a>). As a result, one may actively
participate with a stash key keeping the stash key offline in a secure location.
It can also be used to designate a Proxy account to vote in governance
proposals, as described in link_sect-creating-controller-key[9.5.2]. The Stash
key holds the majority of the users’ funds and should neither be shared with
anyone, saved on an online device, nor used to submit extrinsics.</p>
</div>
</div>
</div>
<div id="defn-controller-key" class="exampleblock">
<div class="title">Definition 146. <a href="#defn-controller-key">Controller Key</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>Controller key</strong> is a type of account key that acts on behalf of the Stash
account. It signs transactions that make decisions regarding the nomination and
the validation of the other keys. It is a key that will be in direct control of
a user and should mostly be kept offline, used to submit manual extrinsics. It
sets preferences like payout account and commission, as described in
link_sect-controller-settings[9.5.4]. If used for a validator, it certifies the
session keys, as described in link_sect-certifying-keys[9.5.5]. It only needs
the required funds to pay transaction fees [TODO: key needing fund needs to be
defined].</p>
</div>
</div>
</div>
<div id="defn-session-key" class="exampleblock">
<div class="title">Definition 147. <a href="#defn-session-key">Session Keys</a></div>
<div class="content">
<div class="paragraph">
<p><strong>Session keys</strong> are short-lived keys that are used to authenticate validator
operations. Session keys are generated by the Polkadot Host and should be
changed regularly due to security reasons. Nonetheless, no validity period is
enforced by the Polkadot protocol on session keys. Various types of keys used by
the Polkadot Host are presented in Table link_tabl-session-keys[9.1]<em>:</em></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. List of key schemes which are used for session keys depending on the protocol</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Protocol</th>
<th class="tableblock halign-left valign-top">Key scheme</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GRANDPA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ED25519</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BABE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SR25519</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">I’m Online</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SR25519</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parachain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SR25519</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Session keys must be accessible by certain Polkadot Host APIs defined in
Appendix link_sect-host-api[12]. Session keys are <em>not</em> meant to control the
majority of the users’ funds and should only be used for their intended purpose.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-staking-funds"><a class="link" href="#sect-staking-funds">10.5.1. Holding and staking funds</a></h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
TBH
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="sect-creating-controller-key"><a class="link" href="#sect-creating-controller-key">10.5.2. Creating a Controller key</a></h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
TBH
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="sect-designating-proxy"><a class="link" href="#sect-designating-proxy">10.5.3. Designating a proxy for voting</a></h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
TBH
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="sect-controller-settings"><a class="link" href="#sect-controller-settings">10.5.4. Controller settings</a></h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
TBH
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="sect-certifying-keys"><a class="link" href="#sect-certifying-keys">10.5.5. Certifying keys</a></h4>
<div class="paragraph">
<p>Due to security considerations and Runtime upgrades, the session keys are
supposed to  be changed regularly. As such, the new session keys need to be
certified by a controller key before putting them in use. The controller only
needs to create a certificate by signing a session public key and broadcasting
this certificate via an extrinsic. [TODO: spec the detail of the data structure
of the certificate etc.]</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter-encoding"><a class="link" href="#chapter-encoding">11. Auxiliary Encodings</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="sect-scale-codec"><a class="link" href="#sect-scale-codec">11.1. SCALE Codec</a></h3>
<div class="paragraph">
<p>The Polkadot Host uses <em>Simple Concatenated Aggregate Little-Endian” (SCALE)
codec</em> to encode byte arrays as well as other data structures. SCALE provides a
canonical encoding to produce consistent hash values across their
implementation, including the Merkle hash proof for the State Storage.</p>
</div>
<div class="exampleblock">
<div class="title">Definition 148. Decoding</div>
<div class="content">
<div class="paragraph">
<p>\$"Dec"_("SC")(d)\$ refers to the decoding of a blob of data. Since the SCALE codec is not
self-describing, it’s up to the decoder to validate whether the blob of data can
be deserialized into the given type or data structure.</p>
</div>
</div>
</div>
<div id="defn-scale-byte-array" class="exampleblock">
<div class="title">Definition 149. Byte Array</div>
<div class="content">
<div class="paragraph">
<p>The <strong>SCALE codec</strong> for <strong>Byte array</strong>, \$A\$, such that:</p>
</div>
<div class="stemblock">
<div class="content">
\$A := (b_1, b_2, ... b_n)\$
</div>
</div>
<div class="paragraph">
<p>such that \$n &lt; 2^(536)\$ is a byte array referred to \$"Enc"_("SC")(A)\$
and defined as:</p>
</div>
<div class="stemblock">
<div class="content">
\$"Enc"_("SC")(A) := "Enc"_("SC")^("Len")(abs(A)) "||" A\$
</div>
</div>
<div class="paragraph">
<p>where \$"Enc"_("SC")^("Len")\$ is defined in <a href="#defn-sc-len-encoding">Definition 160</a>.</p>
</div>
</div>
</div>
<div id="defn-scale-tuple" class="exampleblock">
<div class="title">Definition 150. Tuple</div>
<div class="content">
<div class="paragraph">
<p>The <strong>SCALE codec</strong> for <strong>Tuple</strong>, \$T\$, such that:</p>
</div>
<div class="stemblock">
<div class="content">
\$T := (A_1,... A_n)\$
</div>
</div>
<div class="paragraph">
<p>Where \$A_i\$’s are values of <strong>different types</strong>, is defined as:</p>
</div>
<div class="stemblock">
<div class="content">
\$"Enc"_("SC")(T) := "Enc"_("SC")(A_1) "||" "Enc"_("SC")(A_2) "||" ... "||" "Enc"_("SC")(A_n)\$
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In case of a tuple (or a structure), the knowledge of the shape of data is not
encoded even though it is necessary for decoding. The decoder needs to derive
that information from the context where the encoding/decoding is happening.</p>
</div>
<div id="defn-varrying-data-type" class="exampleblock">
<div class="title">Definition 151. Varying Data Type</div>
<div class="content">
<div class="paragraph">
<p>We define a <strong>varying data</strong> type to be an ordered set of data types.</p>
</div>
<div class="stemblock">
<div class="content">
\$cc T = {T_1, ..., T_n}\$
</div>
</div>
<div class="paragraph">
<p>A value \$A\$ of varying date type is a pair \$(A_("Type"),A_("Value"))\$
where \$A_("Type") = T_i\$ for some \$T_i in cc T\$ and
\$A_("Value")\$ is its value of type \$T_i\$, which can be empty. We
define \$"idx"(T_i) = i - 1\$, unless it is explicitly defined as another
value in the definition of a particular varying data type.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>In particular, we define two specific varying data which are frequently used in
various part of Polkadot Protocol:</p>
</div>
<div id="defn-option-type" class="exampleblock">
<div class="title">Definition 152. Option Type</div>
<div class="content">
<div class="paragraph">
<p>The <strong>Option</strong> type is a varying data type of \${"None",T_2}\$ which indicates if
data of \$T_2\$ type is available (referred to as <em>some</em> state) or not
(referred to as <em>empty</em>, <em>none</em> or <em>null</em> state). The presence of type <em>none</em>,
indicated by \$"idx"(T_("None")) = 0\$, implies that the data corresponding
to \$T_2\$ type is not available and contains no additional data. Where as
the presence of type \$T_2\$ indicated by \$"idx"(T_2) = 1\$ implies that
the data is available.</p>
</div>
</div>
</div>
<div id="defn-result-type" class="exampleblock">
<div class="title">Definition 153. Result Type</div>
<div class="content">
<div class="paragraph">
<p>The <strong>Result</strong> type is a varying data type of \${T_1, T_2}\$ which is used to
indicate if a certain operation or function was executed successfully (referred
to as "ok" state) or not (referred to as "error" state). \$T_1\$ implies
success, \$T_2\$ implies failure. Both types can either contain additional
data or are defined as empty type otherwise.</p>
</div>
</div>
</div>
<div id="defn-scale-variable-type" class="exampleblock">
<div class="title">Definition 154. Encoding of Varying Data Type</div>
<div class="content">
<div class="paragraph">
<p>The SCALE codec for value \$A = (A_("Type"), A_("Value"))\$ of varying data
type \$cc T = {T_i, ... T_n}\$, formally referred to as
stem:["Enc" ("SC")(A)} is defined as follows:</p>
</div>
<div class="stemblock">
<div class="content">
\$"Enc"_("SC")(A) := "Enc"_("SC")("idx"(A_("Type")) "||" "Enc"_("SC")(A_("Value")))\$
</div>
</div>
<div class="paragraph">
<p>Where \$"idx"\$ is encoded in a fixed length integer determining the type of
\$A\$. In particular, for the optional type defined in
<a href="#defn-varrying-data-type">Definition 151</a>, we have:</p>
</div>
<div class="stemblock">
<div class="content">
\$"Enc"_("SC")("None", phi) := 0_(bbb B_1)\$
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The SCALE codec does not encode the correspondence between the value of \$idx\$
defined in <a href="#defn-scale-variable-type">Definition 154</a> and the data type it represents; the
decoder needs prior knowledge of such correspondence to decode the data.</p>
</div>
<div id="defn-scale-list" class="exampleblock">
<div class="title">Definition 155. Sequence</div>
<div class="content">
<div class="paragraph">
<p>The <strong>SCALE codec</strong> for <strong>sequence</strong> \$S\$ such that:</p>
</div>
<div class="stemblock">
<div class="content">
\$S := A_1, ... A_n\$
</div>
</div>
<div class="paragraph">
<p>where \$A_i\$’s are values of <strong>the same type</strong> (and the decoder is unable to
infer value of \$n\$ from the context) is defined as:</p>
</div>
<div class="stemblock">
<div class="content">
\$"Enc"_("SC")(S) := "Enc"_("SC")^("Len")(abs(S)) "||" "Enc"_("SC")(A_2) "||" ... "||" "Enc"_("SC")(A_n)\$
</div>
</div>
<div class="paragraph">
<p>where \$"Enc"_("SC")^("Len")\$ is defined in <a href="#defn-sc-len-encoding">Definition 160</a>.</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Definition 156. Dictionary</div>
<div class="content">
<div class="paragraph">
<p>SCALE codec for <strong>dictionary</strong> or <strong>hashtable</strong> D with key-value pairs \$(k_i,
v_i)\$s such that:</p>
</div>
<div class="stemblock">
<div class="content">
\$D := {(k_1, v_1), ... (k_n, v_n)}\$
</div>
</div>
<div class="paragraph">
<p>is defined the SCALE codec of \$D\$ as a sequence of key value pairs (as
tuples):</p>
</div>
<div class="stemblock">
<div class="content">
\$"Enc"_("SC")(D) := "Enc"_("SC")^("Size")(abs(D)) "||" "Enc"_("SC")(k_1, v_1) "||"..."||" "Enc"_("SC")(k_n, v_n)\$
</div>
</div>
<div class="paragraph">
<p>where \$"Enc"_("SC")^("Size")\$ is encoded the same way as
\$"Enc"_("SC")^("Len")\$ but argument \$"Size"\$ refers to the number of
key-value pairs rather than the length.</p>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Definition 157. Boolean</div>
<div class="content">
<div class="paragraph">
<p>The <strong>SCALE codec</strong> for <strong>boolean value</strong> \$b\$ defined as a byte as follows:</p>
</div>
<div class="stemblock">
<div class="content">
\$"Enc"_("SC"): {"False", "True"} -&gt; bbb B_1\$
\$b -&gt; {(0, b="False"),(1, b="True"):}\$
</div>
</div>
</div>
</div>
<div id="defn-scale-fixed-length" class="exampleblock">
<div class="title">Definition 158. Fixed Length</div>
<div class="content">
<div class="paragraph">
<p>The SCALE codec, \$"Enc"_("SC")\$, for other types such as fixed length
integers not defined here otherwise, is equal to little endian encoding of those
values defined in <a href="#defn-little-endian">Definition 6</a>.</p>
</div>
</div>
</div>
<div id="defn-scale-empty" class="exampleblock">
<div class="title">Definition 159. Empty</div>
<div class="content">
<div class="paragraph">
<p>The SCALE codec, \$"Enc"_("SC")\$, for an empty type is defined to a byte
array of zero length and depicted as \$phi\$.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_length_and_compact_encoding"><a class="link" href="#_length_and_compact_encoding">11.1.1. Length and Compact Encoding</a></h4>
<div class="paragraph">
<p>SCALE Length encoding is used to encode integer numbers of variying sizes prominently in an encoding length of arrays:</p>
</div>
<div id="defn-sc-len-encoding" class="exampleblock">
<div class="title">Definition 160. Length Encoding</div>
<div class="content">
<div class="paragraph">
<p><strong>SCALE Length encoding</strong>, \$"Enc"_("SC")^("Len")\$, also known as a <em>compact encoding</em>, of a non-negative number \$n\$ is defined as follows:</p>
</div>
<div class="stemblock">
<div class="content">
\$"Enc"_("SC")^("Len"): bbb N -&gt; bbb B\$
\$n -&gt; b := {(l_1, 0 &lt;= n &lt; 2^6),(i_1 i_2, 2^6 &lt;= n &lt; 2^14),(j_1 j_2 j_3, 2^14 &lt;= n &lt; 2^30),(k_1 k_2 ... k_m, 2^30&lt;=n):}\$
</div>
</div>
<div class="paragraph">
<p>in where the least significant bits of the first byte of byte array b
are defined as follows:</p>
</div>
<div class="stemblock">
<div class="content">
\$l_1^1 l_1^0 = 00\$
\$i_1^1 i_1^0 = 01\$
\$j_1^1 j_1^0 = 10\$
\$k_1^1 k_1^0 = 11\$
</div>
</div>
<div class="paragraph">
<p>and the rest of the bits of \$b\$ store the value of \$n\$ in
little-endian format in base-2 as follows:</p>
</div>
<div class="stemblock">
<div class="content">
\$n := {
	(l_1^7 ... l_1^3 l_1^2, n &lt; 2^6),
	(i_2^7 ... i_2^0 i_1^7 .. i_1^2, 2^6 &lt;= n &lt; 2^14),
	(j_4^7 ... j_4^0 j_3^7 ... j_1^7 ... j_1^2, 2^14 &lt;= n &lt; 2^30),
	(k_2 + k_3 2^8 + k_4 2^(2 xx 8)+...+k_m2^((m-2)8),2^30 &lt;= n)
	:}\$
</div>
</div>
<div class="paragraph">
<p>such that:</p>
</div>
<div class="stemblock">
<div class="content">
\$k_1^7 ... k_1^3 k_1^2 := m-4\$
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hex_encoding"><a class="link" href="#_hex_encoding">11.2. Hex Encoding</a></h3>
<div class="paragraph">
<p>Practically, it is more convenient and efficient to store and process data which
is stored in a byte array. On the other hand, the Trie keys are broken into
4-bits nibbles. Accordingly, we need a method to encode sequences of 4-bits
nibbles into byte arrays canonically. To this aim, we define
hex encoding function \$"Enc" ("HE")("PK")\$ as follows:</p>
</div>
<div id="defn-hex-encoding" class="exampleblock">
<div class="title">Definition 161. Hex Encoding</div>
<div class="content">
<div class="paragraph">
<p>Suppose that \$"PK" = (k_1, ... k_n)\$ is a sequence of nibbles, then:</p>
</div>
<div class="stemblock">
<div class="content">
\$"Enc"_("HE")("PK") := {("Nibbles"_4,-&gt;, bbb B),("PK" = (k_1, ... k_n),-&gt;,{((16k_1+k_2,...,16k_(2i-1)+k_(2i)),n=2i),((k_1,16k_2+k_3,...,16k_(2i)+k_(2i+1)),n = 2i+1):}):}\$
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter-genesis"><a class="link" href="#chapter-genesis">12. Genesis State</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The genesis state is a set of key-value pairs representing the intial state of
the Polkadot state storage. It can be retrieved from
<a href="https://github.com/paritytech/polkadot/tree/master/node/service/res">the Polkadot
repository</a>. While each of those key-value pairs offers important identifyable
information to the Runtime, to the Polkadot Host they are a transparent set of
arbitrary chain- and network-dependent keys and values. The only exception to
this are the <code>:code</code> (<a href="#sect-loading-runtime-code">Section 3.1.2</a>) and <code>:heappages</code>
(<a href="#sect-memory-management">Section 3.1.3.1</a>) keys, which are used by the Polkadot Host to
initialize the WASM environment and its Runtime. The other keys and values are
unspecified and solely depend on the chain and respectively its corresponding
Runtime. On initialization the data should be inserted into the state storage
with the Host API (<a href="#sect-storage-set">Section 15.1.1</a>).</p>
</div>
<div class="paragraph">
<p>As such, Polkadot does not defined a formal genesis block. Nonetheless for the
compatibility reasons in several algorithms, the Polkadot Host defines the
<em>genesis header</em> (<a href="#defn-genesis-header">[defn-genesis-header]</a>). By the abuse of terminology,
"genesis block" refers to the hypothetical parent of block number <em>1</em> which
holds genisis header as its header.</p>
</div>
<div id="defn-genesis-header" class="paragraph">
<p>The Polkadot genesis
header is a data structure conforming to block header format (<a href="#defn-block-header">Definition 32</a>). It contains the following
values:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Block header field</th>
<th class="tableblock halign-left valign-top">Genesis Header Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>parent_hash</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>0</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>number</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>0</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>state_root</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Merkle hash of the state storage trie (<a href="#defn-merkle-value">Definition 28</a>) after inserting the genesis state in it.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>extrinsics_root</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>0</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>digest</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>0</em></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="chapter-erasure-encoding"><a class="link" href="#chapter-erasure-encoding">13. Erasure Encoding</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="sect-erasure-encoding"><a class="link" href="#sect-erasure-encoding">13.1. Erasure Encoding</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Erasure Encoding has not been documented yet.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<h1 id="chap-host-api" class="sect0"><a class="link" href="#chap-host-api">Host API</a></h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>Description of the expected environment available for import by the Polkadot Runtime</p>
</div>
<div id="defn-state-version" class="exampleblock">
<div class="title">Definition 162. <a href="#defn-state-version">State Version</a></div>
<div class="content">
<div class="paragraph">
<p>The state version, \$v\$, dictates how a merkle root should be constructed.
The datastructure is a varying type of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$v = {(0, "full values"),(1, "node hashes"):}\$
</div>
</div>
<div class="paragraph">
<p>where \$0\$ indicates that the values of the keys should be inserted into the
trie directly and \$1\$ makes use of "node hashes" when calculating the
merkle proof (<a href="#defn-node-hashes">Definition 27</a>).</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_preliminaries_7"><a class="link" href="#_preliminaries_7">14. Preliminaries</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Polkadot Host API is a set of functions that the Polkadot Host
exposes to Runtime to access external functions needed for various
reasons, such as the Storage of the content, access and manipulation,
memory allocation, and also efficiency. The encoding of each data type
is specified or referenced in this section. If the encoding is not
mentioned, then the default Wasm encoding is used, such as little-endian
byte ordering for integers.</p>
</div>
<div id="defn-host-api-at-state" class="exampleblock">
<div class="title">Definition 163. <a href="#defn-host-api-at-state">Exposed Host API</a></div>
<div class="content">
<div class="paragraph">
<p>By \$"RE"_B\$ we refer to the API exposed by the Polkadot Host which
interact, manipulate and response based on the state storage whose state is set
at the end of the execution of block \$B\$.</p>
</div>
</div>
</div>
<div id="defn-runtime-pointer" class="exampleblock">
<div class="title">Definition 164. <a href="#defn-runtime-pointer">Runtime Pointer</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>Runtime pointer</strong> type is an unsigned 32-bit integer representing a pointer
to data in memory. This pointer is the primary way to exchange data of
fixed/known size between the Runtime and Polkadot Host.</p>
</div>
</div>
</div>
<div id="defn-runtime-pointer-size" class="exampleblock">
<div class="title">Definition 165. <a href="#defn-runtime-pointer-size">Runtime Pointer Size</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>Runtime pointer-size</strong> type is an unsigned 64-bit integer, representing two
consecutive integers. The least significant is <strong>Runtime pointer</strong> (<a href="#defn-runtime-pointer">Definition 164</a>).
The most significant provides the size of the data in bytes. This representation
is the primary way to exchange data of arbitrary/dynamic sizes between the
Runtime and the Polkadot Host.</p>
</div>
</div>
</div>
<div id="defn-lexicographic-ordering" class="exampleblock">
<div class="title">Definition 166. <a href="#defn-lexicographic-ordering">Lexicographic ordering</a></div>
<div class="content">
<div class="paragraph">
<p><strong>Lexicographic ordering</strong> refers to the ascending ordering of bytes or byte
arrays, such as:</p>
</div>
<div class="stemblock">
<div class="content">
\$[0,0,2]&lt;[0,1,1]&lt;[1]&lt;[1,1,0]&lt;[2]&lt;[...]\$
</div>
</div>
<div class="paragraph">
<p>The functions are specified in each subsequent subsection for each category of
those functions.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sect-storage-api"><a class="link" href="#sect-storage-api">15. Storage</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Interface for accessing the storage from within the runtime.</p>
</div>
<div class="sect2">
<h3 id="_functions"><a class="link" href="#_functions">15.1. Functions</a></h3>
<div class="sect3">
<h4 id="sect-storage-set"><a class="link" href="#sect-storage-set">15.1.1. <code>ext_storage_set</code></a></h4>
<div class="paragraph">
<p>Sets the value under a given key into storage.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype"><a class="link" href="#_version_1_prototype">15.1.1.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_storage_set_version_1
	(param $key i64) (param $value i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) containing the key.</p>
</li>
<li>
<p><code>value</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) containing the
value.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_storage_get"><a class="link" href="#_ext_storage_get">15.1.2. <code>ext_storage_get</code></a></h4>
<div class="paragraph">
<p>Retrieves the value associated with the given key from storage.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_2"><a class="link" href="#_version_1_prototype_2">15.1.2.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_storage_get_version_1
	(param $key i64) (result i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) containing the key.</p>
</li>
<li>
<p><code>result</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) returning the SCALE
encoded <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) containing the value.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_storage_read"><a class="link" href="#_ext_storage_read">15.1.3. <code>ext_storage_read</code></a></h4>
<div class="paragraph">
<p>Gets the given key from storage, placing the value into a buffer and
returning the number of bytes that the entry in storage has beyond the
offset.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_3"><a class="link" href="#_version_1_prototype_3">15.1.3.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_storage_read_version_1
	(param $key i64) (param $value_out i64) (param $offset u32) (result i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) containing the key.</p>
</li>
<li>
<p><code>value_out</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) containing the
buffer to which the value will be written to. This function will never write
more then the length of the buffer, even if the value’s length is bigger.</p>
</li>
<li>
<p><code>offset</code>: an u32 integer containing the offset beyond the value should be read
from.</p>
</li>
<li>
<p><code>result</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) pointing to a SCALE
encoded <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) containing an unsigned 32-bit
integer representing the number of bytes left at supplied <code>offset</code>. Returns
<em>None</em> if the entry does not exists.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_storage_clear"><a class="link" href="#_ext_storage_clear">15.1.4. <code>ext_storage_clear</code></a></h4>
<div class="paragraph">
<p>Clears the storage of the given key and its value.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_4"><a class="link" href="#_version_1_prototype_4">15.1.4.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_storage_clear_version_1
	(param $key_data i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) containing the key.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_storage_exists"><a class="link" href="#_ext_storage_exists">15.1.5. <code>ext_storage_exists</code></a></h4>
<div class="paragraph">
<p>Checks whether the given key exists in storage.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_5"><a class="link" href="#_version_1_prototype_5">15.1.5.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_storage_exists_version_1
	(param $key_data i64) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) containing the key.</p>
</li>
<li>
<p><code>return</code>: an i32 integer value equal to <em>1</em> if the key exists or a value equal
to <em>0</em> if otherwise.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_storage_clear_prefix"><a class="link" href="#_ext_storage_clear_prefix">15.1.6. <code>ext_storage_clear_prefix</code></a></h4>
<div class="paragraph">
<p>Clear the storage of each key/value pair where the key starts with the given
prefix.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_6"><a class="link" href="#_version_1_prototype_6">15.1.6.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_storage_clear_prefix_version_1
	(param $prefix i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>prefix</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) containing
the prefix.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_version_2_prototype"><a class="link" href="#_version_2_prototype">15.1.6.2. Version 2 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_storage_clear_prefix_version_2
	(param $prefix i64) (param $limit i64)
	(return i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>prefix</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) containing
the prefix.</p>
</li>
<li>
<p><code>limit</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to an <em>Option</em> type
(<a href="#defn-option-type">Definition 152</a>) containing an unsigned 32-bit integer indicating the
limit on how many keys should be deleted. No limit is applied if this is <em>None</em>.
Any keys created during the current block execution do not count towards the
limit.</p>
</li>
<li>
<p><code>return</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the following variant, \$k\$:</p>
<div class="stemblock">
<div class="content">
\$k = {(0,-&gt; c),(1,-&gt; c):}\$
</div>
</div>
<div class="paragraph">
<p>where <em>0</em> indicates that all keys of the child storage have been removed,
followed by the number of removed keys, \$c\$. The variant <em>1</em> indicates that
there are remaining keys, followed by the number of removed keys.</p>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_storage_append"><a class="link" href="#_ext_storage_append">15.1.7. <code>ext_storage_append</code></a></h4>
<div class="paragraph">
<p>Append the SCALE encoded value to a SCALE encoded sequence (<a href="#defn-scale-list">Definition 155</a>)
at the given key. This function assumes that the existing storage item is either
empty or a SCALE encoded sequence and that the value to append is also SCALE
encoded and of the same type as the items in the existing sequence.</p>
</div>
<div class="paragraph">
<p>To improve performance, this function is allowed to skip decoding the entire
SCALE encoded sequence and instead can just append the new item to the end of
the existing data and increment the length prefix \$"Enc"_("SC")^("Len")\$.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If the storage item does not exist or is not SCALE encoded, the storage
item will be set to the specified value, represented as a SCALE encoded byte
array.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_7"><a class="link" href="#_version_1_prototype_7">15.1.7.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_storage_append_version_1
	(param $key i64) (param $value i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) containing the key.</p>
</li>
<li>
<p><code>value</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) containing the
value to be appended.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_storage_root"><a class="link" href="#_ext_storage_root">15.1.8. <code>ext_storage_root</code></a></h4>
<div class="paragraph">
<p>Compute the storage root.</p>
</div>
<div class="sect4">
<h5 id="sect-ext-storage-root-version-1"><a class="link" href="#sect-ext-storage-root-version-1">15.1.8.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_storage_root_version_1
	(return i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>return</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to a buffer containing
the 256-bit Blake2 storage root.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="sect-ext-storage-root-version-2"><a class="link" href="#sect-ext-storage-root-version-2">15.1.8.2. Version 2 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_storage_root_version_2
	(param $version i32) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>version</code>: a pointer-size (<a href="#defn-runtime-pointer">Definition 164</a>) to the state version <a href="#defn-state-version">Definition 162</a>.</p>
</li>
<li>
<p><code>return</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 256-bit Blake2 storage
root.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-ext-storage-changes-root"><a class="link" href="#sect-ext-storage-changes-root">15.1.9. <code>ext_storage_changes_root</code></a></h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This function is not longer used and only exists for compatibiltiy reasons.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_8"><a class="link" href="#_version_1_prototype_8">15.1.9.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_storage_changes_root_version_1
	(param $parent_hash i64) (return i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>parent_hash</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
SCALE encoded block hash.</p>
</li>
<li>
<p><code>return</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to an <em>Option</em> type
(<a href="#defn-option-type">Definition 152</a>) that&#8217;s always <em>None</em>.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_storage_next_key"><a class="link" href="#_ext_storage_next_key">15.1.10. <code>ext_storage_next_key</code></a></h4>
<div class="paragraph">
<p>Get the next key in storage after the given one in lexicographic order
(<a href="#defn-lexicographic-ordering">Definition 166</a>). The key provided to this function may or may
not exist in storage.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_9"><a class="link" href="#_version_1_prototype_9">15.1.10.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_storage_next_key_version_1
	(param $key i64) (return i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the key.</p>
</li>
<li>
<p><code>return</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) containing the next key in
lexicographic order.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-ext-storage-start-transaction"><a class="link" href="#sect-ext-storage-start-transaction">15.1.11. <code>ext_storage_start_transaction</code></a></h4>
<div class="paragraph">
<p>Start a new nested transaction. This allows to either commit or roll back all
changes that are made after this call. For every transaction there must be a
matching call to either <code>ext_storage_rollback_transaction</code>
(<a href="#sect-ext-storage-rollback-transaction">Section 15.1.12</a>) or <code>ext_storage_commit_transaction</code>
(<a href="#sect-ext-storage-commit-transaction">Section 15.1.13</a>). This is also effective for all values
manipulated using the child storage API (<a href="#sect-child-storage-api">Chapter 16</a>).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This is a low level API that is potentially dangerous as it can easily
result in unbalanced transactions. Runtimes should use high level storage
abstractions.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_10"><a class="link" href="#_version_1_prototype_10">15.1.11.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_storage_start_transaction_version_1)</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-ext-storage-rollback-transaction"><a class="link" href="#sect-ext-storage-rollback-transaction">15.1.12. <code>ext_storage_rollback_transaction</code></a></h4>
<div class="paragraph">
<p>Rollback the last transaction started by <code>ext_storage_start_transaction</code>
(<a href="#sect-ext-storage-start-transaction">Section 15.1.11</a>). Any changes made during that
transaction are discarded.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Panics if <code>ext_storage_start_transaction</code>
(<a href="#sect-ext-storage-start-transaction">Section 15.1.11</a>) was not called.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_11"><a class="link" href="#_version_1_prototype_11">15.1.12.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_storage_rollback_transaction_version_1)</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-ext-storage-commit-transaction"><a class="link" href="#sect-ext-storage-commit-transaction">15.1.13. <code>ext_storage_commit_transaction</code></a></h4>
<div class="paragraph">
<p>Commit the last transaction started by <code>ext_storage_start_transaction</code>
(<a href="#sect-ext-storage-start-transaction">Section 15.1.11</a>). Any changes made during that
transaction are committed to the main state.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Panics if <code>ext_storage_start_transaction</code>
(<a href="#sect-ext-storage-start-transaction">Section 15.1.11</a>) was not called.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_12"><a class="link" href="#_version_1_prototype_12">15.1.13.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_storage_commit_transaction_version_1)</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sect-child-storage-api"><a class="link" href="#sect-child-storage-api">16. Child Storage</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Interface for accessing the child storage from within the runtime.</p>
</div>
<div id="defn-child-storage-type" class="exampleblock">
<div class="title">Definition 167. <a href="#defn-child-storage-type">Child Storage</a></div>
<div class="content">
<div class="paragraph">
<p><strong>Child storage</strong> key is a unprefixed location of the child trie in the main trie.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_functions_2"><a class="link" href="#_functions_2">16.1. Functions</a></h3>
<div class="sect3">
<h4 id="_ext_default_child_storage_set"><a class="link" href="#_ext_default_child_storage_set">16.1.1. <code>ext_default_child_storage_set</code></a></h4>
<div class="paragraph">
<p>Sets the value under a given key into the child storage.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_13"><a class="link" href="#_version_1_prototype_13">16.1.1.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_default_child_storage_set_version_1
	(param $child_storage_key i64) (param $key i64) (param $value i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>child_storage_key</code> : a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
child storage key (<a href="#defn-child-storage-type">Definition 167</a>).</p>
</li>
<li>
<p><code>key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the key.</p>
</li>
<li>
<p><code>value</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the value.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_default_child_storage_get"><a class="link" href="#_ext_default_child_storage_get">16.1.2. <code>ext_default_child_storage_get</code></a></h4>
<div class="paragraph">
<p>Retrieves the value associated with the given key from the child storage.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_14"><a class="link" href="#_version_1_prototype_14">16.1.2.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_default_child_storage_get_version_1
	(param $child_storage_key i64) (param $key i64) (result i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>child_storage_key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
child storage key (<a href="#defn-child-storage-type">Definition 167</a>).</p>
</li>
<li>
<p><code>key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the key.</p>
</li>
<li>
<p><code>result</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) containing the value.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_default_child_storage_read"><a class="link" href="#_ext_default_child_storage_read">16.1.3. <code>ext_default_child_storage_read</code></a></h4>
<div class="paragraph">
<p>Gets the given key from storage, placing the value into a buffer and returning
the number of bytes that the entry in storage has beyond the offset.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_15"><a class="link" href="#_version_1_prototype_15">16.1.3.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_default_child_storage_read_version_1
	(param $child_storage_key i64) (param $key i64) (param $value_out i64)
	(param $offset u32) (result i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>child_storage_key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
child storage key (<a href="#defn-child-storage-type">Definition 167</a>).</p>
</li>
<li>
<p><code>key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the key.</p>
</li>
<li>
<p><code>value_out</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the buffer
to which the value will be written to. This function will never write more then
the length of the buffer, even if the value’s length is bigger.</p>
</li>
<li>
<p><code>offset</code>: an u32 integer containing the offset beyond the value should be read
from.</p>
</li>
<li>
<p><code>result</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) containing the number of bytes
written into the <strong>value_out</strong> buffer. Returns if the entry does not exists.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_default_child_storage_clear"><a class="link" href="#_ext_default_child_storage_clear">16.1.4. <code>ext_default_child_storage_clear</code></a></h4>
<div class="paragraph">
<p>Clears the storage of the given key and its value from the child storage.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_16"><a class="link" href="#_version_1_prototype_16">16.1.4.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_default_child_storage_clear_version_1
	(param $child_storage_key i64) (param $key i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>child_storage_key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
child storage key (<a href="#defn-child-storage-type">Definition 167</a>).</p>
</li>
<li>
<p><code>key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the key.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_default_child_storage_storage_kill"><a class="link" href="#_ext_default_child_storage_storage_kill">16.1.5. <code>ext_default_child_storage_storage_kill</code></a></h4>
<div class="paragraph">
<p>Clears an entire child storage.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_17"><a class="link" href="#_version_1_prototype_17">16.1.5.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_default_child_storage_storage_kill_version_1
	(param $child_storage_key i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>child_storage_key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
child storage key (<a href="#defn-child-storage-type">Definition 167</a>).</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_version_2_prototype_2"><a class="link" href="#_version_2_prototype_2">16.1.5.2. Version 2 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_default_child_storage_storage_kill_version_2
	(param $child_storage_key i64) (param $limit i64)
	(return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>child_storage_key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
child storage key (<a href="#defn-child-storage-type">Definition 167</a>).</p>
</li>
<li>
<p><code>limit</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to an <em>Option</em> type
(<a href="#defn-option-type">Definition 152</a>) containing an unsigned 32-bit integer indicating the
limit on how many keys should be deleted. No limit is applied if this is <em>None</em>.
Any keys created during the current block execution do not count towards the
limit.</p>
</li>
<li>
<p><code>return</code>: a value equal to <em>1</em> if all the keys of the child storage have been
deleted or a value equal to <em>0</em> if there are remaining keys.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_version_3_prototype"><a class="link" href="#_version_3_prototype">16.1.5.3. Version 3 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_default_child_storage_storage_kill_version_3
	(param $child_storage_key i64) (param $limit i64)
	(return i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>child_storage_key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
child storage key (<a href="#defn-child-storage-type">Definition 167</a>).</p>
</li>
<li>
<p><code>limit</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to an <em>Option</em> type
(<a href="#defn-option-type">Definition 152</a>) containing an unsigned 32-bit integer indicating the
limit on how many keys should be deleted. No limit is applied if this is <em>None</em>.
Any keys created during the current block execution do not count towards the
limit.</p>
</li>
<li>
<p><code>return</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the following variant, \$k\$:</p>
<div class="stemblock">
<div class="content">
\$k = {(0,-&gt; c),(1,-&gt; c):}\$
</div>
</div>
<div class="paragraph">
<p>where <em>0</em> indicates that all keys of the child storage have been removed,
followed by the number of removed keys, \$c\$. The variant <em>1</em> indicates that
there are remaining keys, followed by the number of removed keys.</p>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_default_child_storage_exists"><a class="link" href="#_ext_default_child_storage_exists">16.1.6. <code>ext_default_child_storage_exists</code></a></h4>
<div class="paragraph">
<p>Checks whether the given key exists in the child storage.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_18"><a class="link" href="#_version_1_prototype_18">16.1.6.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_default_child_storage_exists_version_1
	(param $child_storage_key i64) (param $key i64) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>child_storage_key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
child storage key (<a href="#defn-child-storage-type">Definition 167</a>).</p>
</li>
<li>
<p><code>key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the key.</p>
</li>
<li>
<p><code>return</code>: an i32 integer value equal to <em>1</em> if the key exists or a value equal
to <em>0</em> if otherwise.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_default_child_storage_clear_prefix"><a class="link" href="#_ext_default_child_storage_clear_prefix">16.1.7. <code>ext_default_child_storage_clear_prefix</code></a></h4>
<div class="paragraph">
<p>Clears the child storage of each key/value pair where the key starts with the
given prefix.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_19"><a class="link" href="#_version_1_prototype_19">16.1.7.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_default_child_storage_clear_prefix_version_1
	(param $child_storage_key i64) (param $prefix i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>child_storage_key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
child storage key (<a href="#defn-child-storage-type">Definition 167</a>).</p>
</li>
<li>
<p><code>prefix</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
prefix.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_version_2_prototype_3"><a class="link" href="#_version_2_prototype_3">16.1.7.2. Version 2 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_default_child_storage_clear_prefix_version_2
	(param $child_storage_key i64) (param $prefix i64)
	(param $limit i64) (return i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>child_storage_key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
child storage key (<a href="#defn-child-storage-type">Definition 167</a>).</p>
</li>
<li>
<p><code>prefix</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
prefix.</p>
</li>
<li>
<p><code>limit</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to an <em>Option</em> type
(<a href="#defn-option-type">Definition 152</a>) containing an unsigned 32-bit integer indicating the
limit on how many keys should be deleted. No limit is applied if this is <em>None</em>.
Any keys created during the current block execution do not count towards the
limit.</p>
</li>
<li>
<p><code>return</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the following variant, \$k\$:</p>
<div class="stemblock">
<div class="content">
\$k = {(0,-&gt; c),(1,-&gt; c):}\$
</div>
</div>
<div class="paragraph">
<p>where <em>0</em> indicates that all keys of the child storage have been removed,
followed by the number of removed keys, \$c\$. The variant <em>1</em> indicates that
there are remaining keys, followed by the number of removed keys.</p>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_default_child_storage_root"><a class="link" href="#_ext_default_child_storage_root">16.1.8. <code>ext_default_child_storage_root</code></a></h4>
<div class="paragraph">
<p>Commits all existing operations and computes the resulting child storage
root.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_20"><a class="link" href="#_version_1_prototype_20">16.1.8.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_default_child_storage_root_version_1
	(param $child_storage_key i64) (return i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>child_storage_key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
child storage key (<a href="#defn-child-storage-type">Definition 167</a>).</p>
</li>
<li>
<p><code>return</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
SCALE encoded storage root.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_version_2_prototype_4"><a class="link" href="#_version_2_prototype_4">16.1.8.2. Version 2 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_default_child_storage_root_version_2
	(param $child_storage_key i64) (param $version i32)
	(return i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>child_storage_key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
child storage key (<a href="#defn-child-storage-type">Definition 167</a>).</p>
</li>
<li>
<p><code>version</code>: a pointer-size (<a href="#defn-runtime-pointer">Definition 164</a>) to the state version (<a href="#defn-state-version">Definition 162</a>).</p>
</li>
<li>
<p><code>return</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 256-bit Blake2 storage
root.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_default_child_storage_next_key"><a class="link" href="#_ext_default_child_storage_next_key">16.1.9. <code>ext_default_child_storage_next_key</code></a></h4>
<div class="paragraph">
<p>Gets the next key in storage after the given one in lexicographic order
(<a href="#defn-lexicographic-ordering">Definition 166</a>).
The key provided to this function may or may not exist in storage.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_21"><a class="link" href="#_version_1_prototype_21">16.1.9.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_default_child_storage_next_key_version_1
	(param $child_storage_key i64) (param $key i64) (return i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>child_storage_key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
child storage key (<a href="#defn-child-storage-type">Definition 167</a>).</p>
</li>
<li>
<p><code>key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the key.</p>
</li>
<li>
<p><code>return</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded as defined in <a href="#defn-option-type">Definition 152</a>
containing the next key in lexicographic order. Returns if the entry cannot be
found.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sect-crypto-api"><a class="link" href="#sect-crypto-api">17. Crypto</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Interfaces for working with crypto related types from within the runtime.</p>
</div>
<div id="defn-key-type-id" class="exampleblock">
<div class="title">Definition 168. <a href="#defn-key-type-id">Key Type Identifier</a></div>
<div class="content">
<div class="paragraph">
<p>Cryptographic keys are stored in separate key stores based on their intended use
case. The separate key stores are identified by a 4-byte ASCII <strong>key type
identifier</strong>. The following known types are available:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Table of known key type identifiers</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Id</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">acco</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key type for the controlling accounts</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">babe</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key type for the Babe module</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">gran</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key type for the Grandpa module</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">imon</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key type for the ImOnline module</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">audi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key type for the AuthorityDiscovery module</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">para</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key type for the Parachain Validator Key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">asgn</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key type for the Parachain Assignment Key</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="defn-ecdsa-verify-error" class="exampleblock">
<div class="title">Definition 169. <a href="#defn-ecdsa-verify-error">ECDSA Verify Error</a></div>
<div class="content">
<div class="paragraph">
<p><strong>EcdsaVerifyError</strong> is a varying data type (<a href="#defn-varrying-data-type">Definition 151</a>) that
specifies the error type when using ECDSA recovery functionality. Following
values are possible:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Table of error types in ECDSA recovery</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Id</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incorrect value of R or S</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Incorrect value of V</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Invalid signature</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_functions_3"><a class="link" href="#_functions_3">17.1. Functions</a></h3>
<div class="sect3">
<h4 id="_ext_crypto_ed25519_public_keys"><a class="link" href="#_ext_crypto_ed25519_public_keys">17.1.1. <code>ext_crypto_ed25519_public_keys</code></a></h4>
<div class="paragraph">
<p>Returns all <em>ed25519</em> public keys for the given key identifier from the keystore.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_22"><a class="link" href="#_version_1_prototype_22">17.1.1.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_ed25519_public_keys_version_1
	(param $key_type_id i32) (return i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>key_type_id</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the key type identifier
(<a href="#defn-key-type-id">Definition 168</a>).</p>
</li>
<li>
<p><code>return</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to an SCALE encoded
256-bit public keys.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_crypto_ed25519_generate"><a class="link" href="#_ext_crypto_ed25519_generate">17.1.2. <code>ext_crypto_ed25519_generate</code></a></h4>
<div class="paragraph">
<p>Generates an <em>ed25519</em> key for the given key type using an optional BIP-39 seed and stores
it in the keystore.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Panics if the key cannot be generated, such as when an invalid key type
or invalid seed was provided.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_23"><a class="link" href="#_version_1_prototype_23">17.1.2.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_ed25519_generate_version_1
	(param $key_type_id i32) (param $seed i64) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>key_type_id</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the key type identifier
(<a href="#defn-key-type-id">Definition 168</a>).</p>
</li>
<li>
<p><code>seed</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE encoded
<em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) containing the BIP-39 seed which must be
valid UTF8.</p>
</li>
<li>
<p><code>return</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 256-bit public key.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_crypto_ed25519_sign"><a class="link" href="#_ext_crypto_ed25519_sign">17.1.3. <code>ext_crypto_ed25519_sign</code></a></h4>
<div class="paragraph">
<p>Signs the given message with the <code>ed25519</code> key that corresponds to the given public key
and key type in the keystore.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_24"><a class="link" href="#_version_1_prototype_24">17.1.3.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_ed25519_sign_version_1
	(param $key_type_id i32) (param $key i32) (param $msg i64) (return i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>key_type_id</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the key type identifier
(<a href="#defn-key-type-id">Definition 168</a>).</p>
</li>
<li>
<p><code>key</code>: a pointer to the buffer containing the 256-bit public key.</p>
</li>
<li>
<p><code>msg</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
message that is to be signed.</p>
</li>
<li>
<p><code>return</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) containing the 64-byte signature.
This function returns if the public key cannot be found in the key store.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-ext-crypto-ed25519-verify"><a class="link" href="#sect-ext-crypto-ed25519-verify">17.1.4. <code>ext_crypto_ed25519_verify</code></a></h4>
<div class="paragraph">
<p>Verifies an <em>ed25519</em> signature.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_25"><a class="link" href="#_version_1_prototype_25">17.1.4.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_ed25519_verify_version_1
	(param $sig i32) (param $msg i64) (param $key i32) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>sig</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 64-byte signature.</p>
</li>
<li>
<p><code>msg</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
message that is to be verified.</p>
</li>
<li>
<p><code>key</code>: a pointer to the buffer containing the 256-bit public key.</p>
</li>
<li>
<p><code>return</code>: a i32 integer value equal to <em>1</em> if the signature is valid or a
value equal to <em>0</em> if otherwise.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-ext-crypto-ed25519-batch-verify"><a class="link" href="#sect-ext-crypto-ed25519-batch-verify">17.1.5. <code>ext_crypto_ed25519_batch_verify</code></a></h4>
<div class="paragraph">
<p>Registers a ed25519 signature for batch verification. Batch verification is
enabled by calling <code>ext_crypto_start_batch_verify</code>
(<a href="#sect-ext-crypto-start-batch-verify">Section 17.1.20</a>). The result of the verification is
returned by <code>ext_crypto_finish_batch_verify</code>
(<a href="#sect-ext-crypto-finish-batch-verify">Section 17.1.21</a>). If batch verification is not enabled,
the signature is verified immediately.</p>
</div>
<div class="sect4">
<h5 id="_version_1"><a class="link" href="#_version_1">17.1.5.1. Version 1</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_ed25519_batch_verify_version_1
	(param $sig i32) (param $msg i64) (param $key i32) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>sig</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 64-byte signature.</p>
</li>
<li>
<p><code>msg</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
message that is to be verified.</p>
</li>
<li>
<p><code>key</code>: a pointer to the buffer containing the 256-bit public key.</p>
</li>
<li>
<p><code>return</code>: a i32 integer value equal to <em>1</em> if the signature is valid or
batched or a value equal <em>0</em> to if otherwise.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_crypto_sr25519_public_keys"><a class="link" href="#_ext_crypto_sr25519_public_keys">17.1.6. <code>ext_crypto_sr25519_public_keys</code></a></h4>
<div class="paragraph">
<p>Returns all <em>sr25519</em> public keys for the given key id from the keystore.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_26"><a class="link" href="#_version_1_prototype_26">17.1.6.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_sr25519_public_keys_version_1
	(param $key_type_id i32) (return i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>key_type_id</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the key type identifier
(<a href="#defn-key-type-id">Definition 168</a>).</p>
</li>
<li>
<p><code>return</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
SCALE encoded 256-bit public keys.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_crypto_sr25519_generate"><a class="link" href="#_ext_crypto_sr25519_generate">17.1.7. <code>ext_crypto_sr25519_generate</code></a></h4>
<div class="paragraph">
<p>Generates an <em>sr25519</em> key for the given key type using an optional BIP-39 seed
and stores it in the keystore.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Panics if the key cannot be generated, such as when an invalid key type
or invalid seed was provided.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_27"><a class="link" href="#_version_1_prototype_27">17.1.7.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_sr25519_generate_version_1
	(param $key_type_id i32) (param $seed i64) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>key_type_id</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the key identifier (<a href="#defn-key-type-id">Definition 168</a>).</p>
</li>
<li>
<p><code>seed</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE encoded
<em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) containing the BIP-39 seed which must be
valid UTF8.</p>
</li>
<li>
<p><code>return</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 256-bit public key.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_crypto_sr25519_sign"><a class="link" href="#_ext_crypto_sr25519_sign">17.1.8. <code>ext_crypto_sr25519_sign</code></a></h4>
<div class="paragraph">
<p>Signs the given message with the <em>sr25519</em> key that corresponds to the given
public key and key type in the keystore.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_28"><a class="link" href="#_version_1_prototype_28">17.1.8.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_sr25519_sign_version_1
	(param $key_type_id i32) (param $key i32) (param $msg i64) (return i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>key_type_id</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the key identifier (<a href="#defn-key-type-id">Definition 168</a>).</p>
</li>
<li>
<p><code>key</code>: a pointer to the buffer containing the 256-bit public key.</p>
</li>
<li>
<p><code>msg</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
message that is to be signed.</p>
</li>
<li>
<p><code>return</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) containing the 64-byte signature.
This function returns <em>None</em> if the public key cannot be found in the key store.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-ext-crypto-sr25519-verify"><a class="link" href="#sect-ext-crypto-sr25519-verify">17.1.9. <code>ext_crypto_sr25519_verify</code></a></h4>
<div class="paragraph">
<p>Verifies an sr25519 signature.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_29"><a class="link" href="#_version_1_prototype_29">17.1.9.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_sr25519_verify_version_1
	(param $sig i32) (param $msg i64) (param $key i32) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>sig</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 64-byte signature.</p>
</li>
<li>
<p><code>msg</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
message that is to be verified.</p>
</li>
<li>
<p><code>key</code>: a pointer to the buffer containing the 256-bit public key.</p>
</li>
<li>
<p><code>return</code>: a i32 integer value equal to <em>1</em> if the signature is valid or a
value equal to <em>0</em> if otherwise.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_version_2_prototype_5"><a class="link" href="#_version_2_prototype_5">17.1.9.2. Version 2 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_sr25519_verify_version_2
	(param $sig i32) (param $msg i64) (param $key i32) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>sig</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 64-byte signature.</p>
</li>
<li>
<p><code>msg</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
message that is to be verified.</p>
</li>
<li>
<p><code>key</code>: a pointer to the buffer containing the 256-bit public key.</p>
</li>
<li>
<p><code>return</code>: a i32 integer value equal to <em>1</em> if the signature is valid or a
value equal to <em>0</em> if otherwise.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-ext-crypto-sr25519-batch-verify"><a class="link" href="#sect-ext-crypto-sr25519-batch-verify">17.1.10. <code>ext_crypto_sr25519_batch_verify</code></a></h4>
<div class="paragraph">
<p>Registers a sr25519 signature for batch verification. Batch verification is
enabled by calling <code>ext_crypto_start_batch_verify</code>
(<a href="#sect-ext-crypto-start-batch-verify">Section 17.1.20</a>). The result of the verification is
returned by <code>ext_crypto_finish_batch_verify</code>
(<a href="#sect-ext-crypto-finish-batch-verify">Section 17.1.21</a>). If batch verification is not enabled,
the signature is verified immediately.</p>
</div>
<div class="sect4">
<h5 id="_version_1_2"><a class="link" href="#_version_1_2">17.1.10.1. Version 1</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_sr25519_batch_verify_version_1
	(param $sig i32) (param $msg i64) (param $key i32) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>sig</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 64-byte signature.</p>
</li>
<li>
<p><code>msg</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
message that is to be verified.</p>
</li>
<li>
<p><code>key</code>: a pointer to the buffer containing the 256-bit public key.</p>
</li>
<li>
<p><code>return</code>: a i32 integer value equal to <em>1</em> if the signature is valid or
batched or a value equal <em>0</em> to if otherwise.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_crypto_ecdsa_public_keys"><a class="link" href="#_ext_crypto_ecdsa_public_keys">17.1.11. <code>ext_crypto_ecdsa_public_keys</code></a></h4>
<div class="paragraph">
<p>Returns all <em>ecdsa</em> public keys for the given key id from the keystore.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_30"><a class="link" href="#_version_1_prototype_30">17.1.11.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_ecdsa_public_key_version_1
	(param $key_type_id i64) (return i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>key_type_id</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the key type identifier (<a href="#defn-key-type-id">Definition 168</a>).</p>
</li>
<li>
<p><code>return</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
SCALE encoded 33-byte compressed public keys.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_crypto_ecdsa_generate"><a class="link" href="#_ext_crypto_ecdsa_generate">17.1.12. <code>ext_crypto_ecdsa_generate</code></a></h4>
<div class="paragraph">
<p>Generates an <em>ecdsa</em> key for the given key type using an optional BIP-39 seed
and stores it in the keystore.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Panics if the key cannot be generated, such as when an invalid key type
or invalid seed was provided.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_31"><a class="link" href="#_version_1_prototype_31">17.1.12.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_ecdsa_generate_version_1
	(param $key_type_id i32) (param $seed i64) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>key_type_id</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the key identifier (<a href="#defn-key-type-id">Definition 168</a>).</p>
</li>
<li>
<p><code>seed</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE encoded
<em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) containing the BIP-39 seed which must be
valid UTF8.</p>
</li>
<li>
<p><code>return</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 33-byte compressed
public key.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_crypto_ecdsa_sign"><a class="link" href="#_ext_crypto_ecdsa_sign">17.1.13. <code>ext_crypto_ecdsa_sign</code></a></h4>
<div class="paragraph">
<p>Signs the hash of the given message with the <em>ecdsa</em> key that corresponds to the
given public key and key type in the keystore.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_32"><a class="link" href="#_version_1_prototype_32">17.1.13.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_ecdsa_sign_version_1
	(param $key_type_id i32) (param $key i32) (param $msg i64) (return i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>key_type_id</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the key identifier (<a href="#defn-key-type-id">Definition 168</a>).</p>
</li>
<li>
<p><code>key</code>: a pointer to the buffer containing the 33-byte compressed public
key.</p>
</li>
<li>
<p><code>msg</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
message that is to be signed.</p>
</li>
<li>
<p><code>return</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) containing the signature. The
signature is 65-bytes in size, where the first 512-bits represent the signature
and the other 8 bits represent the recovery ID. This function returns if the
public key cannot be found in the key store.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_crypto_ecdsa_sign_prehashed"><a class="link" href="#_ext_crypto_ecdsa_sign_prehashed">17.1.14. <code>ext_crypto_ecdsa_sign_prehashed</code></a></h4>
<div class="paragraph">
<p>Signs the prehashed message with the <em>ecdsa</em> key that corresponds to the given
public key and key type in the keystore.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_33"><a class="link" href="#_version_1_prototype_33">17.1.14.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_ecdsa_sign_prehashed_version_1
	(param $key_type_id i32) (param $key i32) (param $msg i64) (return i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>key_type_id</code>: a pointer-size (<a href="#defn-runtime-pointer">Definition 164</a>) to the key identifier
(<a href="#defn-key-type-id">Definition 168</a>).</p>
</li>
<li>
<p><code>key</code>: a pointer to the buffer containing the 33-byte compressed public key.</p>
</li>
<li>
<p><code>msg</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
message that is to be signed.</p>
</li>
<li>
<p><code>return</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) containing the signature. The
signature is 65-bytes in size, where the first 512-bits represent the signature
and the other 8 bits represent the recovery ID. This function returns if the
public key cannot be found in the key store.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-ext-crypto-ecdsa-verify"><a class="link" href="#sect-ext-crypto-ecdsa-verify">17.1.15. <code>ext_crypto_ecdsa_verify</code></a></h4>
<div class="paragraph">
<p>Verifies the hash of the given message against a ECDSA signature.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_34"><a class="link" href="#_version_1_prototype_34">17.1.15.1. Version 1 - Prototype</a></h5>
<div class="paragraph">
<p>This function allows the verification of non-standard, overflowing ECDSA signatures, an
implemenation specific mechanism of the Rust
<a href="https://github.com/paritytech/libsecp256k1"><code>libsecp256k1</code> library</a>, specifically
the
<a href="https://docs.rs/libsecp256k1/0.7.0/libsecp256k1/struct.Signature.html#method.parse_overflowing"><code>parse_overflowing</code></a>
function.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_ecdsa_verify_version_1
	(param $sig i32) (param $msg i64) (param $key i32) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>sig</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 65-byte signature. The
signature is 65-bytes in size, where the first 512-bits represent the signature
and the other 8 bits represent the recovery ID.</p>
</li>
<li>
<p><code>msg</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
message that is to be verified.</p>
</li>
<li>
<p><code>key</code>: a pointer to the buffer containing the 33-byte compressed public
key.</p>
</li>
<li>
<p><code>return</code>: a i32 integer value equal <em>1</em> to if the signature is valid or a
value equal to <em>0</em> if otherwise.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_version_2_prototype_6"><a class="link" href="#_version_2_prototype_6">17.1.15.2. Version 2 - Prototype</a></h5>
<div class="paragraph">
<p>Does not allow the verification of non-standard, overflowing ECDSA signatures.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_ecdsa_verify_version_2
	(param $sig i32) (param $msg i64) (param $key i32) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>sig</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 65-byte signature. The
signature is 65-bytes in size, where the first 512-bits represent the signature
and the other 8 bits represent the recovery ID.</p>
</li>
<li>
<p><code>msg</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
message that is to be verified.</p>
</li>
<li>
<p><code>key</code>: a pointer to the buffer containing the 33-byte compressed public
key.</p>
</li>
<li>
<p><code>return</code>: a i32 integer value equal <em>1</em> to if the signature is valid or a
value equal to <em>0</em> if otherwise.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_crypto_ecdsa_verify_prehashed"><a class="link" href="#_ext_crypto_ecdsa_verify_prehashed">17.1.16. <code>ext_crypto_ecdsa_verify_prehashed</code></a></h4>
<div class="paragraph">
<p>Verifies the prehashed message against a ECDSA signature.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_35"><a class="link" href="#_version_1_prototype_35">17.1.16.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_ecdsa_verify_prehashed_version_1
	(param $sig i32) (param $msg i32) (param $key i32) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>sig</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 65-byte signature. The
signature is 65-bytes in size, where the first 512-bits represent the signature
and the other 8 bits represent the recovery ID.</p>
</li>
<li>
<p><code>msg</code>: a pointer to the 32-bit prehashed message to be verified.</p>
</li>
<li>
<p><code>key</code>: a pointer to the 33-byte compressed public key.</p>
</li>
<li>
<p><code>return</code>: a i32 integer value equal <em>1</em> to if the signature is valid or a
value equal to <em>0</em> if otherwise.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-ext-crypto-ecdsa-batch-verify"><a class="link" href="#sect-ext-crypto-ecdsa-batch-verify">17.1.17. <code>ext_crypto_ecdsa_batch_verify</code></a></h4>
<div class="paragraph">
<p>Registers a ECDSA signature for batch verification. Batch verification is
enabled by calling <code>ext_crypto_start_batch_verify</code>
(<a href="#sect-ext-crypto-start-batch-verify">Section 17.1.20</a>). The result of the verification is
returned by <code>ext_crypto_finish_batch_verify</code>
(<a href="#sect-ext-crypto-finish-batch-verify">Section 17.1.21</a>). If batch verification is not enabled,
the signature is verified immediately.</p>
</div>
<div class="sect4">
<h5 id="_version_1_3"><a class="link" href="#_version_1_3">17.1.17.1. Version 1</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_ecdsa_batch_verify_version_1
	(param $sig i32) (param $msg i64) (param $key i32) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>sig</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 64-byte signature.</p>
</li>
<li>
<p><code>msg</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
message that is to be verified.</p>
</li>
<li>
<p><code>key</code>: a pointer to the buffer containing the 256-bit public key.</p>
</li>
<li>
<p><code>return</code>: a i32 integer value equal to <em>1</em> if the signature is valid or
batched or a value equal <em>0</em> to if otherwise.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_crypto_secp256k1_ecdsa_recover"><a class="link" href="#_ext_crypto_secp256k1_ecdsa_recover">17.1.18. <code>ext_crypto_secp256k1_ecdsa_recover</code></a></h4>
<div class="paragraph">
<p>Verify and recover a <em>secp256k1</em> ECDSA signature.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_36"><a class="link" href="#_version_1_prototype_36">17.1.18.1. Version 1 - Prototype</a></h5>
<div class="paragraph">
<p>This function can handle non-standard, overflowing ECDSA signatures, an
implemenation specific mechanism of the Rust
<a href="https://github.com/paritytech/libsecp256k1"><code>libsecp256k1</code> library</a>, specifically
the
<a href="https://docs.rs/libsecp256k1/0.7.0/libsecp256k1/struct.Signature.html#method.parse_overflowing"><code>parse_overflowing</code></a>
function.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_secp256k1_ecdsa_recover_version_1
	(param $sig i32) (param $msg i32) (return i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>sig</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 65-byte signature in RSV
format. V should be either or .</p>
</li>
<li>
<p><code>msg</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 256-bit Blake2 hash of
the message.</p>
</li>
<li>
<p><code>return</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <em>Result</em> (<a href="#defn-result-type">Definition 153</a>). On success it contains the 64-byte
recovered public key or an error type (<a href="#defn-ecdsa-verify-error">Definition 169</a>) on failure.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_version_2_prototype_7"><a class="link" href="#_version_2_prototype_7">17.1.18.2. Version 2 - Prototype</a></h5>
<div class="paragraph">
<p>Does not handle non-standard, overflowing ECDSA signatures.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_secp256k1_ecdsa_recover_version_2
	(param $sig i32) (param $msg i32) (return i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>sig</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 65-byte signature in RSV
format. V should be either or .</p>
</li>
<li>
<p><code>msg</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 256-bit Blake2 hash of
the message.</p>
</li>
<li>
<p><code>return</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <em>Result</em> (<a href="#defn-result-type">Definition 153</a>). On success it contains the 64-byte
recovered public key or an error type (<a href="#defn-ecdsa-verify-error">Definition 169</a>) on failure.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_crypto_secp256k1_ecdsa_recover_compressed"><a class="link" href="#_ext_crypto_secp256k1_ecdsa_recover_compressed">17.1.19. <code>ext_crypto_secp256k1_ecdsa_recover_compressed</code></a></h4>
<div class="paragraph">
<p>Verify and recover a <em>secp256k1</em> ECDSA signature.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_37"><a class="link" href="#_version_1_prototype_37">17.1.19.1. Version 1 - Prototype</a></h5>
<div class="paragraph">
<p>This function can handle non-standard, overflowing ECDSA signatures, an
implemenation specific mechanism of the Rust
<a href="https://github.com/paritytech/libsecp256k1"><code>libsecp256k1</code> library</a>, specifically
the
<a href="https://docs.rs/libsecp256k1/0.7.0/libsecp256k1/struct.Signature.html#method.parse_overflowing"><code>parse_overflowing</code></a>
function.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_secp256k1_ecdsa_recover_compressed_version_1
	(param $sig i32) (param $msg i32) (return i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>sig</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 65-byte signature in RSV
format. V should be either <code>0/1</code> or <code>27/28</code>.</p>
</li>
<li>
<p><code>msg</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 256-bit Blake2 hash of
the message.</p>
</li>
<li>
<p><code>return</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <code>Result</code> value (<a href="#defn-result-type">Definition 153</a>). On success it contains the
33-byte recovered public key in compressed form on success or an error type
(<a href="#defn-ecdsa-verify-error">Definition 169</a>) on failure.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_version_2_prototype_8"><a class="link" href="#_version_2_prototype_8">17.1.19.2. Version 2 - Prototype</a></h5>
<div class="paragraph">
<p>Does not handle non-standard, overflowing ECDSA signatures.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_secp256k1_ecdsa_recover_compressed_version_2
	(param $sig i32) (param $msg i32) (return i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>sig</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 65-byte signature in RSV
format. V should be either <code>0/1</code> or <code>27/28</code>.</p>
</li>
<li>
<p><code>msg</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 256-bit Blake2 hash of
the message.</p>
</li>
<li>
<p><code>return</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <code>Result</code> value (<a href="#defn-result-type">Definition 153</a>). On success it contains the
33-byte recovered public key in compressed form on success or an error type
(<a href="#defn-ecdsa-verify-error">Definition 169</a>) on failure.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-ext-crypto-start-batch-verify"><a class="link" href="#sect-ext-crypto-start-batch-verify">17.1.20. <code>ext_crypto_start_batch_verify</code></a></h4>
<div class="paragraph">
<p>Starts the verification extension. The extension is a separate background
process and is used to parallel-verify signatures which are pushed to the batch
with
<code>ext_crypto_ed25519_batch_verify</code>(<a href="#sect-ext-crypto-ed25519-batch-verify">Section 17.1.5</a>),
<code>ext_crypto_sr25519_batch_verify</code> (<a href="#sect-ext-crypto-sr25519-batch-verify">Section 17.1.10</a>) or
<code>ext_crypto_ecdsa_batch_verify</code> (<a href="#sect-ext-crypto-ecdsa-batch-verify">Section 17.1.17</a>).
Verification will start immediately and the Runtime can retrieve the result when
calling <code>ext_crypto_finish_batch_verify</code>
(<a href="#sect-ext-crypto-finish-batch-verify">Section 17.1.21</a>).</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_38"><a class="link" href="#_version_1_prototype_38">17.1.20.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_start_batch_verify_version_1)</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-ext-crypto-finish-batch-verify"><a class="link" href="#sect-ext-crypto-finish-batch-verify">17.1.21. <code>ext_crypto_finish_batch_verify</code></a></h4>
<div class="paragraph">
<p>Finish verifying the batch of signatures since the last call to this function.
Blocks until all the signatures are verified.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Panics if <code>ext_crypto_start_batch_verify</code>
(<a href="#sect-ext-crypto-start-batch-verify">Section 17.1.20</a>) was not called.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_39"><a class="link" href="#_version_1_prototype_39">17.1.21.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_crypto_finish_batch_verify_version_1
	(return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>return</code>: an i32 integer value equal to <em>1</em> if all the signatures are valid or
a value equal to <em>0</em> if one or more of the signatures are invalid.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sect-hashing-api"><a class="link" href="#sect-hashing-api">18. Hashing</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Interface that provides functions for hashing with different algorithms.</p>
</div>
<div class="sect2">
<h3 id="_functions_4"><a class="link" href="#_functions_4">18.1. Functions</a></h3>
<div class="sect3">
<h4 id="_ext_hashing_keccak_256"><a class="link" href="#_ext_hashing_keccak_256">18.1.1. <code>ext_hashing_keccak_256</code></a></h4>
<div class="paragraph">
<p>Conducts a 256-bit Keccak hash.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_40"><a class="link" href="#_version_1_prototype_40">18.1.1.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_hashing_keccak_256_version_1
	(param $data i64) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the data
to be hashed.</p>
</li>
<li>
<p><code>return</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 256-bit hash result.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_hashing_keccak_512"><a class="link" href="#_ext_hashing_keccak_512">18.1.2. <code>ext_hashing_keccak_512</code></a></h4>
<div class="paragraph">
<p>Conducts a 512-bit Keccak hash.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_41"><a class="link" href="#_version_1_prototype_41">18.1.2.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_hashing_keccak_512_version_1
	(param $data i64) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the data
to be hashed.</p>
</li>
<li>
<p><code>return</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 512-bit hash result.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_hashing_sha2_256"><a class="link" href="#_ext_hashing_sha2_256">18.1.3. <code>ext_hashing_sha2_256</code></a></h4>
<div class="paragraph">
<p>Conducts a 256-bit Sha2 hash.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_42"><a class="link" href="#_version_1_prototype_42">18.1.3.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_hashing_sha2_256_version_1
	(param $data i64) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the data
to be hashed.</p>
</li>
<li>
<p><code>return</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 256-bit hash result.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_hashing_blake2_128"><a class="link" href="#_ext_hashing_blake2_128">18.1.4. <code>ext_hashing_blake2_128</code></a></h4>
<div class="paragraph">
<p>Conducts a 128-bit Blake2 hash.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_43"><a class="link" href="#_version_1_prototype_43">18.1.4.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_hashing_blake2_128_version_1
	(param $data i64) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the data
to be hashed.</p>
</li>
<li>
<p><code>return</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 128-bit hash result.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_hashing_blake2_256"><a class="link" href="#_ext_hashing_blake2_256">18.1.5. <code>ext_hashing_blake2_256</code></a></h4>
<div class="paragraph">
<p>Conducts a 256-bit Blake2 hash.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_44"><a class="link" href="#_version_1_prototype_44">18.1.5.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_hashing_blake2_256_version_1
	(param $data i64) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the data
to be hashed.</p>
</li>
<li>
<p><code>return</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 256-bit hash result.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_hashing_twox_64"><a class="link" href="#_ext_hashing_twox_64">18.1.6. <code>ext_hashing_twox_64</code></a></h4>
<div class="paragraph">
<p>Conducts a 64-bit xxHash hash.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_45"><a class="link" href="#_version_1_prototype_45">18.1.6.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_hashing_twox_64_version_1
	(param $data i64) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the data
to be hashed.</p>
</li>
<li>
<p><code>return</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 64-bit hash result.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_hashing_twox_128"><a class="link" href="#_ext_hashing_twox_128">18.1.7. <code>ext_hashing_twox_128</code></a></h4>
<div class="paragraph">
<p>Conducts a 128-bit xxHash hash.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_46"><a class="link" href="#_version_1_prototype_46">18.1.7.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_hashing_twox_128
	(param $data i64) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the data
to be hashed.</p>
</li>
<li>
<p><code>return</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 128-bit hash result.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_hashing_twox_256"><a class="link" href="#_ext_hashing_twox_256">18.1.8. <code>ext_hashing_twox_256</code></a></h4>
<div class="paragraph">
<p>Conducts a 256-bit xxHash hash.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_47"><a class="link" href="#_version_1_prototype_47">18.1.8.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_hashing_twox_256
	(param $data i64) (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the data
to be hashed.</p>
</li>
<li>
<p><code>return</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 256-bit hash result.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sect-offchain-api"><a class="link" href="#sect-offchain-api">19. Offchain</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Offchain Workers allow the execution of long-running and possibly
non-deterministic tasks (e.g. web requests, encryption/decryption and signing of
data, random number generation, CPU-intensive computations,
enumeration/aggregation of on-chain data, etc.) which could otherwise require
longer than the block execution time. Offchain Workers have their own execution
environment. This separation of concerns is to make sure that the block
production is not impacted by the long-running tasks.</p>
</div>
<div class="paragraph">
<p>All data and results generated by Offchain workers are unique per node and
nondeterministic. Information can be propagated to other nodes by submitting a
transaction that should be included in the next block. As Offchain workers runs
on their own execution environment they have access to their own separate
storage. There are two different types of storage available which are defined in
<a href="#defn-offchain-persistent-storage">Definition 170</a> and <a href="#defn-offchain-local-storage">Definition 171</a>.</p>
</div>
<div id="defn-offchain-persistent-storage" class="exampleblock">
<div class="title">Definition 170. <a href="#defn-offchain-persistent-storage">Persisted Storage</a></div>
<div class="content">
<div class="paragraph">
<p><strong>Persistent storage</strong> is non-revertible and not fork-aware. It means that any value
set by the offchain worker is persisted even if that block (at which the worker
is called) is reverted as non-canonical (meaning that the block was surpassed by
a longer chain). The value is available for the worker that is re-run at the new
(different block with the same block number) and future blocks. This storage can
be used by offchain workers to handle forks and coordinate offchain workers
running on different forks.</p>
</div>
</div>
</div>
<div id="defn-offchain-local-storage" class="exampleblock">
<div class="title">Definition 171. <a href="#defn-offchain-local-storage">Local Storage</a></div>
<div class="content">
<div class="paragraph">
<p><strong>Local storage</strong> is revertible and fork-aware. It means that any value set by the
offchain worker triggered at a certain block is reverted if that block is
reverted as non-canonical. The value is NOT available for the worker that is
re-run at the next or any future blocks.</p>
</div>
</div>
</div>
<div id="defn-http-status-code" class="exampleblock">
<div class="title">Definition 172. <a href="#defn-http-status-code">HTTP Status Code</a></div>
<div class="content">
<div class="paragraph">
<p><strong>HTTP status codes</strong> that can get returned by certain Offchain HTTP functions.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0</code>: the specified request identifier is invalid.</p>
</li>
<li>
<p><code>10</code>: the deadline for the started request was reached.</p>
</li>
<li>
<p><code>20</code>: an error has occurred during the request, e.g. a timeout or the remote
server has closed the connection. On returning this error code, the request is
considered destroyed and must be reconstructed again.</p>
</li>
<li>
<p><code>100</code>-<code>999</code>: the request has finished with the given HTTP status code.</p>
</li>
</ul>
</div>
</div>
</div>
<div id="defn-http-error" class="exampleblock">
<div class="title">Definition 173. <a href="#defn-http-error">HTTP Error</a></div>
<div class="content">
<div class="paragraph">
<p>HTTP error, \$E\$, is a varying data type (<a href="#defn-varrying-data-type">Definition 151</a>) and
specifies the error types of certain HTTP functions. Following values are
possible:</p>
</div>
<div class="stemblock">
<div class="content">
\$E = {(0,"The deadile was reached"),(1,"There was an IO error while processing the request"),(2,"The Id of the request is invalid"):}\$
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_functions_5"><a class="link" href="#_functions_5">19.1. Functions</a></h3>
<div class="sect3">
<h4 id="_ext_offchain_is_validator"><a class="link" href="#_ext_offchain_is_validator">19.1.1. <code>ext_offchain_is_validator</code></a></h4>
<div class="paragraph">
<p>Check whether the local node is a potential validator. Even if this function
returns <em>1</em>, it does not mean that any keys are configured or that the validator
is registered in the chain.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_48"><a class="link" href="#_version_1_prototype_48">19.1.1.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_offchain_is_validator_version_1 (return i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>return</code>: a i32 integer which is equal to <em>1</em> if the local node is a potential
validator or a integer equal to <em>0</em> if it is not.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-ext-offchain-submit-transaction"><a class="link" href="#sect-ext-offchain-submit-transaction">19.1.2. <code>ext_offchain_submit_transaction</code></a></h4>
<div class="paragraph">
<p>Given a SCALE encoded extrinsic, this function submits the extrinsic to the
Host&#8217;s transaction pool, ready to be propagated to remote peers.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_49"><a class="link" href="#_version_1_prototype_49">19.1.2.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_offchain_submit_transaction_version_1
	(param $data i64) (return i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the byte array
storing the encoded extrinsic.</p>
</li>
<li>
<p><code>return</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <em>Result</em> value (<a href="#defn-result-type">Definition 153</a>). Neither on success or failure is
there any additional data provided. The cause of a failure is implementation
specific.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_offchain_network_state"><a class="link" href="#_ext_offchain_network_state">19.1.3. <code>ext_offchain_network_state</code></a></h4>
<div class="paragraph">
<p>Returns the SCALE encoded, opaque information about the local node&#8217;s network state.</p>
</div>
<div id="defn-opaque-network-state" class="exampleblock">
<div class="title">Definition 174. <a href="#defn-opaque-network-state">Opaque Network State</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>Opaque network state structure</strong>, \$S\$, is a SCALE encoded blob holding
information about the the <em>libp2p PeerId</em>, \$P_("id")\$, of the local node
and a list of <em>libp2p Multiaddresses</em>, \$(M_0, ... M_n)\$, the node knows it
can be reached at:</p>
</div>
<div class="stemblock">
<div class="content">
\$S = (P_("id"),(M_0, ... M_n))\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="stemblock">
<div class="content">
\$P_("id") = (b_0,... b_n)
M = (b_0, ... b_n)\$
</div>
</div>
<div class="paragraph">
<p>The information contained in this structure is naturally opaque to the caller of
this function.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_50"><a class="link" href="#_version_1_prototype_50">19.1.3.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_offchain_network_state_version_1 (result i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>result</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <code>Result</code> value (<a href="#defn-result-type">Definition 153</a>). On success it contains the
<em>Opaque network state</em> structure (<a href="#defn-opaque-network-state">Definition 174</a>). On failure, an
empty value is yielded where its cause is implementation specific.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_offchain_timestamp"><a class="link" href="#_ext_offchain_timestamp">19.1.4. <code>ext_offchain_timestamp</code></a></h4>
<div class="paragraph">
<p>Returns the current timestamp.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_51"><a class="link" href="#_version_1_prototype_51">19.1.4.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_offchain_timestamp_version_1 (result u64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>result</code>: an u64 integer indicating the current UNIX timestamp (<a href="#defn-unix-time">Definition 9</a>).</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_offchain_sleep_until"><a class="link" href="#_ext_offchain_sleep_until">19.1.5. <code>ext_offchain_sleep_until</code></a></h4>
<div class="paragraph">
<p>Pause the execution until the <code>deadline</code> is reached.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_52"><a class="link" href="#_version_1_prototype_52">19.1.5.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_offchain_sleep_until_version_1 (param $deadline u64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>deadline</code>: an u64 integer specifying the UNIX timestamp (<a href="#defn-unix-time">Definition 9</a>).</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_offchain_random_seed"><a class="link" href="#_ext_offchain_random_seed">19.1.6. <code>ext_offchain_random_seed</code></a></h4>
<div class="paragraph">
<p>Generates a random seed. This is a truly random non deterministic seed generated
by the host environment.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_53"><a class="link" href="#_version_1_prototype_53">19.1.6.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_offchain_random_seed_version_1 (result i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>result</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 256-bit seed.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_offchain_local_storage_set"><a class="link" href="#_ext_offchain_local_storage_set">19.1.7. <code>ext_offchain_local_storage_set</code></a></h4>
<div class="paragraph">
<p>Sets a value in the local storage. This storage is not part of the consensus,
it&#8217;s only accessible by the offchain worker tasks running on the same machine
and is persisted between runs.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_54"><a class="link" href="#_version_1_prototype_54">19.1.7.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_offchain_local_storage_set_version_1
	(param $kind i32) (param $key i64) (param $value i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>kind</code>: an i32 integer indicating the storage kind. A value equal to <em>1</em> is
used for a persistent storage (<a href="#defn-offchain-persistent-storage">Definition 170</a>) and a value
equal to <em>2</em> for local storage (<a href="#defn-offchain-local-storage">Definition 171</a>).</p>
</li>
<li>
<p><code>key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the key.</p>
</li>
<li>
<p><code>value</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the value.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_offchain_local_storage_clear"><a class="link" href="#_ext_offchain_local_storage_clear">19.1.8. <code>ext_offchain_local_storage_clear</code></a></h4>
<div class="paragraph">
<p>Remove a value from the local storage.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_55"><a class="link" href="#_version_1_prototype_55">19.1.8.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_offchain_local_storage_clear_version_1
	(param $kind i32) (param $key i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>kind</code>: an i32 integer indicating the storage kind. A value equal to <em>1</em> is
used for a persistent storage (<a href="#defn-offchain-persistent-storage">Definition 170</a>) and a value
equal to <em>2</em> for local storage (<a href="#defn-offchain-local-storage">Definition 171</a>).</p>
</li>
<li>
<p><code>key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the key.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_offchain_local_storage_compare_and_set"><a class="link" href="#_ext_offchain_local_storage_compare_and_set">19.1.9. <code>ext_offchain_local_storage_compare_and_set</code></a></h4>
<div class="paragraph">
<p>Sets a new value in the local storage if the condition matches the current value.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_56"><a class="link" href="#_version_1_prototype_56">19.1.9.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(fund $ext_offchain_local_storage_compare_and_set_version_1
	(param $kind i32) (param $key i64) (param $old_value i64)
	(param $new_value i64) (result i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>kind</code>: an i32 integer indicating the storage kind. A value equal to <em>1</em> is
used for a persistent storage (<a href="#defn-offchain-persistent-storage">Definition 170</a>) and a value
equal to <em>2</em> for local storage (<a href="#defn-offchain-local-storage">Definition 171</a>).</p>
</li>
<li>
<p><code>key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the key.</p>
</li>
<li>
<p><code>old_value</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) containing the old key.</p>
</li>
<li>
<p><code>new_value</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the new value.</p>
</li>
<li>
<p><code>result</code>: an i32 integer equal to <em>1</em> if the new value has been set or a value
equal to <em>0</em> if otherwise.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_offchain_local_storage_get"><a class="link" href="#_ext_offchain_local_storage_get">19.1.10. <code>ext_offchain_local_storage_get</code></a></h4>
<div class="paragraph">
<p>Gets a value from the local storage.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_57"><a class="link" href="#_version_1_prototype_57">19.1.10.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_offchain_local_storage_get_version_1
	(param $kind i32) (param $key i64) (result i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>kind</code>: an i32 integer indicating the storage kind. A value equal to <em>1</em> is
used for a persistent storage (<a href="#defn-offchain-persistent-storage">Definition 170</a>) and a value
equal to <em>2</em> for local storage (<a href="#defn-offchain-local-storage">Definition 171</a>).</p>
</li>
<li>
<p><code>key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the key.</p>
</li>
<li>
<p><code>result</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) containing the value or the
corresponding key.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_offchain_http_request_start"><a class="link" href="#_ext_offchain_http_request_start">19.1.11. <code>ext_offchain_http_request_start</code></a></h4>
<div class="paragraph">
<p>Initiates a HTTP request given by the HTTP method and the URL. Returns the Id of
a newly started request.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_58"><a class="link" href="#_version_1_prototype_58">19.1.11.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_offchain_http_request_start_version_1
  (param $method i64) (param $uri i64) (param $meta i64) (result i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>method</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the HTTP
method. Possible values are “GET” and “POST”.</p>
</li>
<li>
<p><code>uri</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the URI.</p>
</li>
<li>
<p><code>meta</code>: a future-reserved field containing additional, SCALE encoded
parameters. Currently, an empty array should be passed.</p>
</li>
<li>
<p><code>result</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <em>Result</em> value (<a href="#defn-result-type">Definition 153</a>) containing the i16 ID of the newly
started request. On failure no additionally data is provided. The cause of
failure is implementation specific.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_offchain_http_request_add_header"><a class="link" href="#_ext_offchain_http_request_add_header">19.1.12. <code>ext_offchain_http_request_add_header</code></a></h4>
<div class="paragraph">
<p>Append header to the request. Returns an error if the request identifier is
invalid, <code>http_response_wait</code> has already been called on the specified request
identifier, the deadline is reached or an I/O error has happened (e.g. the
remote has closed the connection).</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_59"><a class="link" href="#_version_1_prototype_59">19.1.12.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_offchain_http_request_add_header_version_1
	(param $request_id i32) (param $name i64) (param $value i64) (result i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>request_id</code>: an i32 integer indicating the ID of the started request.</p>
</li>
<li>
<p><code>name</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the HTTP header name.</p>
</li>
<li>
<p><code>value</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the HTTP header value.</p>
</li>
<li>
<p><code>result</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <em>Result</em> value (<a href="#defn-result-type">Definition 153</a>). Neither on success or failure is
there any additional data provided. The cause of failure is implementation
specific.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_offchain_http_request_write_body"><a class="link" href="#_ext_offchain_http_request_write_body">19.1.13. <code>ext_offchain_http_request_write_body</code></a></h4>
<div class="paragraph">
<p>Writes a chunk of the request body. Returns a non-zero value in case the
deadline is reached or the chunk could not be written.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_60"><a class="link" href="#_version_1_prototype_60">19.1.13.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_offchain_http_request_write_body_version_1
	(param $request_id i32) (param $chunk i64) (param $deadline i64) (result i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>request_id</code>: an i32 integer indicating the ID of the started request.</p>
</li>
<li>
<p><code>chunk</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the chunk of
bytes. Writing an empty chunk finalizes the request.</p>
</li>
<li>
<p><code>deadline</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) containing the UNIX timestamp
(<a href="#defn-unix-time">Definition 9</a>). Passing <em>None</em> blocks indefinitely.</p>
</li>
<li>
<p><code>result</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <em>Result</em> value (<a href="#defn-result-type">Definition 153</a>). On success, no additional data is
provided. On error it contains the HTTP error type (<a href="#defn-http-error">Definition 173</a>).</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_offchain_http_response_wait"><a class="link" href="#_ext_offchain_http_response_wait">19.1.14. <code>ext_offchain_http_response_wait</code></a></h4>
<div class="paragraph">
<p>Returns an array of request statuses (the length is the same as IDs). Note that
if deadline is not provided the method will block indefinitely, otherwise
unready responses will produce DeadlineReached status.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_61"><a class="link" href="#_version_1_prototype_61">19.1.14.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_offchain_http_response_wait_version_1
	(param $ids i64) (param $deadline i64) (result i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>ids</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded array of started request IDs.</p>
</li>
<li>
<p><code>deadline</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) containing the UNIX timestamp
(<a href="#defn-unix-time">Definition 9</a>). Passing None blocks indefinitely.</p>
</li>
<li>
<p><code>result</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded array of request statuses (<a href="#defn-http-status-codes">[defn-http-status-codes]</a>).</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_offchain_http_response_headers"><a class="link" href="#_ext_offchain_http_response_headers">19.1.15. <code>ext_offchain_http_response_headers</code></a></h4>
<div class="paragraph">
<p>Read all HTTP response headers. Returns an array of key/value pairs. Response
headers must be read before the response body.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_62"><a class="link" href="#_version_1_prototype_62">19.1.15.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_offchain_http_response_headers_version_1
	(param $request_id i32) (result i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>request_id</code>: an i32 integer indicating the ID of the started request.</p>
</li>
<li>
<p><code>result</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to a SCALE encoded array of key/value pairs.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_offchain_http_response_read_body"><a class="link" href="#_ext_offchain_http_response_read_body">19.1.16. <code>ext_offchain_http_response_read_body</code></a></h4>
<div class="paragraph">
<p>Reads a chunk of body response to the given buffer. Returns the number of bytes
written or an error in case a deadline is reached or the server closed the
connection. If 0 is returned it means that the response has been fully consumed
and the request_id is now invalid. This implies that response headers must be
read before draining the body.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_63"><a class="link" href="#_version_1_prototype_63">19.1.16.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_offchain_http_response_read_body_version_1
	(param $request_id i32) (param $buffer i64) (param $deadline i64) (result i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>request_id</code>: an i32 integer indicating the ID of the started request.</p>
</li>
<li>
<p><code>buffer</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the buffer
where the body gets written to.</p>
</li>
<li>
<p><code>deadline</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) containing the UNIX timestamp
(<a href="#defn-unix-time">Definition 9</a>). Passing <em>None</em> will block indefinitely.</p>
</li>
<li>
<p><code>result</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <em>Result</em> value (<a href="#defn-result-type">Definition 153</a>). On success it contains an i32
integer specifying the number of bytes written or a HTTP error type
(<a href="#defn-http-error">Definition 173</a>) on failure.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sect-trie-api"><a class="link" href="#sect-trie-api">20. Trie</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Interface that provides trie related functionality.</p>
</div>
<div class="sect2">
<h3 id="_functions_6"><a class="link" href="#_functions_6">20.1. Functions</a></h3>
<div class="sect3">
<h4 id="_ext_trie_blake2_256_root"><a class="link" href="#_ext_trie_blake2_256_root">20.1.1. <code>ext_trie_blake2_256_root</code></a></h4>
<div class="paragraph">
<p>Compute a 256-bit Blake2 trie root formed from the iterated items.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_64"><a class="link" href="#_version_1_prototype_64">20.1.1.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_trie_blake2_256_root_version_1
	(param $data i64) (result i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
iterated items from which the trie root gets formed. The items consist of a
SCALE encoded array containing arbitrary key/value pairs (tuples).</p>
</li>
<li>
<p><code>result</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 256-bit trie root.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_version_2_prototype_9"><a class="link" href="#_version_2_prototype_9">20.1.1.2. Version 2 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_trie_blake2_256_root_version_2
	(param $data i64) (param $version i32)
	(result i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
iterated items from which the trie root gets formed. The items consist of a
SCALE encoded array containing arbitrary key/value pairs (tuples).</p>
</li>
<li>
<p><code>version</code>: a pointer-size (<a href="#defn-runtime-pointer">Definition 164</a>) to the state version <a href="#defn-state-version">Definition 162</a>.</p>
</li>
<li>
<p><code>result</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 256-bit trie root.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_trie_blake2_256_ordered_root"><a class="link" href="#_ext_trie_blake2_256_ordered_root">20.1.2. <code>ext_trie_blake2_256_ordered_root</code></a></h4>
<div class="paragraph">
<p>Compute a 256-bit Blake2 trie root formed from the enumerated items.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_65"><a class="link" href="#_version_1_prototype_65">20.1.2.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_trie_blake2_256_ordered_root_version_1
	(param $data i64) (result i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the enumerated
items from which the trie root gets formed. The items consist of a SCALE encoded
array containing only values, where the corresponding key of each value is the
index of the item in the array, starting at 0. The keys are compact encoded
integers (<a href="#defn-sc-len-encoding">Definition 160</a>).</p>
</li>
<li>
<p><code>result</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 256-bit trie root
result.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_version_2_prototype_10"><a class="link" href="#_version_2_prototype_10">20.1.2.2. Version 2 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_trie_blake2_256_ordered_root_version_2
	(param $data i64) (param $version i32)
	(result i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the enumerated
items from which the trie root gets formed. The items consist of a SCALE encoded
array containing only values, where the corresponding key of each value is the
index of the item in the array, starting at 0. The keys are compact encoded
integers (<a href="#defn-sc-len-encoding">Definition 160</a>).</p>
</li>
<li>
<p><code>version</code>: a pointer-size (<a href="#defn-runtime-pointer">Definition 164</a>) to the state version <a href="#defn-state-version">Definition 162</a>.</p>
</li>
<li>
<p><code>result</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 256-bit trie root
result.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_trie_keccak_256_root"><a class="link" href="#_ext_trie_keccak_256_root">20.1.3. <code>ext_trie_keccak_256_root</code></a></h4>
<div class="paragraph">
<p>Compute a 256-bit Keccak trie root formed from the iterated items.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_66"><a class="link" href="#_version_1_prototype_66">20.1.3.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_trie_keccak_256_root_version_1
	(param $data i64) (result i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
iterated items from which the trie root gets formed. The items consist of a
SCALE encoded array containing arbitrary key/value pairs.</p>
</li>
<li>
<p><code>result</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 256-bit trie root.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_version_2_prototype_11"><a class="link" href="#_version_2_prototype_11">20.1.3.2. Version 2 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_trie_keccak_256_root_version_2
	(param $data i64) (param $version i32)
	(result i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
iterated items from which the trie root gets formed. The items consist of a
SCALE encoded array containing arbitrary key/value pairs.</p>
</li>
<li>
<p><code>version</code>: a pointer-size (<a href="#defn-runtime-pointer">Definition 164</a>) to the state version <a href="#defn-state-version">Definition 162</a>.</p>
</li>
<li>
<p><code>result</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 256-bit trie root.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_trie_keccak_256_ordered_root"><a class="link" href="#_ext_trie_keccak_256_ordered_root">20.1.4. <code>ext_trie_keccak_256_ordered_root</code></a></h4>
<div class="paragraph">
<p>Compute a 256-bit Keccak trie root formed from the enumerated items.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_67"><a class="link" href="#_version_1_prototype_67">20.1.4.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_trie_keccak_256_ordered_root_version_1
	(param $data i64) (result i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the enumerated
items from which the trie root gets formed. The items consist of a SCALE encoded
array containing only values, where the corresponding key of each value is the
index of the item in the array, starting at 0. The keys are compact encoded
integers (<a href="#defn-sc-len-encoding">Definition 160</a>).</p>
</li>
<li>
<p><code>result</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 256-bit trie root
result.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_version_2_prototype_12"><a class="link" href="#_version_2_prototype_12">20.1.4.2. Version 2 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_trie_keccak_256_ordered_root_version_2
	(param $data i64) (param $version i32)
	(result i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the enumerated
items from which the trie root gets formed. The items consist of a SCALE encoded
array containing only values, where the corresponding key of each value is the
index of the item in the array, starting at 0. The keys are compact encoded
integers (<a href="#defn-sc-len-encoding">Definition 160</a>).</p>
</li>
<li>
<p><code>version</code>: a pointer-size (<a href="#defn-runtime-pointer">Definition 164</a>) to the state version <a href="#defn-state-version">Definition 162</a>.</p>
</li>
<li>
<p><code>result</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the buffer containing the 256-bit trie root
result.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_trie_blake2_256_verify_proof"><a class="link" href="#_ext_trie_blake2_256_verify_proof">20.1.5. <code>ext_trie_blake2_256_verify_proof</code></a></h4>
<div class="paragraph">
<p>Verifies a key/value pair against a Blake2 256-bit merkle root.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_68"><a class="link" href="#_version_1_prototype_68">20.1.5.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_trie_blake2_256_verify_proof_version_1
	(param $root i32) (param $proof i64)
	(param $key i64) (param $value i64)
	(result i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>root</code>: a pointer to the 256-bit merkle root.</p>
</li>
<li>
<p><code>proof</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to an array containing
the node proofs.</p>
</li>
<li>
<p><code>key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the key.</p>
</li>
<li>
<p><code>value</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the value.</p>
</li>
<li>
<p><code>return</code>: a value equal to <em>1</em> if the proof could be succesfully verified or a
value equal to <em>0</em> if otherwise.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_version_2_prototype_13"><a class="link" href="#_version_2_prototype_13">20.1.5.2. Version 2 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_trie_blake2_256_verify_proof_version_2
	(param $root i32) (param $proof i64)
	(param $key i64) (param $value i64)
	(param $version i32) (result i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>root</code>: a pointer to the 256-bit merkle root.</p>
</li>
<li>
<p><code>proof</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to an array containing
the node proofs.</p>
</li>
<li>
<p><code>key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the key.</p>
</li>
<li>
<p><code>value</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the value.</p>
</li>
<li>
<p><code>version</code>: a pointer-size (<a href="#defn-runtime-pointer">Definition 164</a>) to the state version <a href="#defn-state-version">Definition 162</a>.</p>
</li>
<li>
<p><code>return</code>: a value equal to <em>1</em> if the proof could be succesfully verified or a
value equal to <em>0</em> if otherwise.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_trie_keccak_256_verify_proof"><a class="link" href="#_ext_trie_keccak_256_verify_proof">20.1.6. <code>ext_trie_keccak_256_verify_proof</code></a></h4>
<div class="paragraph">
<p>Verifies a key/value pair against a Keccak 256-bit merkle root.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_69"><a class="link" href="#_version_1_prototype_69">20.1.6.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_trie_keccak_256_verify_proof_version_1
	(param $root i32) (param $proof i64)
	(param $key i64) (param $value i64)
	(result i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>root</code>: a pointer to the 256-bit merkle root.</p>
</li>
<li>
<p><code>proof</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to an array containing
the node proofs.</p>
</li>
<li>
<p><code>key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the key.</p>
</li>
<li>
<p><code>value</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the value.</p>
</li>
<li>
<p><code>return</code>: a value equal to <em>1</em> if the proof could be succesfully verified or a
value equal to <em>0</em> if otherwise.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_version_2_prototype_14"><a class="link" href="#_version_2_prototype_14">20.1.6.2. Version 2 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_trie_keccak_256_verify_proof_version_2
	(param $root i32) (param $proof i64)
	(param $key i64) (param $value i64)
	(param $version i32) (result i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>root</code>: a pointer to the 256-bit merkle root.</p>
</li>
<li>
<p><code>proof</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to an array containing
the node proofs.</p>
</li>
<li>
<p><code>key</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the key.</p>
</li>
<li>
<p><code>value</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the value.</p>
</li>
<li>
<p><code>version</code>: a pointer-size (<a href="#defn-runtime-pointer">Definition 164</a>) to the state version <a href="#defn-state-version">Definition 162</a>.</p>
</li>
<li>
<p><code>return</code>: a value equal to <em>1</em> if the proof could be succesfully verified or a
value equal to <em>0</em> if otherwise.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sect-misc-api"><a class="link" href="#sect-misc-api">21. Miscellaneous</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Interface that provides miscellaneous functions for communicating between the
runtime and the node.</p>
</div>
<div class="sect2">
<h3 id="_functions_7"><a class="link" href="#_functions_7">21.1. Functions</a></h3>
<div class="sect3">
<h4 id="_ext_misc_print_num"><a class="link" href="#_ext_misc_print_num">21.1.1. <code>ext_misc_print_num</code></a></h4>
<div class="paragraph">
<p>Print a number.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_70"><a class="link" href="#_version_1_prototype_70">21.1.1.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_misc_print_num_version_1 (param $value i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code>: the number to be printed.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_misc_print_utf8"><a class="link" href="#_ext_misc_print_utf8">21.1.2. <code>ext_misc_print_utf8</code></a></h4>
<div class="paragraph">
<p>Print a valid UTF8 encoded buffer.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_71"><a class="link" href="#_version_1_prototype_71">21.1.2.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_misc_print_utf8_version_1 (param $data i64))</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Arguments</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to
the valid buffer to be printed.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_misc_print_hex"><a class="link" href="#_ext_misc_print_hex">21.1.3. <code>ext_misc_print_hex</code></a></h4>
<div class="paragraph">
<p>Print any buffer in hexadecimal representation.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_72"><a class="link" href="#_version_1_prototype_72">21.1.3.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_misc_print_hex_version_1 (param $data i64))</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Arguments</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to
the buffer to be printed.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_misc_runtime_version"><a class="link" href="#_ext_misc_runtime_version">21.1.4. <code>ext_misc_runtime_version</code></a></h4>
<div class="paragraph">
<p>Extract the Runtime version of the given Wasm blob by calling <code>Core_version</code>
(<a href="#defn-rt-core-version">Section 26.1.1</a>). Returns the SCALE encoded runtime version or <em>None</em>
(<a href="#defn-option-type">Definition 152</a>) if the call fails. This function gets primarily used when
upgrading Runtimes.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Calling this function is very expensive and should only be done very
occasionally. For getting the runtime version, it requires instantiating the
Wasm blob (<a href="#sect-loading-runtime-code">Section 3.1.2</a>) and calling the <code>Core_version</code>
function (<a href="#defn-rt-core-version">Section 26.1.1</a>) in this blob.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_73"><a class="link" href="#_version_1_prototype_73">21.1.4.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_misc_runtime_version_version_1 (param $data i64) (result i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>data</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the Wasm
blob.</p>
</li>
<li>
<p><code>result</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE
encoded <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) containing the Runtime version of
the given Wasm blob which is encoded as a byte array.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sect-allocator-api"><a class="link" href="#sect-allocator-api">22. Allocator</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Polkadot Runtime does not include a memory allocator and relies on the Host
API for all heap allocations. The beginning of this heap is marked by the
<code>__heap_base</code> symbol exported by the Polkadot Runtime. No memory should be
allocated below that address, to avoid clashes with the stack and data section.
The same allocator made accessible by this Host API should be used for any other
WASM memory allocations and deallocations outside the runtime e.g. when passing
the SCALE-encoded parameters to Runtime API calls.</p>
</div>
<div class="sect2">
<h3 id="_functions_8"><a class="link" href="#_functions_8">22.1. Functions</a></h3>
<div class="sect3">
<h4 id="_ext_allocator_malloc"><a class="link" href="#_ext_allocator_malloc">22.1.1. <code>ext_allocator_malloc</code></a></h4>
<div class="paragraph">
<p>Allocates the given number of bytes and returns the pointer to that memory
location.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_74"><a class="link" href="#_version_1_prototype_74">22.1.1.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_allocator_malloc_version_1 (param $size i32) (result i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>size</code>: the size of the buffer to be allocated.</p>
</li>
<li>
<p><code>result</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the allocated buffer.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ext_allocator_free"><a class="link" href="#_ext_allocator_free">22.1.2. <code>ext_allocator_free</code></a></h4>
<div class="paragraph">
<p>Free the given pointer.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_75"><a class="link" href="#_version_1_prototype_75">22.1.2.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_allocator_free_version_1 (param $ptr i32))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>ptr</code>: a pointer (<a href="#defn-runtime-pointer">Definition 164</a>) to the memory buffer to be freed.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sect-logging-api"><a class="link" href="#sect-logging-api">23. Logging</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Interface that provides functions for logging from within the runtime.</p>
</div>
<div id="defn-logging-log-level" class="exampleblock">
<div class="title">Definition 175. <a href="#defn-logging-log-level">Log Level</a></div>
<div class="content">
<div class="paragraph">
<p>The <strong>Log Level</strong>, \$L\$, is a varying data type (<a href="#defn-varrying-data-type">Definition 151</a>)
and implies the emergency of the log. Possible log levels and the corresponding
identifier is as follows:</p>
</div>
<div class="stemblock">
<div class="content">
\$L = {(0,"Error = 1"),(1,"Warn = 2"),(2,"Info = 3"),(3, "Debug = 4"),(4,"Trace = 5"):}\$
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_functions_9"><a class="link" href="#_functions_9">23.1. Functions</a></h3>
<div class="sect3">
<h4 id="_ext_logging_log"><a class="link" href="#_ext_logging_log">23.1.1. <code>ext_logging_log</code></a></h4>
<div class="paragraph">
<p>Request to print a log message on the host. Note that this will be only
displayed if the host is enabled to display log messages with given level and
target.</p>
</div>
<div class="sect4">
<h5 id="_version_1_prototype_76"><a class="link" href="#_version_1_prototype_76">23.1.1.1. Version 1 - Prototype</a></h5>
<div class="listingblock">
<div class="content">
<pre>(func $ext_logging_log_version_1
	(param $level i32) (param $target i64) (param $message i64))</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>level</code>: the log level (<a href="#defn-logging-log-level">Definition 175</a>).</p>
</li>
<li>
<p><code>target</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the
string which contains the path, module or location from where the log was
executed.</p>
</li>
<li>
<p><code>message</code>: a pointer-size (<a href="#defn-runtime-pointer-size">Definition 165</a>) to the log
message.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<h1 id="chap-runtime-api" class="sect0"><a class="link" href="#chap-runtime-api">Runtime API</a></h1>
<div class="openblock partintro">
<div class="content">
Description of how to interact with the Runtime through its exported functions
</div>
</div>
<div class="sect1">
<h2 id="_general_information"><a class="link" href="#_general_information">24. General Information</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Polkadot Host assumes that at least the constants and functions
described in this Chapter are implemented in the Runtime Wasm blob.</p>
</div>
<div class="paragraph">
<p>It should be noted that the API can change through the Runtime updates.
Therefore, a host should check the API versions of each module returned
in the <code>api</code> field by <code>Core_version</code> (<a href="#defn-rt-core-version">Section 26.1.1</a>) after
every Runtime upgrade and warn if an updated API is encountered and that
this might require an update of the host.</p>
</div>
<div class="sect2">
<h3 id="sect-json-rpc-api"><a class="link" href="#sect-json-rpc-api">24.1. JSON-RPC API for external services</a></h3>
<div class="paragraph">
<p>Polkadot Host implementers are encouraged to implement an API in order
for external, third-party services to interact with the node. The
<a href="https://github.com/w3f/PSPs/blob/master/PSPs/drafts/psp-6.md">JSON-RPC
Interface for Polkadot Nodes</a> (PSP6) is a Polkadot Standard
Proposal for such an API and makes it easier to integrate the node with
existing tools available in the Polkadot ecosystem, such as
<a href="https://polkadot.js.org/">polkadot.js.org</a>. The Runtime API has a few
modules designed specifically for use in the official RPC API.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_runtime_constants"><a class="link" href="#_runtime_constants">25. Runtime Constants</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_heap_base"><a class="link" href="#_heap_base">25.1. <code>__heap_base</code></a></h3>
<div class="paragraph">
<p>This constant indicates the beginning of the heap in memory. The space
below is reserved for the stack and the data section. For more details
please refer to <a href="#sect-ext-allocator-api">[sect-ext-allocator-api]</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_runtime_functions"><a class="link" href="#_runtime_functions">26. Runtime Functions</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section, we describe all Runtime API functions alongside their
arguments and the return values. The functions are organized into
modules with each being versioned independently.</p>
</div>
<div id="defn-runtime-api-convention" class="exampleblock">
<div class="title">Definition 176. Runtime API Call Convention</div>
<div class="content">
<div class="paragraph">
<p>The <strong>Runtime API Call Convention</strong> describes that all functions receive and return SCALE-encoded data and as a result have the following prototype signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="wat">(func $generic_runtime_entry
  (param $ptr i32) (parm $len i32) (result i64))</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>ptr</code> points to the SCALE encoded tuple of the parameters passed to the
function and <code>len</code> is the length of this data, while <code>result</code> is a pointer-size
(Definition <a href="#defn-runtime-pointer-size">Definition 165</a>) to the SCALE-encoded return data.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>See <a href="#sect-code-executor">Section 3.1.3</a> for more information about the behaviour of the Wasm Runtime. Also note that any state changes created by calling any of the Runtime functions are not necessarily to be persisted after the call is ended. See <a href="#sect-handling-runtime-state-update">Section 3.1.3.4</a> for more information.</p>
</div>
<div class="sect2">
<h3 id="sect-runtime-core-module"><a class="link" href="#sect-runtime-core-module">26.1. Core Module (Version 3)</a></h3>
<div class="sect3">
<h4 id="defn-rt-core-version"><a class="link" href="#defn-rt-core-version">26.1.1. <code>Core_version</code></a></h4>
<div class="paragraph">
<p>Returns the version identifiers of the Runtime. This function can be used by the Polkadot Host implementation when it seems appropriate, such as for the JSON-RPC API as described in <a href="#sect-json-rpc-api">Section 24.1</a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A datastructure of the following format:</p>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Details of the version that the data type returns from the Runtime function.</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec_name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Runtime identifier</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>impl_name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the implementation (e.g. C++)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>authoring_version</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unsigned 32-bit integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version of the authorship interface</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>spec_version</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unsigned 32-bit integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version of the Runtime specification</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>impl_version</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unsigned 32-bit integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version of the Runtime implementation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>apis</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ApiVersions (<a href="#defn-rt-apisvec">Definition 177</a>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of supported APIs along with their version</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>transaction_version</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unsigned 32-bit integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version of the transaction format</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>state_version</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unsigned 32-bit integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version of the trie format</p></td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div id="defn-rt-apisvec" class="exampleblock">
<div class="title">Definition 177. ApiVersions</div>
<div class="content">
<div class="paragraph">
<p><strong>ApiVersions</strong> is a specialized type for the (<a href="#defn-rt-core-version">Section 26.1.1</a>) function entry. It represents an array of tuples, where the first value of the tuple is an array of 8-bytes containing the Blake2b hash of the API name. The second value of the tuple is the version number of the corresponding API.</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{aligned}
      \mathrm{ApiVersions} :=&amp; (T_0, \ldots, T_n)\\
      T :=&amp; ((b_0, \ldots, b_7), \mathrm{UINT32})
\end{aligned}\]
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Requires <code>Core_initialize_block</code> to be called beforehand.</p>
</div>
</div>
<div class="sect3">
<h4 id="sect-rte-core-execute-block"><a class="link" href="#sect-rte-core-execute-block">26.1.2. <code>Core_execute_block</code></a></h4>
<div class="paragraph">
<p>This function executes a full block and all its extrinsics and updates the state accordingly. Additionally, some integrity checks are executed such as validating if the parent hash is correct and that the transaction root represents the transactions. Internally, this function performs an operation similar to the process described in <a href="#algo-build-block">Section 5.2.7.1</a>, by calling <code>Core_initialize_block</code>,<code>BlockBuilder_apply_extrinsics</code> and <code>BlockBuilder_finalize_block</code>.</p>
</div>
<div class="paragraph">
<p>This function should be called when a fully complete block is available
that is not actively being built on, such as blocks received from other
peers. State changes resulted from calling this function are usually
meant to persist when the block is imported successfully.</p>
</div>
<div class="paragraph">
<p>Additionally, the seal digest in the block header, as described in  <a href="#defn-digest">Definition 33</a>, must be removed by the
Polkadot host before submitting the block.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A block represented as a tuple consisting of a block header, as described in <a href="#defn-block-header">Definition 32</a>, and the block body, as described in <a href="#defn-block-body">Definition 35</a>.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="sect-rte-core-initialize-block"><a class="link" href="#sect-rte-core-initialize-block">26.1.3. <code>Core_initialize_block</code></a></h4>
<div class="paragraph">
<p>Sets up the environment required for building a new block as described in <a href="#algo-build-block">Section 5.2.7.1</a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The header of the new block as defined in <a href="#defn-block-header">Definition 32</a>. The values \(H_r\), \(H_e\) and \(H_d\) are left empty.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-runtime-metadata-module"><a class="link" href="#sect-runtime-metadata-module">26.2. Metadata Module (Version 1)</a></h3>
<div class="sect3">
<h4 id="_metadata_metadata"><a class="link" href="#_metadata_metadata">26.2.1. <code>Metadata_metadata</code></a></h4>
<div class="paragraph">
<p>Returns native Runtime metadata in an opaque form. This function can be used by the Polkadot Host implementation when it seems appropriate, such as for the JSON-RPC API as described in <a href="#sect-json-rpc-api">Section 24.1</a>. and returns all the information necessary to build valid transactions.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A byte array of varying size containing the metadata in an opaque form.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-runtime-blockbuilder-module"><a class="link" href="#sect-runtime-blockbuilder-module">26.3. BlockBuilder Module (Version 4)</a></h3>
<div class="paragraph">
<p>All calls in this module require <code>Core_intialize_block</code>
(<a href="#sect-rte-core-initialize-block">Section 26.1.3</a>) to be called beforehand.</p>
</div>
<div class="sect3">
<h4 id="sect-rte-apply-extrinsic"><a class="link" href="#sect-rte-apply-extrinsic">26.3.1. <code>BlockBuilder_apply_extrinsic</code></a></h4>
<div class="paragraph">
<p>Apply the extrinsic outside of the block execution function. This does
not attempt to validate anything regarding the block, but it builds a
list of transaction hashes.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A byte array of varying size containing the opaque extrinsic.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Returns the varying datatype <em>ApplyExtrinsicResult</em> as defined in <a href="#defn-rte-apply-extrinsic-result">Definition 178</a>.
This structure lets the block builder know whether an extrinsic should
be included into the block or rejected.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div id="defn-rte-apply-extrinsic-result" class="exampleblock">
<div class="title">Definition 178. ApplyExtrinsicResult</div>
<div class="content">
<div class="paragraph">
<p><strong>ApplyExtrinsicResult</strong> is a varying data type as defined in <a href="#defn-result-type">Definition 153</a>.
This structure can contain multiple nested structures, indicating either module
dispatch outcomes or transaction invalidity errors.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Possible values of varying data type <em>ApplyExtrinsicResult</em>.</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 60%;">
<col style="width: 30%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Id</strong></th>
<th class="tableblock halign-left valign-top"><strong>Description</strong></th>
<th class="tableblock halign-left valign-top"><strong>Type</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Outcome of dispatching the extrinsic.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>DispatchOutcome</em> (<a href="#defn-rte-dispatch-outcome">Definition 179</a>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Possible errors while checking the validity of a transaction.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>TransactionValidityError</em> (<a href="#defn-rte-transaction-validity-error">Definition 182</a>)</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As long as a <em>DispatchOutcome</em> (<a href="#defn-rte-dispatch-outcome">Definition 179</a>) is returned,
the extrinsic is always included in the block, even if the outcome is a dispatch
error. Dispatch errors do not invalidate the block and all state changes are
persisted.
</td>
</tr>
</table>
</div>
<div id="defn-rte-dispatch-outcome" class="exampleblock">
<div class="title">Definition 179. DispatchOutcome</div>
<div class="content">
<div class="paragraph">
<p><strong>DispatchOutcome</strong> is the varying data type as defined in <a href="#defn-result-type">Definition 153</a>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Possible values of varying data type <em>DispatchOutcome</em>.</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 60%;">
<col style="width: 30%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Id</strong></th>
<th class="tableblock halign-left valign-top"><strong>Description</strong></th>
<th class="tableblock halign-left valign-top"><strong>Type</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extrinsic is valid and was submitted successfully.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Possible errors while dispatching the extrinsic.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>DispatchError</em> (<a href="#defn-rte-dispatch-error">Definition 180</a>)</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="defn-rte-dispatch-error" class="exampleblock">
<div class="title">Definition 180. DispatchError</div>
<div class="content">
<div class="paragraph">
<p><strong>DispatchError</strong> is a varying data type as defined in <a href="#defn-varrying-data-type">Definition 151</a>.
Indicates various reasons why a dispatch call failed.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Possible values of varying data type <em>DispatchError</em>.</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 40%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Id</strong></th>
<th class="tableblock halign-left valign-top"><strong>Description</strong></th>
<th class="tableblock halign-left valign-top"><strong>Type</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Some unknown error occurred.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SCALE encoded byte array containing a valid UTF-8 sequence.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Failed to lookup some data.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A bad origin.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A custom error in a module.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>CustomModuleError</em> (<a href="#defn-rte-custom-module-error">Definition 181</a>)</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="defn-rte-custom-module-error" class="exampleblock">
<div class="title">Definition 181. CustomModuleError</div>
<div class="content">
<div class="paragraph">
<p><strong>CustomModuleError</strong> is a tuple appended after a possible error in as defined in <a href="#defn-rte-dispatch-error">Definition 180</a>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Possible values of varying data type <em>CustomModuleError</em>.</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Name</strong></th>
<th class="tableblock halign-left valign-top"><strong>Description</strong></th>
<th class="tableblock halign-left valign-top"><strong>Type</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Index</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Module index matching the metadata module index.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unsigned 8-bit integer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Module specific error value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unsigned 8-bit integer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional error message.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Varying data type <em>Option</em> (<a href="#defn-option-type">Definition 152</a>).
The optional value is a SCALE encoded byte array containing a valid UTF-8 sequence.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Whenever <em>TransactionValidityError</em> (<a href="#defn-rte-transaction-validity-error">Definition 182</a>)
is returned, the contained error type will indicate whether an extrinsic should
be outright rejected or requested for a later block. This behaviour is clarified
further in <a href="#defn-rte-invalid-transaction">Definition 183</a> and respectively <a href="#defn-rte-unknown-transaction">Definition 184</a>.
</td>
</tr>
</table>
</div>
<div id="defn-rte-transaction-validity-error" class="exampleblock">
<div class="title">Definition 182. TransactionValidityError</div>
<div class="content">
<div class="paragraph">
<p><strong>TransactionValidityError</strong> is a varying data type as defined in <a href="#defn-varrying-data-type">Definition 151</a>.
It indicates possible errors that can occur while checking the validity of a transaction.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. Possible values of varying data type <em>TransactionValidityError</em>.</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 50%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Id</strong></th>
<th class="tableblock halign-left valign-top"><strong>Description</strong></th>
<th class="tableblock halign-left valign-top"><strong>Type</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction is invalid.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>InvalidTransaction</em> (<a href="#defn-rte-invalid-transaction">Definition 183</a>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction validity can’t be determined.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>UnknownTransaction</em> (<a href="#defn-rte-unknown-transaction">Definition 184</a>)</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="defn-rte-invalid-transaction" class="exampleblock">
<div class="title">Definition 183. InvalidTransaction</div>
<div class="content">
<div class="paragraph">
<p><strong>InvalidTransaction</strong> is a varying data type as defined in <a href="#defn-varrying-data-type">Definition 151</a>
and specifies the invalidity of the transaction in more detail.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. Possible values of varying data type <em>InvalidTransaction</em>.</caption>
<colgroup>
<col style="width: 9.0909%;">
<col style="width: 54.5454%;">
<col style="width: 18.1818%;">
<col style="width: 18.1819%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Id</strong></th>
<th class="tableblock halign-left valign-top"><strong>Description</strong></th>
<th class="tableblock halign-left valign-top"><strong>Type</strong></th>
<th class="tableblock halign-left valign-top"><strong>Reject</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Call of the transaction is not expected.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">General error to do with the inability to pay some fees (e.g. account balance too low).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">General error to do with the transaction not yet being valid (e.g. nonce too high).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">General error to do with the transaction being outdated (e.g. nonce too low).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">General error to do with the transactions’ proof (e.g. signature)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The transaction birth block is ancient.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The transaction would exhaust the resources of the current block.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Some unknown error occured.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unsigned 8-bit integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An extrinsic with mandatory dispatch resulted in an error.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A transaction with a mandatory dispatch (only inherents are allowed to have mandatory dispatch).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="defn-rte-unknown-transaction" class="exampleblock">
<div class="title">Definition 184. UnknownTransaction</div>
<div class="content">
<div class="paragraph">
<p><strong>UnknownTransaction</strong> is a varying data type as defined in <a href="#defn-varrying-data-type">Definition 151</a>
and specifies the unknown invalidity of the transaction in more detail.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 13. Possible values of varying data type <em>UnknownTransaction</em>.</caption>
<colgroup>
<col style="width: 9.0909%;">
<col style="width: 54.5454%;">
<col style="width: 18.1818%;">
<col style="width: 18.1819%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Id</strong></th>
<th class="tableblock halign-left valign-top"><strong>Description</strong></th>
<th class="tableblock halign-left valign-top"><strong>Type</strong></th>
<th class="tableblock halign-left valign-top"><strong>Reject</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Could not lookup some information that is required to validate the transaction.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No validator found for the given unsigned transaction.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any other custom unknown validity that is not covered by this type.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unsigned 8-bit integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="defn-rt-blockbuilder-finalize-block"><a class="link" href="#defn-rt-blockbuilder-finalize-block">26.3.2. <code>BlockBuilder_finalize_block</code></a></h4>
<div class="paragraph">
<p>Finalize the block - it is up to the caller to ensure that all header
fields are valid except for the state root. State changes resulting from
calling this function are usually meant to persist upon successful
execution of the function and appending of the block to the chain.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The header of the new block as defined in <a href="#defn-block-header">Definition 32</a>.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="defn-rt-builder-inherent-extrinsics"><a class="link" href="#defn-rt-builder-inherent-extrinsics">26.3.3. <code>BlockBuilder_inherent_extrinisics</code>:</a></h4>
<div class="paragraph">
<p>Generates the inherent extrinsics, which are explained in more detail in
<a href="#sect-inherents">Section 3.2.3</a>. This function takes a SCALE-encoded hash table as defined in
<a href="#defn-scale-list">Definition 155</a> and returns an array of extrinsics. The Polkadot Host must
submit each of those to the <code>BlockBuilder_apply_extrinsic</code>, described in
<a href="#sect-rte-apply-extrinsic">Section 26.3.1</a>. This procedure is outlined in <a href="#algo-build-block">Section 5.2.7.1</a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A Inherents-Data structure as defined in <a href="#defn-inherent-data">Section 3.2.3.1</a>.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A byte array of varying size containing extrinisics. Each extrinsic is a byte
array of varying size.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_blockbuilder_check_inherents"><a class="link" href="#_blockbuilder_check_inherents">26.3.4. <code>BlockBuilder_check_inherents</code></a></h4>
<div class="paragraph">
<p>Checks whether the provided inherent is valid. This function can be used
by the Polkadot Host when deemed appropriate, e.g. during the
block-building process.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A block represented as a tuple consisting of a block header as described in
<a href="#defn-block-header">Definition 32</a> and the block body as described in <a href="#defn-block-body">Definition 35</a>.</p>
</li>
<li>
<p>A Inherents-Data structure as defined in <a href="#defn-inherent-data">Section 3.2.3.1</a>.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A data structure of the following format:</p>
<div class="stemblock">
<div class="content">
\[(o, f_e, e)\]
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\(o\) is a boolean indicating whether the check was successful.</p>
</li>
<li>
<p>\(f_e\) is a boolean indicating whether a fatal error was encountered.</p>
</li>
<li>
<p>\(e\) is a Inherents-Data structure as defined in <a href="#defn-inherent-data">Section 3.2.3.1</a>
containing any errors created by this Runtime function.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_blockbuilder_random_seed"><a class="link" href="#_blockbuilder_random_seed">26.3.5. <code>BlockBuilder_random_seed</code></a></h4>
<div class="paragraph">
<p>Generates a random seed.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A 32-byte array containing the random seed.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-runtime-txqueue-module"><a class="link" href="#sect-runtime-txqueue-module">26.4. TaggedTransactionQueue (Version 2)</a></h3>
<div class="paragraph">
<p>All calls in this module require <code>Core_initialize_block</code> (<a href="#sect-rte-core-initialize-block">Section 26.1.3</a>) to be called beforehand.</p>
</div>
<div class="sect3">
<h4 id="sect-rte-validate-transaction"><a class="link" href="#sect-rte-validate-transaction">26.4.1. <code>TaggedTransactionQueue_validate_transaction</code></a></h4>
<div class="paragraph">
<p>This entry is invoked against extrinsics submitted through a transaction network
message (<a href="#sect-msg-transactions">Section 4.8.5</a>) or by an offchain worker through the Host API
(<a href="#sect-ext-offchain-submit-transaction">Section 19.1.2</a>).</p>
</div>
<div class="paragraph">
<p>It indicates if the submitted blob represents a valid extrinsics, the
order in which it should be applied and if it should be gossiped to
other peers. Furthermore this function gets called internally when
executing blocks with the runtime function as described in <a href="#sect-rte-core-execute-block">Section 26.1.2</a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The source of the transaction as defined in <a href="#defn-transaction-source">Definition 185</a>.</p>
</li>
<li>
<p>A byte array that contains the transaction.</p>
<div id="defn-transaction-source" class="exampleblock">
<div class="title">Definition 185. TransactionSource</div>
<div class="content">
<div class="paragraph">
<p><strong>TransactionSource</strong> is an enum describing the source of a transaction and can
have one of the following values:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 14. The <em>TransactionSource</em> enum</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 20%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Id</th>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>InBlock</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction is already included in a block.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Local</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction is coming from a local source, e.g. off-chain worker.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>External</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction has been received externally, e.g. over the network.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>This function returns a <em>Result</em> as defined in <a href="#defn-result-type">Definition 153</a> which contains
the type <em>ValidTransaction</em>  as defined in <a href="#defn-valid-transaction">Definition 186</a> on success
and the type <em>TransactionValidityError</em> as defined in
<a href="#defn-rte-transaction-validity-error">Definition 182</a> on failure.</p>
<div id="defn-valid-transaction" class="exampleblock">
<div class="title">Definition 186. ValidTransaction</div>
<div class="content">
<div class="paragraph">
<p><strong>ValidTransaction</strong> is a tuple that contains information concerning a valid transaction.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 15. The tuple provided by in the case the transaction is judged to be valid.</caption>
<colgroup>
<col style="width: 10%;">
<col style="width: 70%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Name</strong></th>
<th class="tableblock halign-left valign-top"><strong>Description</strong></th>
<th class="tableblock halign-left valign-top"><strong>Type</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Priority</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Determines the ordering of two transactions that have all their dependencies
(required tags) are satisfied.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unsigned 64bit integer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Requires</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of tags specifying extrinsics which should be applied before the current
exrinsics can be applied.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array containing inner arrays</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Provides</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Informs Runtime  of the extrinsics depending on the tags in the list that can be
applied after current extrinsics are being applied. Describes the minimum number
of blocks for the validity to be correct</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array containing inner arrays</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Longevity</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">After this period, the transaction should be removed from the pool or revalidated.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unsigned 64-bit integer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Propagate</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A flag indicating if the transaction should be gossiped to other peers.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If <em>Propagate</em> is set to <code>false</code> the transaction will still be considered for inclusion in blocks that are authored on the current node, but should not be gossiped to other peers.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If this function gets called by the Polkadot Host in order to validate a transaction received from peers, the Polkadot Host disregards and rewinds state changes resulting in such a call.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-runtime-offchainapi-module"><a class="link" href="#sect-runtime-offchainapi-module">26.5. OffchainWorkerApi Module (Version 2)</a></h3>
<div class="paragraph">
<p>Does not require <code>Core_intialize_block</code> (<a href="#sect-rte-core-initialize-block">Section 26.1.3</a>) to be called beforehand.</p>
</div>
<div class="sect3">
<h4 id="_offchainworkerapi_offchain_worker"><a class="link" href="#_offchainworkerapi_offchain_worker">26.5.1. <code>OffchainWorkerApi_offchain_worker</code></a></h4>
<div class="paragraph">
<p>Starts an off-chain worker and generates extrinsics. [To do: when is
this called?]</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The block header as defined in <a href="#defn-block-header">Definition 32</a>.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sect-anv-runtime-api"><a class="link" href="#sect-anv-runtime-api">26.6. ParachainHost Module (Version 1)</a></h3>
<div class="sect3">
<h4 id="sect-rt-api-validators"><a class="link" href="#sect-rt-api-validators">26.6.1. <code>ParachainHost_validators</code></a></h4>
<div class="paragraph">
<p>Returns the validator set at the current state. The specified validators are responsible for backing parachains for the current state.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>An array of public keys representing the validators.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="sect-rt-api-validator-groups"><a class="link" href="#sect-rt-api-validator-groups">26.6.2. <code>ParachainHost_validator_groups</code></a></h4>
<div class="paragraph">
<p>Returns the validator groups (<a href="#defn-validator-groups">Section 6.8.7</a>) used during the current
session. The validators in the groups are referred to by the validator set Id
(<a href="#defn-authority-list">Definition 58</a>).</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>An array of tuples, \$T\$, of the following format:</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="stemblock">
<div class="content">
\$T == (I,G)\$
\$I == (v_n,…v_m)\$
\$G == (B_s,f,B_c)\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$I\$ is an array the validator set Ids (<a href="#defn-authority-list">Definition 58</a>).</p>
</li>
<li>
<p>\$B_s\$ indicates the block number where the session started.</p>
</li>
<li>
<p>\$f\$ indicates how often groups rotate. 0 means never.</p>
</li>
<li>
<p>\$B_c\$ indicates the current block number.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="sect-rt-api-availability-cores"><a class="link" href="#sect-rt-api-availability-cores">26.6.3. <code>ParachainHost_availability_cores</code></a></h4>
<div class="paragraph">
<p>Returns information on all availability cores (<a href="#defn-availability-core">Section 6.8.6</a>).</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>An array of core states, S, of the following format:</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="stemblock">
<div class="content">
\$S == {(0,-&gt;,C_o),(1,-&gt;,C_s),(2,-&gt;,phi):}\$
\$C_o == (n_u,B_o,B_t,n_t,b,G_i,C_h,C_d)\$
\$C_s == (P_id,C_i)\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$S\$ specifies the core state. <em>0</em> indicates that the core is occupied,
<em>1</em> implies it&#8217;s currently free but scheduled and given the opportunity to
occupy and <em>2</em> implies it&#8217;s free and there&#8217;s nothing scheduled.</p>
</li>
<li>
<p>\$n_u\$ is an <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) which can contain a
\$C_s\$ value if the core was freed by the Runtime and indicates the
assignment that is next scheduled on this core. An empty value indicates there
is nothing scheduled.</p>
</li>
<li>
<p>\$B_o\$ indicates the relay chain block number at which the core got occupied.</p>
</li>
<li>
<p>\$B_t\$ indicates the relay chain block number the core will time-out at, if any.</p>
</li>
<li>
<p>\$n_t\$ is an <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) as described in
Definition ? which can contain a \$C_s\$ value if the core is freed by a
time-out and indicates the assignment that is next scheduled on this core. An
empty value indicates there is nothing scheduled.</p>
</li>
<li>
<p>\$b\$ is a bitfield array (<a href="#defn-bitfield-array">Section 6.8.12</a>). A \$&gt;2/3\$ majority
of assigned validators voting with \$1\$ values means that the core is
available.</p>
</li>
<li>
<p>\$G_i\$ indicates the assigned validator group index
(<a href="#defn-validator-groups">Section 6.8.7</a>) is to distribute availability pieces of this
candidate.</p>
</li>
<li>
<p>\$C_h\$ indicates the hash of the candidate occupying the core.</p>
</li>
<li>
<p>\$C_d\$ is the candidate descriptor (<a href="#defn-candidate-descriptor">Definition 99</a>).</p>
</li>
<li>
<p>\$C_i\$ is an <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) as described in
Definition ? which can contain the collators public key indicating who should
author the block.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="sect-rt-api-persisted-validation-data"><a class="link" href="#sect-rt-api-persisted-validation-data">26.6.4. <code>ParachainHost_persisted_validation_data</code></a></h4>
<div class="paragraph">
<p>Returns the persisted validation data for the given parachain Id and a given occupied core assumption.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The parachain Id (<a href="#defn-para-id">Section 6.8.5</a>).</p>
</li>
<li>
<p>An occupied core assumption (<a href="#defn-occupied-core-assumption">Definition 187</a>).</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>An <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) which can contain the persisted
validation data (<a href="#defn-persisted-validation-data">Definition 188</a>). The value is empty if the
parachain Id is not registered or the core assumption is of index \$2\$,
meaning that the core was freed.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div id="defn-occupied-core-assumption" class="exampleblock">
<div class="title">Definition 187. <a href="#defn-occupied-core-assumption">Occupied Core Assumption</a></div>
<div class="content">
<div class="paragraph">
<p>A occupied core assumption is used for fetching certain pieces of information
about a parachain by using the relay chain API. The assumption indicates how the
Runtime API should compute the result. The assumptions, A, is a varying datatype
of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$A == {(0,-&gt;,phi),(1,-&gt;,phi),(2,-&gt;,phi):}\$
</div>
</div>
<div class="paragraph">
<p>where <em>0</em> indicates that the candidate occupying the core was made available and
included to free the core, <em>1</em> indicates that it timed-out and freed the core
without advancing the parachain and <em>2</em> indicates that the core was not occupied
to begin with.</p>
</div>
</div>
</div>
<div id="defn-persisted-validation-data" class="exampleblock">
<div class="title">Definition 188. <a href="#defn-persisted-validation-data">Persisted Validation Data</a></div>
<div class="content">
<div class="paragraph">
<p>The persisted validation data provides information about how to create the
inputs for the validation of a candidate by calling the Runtime. This
information is derived from the parachain state and will vary from parachain to
parachain, although some of the fields may be the same for every parachain. This
validation data acts as a way to authorize the additional data (such as
messages) the collator needs to pass to the validation function.</p>
</div>
<div class="paragraph">
<p>The persisted validation data, \$D_{pv}\$, is a datastructure of the following format:</p>
</div>
<div class="stemblock">
<div class="content">
\$D_{pv} == (P_h,H_i,H_r,m_b)\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\$P_h\$ is the parent head data (<a href="#defn-head-data">Section 6.8.4</a>).</p>
</li>
<li>
<p>\$H_i\$ is the relay chain block number this is in the context of.</p>
</li>
<li>
<p>\$H_r\$ is the relay chain storage root this is in the context of.</p>
</li>
<li>
<p>\$m_b\$ is the maximum legal size of the PoV block, in bytes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The persisted validation data is fetched via the Runtime API
(<a href="#sect-rt-api-persisted-validation-data">Section 26.6.4</a>).</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_parachainhost_check_validation_outputs"><a class="link" href="#_parachainhost_check_validation_outputs">26.6.5. <code>ParachainHost_check_validation_outputs</code></a></h4>
<div class="paragraph">
<p>Checks if the given validation outputs pass the acceptance criteria.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The parachain Id (<a href="#defn-para-id">Section 6.8.5</a>).</p>
</li>
<li>
<p>The candidate commitments (<a href="#defn-candidate-commitments">Definition 100</a>).</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A boolean indicating whether the candidate commitments pass the acceptance criteria.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_parachainhost_session_index_for_child"><a class="link" href="#_parachainhost_session_index_for_child">26.6.6. <code>ParachainHost_session_index_for_child</code></a></h4>
<div class="paragraph">
<p>Returns the session index that is expected at the child of a block.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
TODO clarify session index
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A unsigned 32-bit integer representing the session index.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="sect-rt-api-validation-code"><a class="link" href="#sect-rt-api-validation-code">26.6.7. <code>ParachainHost_validation_code</code></a></h4>
<div class="paragraph">
<p>Fetches the validation code (Runtime) of a parachain by parachain Id.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The parachain Id (<a href="#defn-para-id">Section 6.8.5</a>).</p>
</li>
<li>
<p>The occupied core assumption (<a href="#defn-occupied-core-assumption">Definition 187</a>).</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>An <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) containing the full validation code
in an byte array. This value is empty if the parachain Id cannot be found or the
assumption is wrong.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="sect-rt-api-validation-code-by-hash"><a class="link" href="#sect-rt-api-validation-code-by-hash">26.6.8. <code>ParachainHost_validation_code_by_hash</code></a></h4>
<div class="paragraph">
<p>Returns the validation code (Runtime) of a parachain by its hash.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The hash value of the validation code.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>An <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) containing the full validation code
in an byte array. This value is empty if the parachain Id cannot be found or the
assumption is wrong.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_parachainhost_candidate_pending_availability"><a class="link" href="#_parachainhost_candidate_pending_availability">26.6.9. <code>ParachainHost_candidate_pending_availability</code></a></h4>
<div class="paragraph">
<p>Returns the receipt of a candidate pending availability for any parachain
assigned to an occupied availability core.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The parachain Id (<a href="#defn-para-id">Section 6.8.5</a>).</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>An <em>Option</em> value (<a href="#defn-option-type">Definition 152</a>) containing the committed candidate
receipt (<a href="#defn-candidate-receipt">Definition 97</a>). This value is empty if the given parachain
Id is not assigned to an occupied availability cores.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_parachainhost_candidate_events"><a class="link" href="#_parachainhost_candidate_events">26.6.10. <code>ParachainHost_candidate_events</code></a></h4>
<div class="paragraph">
<p>Returns an array of candidate events that occurred within the latest state.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>An array of single candidate events, E, of the following format:</p>
<div class="stemblock">
<div class="content">
\$E == {(0,-&gt;,d),(1,-&gt;,d),(2,-&gt;,(C_r,h,I_c)):}\$
\$d == (C_r,h,I_c,G_i)\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
</li>
<li>
<p>\$E\$ specifies the the event type of the candidate. <em>0</em> indicates that the
candidate receipt was backed in the latest relay chain block, <em>1</em> indicates that
it was included and became a parachain block at the latest relay chain block and
<em>2</em> indicates that the candidate receipt was not made available and timed-out.</p>
</li>
<li>
<p>\$C_r\$ is the candidate receipt (<a href="#defn-candidate-receipt">Definition 97</a>).</p>
</li>
<li>
<p>\$h\$ is the parachain head data (<a href="#defn-head-data">Section 6.8.4</a>).</p>
</li>
<li>
<p>\$I_c\$ is the index of the availability core as can be retrieved in
<a href="#sect-rt-api-availability-cores">Section 26.6.3</a> that the candidate is occupying. If \$E\$
is of variant \$2\$, then this indicates the core index the candidate <em>was</em>
occupying.</p>
</li>
<li>
<p>\$G_i\$ is the group index (<a href="#defn-validator-groups">Section 6.8.7</a>) that is responsible
of backing the candidate.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="sect-rt-api-session-info"><a class="link" href="#sect-rt-api-session-info">26.6.11. <code>ParachainHost_session_info</code></a></h4>
<div class="paragraph">
<p>Get the session info of the given session, if available.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The unsigned 32-bit integer indicating the session index.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>An <em>Option</em> type (<a href="#defn-option-type">Definition 152</a>) which can contain the session info
structure, \$S\$, of the following format:</p>
<div class="stemblock">
<div class="content">
\$S == (A,D,K,G,c,z,s,d,x,a)\$
\$A == (v_n,…v_m)\$
\$D == (v_(_n),…v_m)\$
\$K == (v_n,…v_m)\$
\$G == (g_n,…g_m)\$
\$g == (A_n,…A_m)\$
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
</li>
<li>
<p>\$A\$ indicates the validators of the current session, in canonical order.
There might be more validators in the current session than validators
participating in parachain consensus, as returned by the Runtime API
(<a href="#sect-rt-api-validators">Section 26.6.1</a>).</p>
</li>
<li>
<p>\$D\$ indicates the validator authority discovery keys for the given
session in canonical order. The first couple of validators are equal to the
corresponding validators participating in the parachain consensus, as returned
by the Runtime API (<a href="#sect-rt-api-validators">Section 26.6.1</a>). The remaining authorities are
not participating in the parachain consensus.</p>
</li>
<li>
<p>\$K\$ indicates the assignment keys for validators. There might be more
authorities in the session that validators participating in parachain consensus,
as returned by the Runtime API (<a href="#sect-rt-api-validators">Section 26.6.1</a>).</p>
</li>
<li>
<p>\$G\$ indicates the validator groups in shuffled order.</p>
</li>
<li>
<p>\$v_n\$ is public key of the authority.</p>
</li>
<li>
<p>\$A_n\$ is the authority set Id (<a href="#defn-authority-list">Definition 58</a>).</p>
</li>
<li>
<p>\$c\$ is an unsigned 32-bit integer indicating the number of availability
cores used by the protocol during the given session.</p>
</li>
<li>
<p>\$z\$ is an unsigned 32-bit integer indicating the zeroth delay tranche width.</p>
</li>
<li>
<p>\$s\$ is an unsigned 32-bit integer indicating the number of samples an
assigned validator should do for approval voting.</p>
</li>
<li>
<p>\$d\$ is an unsigned 32-bit integer indicating the number of delay tranches in total.</p>
</li>
<li>
<p>\$x\$ is an unsigned 32-bit integer indicating how many BABE slots must
pass before an assignment is considered a “no-show”.</p>
</li>
<li>
<p>\$a\$ is an unsigned 32-bit integer indicating the number of validators
needed to approve a block.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_parachainhost_dmq_contents"><a class="link" href="#_parachainhost_dmq_contents">26.6.12. <code>ParachainHost_dmq_contents</code></a></h4>
<div class="paragraph">
<p>Returns all the pending inbound messages in the downward message queue for a given parachain.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The parachain Id (<a href="#defn-para-id">Section 6.8.5</a>).</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>An array of inbound downward messages (<a href="#defn-downward-message">Section 6.8.9</a>).</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_parachainhost_inbound_hrmp_channels_contents"><a class="link" href="#_parachainhost_inbound_hrmp_channels_contents">26.6.13. <code>ParachainHost_inbound_hrmp_channels_contents</code></a></h4>
<div class="paragraph">
<p>Returns the contents of all channels addressed to the given recipient. Channels that have no messages in them are also included.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The parachain Id (<a href="#defn-para-id">Section 6.8.5</a>).</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>An array of inbound HRMP messages (<a href="#defn-inbound-hrmp-message">Section 6.8.11</a>).</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_grandpaapi_module_version_2"><a class="link" href="#_grandpaapi_module_version_2">26.7. GrandpaApi Module (Version 2)</a></h3>
<div class="paragraph">
<p>All calls in this module require <code>Core_initalize_block</code> (<a href="#sect-rte-core-initialize-block">Section 26.1.3</a>) to be called beforehand.</p>
</div>
<div class="sect3">
<h4 id="sect-rte-grandpa-auth"><a class="link" href="#sect-rte-grandpa-auth">26.7.1. <code>GrandpaApi_grandpa_authorities</code></a></h4>
<div class="paragraph">
<p>This entry fetches the list of GRANDPA authorities according to the
genesis block and is used to initialize an authority list at genesis,
defined in <a href="#defn-authority-list">Definition 58</a>.
Any future authority changes get tracked via Runtime-to-consensus engine
messages, as described in <a href="#sect-consensus-message-digest">Section 5.1.2</a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>An authority list as defined in <a href="#defn-authority-list">Definition 58</a>.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="sect-grandpaapi_submit_report_equivocation_unsigned_extrinsic"><a class="link" href="#sect-grandpaapi_submit_report_equivocation_unsigned_extrinsic">26.7.2. <code>GrandpaApi_submit_report_equivocation_unsigned_extrinsic</code></a></h4>
<div class="paragraph">
<p>A GRANDPA equivocation occurs when a validator votes for multiple blocks
during one voting subround, as described further in <a href="#defn-equivocation">Definition 81</a>. The Polkadot Host is expected to identify equivocators and report those to the Runtime by
calling this function.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The equivocation proof of the following format:</p>
<div class="stemblock">
<div class="content">
\[\begin{aligned}
    G_{\mathrm{Ep}} =&amp; (\mathrm{id}_{\mathbb{V}}, e, r, A_{\mathrm{id}}, B^1_h,
    B^1_n A^1_{\mathrm{sig}}, B^2_h, B^2_n, A^2_{\mathrm{sig}}) \\
    e =&amp; \begin{cases}
      0 &amp;\quad \textrm{Equivocation at prevote stage} \\
      1 &amp;\quad \textrm{Equivocation at precommit stage}
    \end{cases}
\end{aligned}\]
</div>
</div>
<div class="paragraph">
<p>where
<strong> \(\mathrm{id}_{\mathbb{V}}\) is the authority set as defined in <a href="#defn-authority-set-id">Definition 74</a>.
</strong> \(e\) indicates the stage at which the equivocation occurred.
<strong> \(r\) is the round number the equivocation occurred.
</strong> \(A_{\mathrm{id}}\) is the public key of the equivocator.
<strong> \(B^1_h\) is the block hash of the first block the equivocator voted for.
</strong> \(B^1_n\) is the block number of the first block the equivocator voted for.
<strong> \(A^1_{\mathrm{sig}}\) is the equivocators signature of the first vote.
</strong> \(B^2_h\) is the block hash of the second block the equivocator voted for.
<strong> \(B^2_n\) is the block number of the second block the equivocator voted for.
</strong> \(A^2_{\mathrm{sig}}\) is the equivocators signature of the second vote.</p>
</div>
</li>
<li>
<p>A proof of the key owner in an opaque form as described in <a href="#sect-grandpaapi_generate_key_ownership_proof">Section 26.7.3</a>.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A SCALE encoded <em>Option</em> as defined in <a href="#defn-option-type">Definition 152</a> containing an empty value on success.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="sect-grandpaapi_generate_key_ownership_proof"><a class="link" href="#sect-grandpaapi_generate_key_ownership_proof">26.7.3. <code>GrandpaApi_generate_key_ownership_proof</code></a></h4>
<div class="paragraph">
<p>Generates proof of the membership of a key owner in the specified block
state. The returned value is used to report equivocations as described
in <a href="#sect-grandpaapi_submit_report_equivocation_unsigned_extrinsic">Section 26.7.2</a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The authority set id as defined in <a href="#defn-authority-set-id">Definition 74</a>.</p>
</li>
<li>
<p>The 256-bit public key of the authority.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A SCALE encoded <em>Option</em> as defined in <a href="#defn-option-type">Definition 152</a> containing the proof in an opaque form.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_babeapi_module_version_2"><a class="link" href="#_babeapi_module_version_2">26.8. BabeApi Module (Version 2)</a></h3>
<div class="paragraph">
<p>All calls in this module require <code>Core_intialized_block</code> (<a href="#sect-rte-core-initialize-block">Section 26.1.3</a>) to be called beforehand.</p>
</div>
<div class="sect3">
<h4 id="sect-rte-babeapi-epoch"><a class="link" href="#sect-rte-babeapi-epoch">26.8.1. <code>BabeApi_configuration</code></a></h4>
<div class="paragraph">
<p>This entry is called to obtain the current configuration of the BABE
consensus protocol.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A tuple containing configuration data used by the Babe consensus
engine.</p>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 16. The tuple provided by <strong>BabeApi_configuration</strong>.</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 60%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Name</strong></th>
<th class="tableblock halign-left valign-top"><strong>Description</strong></th>
<th class="tableblock halign-left valign-top"><strong>Type</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>SlotDuration</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The slot duration in milliseconds. Currently, only the value provided by this
type at genesis will be used. Dynamic slot duration may be supported in the future.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unsigned 64bit integer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>EpochLength</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The duration of epochs in slots.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unsigned 64bit integer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Constant</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A constant value that is used in the threshold calculation formula as defined in <a href="#defn-babe-constant">Definition 64</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tuple containing two unsigned 64bit integers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>GenesisAuthorities</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The authority list for the genesis epoch as defined in <a href="#defn-authority-list">Definition 58</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array of tuples containing a 256-bit byte array and a unsigned 64bit integer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Randomness</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The randomness for the genesis epoch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32-byte array</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>SecondarySlot</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether this chain should run with round-robin-style secondary slot and if this secondary slot
requires the inclusion of an auxilary VRF output (<a href="#sect-block-production-lottery">Section 5.2.2</a>).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A one-byte enum as defined in <a href="#defn-consensus-message-digest">Definition 59</a> as \$2_("nd")\$.</p></td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_babeapi_current_epoch_start"><a class="link" href="#_babeapi_current_epoch_start">26.8.2. <code>BabeApi_current_epoch_start</code></a></h4>
<div class="paragraph">
<p>Finds the start slot of the current epoch.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A unsigned 64-bit integer indicating the slot number.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="sect-babeapi_current_epoch"><a class="link" href="#sect-babeapi_current_epoch">26.8.3. <code>BabeApi_current_epoch</code></a></h4>
<div class="paragraph">
<p>Produces information about the current epoch.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A data structure of the following format:</p>
<div class="stemblock">
<div class="content">
\[(e_i, s_s, d, A, r)\]
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\(e_i\) is a unsigned 64-bit integer representing the epoch index.</p>
</li>
<li>
<p>\(s_s\) is a unsigned 64-bit integer representing the starting slot of the epoch.</p>
</li>
<li>
<p>\(d\) is a unsigned 64-bit integer representing the duration of the epoch.</p>
</li>
<li>
<p>\(A\) is an authority list as defined in <a href="#defn-authority-list">Definition 58</a>.</p>
</li>
<li>
<p>\(r\) is an 256-bit array containing the randomness for the epoch as defined in <a href="#defn-epoch-randomness">Definition 72</a>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_babeapi_next_epoch"><a class="link" href="#_babeapi_next_epoch">26.8.4. <code>BabeApi_next_epoch</code></a></h4>
<div class="paragraph">
<p>Produces information about the next epoch.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Returns the same datastructure as described in <a href="#sect-babeapi_current_epoch">Section 26.8.3</a>.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="sect-babeapi_generate_key_ownership_proof"><a class="link" href="#sect-babeapi_generate_key_ownership_proof">26.8.5. <code>BabeApi_generate_key_ownership_proof</code></a></h4>
<div class="paragraph">
<p>Generates a proof of the membership of a key owner in the specified
block state. The returned value is used to report equivocations as
described in <a href="#sect-babeapi_submit_report_equivocation_unsigned_extrinsic">Section 26.8.6</a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The unsigned 64-bit integer indicating the slot number.</p>
</li>
<li>
<p>The 256-bit public key of the authority.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A SCALE encoded <em>Option</em> as defined in Definition <a href="#defn-option-type">Definition 152</a> containing the
proof in an opaque form.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="sect-babeapi_submit_report_equivocation_unsigned_extrinsic"><a class="link" href="#sect-babeapi_submit_report_equivocation_unsigned_extrinsic">26.8.6. <code>BabeApi_submit_report_equivocation_unsigned_extrinsic</code></a></h4>
<div class="paragraph">
<p>A BABE equivocation occurs when a validator produces more than one block
at the same slot. The proof of equivocation are the given distinct
headers that were signed by the validator and which include the slot
number. The Polkadot Host is expected to identify equivocators and
report those to the Runtime using this function.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If there are more than two blocks which cause an equivocation, the
equivocation only needs to be reported once i.e. no additional
equivocations must be reported for the same slot.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The equivocation proof of the following format:</p>
<div class="stemblock">
<div class="content">
\[B_{\mathrm{Ep}} = (A_{\mathrm{id}}, s, h_1, h_2)\]
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\(A_{\mathrm{id}}\) is the public key of the equivocator.</p>
</li>
<li>
<p>\(s\) is the slot as described in <a href="#sect-babe">[sect-babe]</a> at which the equivocation occurred.</p>
</li>
<li>
<p>\(h_1\) is the block header of the first block produced by the equivocator.</p>
</li>
<li>
<p>\(h_2\) is the block header of the second block produced by the equivocator.</p>
<div class="paragraph">
<p>Unlike during block execution, the Seal in both block headers is not removed before
submission. The block headers are submitted in its full form.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>An proof of the key owner in an opaque form as described in <a href="#sect-babeapi_generate_key_ownership_proof">Section 26.8.5</a>.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A SCALE encoded <em>Option</em> as defined in <a href="#defn-option-type">Definition 152</a> containing an empty
value on success.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_authoritydiscoveryapi_module_version_1"><a class="link" href="#_authoritydiscoveryapi_module_version_1">26.8.7. AuthorityDiscoveryApi Module (Version 1)</a></h4>
<div class="paragraph">
<p>All calls in this module require (Section
<a href="#sect-rte-core-initialize-block">Section 26.1.3</a>) to be called beforehand.</p>
</div>
<div class="sect4">
<h5 id="_authoritydiscoveryapi_authorities"><a class="link" href="#_authoritydiscoveryapi_authorities">26.8.7.1. <code>AuthorityDiscoveryApi_authorities</code></a></h5>
<div class="paragraph">
<p>A function which helps to discover authorities.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>None.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A byte array of varying size containing 256-bit pulic keys of the
authorities.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sect-runtime-sessionkeys-module"><a class="link" href="#sect-runtime-sessionkeys-module">26.8.8. SessionKeys Module (Version 1)</a></h4>
<div class="paragraph">
<p>All calls in this module require <code>Core_initialize_block</code> (<a href="#sect-rte-core-initialize-block">Section 26.1.3</a>) to be called beforehand.</p>
</div>
<div class="sect4">
<h5 id="_sessionkeys_generate_session_keys"><a class="link" href="#_sessionkeys_generate_session_keys">26.8.8.1. <code>SessionKeys_generate_session_keys</code></a></h5>
<div class="paragraph">
<p>Generates a set of session keys with an optional seed. The keys should
be stored within the keystore exposed by the Host Api. The seed needs to
be valid and UTF-8 encoded.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A SCALE-encoded <em>Option</em> as defined in <a href="#defn-option-type">Definition 152</a> containing an array of varying sizes indicating the seed.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A byte array of varying size containg the encoded session keys.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_sessionkeys_decode_session_keys"><a class="link" href="#_sessionkeys_decode_session_keys">26.8.8.2. <code>SessionKeys_decode_session_keys</code></a></h5>
<div class="paragraph">
<p>Decodes the given public session keys. Returns a list of raw public keys including their key type.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>An array of varying size containing the encoded public session keys.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>An array of varying size containing tuple pairs of the following format:</p>
<div class="stemblock">
<div class="content">
\[(k, k_{\mathrm{id}})\]
</div>
</div>
<div class="paragraph">
<p>where \(k\) is an array of varying sizes containg the raw
public key and \(k_{\mathrm{id}}\) is a
4-byte array indicating the key type.</p>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_accountnonceapi_module_version_1"><a class="link" href="#_accountnonceapi_module_version_1">26.9. AccountNonceApi Module (Version 1)</a></h3>
<div class="paragraph">
<p>All calls in this module require <code>Core_intialize_block</code> (<a href="#sect-rte-core-initialize-block">Section 26.1.3</a>) to be called beforehand.</p>
</div>
<div class="sect3">
<h4 id="sect-accountnonceapi-account-nonce"><a class="link" href="#sect-accountnonceapi-account-nonce">26.9.1. <code>AccountNonceApi_account_nonce</code></a></h4>
<div class="paragraph">
<p>Get the current nonce of an account. This function can be used by the Polkadot Host implementation when it seems appropriate, such as for the JSON-RPC API as described in <a href="#sect-json-rpc-api">Section 24.1</a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The 256-bit public key of the account.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A 32-bit unsigned integer indicating the nonce of the account.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_transactionpaymentapi_module_version_1"><a class="link" href="#_transactionpaymentapi_module_version_1">26.9.2. TransactionPaymentApi Module (Version 1)</a></h4>
<div class="paragraph">
<p>All calls in this module require <code>Core_initialize_block</code> (<a href="#sect-rte-core-initialize-block">Section 26.1.3</a>) to be called beforehand.</p>
</div>
<div class="sect4">
<h5 id="_transactionpaymentapi_query_info"><a class="link" href="#_transactionpaymentapi_query_info">26.9.2.1. <code>TransactionPaymentApi_query_info</code></a></h5>
<div class="paragraph">
<p>Returns information of a given extrinsic. This function is not aware of
the internals of an extrinsic, but only interprets the extrinsic as some
encoded value and accounts for its weight and length, the Runtime’s
extrinsic base weight and the current fee multiplier.</p>
</div>
<div class="paragraph">
<p>This function can be used by the Polkadot Host implementation when it
seems appropriate, such as for the JSON-RPC API as described in <a href="#sect-json-rpc-api">Section 24.1</a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A byte array of varying sizes containing the extrinsic.</p>
</li>
<li>
<p>The length of the extrinsic. [To do: why is this needed?]</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A data structure of the following format:</p>
<div class="stemblock">
<div class="content">
\[(w, c, f)\]
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\(w\) is the weight of the extrinsic.</p>
</li>
<li>
<p>\(c\) is the "class" of the extrinsic, where class is a  varying data (<a href="#defn-varrying-data-type">Definition 151</a>) type defined as:</p>
<div class="stemblock">
<div class="content">
\[c = \left\{\begin{array}{l}
       0 \quad \textrm{Normal extrinsic}\\
       1 \quad \textrm{Operational extrinsic}\\
       2 \quad \textrm{Mandatory extrinsic, which is always included}
     \end{array}\right.\]
</div>
</div>
</li>
<li>
<p>\(f\) is the inclusion fee of the extrinsic. This does not
include a tip or anything else that depends on the signature.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_transactionpaymentapi_query_fee_details"><a class="link" href="#_transactionpaymentapi_query_fee_details">26.9.2.2. <code>TransactionPaymentApi_query_fee_details</code></a></h5>
<div class="paragraph">
<p>Query the detailed fee of a given extrinsic. This function can be used
by the Polkadot Host implementation when it seems appropriate, such as
for the JSON-RPC API as described in <a href="#sect-json-rpc-api">Section 24.1</a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Arguments</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A byte array of varying sizes containing the extrinsic.</p>
</li>
<li>
<p>The length of the extrinsic.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Return</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>A data structure of the following format:</p>
<div class="stemblock">
<div class="content">
\[(f, t)\]
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\(f\) is a SCALE encoded as defined in <a href="#defn-option-type">Definition 152</a> containing the following data structure:</p>
<div class="stemblock">
<div class="content">
\[ f = (f_b, f_l, f_a)\]
</div>
</div>
<div class="paragraph">
<p>where
<strong>* \(f_b\) is the minimum required fee for an extrinsic.
</strong>* \(f_l\) is the length fee, the amount paid for the encoded length (in bytes) of the extrinsic.
<strong>*</strong> \(f_a\) is the &#8220;adjusted weight fee&#8221;, which is a multiplication of the fee multiplier and the weight fee. The fee multiplier varies depending on the usage of the network.</p>
</div>
</li>
<li>
<p>\(t\) is the tip for the block author.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bibliography"><a class="link" href="#_bibliography">Appendix A: Bibliography</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><a id="saarinen_blake2_2015"></a>[1] M. J. Saarinen and J.-P. Aumasson, “The BLAKE2 cryptographic hash and message authentication code (MAC),” -, <a href="https://tools.ietf.org/html/rfc7693" class="bare">https://tools.ietf.org/html/rfc7693</a>, RFC 7693, 2015. [Online]. Available: <a href="https://tools.ietf.org/html/rfc7693" class="bare">https://tools.ietf.org/html/rfc7693</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_glossary"><a class="link" href="#_glossary">Glossary</a></h2>
<div class="sectionbody">
<div class="dlist glossary">
<dl>
<dt>\(P_n\)</dt>
<dd>
<p>A path graph or a path of \(n\) nodes.</p>
</dd>
<dt>\((b_0,b_1,...,b_{n-1})\)</dt>
<dd>
<p>A sequence of bytes or byte array of length \(n\)</p>
</dd>
<dt>\(𝔹_n\)</dt>
<dd>
<p>A set of all byte arrays of length \(n\)</p>
</dd>
<dt>\(I=\left(B_n…B_0\right)_{256}\)</dt>
<dd>
<p>A non-negative interger in base 256</p>
</dd>
<dt>\(B=(b_0,b_1,…,b_n)\)</dt>
<dd>
<p>The little-endian representation of a non-negative interger \(I=(B_n…B_0)_{256}\) such that \(b_i≔B_i\)</p>
</dd>
<dt>\(\textrm{Enc}_{LE}\)</dt>
<dd>
<p>The little-endian encoding function.</p>
</dd>
<dt>\(C\)</dt>
<dd>
<p>A blockchain defined as a directed path graph.</p>
</dd>
<dt>Block</dt>
<dd>
<p>A node of the directed path graph (blockchain) C</p>
</dd>
<dt>Genesis Block</dt>
<dd>
<p>The unique sink of blockchain C</p>
</dd>
<dt>Head</dt>
<dd>
<p>The source of blockchain C</p>
</dd>
<dt>\(P(B)\)</dt>
<dd>
<p>The parent of block \(B\)</p>
</dd>
<dt>UNIX time</dt>
<dd>
<p>The number of milliseconds that have elapsed since the Unix epoch as a 64-bit integer</p>
</dd>
<dt>\(BT\)</dt>
<dd>
<p>The block tree of a blockchain</p>
</dd>
<dt>\(G\)</dt>
<dd>
<p>The genesis block, the root of the block tree BT</p>
</dd>
<dt>\(\textrm{CHAIN}(B)\)</dt>
<dd>
<p>The path graph from \(G\) to \(B\) in \(BT\).</p>
</dd>
<dt>\(Head(C)\)</dt>
<dd>
<p>The head of chain C.</p>
</dd>
<dt>\(|C|\)</dt>
<dd>
<p>The length of chain \(C\) as a path graph</p>
</dd>
<dt>\(\textrm{SubChain}(B',B)\)</dt>
<dd>
<p>The subgraph of \(Chain(B)\) path graph containing both \(B\) and \(B'\).</p>
</dd>
<dt>\(ℂ_B(BT)\)</dt>
<dd>
<p>The set of all subchains of \(BT\) rooted at block \(B\).</p>
</dd>
<dt>\(ℂ, ℂ(BT)\)</dt>
<dd>
<p>\(ℂ_G(BT)\) i.e. the set of all chains of \(BT\) rooted at genesis block</p>
</dd>
<dt>\(\textrm{Longest-Chain}(BT)\)</dt>
<dd>
<p>The longest sub path graph of \(BT\) i.e. \(C : |C| = \max_{C_i ∈ ℂ} |C_i|\)</p>
</dd>
<dt>\(\textrm{Longest-Path}(BT)\)</dt>
<dd>
<p>The longest sub path graph of \((P)BT\) with earliest block arrival time</p>
</dd>
<dt>\(\textrm{Deepest-Leaf}(BT)\)</dt>
<dd>
<p>\(\textrm{Head}(\textrm{Longest-Path}(BT))\) i.e. the head of \(\textrm{Longest-Path}(BT)\)</p>
</dd>
<dt>\(B &gt; B'\)</dt>
<dd>
<p>\(B\) is a descendant of \(B'\) in the block tree</p>
</dd>
<dt>\(\textrm{StoredValue}(k)\)</dt>
<dd>
<p>The function to retrieve the value stored under a specific key in the state storage.</p>
</dd>
<dt>State Trie, Trie</dt>
<dd>
<p>The Merkle radix-16 Tree which stores hashes of storage enteries.</p>
</dd>
<dt>\(\textrm{KeyEncode}(k)\)</dt>
<dd>
<p>The function to encode keys for labeling branaches of the Trie.</p>
</dd>
<dt>\(𝒩\)</dt>
<dd>
<p>The set of all nodes in the Polkadot state trie.</p>
</dd>
<dt>\(N\)</dt>
<dd>
<p>An individual node in the Trie.</p>
</dd>
<dt>\(𝒩_b\)</dt>
<dd>
<p>A branch node of the Trie which has at least one and at most 16 children</p>
</dd>
<dt>\(𝒩_l\)</dt>
<dd>
<p>A childless leaf node of the Trie</p>
</dd>
<dt>\(pk_N^{Agr}\)</dt>
<dd>
<p>The aggregated prefix key of node N</p>
</dd>
<dt>\(pk_N\)</dt>
<dd>
<p>The (suffix) partial key of node N</p>
</dd>
<dt>\(\textrm{Index}_N\)</dt>
<dd>
<p>A function returning an integer in range of {0, . . . ,15} represeting the index of a child node of node \(N\) among the children of \(N\)</p>
</dd>
<dt>\(v_N\)</dt>
<dd>
<p>Node value containing the header of node \(N\), its partial key and the digest of its childern values</p>
</dd>
<dt>\(\textrm{Head}_N\)</dt>
<dd>
<p>The node header of Trie node \(N\) storing information about the node&#8217;s type and kay</p>
</dd>
<dt>\(H(N)\)</dt>
<dd>
<p>The Merkle value of node \(N\).</p>
</dd>
<dt>\(\textrm{ChildrenBitmap}\)</dt>
<dd>
<p>The binary function indicating which child of a given node is present in the Trie.</p>
</dd>
<dt>\(sv_N\)</dt>
<dd>
<p>The subvalue of a Trie node \(N\).</p>
</dd>
<dt>Child storage</dt>
<dd>
<p>A sub storage of the state storage which has the same structure although being stored seperately</p>
</dd>
<dt>Child Trie</dt>
<dd>
<p>State trie of a child storage</p>
</dd>
<dt>Transaction Queue</dt>
<dd>
<p>See <a href="#defn-transaction-queue">Definition 31</a>.</p>
</dd>
<dt>\(H_p\)</dt>
<dd>
<p>The 32-byte Blake2b hash of the header of the parent of the block.</p>
</dd>
<dt>\(H_i,H_i(B)\)</dt>
<dd>
<p>Block number, the incremental interger index of the current block in the chain.</p>
</dd>
<dt>\(H_r\)</dt>
<dd>
<p>The hash of the root of the Merkle trie of the state storage at a given block</p>
</dd>
<dt>\(H_e\)</dt>
<dd>
<p>An auxileray field in block header used by Runtime to validate the integrity of the extrinsics composing the block body.</p>
</dd>
<dt>\(H_d\), \(H_d(B)\)</dt>
<dd>
<p>A block header used to store any chain-specific auxiliary data.</p>
</dd>
<dt>\(H_h(B)\)</dt>
<dd>
<p>The hash of the header of block \(B\)</p>
</dd>
<dt>\(\textrm{Body}(B)\)</dt>
<dd>
<p>The body of block \(B\) consisting of a set of extrinsics</p>
</dd>
<dt>\(M^{r,stage}_v\)</dt>
<dd>
<p>Vote message broadcasted by the voter v as part of the finality protocol</p>
</dd>
<dt>\(M_v^{r,Fin}(B)\)</dt>
<dd>
<p>The commit message broadcasted by voter \(v\) indicating that they have finalized bock \(B\) in round \(r\)</p>
</dd>
<dt>\(v\)</dt>
<dd>
<p>GRANDPA voter node which casts vote in the finality protocol</p>
</dd>
<dt>\(k_v^{pr}\)</dt>
<dd>
<p>The private key of voter \(v\)</p>
</dd>
<dt>\(v_{id}\)</dt>
<dd>
<p>The public key of voter \(v\)</p>
</dd>
<dt>\(𝕍_B,𝕍\)</dt>
<dd>
<p>The set of all GRANDPA voters for at block \(B\)</p>
</dd>
<dt>\(GS\)</dt>
<dd>
<p>GRANDPA protocol state consisting of the set of voters, number of times voters set has changed and the current round number.</p>
</dd>
<dt>\(r\)</dt>
<dd>
<p>The voting round counter in the finality protocol</p>
</dd>
<dt>\(V_(B)\)</dt>
<dd>
<p>A GRANDPA vote casted in favor of block B</p>
</dd>
<dt>\$V_v^(r,pv)\$</dt>
<dd>
<p>A GRANDPA vote casted by voter \(v\) during the pre-vote stage of round \(r\)</p>
</dd>
<dt>\$V_v^(r,pc)\$</dt>
<dd>
<p>A GRANDPA vote casted by voter \(v\) during the pre-commit stage of round \(r\)</p>
</dd>
<dt>\(J^{r,stage}(B)\)</dt>
<dd>
<p>The justification for pre-commiting or comming to block \(B\) in round \(r\) of finality protocol</p>
</dd>
<dt>\(Sign^{r,stage}_{v_i}(B)\)</dt>
<dd>
<p>The signature of voter \(v\) on their voteto block B, broadcasted during the specified stage of finality round \(r\)</p>
</dd>
<dt>\(ℰ^{r,stage}\)</dt>
<dd>
<p>The set of all equivocator voters in sub-round ‘‘stage'' of round \(r\)</p>
</dd>
<dt>\(ℰ^{r,stage}_{obs(v)}\)</dt>
<dd>
<p>The set of all equivocator voters in sub-round ‘‘stage'' of round \(r\) observed by voter \(v\)</p>
</dd>
<dt>\(VD^{r,stage}_{obs(v)}(B)\)</dt>
<dd>
<p>The set of observed direct votes for block B in round \(r\)</p>
</dd>
<dt>\(V^{r,stage}_{obs(v)}\)</dt>
<dd>
<p>The set of total votes observed by voter v in sub-round ‘‘stage'' of round r</p>
</dd>
<dt>\(V^{r,stage}_{obs(v)}(B)\)</dt>
<dd>
<p>The set of all observed votes by \(v\) in the sub-round “stage” of round \(r\) (directly or indirectly) for block \(B\)</p>
</dd>
<dt>\(B^{r,pv}_v\)</dt>
<dd>
<p>The currently pre-voted block in round \(r\). The GRANDPA GHOST of round \(r\)</p>
</dd>
<dt>Account key, \((sk^a,pk^a)\)</dt>
<dd>
<p>A key pair of types accepted by the Polkadot protocol which can be used to sign transactions</p>
</dd>
<dt>\(Enc_{SC}(A)\)</dt>
<dd>
<p>SCALE encoding of value \(A\)</p>
</dd>
<dt>\(T≔(A_1,...,A_n)\)</dt>
<dd>
<p>A tuple of values \(A_i\)'s each of different type</p>
</dd>
<dt>Varying Data Types \(𝒯={T_1,…,T_n}\)</dt>
<dd>
<p>A data type representing any of varying types \(T_1,…,T_n\).</p>
</dd>
<dt>\(S≔A_1,…,A_n\)</dt>
<dd>
<p>Sequence of values \(A_i\) of the same type</p>
</dd>
<dt>\(Enc^{Len}_{SC}(n)\)</dt>
<dd>
<p>SCALE length encoding aka. compact encoding of non-negative interger \(n\) of arbitrary size.</p>
</dd>
<dt>\(Enc_{HE}(PK)\)</dt>
<dd>
<p>Hex encoding</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 0.2.0<br>
Last updated 2022-04-12 17:37:18 UTC
</div>
</div>

  <script>
    MathJax = {
      loader: {
        load: ['input/asciimath', 'input/tex', 'output/chtml', 'a11y/assistive-mml']
      },
      asciimath: {
        delimiters: [['\\$','\\$']]
      },
      options: {
        ignoreHtmlClass: 'nostem|nolatexmath|noasciimath',
      },
      tex: {
        inlineMath: [[ '\\(', '\\)' ]],
        displayMath: [[ '\\[', '\\]' ]],
        processEscapes: false,
        processEnvironments: false,
        processRefs: false,   
      },
    };
  </script>

<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js"></script>
</body>
</html>